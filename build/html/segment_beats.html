<p>众所周知，线段树通过懒标记来做到优化时间复杂度。但使用懒标记必须满足，维护的值可以通过懒标记更新，以及懒标记之间可以快速合并。但有时候我们的区间操作不能简单地依赖懒标记，比如区间开根号，我们需要知道叶子节点的值才能得到开根号的结果，于是我们引入势能线段树这个概念：如果我们发现进行完一个操作之后，总会使能够接受的继续进行的操作次数越来越少，那么我们就可以先在线段树上暴力修改，然后维护是否还能继续操作，如果不能操作了，就直接返回，这样的话我们就达到了优化时间复杂度的效果。</p>
<p>参考<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup><sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup></p>
<h2 id="jian-dan-de-shi-neng-xian-duan-shu" tabindex="-1">简单的势能线段树</h2>
<h3 id="p4145-shang-di-zao-ti-de-qi-fen-zhong-2-hua-shen-you-li-ge-guo" tabindex="-1">P4145 上帝造题的七分钟 2 / 花神游历各国</h3>
<p><a href="https://www.luogu.com.cn/problem/P4145">https://www.luogu.com.cn/problem/P4145</a></p>
<p><strong>题目描述</strong></p>
<p>第一行一个整数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>，代表数列中数的个数。</p>
<p>第二行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 个正整数，表示初始状态下数列中的数。</p>
<p>第三行一个整数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span>，表示有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> 次操作。</p>
<p>接下来 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> 行每行三个整数 <code>k l r</code>。</p>
<ul>
<li>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">k=0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> 表示给 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span> 中的每个数开平方（下取整）。</p>
</li>
<li>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">k=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 表示询问 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span> 中各个数的和。</p>
</li>
</ul>
<p><strong>数据中有可能 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mo>&gt;</mo><mi>r</mi></mrow><annotation encoding="application/x-tex">l&gt;r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>，所以遇到这种情况请交换 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span>。</strong></p>
<p><strong>数据范围</strong></p>
<p>对于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>30</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">30\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">30%</span></span></span></span> 的数据，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo>≤</mo><msup><mn>10</mn><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">1\le n,m\le 10^3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span>，数列中的数不超过 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>32767</mn></mrow><annotation encoding="application/x-tex">32767</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">32767</span></span></span></span>。</p>
<p>对于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>100</mn><mi mathvariant="normal">%</mi></mrow><annotation encoding="application/x-tex">100\%</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8056em;vertical-align:-0.0556em;"></span><span class="mord">100%</span></span></span></span> 的数据，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo>≤</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding="application/x-tex">1\le n,m\le 10^5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo>≤</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">1\le l,r\le n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>，数列中的数大于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>，且不超过 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mn>12</mn></msup></mrow><annotation encoding="application/x-tex">10^{12}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">12</span></span></span></span></span></span></span></span></span></span></span></span>。</p>
<p><strong>笔记</strong></p>
<p>突破点：对一个数反复开根号，并不需要太多的次数，就可以使得这个数变成1，并且在这之后再开根号的话数字仍然不变。</p>
<p>于是我们先暴力遍历到叶子节点开根号，但同时维护某个节点所涵盖的区间是否都变成1，如果都变为1的话，就不需要再暴力遍历该区间开根号了。</p>
<h3 id="d-the-child-and-sequence" tabindex="-1">D. The Child and Sequence</h3>
<p><a href="https://codeforces.com/problemset/problem/438/D">https://codeforces.com/problemset/problem/438/D</a></p>
<p><strong>题目描述</strong></p>
<p>给定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 个数，三种操作：</p>
<ol>
<li>区间询问和</li>
<li>区间取模</li>
<li>单点修改</li>
</ol>
<p><strong>数据范围</strong></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo>≤</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding="application/x-tex">1\le n,m \le 10^5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span> 。其他的数字最大不超过 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mn>9</mn></msup></mrow><annotation encoding="application/x-tex">10^9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span>。</p>
<p><strong>笔记</strong></p>
<p>突破点：让一个数不断对一些数取模，那么这个数应该是越来越小的，至少不会增大。同时如果这个数已经比模数还小了，就不需要再取模了，取模后的结果就是他本身。</p>
<p>于是我们维护区间的最大值，如果这个最大值比模数还小，那么整个的这个区间并不需要取模。反之，我们暴力取模。</p>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTIzaW5jbHVkZSUzQ2JpdHMlMkZzdGRjJTJCJTJCLmglM0UlMEElMjNkZWZpbmUlMjBpbnQlMjBsb25nJTIwbG9uZyUwQSUyM2RlZmluZSUyMHVsbCUyMHVuc2lnbmVkJTIwbG9uZyUyMGxvbmclMEElMjNkZWZpbmUlMjBscyhrKSUyMChrKSUzQyUzQzElMEElMjNkZWZpbmUlMjBycyhrKSUyMChrKSUzQyUzQzElN0MxJTBBJTIzZGVmaW5lJTIwbnQlMjB0cmVlJTVCayU1RCUwQSUyM2RlZmluZSUyMGx0JTIwdHJlZSU1QmxzKGspJTVEJTBBJTIzZGVmaW5lJTIwcnQlMjB0cmVlJTVCcnMoayklNUQlMEElMjNkZWZpbmUlMjBkZWJ1Zyh4KSUyMGNvdXQlM0MlM0MlMjN4JTNDJTNDJTIyJTNEJTIyJTNDJTNDeCUzQyUzQ2VuZGwlMEF1c2luZyUyMG5hbWVzcGFjZSUyMHN0ZCUzQiUwQSUyM2RlZmluZSUyMF8lMjAxMDAwMDUlMEFjb25zdCUyMGludCUyMGluZiUzRDB4M2YzZjNmM2YzZjNmM2YzZiUzQiUwQWNvbnN0JTIwaW50JTIwbW9kJTNEMCUzQiUwQXR5cGVkZWYlMjBwYWlyJTNDaW50JTJDaW50JTNFJTIwcGlpJTNCJTBBaW50JTIwbiUyQ20lMkNpbiU1Ql8lNUQlM0IlMEFzdHJ1Y3QlMjBOb2RlJTdCaW50JTIwc3VtJTJDbXglM0IlN0QlMjB0cmVlJTVCXyUzQyUzQzIlNUQlM0IlMEFpbmxpbmUlMjB2b2lkJTIwcHVzaHVwKGludCUyMGspJTdCJTBBJTIwJTIwJTIwJTIwbnQuc3VtJTNEbHQuc3VtJTJCcnQuc3VtJTNCJTBBJTIwJTIwJTIwJTIwbnQubXglM0RtYXgobHQubXglMkNydC5teCklM0IlMEElN0QlMEF2b2lkJTIwYnVpbGQoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByKSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0QlM0RyKSUyMHJldHVybiUyMG50Lm14JTNEaW4lNUJsJTVEJTJDbnQuc3VtJTNEaW4lNUJsJTVEJTJDdm9pZCgpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElM0IlMEElMjAlMjAlMjAlMjBidWlsZChscyhrKSUyQ2wlMkNtaWQpJTNCJTBBJTIwJTIwJTIwJTIwYnVpbGQocnMoayklMkNtaWQlMkIxJTJDciklM0IlMEElMjAlMjAlMjAlMjBwdXNodXAoayklM0IlMEElN0QlMEFpbnQlMjBxdWVyeShpbnQlMjBrJTJDaW50JTIwbCUyQ2ludCUyMHIlMkNpbnQlMjB4JTJDaW50JTIweSklN0IlMEElMjAlMjAlMjAlMjBpZihsJTNFJTNEeCUyNiUyNnIlM0MlM0R5KSUyMHJldHVybiUyMG50LnN1bSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMG1pZCUzRChsJTJCciklM0UlM0UxJTJDcmVzJTNEMCUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwcmVzJTJCJTNEcXVlcnkobHMoayklMkNsJTJDbWlkJTJDeCUyQ3kpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeSUzRW1pZCklMjByZXMlMkIlM0RxdWVyeShycyhrKSUyQ21pZCUyQjElMkNyJTJDeCUyQ3kpJTNCJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwcmVzJTNCJTBBJTdEJTBBdm9pZCUyMG1vZGlmeShpbnQlMjBrJTJDaW50JTIwbCUyQ2ludCUyMHIlMkNpbnQlMjB4JTJDaW50JTIweSUyQ2ludCUyMHApJTdCJTBBJTIwJTIwJTIwJTIwaWYobCUzRCUzRHIpJTIwcmV0dXJuJTIwbnQuc3VtJTI1JTNEcCUyQ250Lm14JTI1JTNEcCUyQ3ZvaWQoKSUzQiUwQSUyMCUyMCUyMCUyMGlmKG50Lm14JTNDcCklMjByZXR1cm4lM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwbW9kaWZ5KGxzKGspJTJDbCUyQ21pZCUyQ3glMkN5JTJDcCklM0IlMEElMjAlMjAlMjAlMjBpZih5JTNFbWlkKSUyMG1vZGlmeShycyhrKSUyQ21pZCUyQjElMkNyJTJDeCUyQ3klMkNwKSUzQiUwQSUyMCUyMCUyMCUyMHB1c2h1cChrKSUzQiUwQSU3RCUwQXZvaWQlMjBjaGFuZ2UoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHYpJTdCJTBBJTIwJTIwJTIwJTIwaWYobCUzRCUzRHIpJTIwcmV0dXJuJTIwbnQuc3VtJTNEbnQubXglM0R2JTJDdm9pZCgpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElM0IlMEElMjAlMjAlMjAlMjBpZih4JTNDJTNEbWlkKSUyMGNoYW5nZShscyhrKSUyQ2wlMkNtaWQlMkN4JTJDdiklM0IlMEElMjAlMjAlMjAlMjBlbHNlJTIwY2hhbmdlKHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDdiklM0IlMEElMjAlMjAlMjAlMjBwdXNodXAoayklM0IlMEElN0QlMEFpbmxpbmUlMjB2b2lkJTIwc3VidGFzaygpJTdCJTBBJTIwJTIwJTIwJTIwY2luJTNFJTNFbiUzRSUzRW0lM0IlMEElMjAlMjAlMjAlMjBmb3IoaW50JTIwaSUzRDElM0JpJTNDJTNEbiUzQmklMkIlMkIpJTIwY2luJTNFJTNFaW4lNUJpJTVEJTNCJTBBJTIwJTIwJTIwJTIwYnVpbGQoMSUyQzElMkNuKSUzQiUwQSUyMCUyMCUyMCUyMHdoaWxlKG0tLSklN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbnQlMjBvcCUyQ3glMkN5JTJDeiUzQmNpbiUzRSUzRW9wJTNFJTNFeCUzRSUzRXklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCUzRCUzRDEpJTIwY291dCUzQyUzQ3F1ZXJ5KDElMkMxJTJDbiUyQ3glMkN5KSUzQyUzQ2VuZGwlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBlbHNlJTIwaWYob3AlM0QlM0QyKSUyMGNpbiUzRSUzRXolMkNtb2RpZnkoMSUyQzElMkNuJTJDeCUyQ3klMkN6KSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGVsc2UlMjBpZihvcCUzRCUzRDMpJTIwY2hhbmdlKDElMkMxJTJDbiUyQ3glMkN5KSUzQiUwQSUyMCUyMCUyMCUyMCU3RCUwQSU3RCUwQXNpZ25lZCUyMG1haW4oKSU3QiUwQSUyMCUyMCUyMCUyMGlvcyUzQSUzQXN5bmNfd2l0aF9zdGRpbyhmYWxzZSklM0IlMEElMjAlMjAlMjAlMjBpbnQlMjB0JTNEMSUzQiUyRiUyRmNpbiUzRSUzRXQlM0IlMEElMjAlMjAlMjAlMjB3aGlsZSh0LS0pJTIwc3VidGFzaygpJTNCJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwMCUzQiUwQSU3RCUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div><div>63</div><div>64</div><div>65</div><div>66</div></div><div class="code"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ls(k) (k)&lt;&lt;1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rs(k) (k)&lt;&lt;1|1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> nt tree[k]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> lt tree[ls(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rt tree[rs(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> debug(x) cout&lt;&lt;#x&lt;&lt;<span class="hljs-string">&quot;=&quot;</span>&lt;&lt;x&lt;&lt;endl</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ 100005</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> inf=<span class="hljs-number">0x3f3f3f3f3f3f3f3f</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mod=<span class="hljs-number">0</span>;
<span class="hljs-keyword">typedef</span> pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; pii;
<span class="hljs-type">int</span> n,m,in[_];
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>{<span class="hljs-type">int</span> sum,mx;} tree[_&lt;&lt;<span class="hljs-number">2</span>];
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
    nt.sum=lt.sum+rt.sum;
    nt.mx=<span class="hljs-built_in">max</span>(lt.mx,rt.mx);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>{
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.mx=in[l],nt.sum=in[l],<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">ls</span>(k),l,mid);
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.sum;
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(x&lt;=mid) res+=<span class="hljs-built_in">query</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y);
    <span class="hljs-keyword">if</span>(y&gt;mid) res+=<span class="hljs-built_in">query</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y);
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> p)</span></span>{
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.sum%=p,nt.mx%=p,<span class="hljs-built_in">void</span>();
    <span class="hljs-keyword">if</span>(nt.mx&lt;p) <span class="hljs-keyword">return</span>;
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y,p);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y,p);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">change</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.sum=nt.mx=v,<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">change</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,v);
    <span class="hljs-keyword">else</span> <span class="hljs-built_in">change</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">subtask</span><span class="hljs-params">()</span></span>{
    cin&gt;&gt;n&gt;&gt;m;
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) cin&gt;&gt;in[i];
    <span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);
    <span class="hljs-keyword">while</span>(m--){
        <span class="hljs-type">int</span> op,x,y,z;cin&gt;&gt;op&gt;&gt;x&gt;&gt;y;
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>) cout&lt;&lt;<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,x,y)&lt;&lt;endl;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(op==<span class="hljs-number">2</span>) cin&gt;&gt;z,<span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,x,y,z);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(op==<span class="hljs-number">3</span>) <span class="hljs-built_in">change</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,x,y);
    }
}
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-type">int</span> t=<span class="hljs-number">1</span>;<span class="hljs-comment">//cin&gt;&gt;t;</span>
    <span class="hljs-keyword">while</span>(t--) <span class="hljs-built_in">subtask</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<h3 id="f-sum-and-replace" tabindex="-1">F. SUM and REPLACE</h3>
<p><a href="https://codeforces.com/contest/920/problem/F">https://codeforces.com/contest/920/problem/F</a></p>
<p><strong>题目描述</strong></p>
<p>设 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 的因子个数。现在给定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 个数，有两种操作：</p>
<ol>
<li>区间中所有的数字 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 都变为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span></li>
<li>询问区间和</li>
</ol>
<p><strong>数据范围</strong></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo>≤</mo><mn>3</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding="application/x-tex">1\le n,m \le 3\times 10^5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">3</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><msub><mi>a</mi><mi>i</mi></msub><mo>≤</mo><msup><mn>10</mn><mn>6</mn></msup></mrow><annotation encoding="application/x-tex">1\le a_i \le 10^6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.786em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>笔记</strong></p>
<p>突破点：和第一道题目一样的道理，修改操作会让数字不断的减小，直到数字变为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> 或 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>，于是修改操作仍然可以暴力处理。</p>
<p>由于数字的值域只有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mn>6</mn></msup></mrow><annotation encoding="application/x-tex">10^6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span></span></span></span> ，可以先预处理一把。</p>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTIzaW5jbHVkZSUzQ2JpdHMlMkZzdGRjJTJCJTJCLmglM0UlMEElMjNkZWZpbmUlMjBpbnQlMjBsb25nJTIwbG9uZyUwQSUyM2RlZmluZSUyMHVsbCUyMHVuc2lnbmVkJTIwbG9uZyUyMGxvbmclMEElMjNkZWZpbmUlMjBscyhrKSUyMChrKSUzQyUzQzElMEElMjNkZWZpbmUlMjBycyhrKSUyMChrKSUzQyUzQzElN0MxJTBBJTIzZGVmaW5lJTIwbnQlMjB0cmVlJTVCayU1RCUwQSUyM2RlZmluZSUyMGx0JTIwdHJlZSU1QmxzKGspJTVEJTBBJTIzZGVmaW5lJTIwcnQlMjB0cmVlJTVCcnMoayklNUQlMEElMjNkZWZpbmUlMjBfJTIwMTAwMDAwNiUwQSUyM2RlZmluZSUyMGRlYnVnKHgpJTIwY291dCUzQyUzQyUyM3glM0MlM0MlMjIlM0QlMjIlM0MlM0N4JTNDJTNDZW5kbCUwQXVzaW5nJTIwbmFtZXNwYWNlJTIwc3RkJTNCJTBBY29uc3QlMjBpbnQlMjBpbmYlM0QweDNmM2YzZjNmM2YzZjNmM2YlM0IlMEFjb25zdCUyMGludCUyMG1vZCUzRDAlM0IlMEF0eXBlZGVmJTIwcGFpciUzQ2ludCUyQ2ludCUzRSUyMHBpaSUzQiUwQWludCUyMHByaW1lJTVCXyU1RCUyQ2NudCUyQ3ZpcyU1Ql8lNUQlMkNmJTVCXyU1RCUyQ20lMkNuJTJDaW4lNUJfJTVEJTNCJTBBc3RydWN0JTIwTm9kZSU3QmludCUyMHN1bSUyQ29rJTNCJTdEJTIwdHJlZSU1Ql8lM0MlM0MyJTVEJTNCJTBBaW5saW5lJTIwdm9pZCUyMGluaXQoKSU3QiUwQSUyMCUyMCUyMCUyMGYlNUIxJTVEJTNEMSUzQiUwQSUyMCUyMCUyMCUyMGZvcihpbnQlMjBpJTNEMiUzQmklM0MlM0QxMDAwMDAwJTNCaSUyQiUyQiklN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBmJTVCaSU1RCUzRDElM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZighdmlzJTVCaSU1RCklMjBwcmltZSU1QiUyQiUyQmNudCU1RCUzRGklMkN2aXMlNUJpJTVEJTNEaSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGZvcihpbnQlMjBqJTNEMSUzQmolM0MlM0RjbnQlMjYlMjZwcmltZSU1QmolNUQqaSUzQyUzRDEwMDAwMDAlM0JqJTJCJTJCKSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHZpcyU1QmkqcHJpbWUlNUJqJTVEJTVEJTNEcHJpbWUlNUJqJTVEJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYoaSUyNXByaW1lJTVCaiU1RCUzRCUzRDApJTIwYnJlYWslM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0QlMEElMjAlMjAlMjAlMjAlN0QlMEElMjAlMjAlMjAlMjBmb3IoaW50JTIwaSUzRDIlM0JpJTNDJTNEMTAwMDAwMCUzQmklMkIlMkIpJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW50JTIweCUzRGklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB3aGlsZSh4ISUzRDEpJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW50JTIwYyUzRDAlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbnQlMjBueHQlM0R2aXMlNUJ4JTVEJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwd2hpbGUoeCUyNW54dCUzRCUzRDApJTIweCUyRiUzRG54dCUyQ2MlMkIlMkIlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBmJTVCaSU1RColM0QoMSUyQmMpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdEJTBBJTIwJTIwJTIwJTIwJTdEJTBBJTdEJTBBdm9pZCUyMHB1c2h1cChpbnQlMjBrKSU3QiUwQSUyMCUyMCUyMCUyMG50LnN1bSUzRGx0LnN1bSUyQnJ0LnN1bSUzQiUwQSUyMCUyMCUyMCUyMG50Lm9rJTNEbHQub2slMjZydC5vayUzQiUwQSU3RCUwQXZvaWQlMjBidWlsZChpbnQlMjBrJTJDaW50JTIwbCUyQ2ludCUyMHIpJTdCJTBBJTIwJTIwJTIwJTIwaWYobCUzRCUzRHIpJTIwcmV0dXJuJTIwbnQuc3VtJTNEaW4lNUJsJTVEJTJDbnQub2slM0RpbiU1QmwlNUQlM0MlM0QyJTNGMSUzQTAlMkN2b2lkKCklM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUzQiUwQSUyMCUyMCUyMCUyMGJ1aWxkKGxzKGspJTJDbCUyQ21pZCklM0IlMEElMjAlMjAlMjAlMjBidWlsZChycyhrKSUyQ21pZCUyQjElMkNyKSUzQiUwQSUyMCUyMCUyMCUyMHB1c2h1cChrKSUzQiUwQSU3RCUwQWludCUyMHF1ZXJ5KGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciUyQ2ludCUyMHglMkNpbnQlMjB5KSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHkpJTIwcmV0dXJuJTIwbnQuc3VtJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElMkNyZXMlM0QwJTNCJTBBJTIwJTIwJTIwJTIwaWYoeCUzQyUzRG1pZCklMjByZXMlMkIlM0RxdWVyeShscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSklM0IlMEElMjAlMjAlMjAlMjBpZih5JTNFbWlkKSUyMHJlcyUyQiUzRHF1ZXJ5KHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSklM0IlMEElMjAlMjAlMjAlMjByZXR1cm4lMjByZXMlM0IlMEElN0QlMEF2b2lkJTIwbW9kaWZ5KGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciUyQ2ludCUyMHglMkNpbnQlMjB5KSU3QiUwQSUyMCUyMCUyMCUyMGlmKG50Lm9rKSUyMHJldHVybiUzQiUwQSUyMCUyMCUyMCUyMGlmKGwlM0QlM0RyKSUyMHJldHVybiUyMG50Lm9rJTNEZiU1Qm50LnN1bSU1RCUzQyUzRDIlM0YxJTNBMCUyQ250LnN1bSUzRGYlNUJudC5zdW0lNUQlMkN2b2lkKCklM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwbW9kaWZ5KGxzKGspJTJDbCUyQ21pZCUyQ3glMkN5KSUzQiUwQSUyMCUyMCUyMCUyMGlmKHklM0VtaWQpJTIwbW9kaWZ5KHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSklM0IlMEElMjAlMjAlMjAlMjBwdXNodXAoayklM0IlMEElN0QlMEFpbmxpbmUlMjB2b2lkJTIwc3VidGFzaygpJTdCJTBBJTIwJTIwJTIwJTIwY2luJTNFJTNFbiUzRSUzRW0lM0IlMEElMjAlMjAlMjAlMjBmb3IoaW50JTIwaSUzRDElM0JpJTNDJTNEbiUzQmklMkIlMkIpJTIwY2luJTNFJTNFaW4lNUJpJTVEJTNCJTBBJTIwJTIwJTIwJTIwYnVpbGQoMSUyQzElMkNuKSUzQiUwQSUyMCUyMCUyMCUyMHdoaWxlKG0tLSklN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbnQlMjBvcCUyQ2wlMkNyJTNCY2luJTNFJTNFb3AlM0UlM0VsJTNFJTNFciUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKG9wJTNEJTNEMSklMjBtb2RpZnkoMSUyQzElMkNuJTJDbCUyQ3IpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwZWxzZSUyMGlmKG9wJTNEJTNEMiklMjBjb3V0JTNDJTNDcXVlcnkoMSUyQzElMkNuJTJDbCUyQ3IpJTNDJTNDZW5kbCUzQiUwQSUyMCUyMCUyMCUyMCU3RCUwQSU3RCUwQXNpZ25lZCUyMG1haW4oKSU3QiUwQSUyMCUyMCUyMCUyMGluaXQoKSUzQiUwQSUyMCUyMCUyMCUyMCUyRiUyRiUyMGZvcihpbnQlMjBpJTNEMSUzQmklM0MlM0QyMCUzQmklMkIlMkIpJTdCJTBBJTIwJTIwJTIwJTIwJTJGJTJGJTIwJTIwJTIwJTIwJTIwY291dCUzQyUzQ2klM0MlM0MnJTIwJyUzQyUzQ2YlNUJpJTVEJTNDJTNDZW5kbCUzQiUwQSUyMCUyMCUyMCUyMCUyRiUyRiUyMCU3RCUwQSUyMCUyMCUyMCUyMGlvcyUzQSUzQXN5bmNfd2l0aF9zdGRpbyhmYWxzZSklM0IlMEElMjAlMjAlMjAlMjBpbnQlMjB0JTNEMSUzQiUyRiUyRmNpbiUzRSUzRXQlM0IlMEElMjAlMjAlMjAlMjB3aGlsZSh0LS0pJTIwc3VidGFzaygpJTNCJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwMCUzQiUwQSU3RCUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div><div>63</div><div>64</div><div>65</div><div>66</div><div>67</div><div>68</div><div>69</div><div>70</div><div>71</div><div>72</div><div>73</div><div>74</div><div>75</div><div>76</div><div>77</div><div>78</div><div>79</div><div>80</div><div>81</div><div>82</div></div><div class="code"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ls(k) (k)&lt;&lt;1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rs(k) (k)&lt;&lt;1|1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> nt tree[k]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> lt tree[ls(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rt tree[rs(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ 1000006</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> debug(x) cout&lt;&lt;#x&lt;&lt;<span class="hljs-string">&quot;=&quot;</span>&lt;&lt;x&lt;&lt;endl</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> inf=<span class="hljs-number">0x3f3f3f3f3f3f3f3f</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mod=<span class="hljs-number">0</span>;
<span class="hljs-keyword">typedef</span> pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; pii;
<span class="hljs-type">int</span> prime[_],cnt,vis[_],f[_],m,n,in[_];
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>{<span class="hljs-type">int</span> sum,ok;} tree[_&lt;&lt;<span class="hljs-number">2</span>];
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span>{
    f[<span class="hljs-number">1</span>]=<span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;=<span class="hljs-number">1000000</span>;i++){
        f[i]=<span class="hljs-number">1</span>;
        <span class="hljs-keyword">if</span>(!vis[i]) prime[++cnt]=i,vis[i]=i;
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j=<span class="hljs-number">1</span>;j&lt;=cnt&amp;&amp;prime[j]*i&lt;=<span class="hljs-number">1000000</span>;j++){
            vis[i*prime[j]]=prime[j];
            <span class="hljs-keyword">if</span>(i%prime[j]==<span class="hljs-number">0</span>) <span class="hljs-keyword">break</span>;
        }
    }
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">2</span>;i&lt;=<span class="hljs-number">1000000</span>;i++){
        <span class="hljs-type">int</span> x=i;
        <span class="hljs-keyword">while</span>(x!=<span class="hljs-number">1</span>){
            <span class="hljs-type">int</span> c=<span class="hljs-number">0</span>;
            <span class="hljs-type">int</span> nxt=vis[x];
            <span class="hljs-keyword">while</span>(x%nxt==<span class="hljs-number">0</span>) x/=nxt,c++;
            f[i]*=(<span class="hljs-number">1</span>+c);
        }
    }
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
    nt.sum=lt.sum+rt.sum;
    nt.ok=lt.ok&amp;rt.ok;
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>{
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.sum=in[l],nt.ok=in[l]&lt;=<span class="hljs-number">2</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>,<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">ls</span>(k),l,mid);
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.sum;
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(x&lt;=mid) res+=<span class="hljs-built_in">query</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y);
    <span class="hljs-keyword">if</span>(y&gt;mid) res+=<span class="hljs-built_in">query</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y);
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(nt.ok) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.ok=f[nt.sum]&lt;=<span class="hljs-number">2</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>,nt.sum=f[nt.sum],<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">subtask</span><span class="hljs-params">()</span></span>{
    cin&gt;&gt;n&gt;&gt;m;
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) cin&gt;&gt;in[i];
    <span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);
    <span class="hljs-keyword">while</span>(m--){
        <span class="hljs-type">int</span> op,l,r;cin&gt;&gt;op&gt;&gt;l&gt;&gt;r;
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>) <span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(op==<span class="hljs-number">2</span>) cout&lt;&lt;<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r)&lt;&lt;endl;
    }
}
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-built_in">init</span>();
    <span class="hljs-comment">// for(int i=1;i&lt;=20;i++){</span>
    <span class="hljs-comment">//     cout&lt;&lt;i&lt;&lt;&#x27; &#x27;&lt;&lt;f[i]&lt;&lt;endl;</span>
    <span class="hljs-comment">// }</span>
    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-type">int</span> t=<span class="hljs-number">1</span>;<span class="hljs-comment">//cin&gt;&gt;t;</span>
    <span class="hljs-keyword">while</span>(t--) <span class="hljs-built_in">subtask</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<h3 id="a-and-rmq" tabindex="-1">A. And RMQ</h3>
<p><a href="https://codeforces.com/gym/103107/problem/A">https://codeforces.com/gym/103107/problem/A</a></p>
<p><strong>题目描述</strong></p>
<p>给定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 个数，有三种操作：</p>
<ol>
<li>区间按位与</li>
<li>单点修改</li>
<li>区间询问最大值</li>
</ol>
<p><strong>数据范围</strong></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo>≤</mo><mn>4</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding="application/x-tex">1\le n,m \le 4\times 10^5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>笔记</strong></p>
<p>突破点：按位与其实也是有“单调性”的。对于一个数字，对其不断进行按位与，实际上就是不断将其二进制为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 的位上变为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 的数量是单调不增的。如果将数字 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 与某个数字 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 按位与，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 二进制为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> 的位置，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 相同位置上都为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>，那么这个按位与实际上是没有效果的。</p>
<p>对于一个区间中的多个数也有上述的效果。我们令 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mo>=</mo><msub><mi>a</mi><mi>l</mi></msub><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mrow><mi>l</mi><mo>+</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mrow><mi>r</mi><mo>−</mo><mn>1</mn></mrow></msub><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>r</mi></msub></mrow><annotation encoding="application/x-tex">e=a_l|a_{l+1}|...|a_{r-1}|a_{r}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣...∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，即把区间内所有数字都按位或起来。然后如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>e</mi><mi mathvariant="normal">&amp;</mi><mi>x</mi><mo>=</mo><mi>e</mi></mrow><annotation encoding="application/x-tex">e\&amp;x=e</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">e</span><span class="mord">&amp;</span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">e</span></span></span></span> 那么我们就说这个区间的数字就都没必要再对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 按位与了。</p>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTIzaW5jbHVkZSUzQ2JpdHMlMkZzdGRjJTJCJTJCLmglM0UlMEElMjNkZWZpbmUlMjB1bGwlMjB1bnNpZ25lZCUyMGxvbmclMjBsb25nJTBBJTIzZGVmaW5lJTIwbHMoayklMjAoayklM0MlM0MxJTBBJTIzZGVmaW5lJTIwcnMoayklMjAoayklM0MlM0MxJTdDMSUwQSUyM2RlZmluZSUyMG50JTIwdHJlZSU1QmslNUQlMEElMjNkZWZpbmUlMjBsdCUyMHRyZWUlNUJscyhrKSU1RCUwQSUyM2RlZmluZSUyMHJ0JTIwdHJlZSU1QnJzKGspJTVEJTBBJTIzZGVmaW5lJTIwXyUyMDQwMDAwNSUwQSUyM2RlZmluZSUyMGRlYnVnKHgpJTIwY291dCUzQyUzQyUyM3glM0MlM0MlMjIlM0QlMjIlM0MlM0N4JTNDJTNDZW5kbCUwQXVzaW5nJTIwbmFtZXNwYWNlJTIwc3RkJTNCJTBBY29uc3QlMjBpbnQlMjBpbmYlM0QweDNmM2YzZjNmM2YzZjNmM2YlM0IlMEFjb25zdCUyMGludCUyMG1vZCUzRDAlM0IlMEElMjNkZWZpbmUlMjBMT0NBTCUwQW5hbWVzcGFjZSUyMGx5JTBBJTdCJTBBJTIwJTIwJTIwJTIwbmFtZXNwYWNlJTIwSU8lMEElMjAlMjAlMjAlMjAlN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjNpZm5kZWYlMjBMT0NBTCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGNvbnN0ZXhwciUyMGF1dG8lMjBtYXhuJTNEMSUzQyUzQzIwJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwY2hhciUyMGluJTVCbWF4biU1RCUyQ291dCU1Qm1heG4lNUQlMkMqcDElM0RpbiUyQypwMiUzRGluJTJDKnAzJTNEb3V0JTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzZGVmaW5lJTIwZ2V0Y2hhcigpJTIwKHAxJTNEJTNEcDIlMjYlMjYocDIlM0QocDElM0RpbiklMkJmcmVhZChpbiUyQzElMkNtYXhuJTJDc3RkaW4pJTJDcDElM0QlM0RwMiklM0ZFT0YlM0EqcDElMkIlMkIpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzZGVmaW5lJTIwZmx1c2goKSUyMChmd3JpdGUob3V0JTJDMSUyQ3AzLW91dCUyQ3N0ZG91dCkpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzZGVmaW5lJTIwcHV0Y2hhcih4KSUyMChwMyUzRCUzRG91dCUyQm1heG4lMjYlMjYoZmx1c2goKSUyQ3AzJTNEb3V0KSUyQypwMyUyQiUyQiUzRCh4KSklMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBjbGFzcyUyMEZsdXNoJTdCcHVibGljJTNBfkZsdXNoKCklN0JmbHVzaCgpJTNCJTdEJTdEXyUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyM2VuZGlmJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwbmFtZXNwYWNlJTIwdXNyJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdGVtcGxhdGUlM0N0eXBlbmFtZSUyMHR5cGUlM0UlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbmxpbmUlMjB0eXBlJTIwcmVhZCh0eXBlJTIwJTI2eCklMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB4JTNEMCUzQmJvb2wlMjBmbGFnKDApJTNCY2hhciUyMGNoJTNEZ2V0Y2hhcigpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwd2hpbGUoIWlzZGlnaXQoY2gpKSUyMGZsYWclNUUlM0RjaCUzRCUzRCctJyUyQ2NoJTNEZ2V0Y2hhcigpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwd2hpbGUoaXNkaWdpdChjaCkpJTIweCUzRCh4JTNDJTNDMSklMkIoeCUzQyUzQzMpJTJCKGNoJTVFNDgpJTJDY2glM0RnZXRjaGFyKCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjByZXR1cm4lMjBmbGFnJTNGeCUzRC14JTNBeCUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRlbXBsYXRlJTNDdHlwZW5hbWUlMjB0eXBlJTNFJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW5saW5lJTIwdm9pZCUyMHdyaXRlKHR5cGUlMjB4KSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHglM0MwJTNGeCUzRC14JTJDcHV0Y2hhcignLScpJTNBMCUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHN0YXRpYyUyMHNob3J0JTIwU3RhY2slNUI1MCU1RCUyQ3RvcCgwKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGRvJTIwU3RhY2slNUIlMkIlMkJ0b3AlNUQlM0R4JTI1MTAlMkN4JTJGJTNEMTAlM0J3aGlsZSh4KSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHdoaWxlKHRvcCklMjBwdXRjaGFyKFN0YWNrJTVCdG9wLS0lNUQlN0M0OCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbmxpbmUlMjBjaGFyJTIwcmVhZChjaGFyJTIwJTI2eCklN0JkbyUyMHglM0RnZXRjaGFyKCklM0J3aGlsZShpc3NwYWNlKHgpKSUzQnJldHVybiUyMHglM0IlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbmxpbmUlMjBjaGFyJTIwd3JpdGUoY29uc3QlMjBjaGFyJTIwJTI2eCklN0JyZXR1cm4lMjBwdXRjaGFyKHgpJTNCJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW5saW5lJTIwdm9pZCUyMHJlYWQoY2hhciUyMCp4KSU3QnN0YXRpYyUyMGNoYXIlMjBjaCUzQnJlYWQoY2gpJTNCZG8lMjAqKHglMkIlMkIpJTNEY2glM0J3aGlsZSghaXNzcGFjZShjaCUzRGdldGNoYXIoKSklMjYlMjZ+Y2gpJTNCJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdGVtcGxhdGUlM0N0eXBlbmFtZSUyMHR5cGUlM0VpbmxpbmUlMjB2b2lkJTIwd3JpdGUodHlwZSUyMCp4KSU3QndoaWxlKCp4KXB1dGNoYXIoKih4JTJCJTJCKSklM0IlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbmxpbmUlMjB2b2lkJTIwcmVhZChzdHJpbmclMjAlMjZ4KSU3QnN0YXRpYyUyMGNoYXIlMjBjaCUzQnJlYWQoY2gpJTJDeC5jbGVhcigpJTNCZG8lMjB4JTJCJTNEY2glM0J3aGlsZSghaXNzcGFjZShjaCUzRGdldGNoYXIoKSklMjYlMjZ+Y2gpJTNCJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW5saW5lJTIwdm9pZCUyMHdyaXRlKGNvbnN0JTIwc3RyaW5nJTIwJTI2eCklN0Jmb3IoaW50JTIwaSUzRDAlMkNsZW4lM0R4Lmxlbmd0aCgpJTNCaSUzQ2xlbiUzQiUyQiUyQmkpcHV0Y2hhcih4JTVCaSU1RCklM0IlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB0ZW1wbGF0ZSUzQ3R5cGVuYW1lJTIwdHlwZSUyQ3R5cGVuYW1lLi4uVCUzRWlubGluZSUyMHZvaWQlMjByZWFkKHR5cGUlMjAlMjZ4JTJDVCUyNi4uLnkpJTdCcmVhZCh4KSUyQ3JlYWQoeS4uLiklM0IlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB0ZW1wbGF0ZSUzQ3R5cGVuYW1lJTIwdHlwZSUyQ3R5cGVuYW1lLi4uVCUzRSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlubGluZSUyMHZvaWQlMjB3cml0ZShjb25zdCUyMHR5cGUlMjAlMjZ4JTJDY29uc3QlMjBUJTI2Li4ueSklN0J3cml0ZSh4KSUyQ3B1dGNoYXIoJyUyMCcpJTJDd3JpdGUoeS4uLiklMkNzaXplb2YuLi4oeSklNUUxJTNGMCUzQXB1dGNoYXIoJyU1Q24nKSUzQiU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRlbXBsYXRlJTNDdHlwZW5hbWUlMjB0eXBlJTNFJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW5saW5lJTIwdm9pZCUyMHB1dChjb25zdCUyMHR5cGUlMjAlMjZ4JTJDYm9vbCUyMGZsYWclM0QxKSU3QndyaXRlKHgpJTJDZmxhZyUzRnB1dGNoYXIoJyU1Q24nKSUzQXB1dGNoYXIoJyUyMCcpJTNCJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzaWZuZGVmJTIwTE9DQUwlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjN1bmRlZiUyMGdldGNoYXIlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjN1bmRlZiUyMGZsdXNoJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzdW5kZWYlMjBwdXRjaGFyJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzZW5kaWYlMEElMjAlMjAlMjAlMjAlN0R1c2luZyUyMG5hbWVzcGFjZSUyMElPJTNBJTNBdXNyJTNCJTBBJTdEdXNpbmclMjBuYW1lc3BhY2UlMjBseSUzQSUzQUlPJTNBJTNBdXNyJTNCJTBBJTBBdHlwZWRlZiUyMHBhaXIlM0NpbnQlMkNpbnQlM0UlMjBwaWklM0IlMEFpbnQlMjBuJTJDbSUyQ2luJTVCXyU1RCUzQiUwQXN0cnVjdCUyME5vZGUlN0JpbnQlMjBteCUyQ2UlM0IlN0QlMjB0cmVlJTVCXyUzQyUzQzIlNUQlM0IlMEF2b2lkJTIwcHVzaHVwKGludCUyMGspJTdCJTBBJTIwJTIwJTIwJTIwbnQuZSUzRGx0LmUlN0NydC5lJTNCJTBBJTIwJTIwJTIwJTIwbnQubXglM0RtYXgobHQubXglMkNydC5teCklM0IlMEElN0QlMEF2b2lkJTIwYnVpbGQoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByKSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0QlM0RyKSUyMHJldHVybiUyMG50LmUlM0RudC5teCUzRGluJTVCbCU1RCUyQ3ZvaWQoKSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMG1pZCUzRChsJTJCciklM0UlM0UxJTNCJTBBJTIwJTIwJTIwJTIwYnVpbGQobHMoayklMkNsJTJDbWlkKSUzQiUwQSUyMCUyMCUyMCUyMGJ1aWxkKHJzKGspJTJDbWlkJTJCMSUyQ3IpJTNCJTBBJTIwJTIwJTIwJTIwcHVzaHVwKGspJTNCJTBBJTdEJTBBdm9pZCUyMG1vZGlmeShpbnQlMjBrJTJDaW50JTIwbCUyQ2ludCUyMHIlMkNpbnQlMjB4JTJDaW50JTIweSUyQ2ludCUyMHYpJTdCJTBBJTIwJTIwJTIwJTIwaWYoKG50LmUlMjZ2KSUzRCUzRG50LmUpJTIwcmV0dXJuJTNCJTBBJTIwJTIwJTIwJTIwaWYobCUzRCUzRHIpJTIwcmV0dXJuJTIwbnQubXglMjYlM0R2JTJDbnQuZSUyNiUzRHYlMkN2b2lkKCklM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwbW9kaWZ5KGxzKGspJTJDbCUyQ21pZCUyQ3glMkN5JTJDdiklM0IlMEElMjAlMjAlMjAlMjBpZih5JTNFbWlkKSUyMG1vZGlmeShycyhrKSUyQ21pZCUyQjElMkNyJTJDeCUyQ3klMkN2KSUzQiUwQSUyMCUyMCUyMCUyMHB1c2h1cChrKSUzQiUwQSU3RCUwQXZvaWQlMjBjaGFuZ2UoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHYpJTdCJTBBJTIwJTIwJTIwJTIwaWYobCUzRCUzRHIpJTIwcmV0dXJuJTIwbnQubXglM0R2JTJDbnQuZSUzRHYlMkN2b2lkKCklM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwY2hhbmdlKGxzKGspJTJDbCUyQ21pZCUyQ3glMkN2KSUzQiUwQSUyMCUyMCUyMCUyMGVsc2UlMjBjaGFuZ2UocnMoayklMkNtaWQlMkIxJTJDciUyQ3glMkN2KSUzQiUwQSUyMCUyMCUyMCUyMHB1c2h1cChrKSUzQiUwQSU3RCUwQWludCUyMHF1ZXJ5KGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciUyQ2ludCUyMHglMkNpbnQlMjB5KSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHkpJTIwcmV0dXJuJTIwbnQubXglM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUyQ3JlcyUzRC1pbmYlM0IlMEElMjAlMjAlMjAlMjBpZih4JTNDJTNEbWlkKSUyMHJlcyUzRG1heChyZXMlMkNxdWVyeShscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSkpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeSUzRW1pZCklMjByZXMlM0RtYXgocmVzJTJDcXVlcnkocnMoayklMkNtaWQlMkIxJTJDciUyQ3glMkN5KSklM0IlMEElMjAlMjAlMjAlMjByZXR1cm4lMjByZXMlM0IlMEElN0QlMEFpbmxpbmUlMjB2b2lkJTIwc3VidGFzaygpJTdCJTBBJTIwJTIwJTIwJTIwcmVhZChuJTJDbSklM0IlMEElMjAlMjAlMjAlMjBmb3IoaW50JTIwaSUzRDElM0JpJTNDJTNEbiUzQmklMkIlMkIpJTIwcmVhZChpbiU1QmklNUQpJTNCJTBBJTIwJTIwJTIwJTIwYnVpbGQoMSUyQzElMkNuKSUzQiUwQSUyMCUyMCUyMCUyMHdoaWxlKG0tLSklN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBjaGFyJTIwb3AlNUI0JTVEJTNCaW50JTIweCUyQ3klMkN6JTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwcmVhZChvcCUyQ3glMkN5KSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKG9wJTVCMCU1RCUzRCUzRCdBJyklMjByZWFkKHopJTJDbW9kaWZ5KDElMkMxJTJDbiUyQ3glMkN5JTJDeiklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBlbHNlJTIwaWYob3AlNUIwJTVEJTNEJTNEJ1UnKSUyMGNoYW5nZSgxJTJDMSUyQ24lMkN4JTJDeSklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBlbHNlJTIwaWYob3AlNUIwJTVEJTNEJTNEJ1EnKSUyMHB1dChxdWVyeSgxJTJDMSUyQ24lMkN4JTJDeSkpJTNCJTBBJTIwJTIwJTIwJTIwJTdEJTBBJTdEJTBBc2lnbmVkJTIwbWFpbigpJTdCJTBBJTIwJTIwJTIwJTIwJTJGJTJGaW9zJTNBJTNBc3luY193aXRoX3N0ZGlvKGZhbHNlKSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMHQlM0QxJTNCJTJGJTJGY2luJTNFJTNFdCUzQiUwQSUyMCUyMCUyMCUyMHdoaWxlKHQtLSklMjBzdWJ0YXNrKCklM0IlMEElMjAlMjAlMjAlMjByZXR1cm4lMjAwJTNCJTBBJTdEJTBB"><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div><div>63</div><div>64</div><div>65</div><div>66</div><div>67</div><div>68</div><div>69</div><div>70</div><div>71</div><div>72</div><div>73</div><div>74</div><div>75</div><div>76</div><div>77</div><div>78</div><div>79</div><div>80</div><div>81</div><div>82</div><div>83</div><div>84</div><div>85</div><div>86</div><div>87</div><div>88</div><div>89</div><div>90</div><div>91</div><div>92</div><div>93</div><div>94</div><div>95</div><div>96</div><div>97</div><div>98</div><div>99</div><div>100</div><div>101</div><div>102</div><div>103</div><div>104</div><div>105</div><div>106</div><div>107</div><div>108</div><div>109</div><div>110</div><div>111</div><div>112</div><div>113</div><div>114</div><div>115</div><div>116</div><div>117</div></div><div class="code"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ls(k) (k)&lt;&lt;1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rs(k) (k)&lt;&lt;1|1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> nt tree[k]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> lt tree[ls(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rt tree[rs(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ 400005</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> debug(x) cout&lt;&lt;#x&lt;&lt;<span class="hljs-string">&quot;=&quot;</span>&lt;&lt;x&lt;&lt;endl</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> inf=<span class="hljs-number">0x3f3f3f3f3f3f3f3f</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mod=<span class="hljs-number">0</span>;
<span class="hljs-meta">#<span class="hljs-keyword">define</span> LOCAL</span>
<span class="hljs-keyword">namespace</span> ly
{
    <span class="hljs-keyword">namespace</span> IO
    {
        <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> LOCAL</span>
            <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> maxn=<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">20</span>;
            <span class="hljs-type">char</span> in[maxn],out[maxn],*p1=in,*p2=in,*p3=out;
            <span class="hljs-meta">#<span class="hljs-keyword">define</span> getchar() (p1==p2&amp;&amp;(p2=(p1=in)+fread(in,1,maxn,stdin),p1==p2)?EOF:*p1++)</span>
            <span class="hljs-meta">#<span class="hljs-keyword">define</span> flush() (fwrite(out,1,p3-out,stdout))</span>
            <span class="hljs-meta">#<span class="hljs-keyword">define</span> putchar(x) (p3==out+maxn&amp;&amp;(flush(),p3=out),*p3++=(x))</span>
            <span class="hljs-keyword">class</span> <span class="hljs-title class_">Flush</span>{<span class="hljs-keyword">public</span>:~<span class="hljs-built_in">Flush</span>(){<span class="hljs-built_in">flush</span>();}}_;
        <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
        <span class="hljs-keyword">namespace</span> usr
        {
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;
            <span class="hljs-keyword">inline</span> type <span class="hljs-title">read</span><span class="hljs-params">(type &amp;x)</span>
            </span>{
                x=<span class="hljs-number">0</span>;<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">flag</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;<span class="hljs-type">char</span> ch=<span class="hljs-built_in">getchar</span>();
                <span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isdigit</span>(ch)) flag^=ch==<span class="hljs-string">&#x27;-&#x27;</span>,ch=<span class="hljs-built_in">getchar</span>();
                <span class="hljs-keyword">while</span>(<span class="hljs-built_in">isdigit</span>(ch)) x=(x&lt;&lt;<span class="hljs-number">1</span>)+(x&lt;&lt;<span class="hljs-number">3</span>)+(ch^<span class="hljs-number">48</span>),ch=<span class="hljs-built_in">getchar</span>();
                <span class="hljs-keyword">return</span> flag?x=-x:x;
            }
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;
            <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(type x)</span>
            </span>{
                x&lt;<span class="hljs-number">0</span>?x=-x,<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;-&#x27;</span>):<span class="hljs-number">0</span>;
                <span class="hljs-type">static</span> <span class="hljs-type">short</span> Stack[<span class="hljs-number">50</span>],<span class="hljs-built_in">top</span>(<span class="hljs-number">0</span>);
                <span class="hljs-keyword">do</span> Stack[++top]=x%<span class="hljs-number">10</span>,x/=<span class="hljs-number">10</span>;<span class="hljs-keyword">while</span>(x);
                <span class="hljs-keyword">while</span>(top) <span class="hljs-built_in">putchar</span>(Stack[top--]|<span class="hljs-number">48</span>);
            }
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">char</span> <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-type">char</span> &amp;x)</span></span>{<span class="hljs-keyword">do</span> x=<span class="hljs-built_in">getchar</span>();<span class="hljs-keyword">while</span>(<span class="hljs-built_in">isspace</span>(x));<span class="hljs-keyword">return</span> x;}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">char</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> &amp;x)</span></span>{<span class="hljs-keyword">return</span> <span class="hljs-built_in">putchar</span>(x);}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-type">char</span> *x)</span></span>{<span class="hljs-type">static</span> <span class="hljs-type">char</span> ch;<span class="hljs-built_in">read</span>(ch);<span class="hljs-keyword">do</span> *(x++)=ch;<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isspace</span>(ch=<span class="hljs-built_in">getchar</span>())&amp;&amp;~ch);}
            <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(type *x)</span></span>{<span class="hljs-keyword">while</span>(*x)<span class="hljs-built_in">putchar</span>(*(x++));}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">read</span><span class="hljs-params">(string &amp;x)</span></span>{<span class="hljs-type">static</span> <span class="hljs-type">char</span> ch;<span class="hljs-built_in">read</span>(ch),x.<span class="hljs-built_in">clear</span>();<span class="hljs-keyword">do</span> x+=ch;<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isspace</span>(ch=<span class="hljs-built_in">getchar</span>())&amp;&amp;~ch);}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">const</span> string &amp;x)</span></span>{<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>,len=x.<span class="hljs-built_in">length</span>();i&lt;len;++i)<span class="hljs-built_in">putchar</span>(x[i]);}
            <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type,<span class="hljs-keyword">typename</span>...T&gt;<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">read</span><span class="hljs-params">(type &amp;x,T&amp;...y)</span></span>{<span class="hljs-built_in">read</span>(x),<span class="hljs-built_in">read</span>(y...);}
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type,<span class="hljs-keyword">typename</span>...T&gt;
            <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">const</span> type &amp;x,<span class="hljs-type">const</span> T&amp;...y)</span></span>{<span class="hljs-built_in">write</span>(x),<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27; &#x27;</span>),<span class="hljs-built_in">write</span>(y...),<span class="hljs-keyword">sizeof</span>...(y)^<span class="hljs-number">1</span>?<span class="hljs-number">0</span>:<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);}
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;
            <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">put</span><span class="hljs-params">(<span class="hljs-type">const</span> type &amp;x,<span class="hljs-type">bool</span> flag=<span class="hljs-number">1</span>)</span></span>{<span class="hljs-built_in">write</span>(x),flag?<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>):<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27; &#x27;</span>);}
        }
        <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> LOCAL</span>
            <span class="hljs-meta">#<span class="hljs-keyword">undef</span> getchar</span>
            <span class="hljs-meta">#<span class="hljs-keyword">undef</span> flush</span>
            <span class="hljs-meta">#<span class="hljs-keyword">undef</span> putchar</span>
        <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
    }<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> IO::usr;
}<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> ly::IO::usr;

<span class="hljs-keyword">typedef</span> pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; pii;
<span class="hljs-type">int</span> n,m,in[_];
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>{<span class="hljs-type">int</span> mx,e;} tree[_&lt;&lt;<span class="hljs-number">2</span>];
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
    nt.e=lt.e|rt.e;
    nt.mx=<span class="hljs-built_in">max</span>(lt.mx,rt.mx);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>{
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.e=nt.mx=in[l],<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">ls</span>(k),l,mid);
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>((nt.e&amp;v)==nt.e) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.mx&amp;=v,nt.e&amp;=v,<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y,v);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">change</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.mx=v,nt.e=v,<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">change</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,v);
    <span class="hljs-keyword">else</span> <span class="hljs-built_in">change</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.mx;
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=-inf;
    <span class="hljs-keyword">if</span>(x&lt;=mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y));
    <span class="hljs-keyword">if</span>(y&gt;mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y));
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">subtask</span><span class="hljs-params">()</span></span>{
    <span class="hljs-built_in">read</span>(n,m);
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) <span class="hljs-built_in">read</span>(in[i]);
    <span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);
    <span class="hljs-keyword">while</span>(m--){
        <span class="hljs-type">char</span> op[<span class="hljs-number">4</span>];<span class="hljs-type">int</span> x,y,z;
        <span class="hljs-built_in">read</span>(op,x,y);
        <span class="hljs-keyword">if</span>(op[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;A&#x27;</span>) <span class="hljs-built_in">read</span>(z),<span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,x,y,z);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(op[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;U&#x27;</span>) <span class="hljs-built_in">change</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,x,y);
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(op[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;Q&#x27;</span>) <span class="hljs-built_in">put</span>(<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,x,y));
    }
}
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">//ios::sync_with_stdio(false);</span>
    <span class="hljs-type">int</span> t=<span class="hljs-number">1</span>;<span class="hljs-comment">//cin&gt;&gt;t;</span>
    <span class="hljs-keyword">while</span>(t--) <span class="hljs-built_in">subtask</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<div class="alert alert-warn"><div class="icon"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M12 5.99L19.53 19H4.47L12 5.99M12 2L1 21h22L12 2zm1 14h-2v2h2v-2zm0-6h-2v4h2v-4z"></path></svg></div><div class="message"><div class="title"> 踩坑</div><p>modify 函数那里要写成 <code>if((nt.e&amp;v)==nt.e) return;</code> 而不是 <code>if(nt.e&amp;v==nt.e) return;</code> ！</p>
</div></div>
<h3 id="counting-stars" tabindex="-1">Counting Stars</h3>
<p><a href="https://vjudge.net/problem/HDU-7059">https://vjudge.net/problem/HDU-7059</a></p>
<p><strong>题目描述</strong></p>
<p>给定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 个数，三种操作：</p>
<ol>
<li>询问区间和</li>
<li>将区间内所有数的 lowbit 置为 0</li>
<li>将区间内所有数的 highbit 左移一位</li>
</ol>
<p><strong>数据范围</strong></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mo>∑</mo><mi>n</mi><mo separator="true">,</mo><mo>∑</mo><mi>q</mi><mo>≤</mo><mn>4</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding="application/x-tex">1\le \sum n, \sum q \le 4\times 10^5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span>，且 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><msub><mi>a</mi><mi>i</mi></msub><mo>≤</mo><msup><mn>10</mn><mn>9</mn></msup></mrow><annotation encoding="application/x-tex">1\le a_i \le 10^9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.786em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>笔记</strong></p>
<p>对于操作 2 和 操作 3 都不会增加数字二进制 1 的个数，且操作 2 还会减少二进制 1 的个数，所以对于操作 2 我们可以考虑暴力。但注意，操作 3 也暴力的话时间复杂度就不对了，因为操作 3 并不会减少二进制 1 的个数。我们考虑能不能通过懒标记来优化。</p>
<p>我们把一个数的最高位和其他位分开，即 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>=</mo><mi>h</mi><mi>i</mi><mi>g</mi><mi>h</mi><mo>+</mo><mi>l</mi><mi>o</mi><mi>w</mi></mrow><annotation encoding="application/x-tex">x=high+low</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">hi</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">h</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span></span></span></span>，然后操作 3 就相当于把区间内所有的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>i</mi><mi>g</mi><mi>h</mi></mrow><annotation encoding="application/x-tex">high</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">hi</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">h</span></span></span></span> 都乘 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span>，这就可以使用懒标记了</p>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTJGJTJGJTIzcHJhZ21hJTIwR0NDJTIwb3B0aW1pemUoMyUyQyUyMk9mYXN0JTIyJTJDJTIyaW5saW5lJTIyKSUwQSUyM2luY2x1ZGUlM0NiaXRzJTJGc3RkYyUyQiUyQi5oJTNFJTBBJTIzZGVmaW5lJTIwaW50JTIwbG9uZyUyMGxvbmclMEElMjNkZWZpbmUlMjB1bGwlMjB1bnNpZ25lZCUyMGxvbmclMjBsb25nJTBBJTIzZGVmaW5lJTIwbHMoayklMjAoayklM0MlM0MxJTBBJTIzZGVmaW5lJTIwcnMoayklMjAoayklM0MlM0MxJTdDMSUwQSUyM2RlZmluZSUyMG50JTIwdHJlZSU1QmslNUQlMEElMjNkZWZpbmUlMjBsdCUyMHRyZWUlNUJscyhrKSU1RCUwQSUyM2RlZmluZSUyMHJ0JTIwdHJlZSU1QnJzKGspJTVEJTBBJTIzZGVmaW5lJTIwZGVidWcoeCklMjBjb3V0JTNDJTNDJTIzeCUzQyUzQyUyMiUzRCUyMiUzQyUzQ3glM0MlM0NlbmRsJTBBdXNpbmclMjBuYW1lc3BhY2UlMjBzdGQlM0IlMEFjb25zdCUyMGludCUyMGluZiUzRDB4M2YzZjNmM2YzZjNmM2YzZiUzQiUwQWNvbnN0JTIwaW50JTIwbW9kJTNEOTk4MjQ0MzUzJTNCJTBBdHlwZWRlZiUyMHBhaXIlM0NpbnQlMkNpbnQlM0UlMjBwaWklM0IlMEElMjNkZWZpbmUlMjBfJTIwMTAwMDA1JTBBc3RydWN0JTIwTm9kZSU3QmludCUyMGhpZ2glMkNsb3clMkN0YWclM0IlN0QlMjB0cmVlJTVCXyUzQyUzQzIlNUQlM0IlMEFpbnQlMjBpbiU1Ql8lNUQlMkNwdyU1Ql8lNUQlM0IlMEFpbmxpbmUlMjBpbnQlMjBsb3diaXQoaW50JTIweCklN0JyZXR1cm4lMjB4JTI2LXglM0IlN0QlMEFpbmxpbmUlMjB2b2lkJTIwcHVzaHVwKGludCUyMGspJTdCbnQuaGlnaCUzRChsdC5oaWdoJTJCcnQuaGlnaCklMjVtb2QlM0JudC5sb3clM0QobHQubG93JTJCcnQubG93KSUyNW1vZCUzQiU3RCUwQWlubGluZSUyMHZvaWQlMjBwdXNoZG93bihpbnQlMjBrKSU3QiUwQSUyMCUyMCUyMCUyMGlmKCFudC50YWcpJTIwcmV0dXJuJTNCJTBBJTIwJTIwJTIwJTIwbHQuaGlnaCUzRGx0LmhpZ2gqcHclNUJudC50YWclNUQlMjVtb2QlM0IlMEElMjAlMjAlMjAlMjBydC5oaWdoJTNEcnQuaGlnaCpwdyU1Qm50LnRhZyU1RCUyNW1vZCUzQiUwQSUyMCUyMCUyMCUyMGx0LnRhZyUyQiUzRG50LnRhZyUzQiUwQSUyMCUyMCUyMCUyMHJ0LnRhZyUyQiUzRG50LnRhZyUzQiUwQSUyMCUyMCUyMCUyMG50LnRhZyUzRDAlM0IlMEElN0QlMEF2b2lkJTIwYnVpbGQoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByKSU3QiUwQSUyMCUyMCUyMCUyMG50LnRhZyUzRDAlM0IlMEElMjAlMjAlMjAlMjBpZihsJTNEJTNEciklN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbnQlMjBub3clM0QwJTJDeCUzRGluJTVCbCU1RCUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHdoaWxlKHgpJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYoeCUyNjEpJTIwbnQuaGlnaCUzRG5vdyUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHglM0UlM0UlM0QxJTNCbm93JTJCJTJCJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwbnQuaGlnaCUzRHB3JTVCbnQuaGlnaCU1RCUzQm50LmxvdyUzRGluJTVCbCU1RC1udC5oaWdoJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwbnQudGFnJTNEMCUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHJldHVybiUzQiUwQSUyMCUyMCUyMCUyMCU3RCUwQSUyMCUyMCUyMCUyMGludCUyMG1pZCUzRChsJTJCciklM0UlM0UxJTNCJTBBJTIwJTIwJTIwJTIwYnVpbGQobHMoayklMkNsJTJDbWlkKSUzQiUwQSUyMCUyMCUyMCUyMGJ1aWxkKHJzKGspJTJDbWlkJTJCMSUyQ3IpJTNCJTBBJTIwJTIwJTIwJTIwcHVzaHVwKGspJTNCJTBBJTdEJTBBaW50JTIwcXVlcnkoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHkpJTdCJTBBJTIwJTIwJTIwJTIwaWYobCUzRSUzRHglMjYlMjZyJTNDJTNEeSklMjByZXR1cm4lMjAobnQubG93JTJCbnQuaGlnaCklMjVtb2QlM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUyQ3JlcyUzRDAlM0IlMEElMjAlMjAlMjAlMjBwdXNoZG93bihrKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwcmVzJTJCJTNEcXVlcnkobHMoayklMkNsJTJDbWlkJTJDeCUyQ3kpJTJDcmVzJTI1JTNEbW9kJTNCJTBBJTIwJTIwJTIwJTIwaWYoeSUzRW1pZCklMjByZXMlMkIlM0RxdWVyeShycyhrKSUyQ21pZCUyQjElMkNyJTJDeCUyQ3kpJTJDcmVzJTI1JTNEbW9kJTNCJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwcmVzJTNCJTBBJTdEJTBBdm9pZCUyMG1vZGlmeV9sb3diaXQoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHkpJTdCJTBBJTIwJTIwJTIwJTIwaWYoIW50LmhpZ2glMjYlMjYhbnQubG93KSUyMHJldHVybiUyMHZvaWQoKSUzQiUwQSUyMCUyMCUyMCUyMGlmKGwlM0QlM0RyKSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKG50LmxvdyklMjBudC5sb3ctJTNEbG93Yml0KG50LmxvdyklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBlbHNlJTIwbnQuaGlnaCUzRDAlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjByZXR1cm4lM0IlMEElMjAlMjAlMjAlMjAlN0QlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUzQiUwQSUyMCUyMCUyMCUyMHB1c2hkb3duKGspJTNCJTBBJTIwJTIwJTIwJTIwaWYoeCUzQyUzRG1pZCklMjBtb2RpZnlfbG93Yml0KGxzKGspJTJDbCUyQ21pZCUyQ3glMkN5KSUzQiUwQSUyMCUyMCUyMCUyMGlmKHklM0VtaWQpJTIwbW9kaWZ5X2xvd2JpdChycyhrKSUyQ21pZCUyQjElMkNyJTJDeCUyQ3kpJTNCJTBBJTIwJTIwJTIwJTIwcHVzaHVwKGspJTNCJTBBJTdEJTBBdm9pZCUyMG1vZGlmeV9oaWdoYml0KGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciUyQ2ludCUyMHglMkNpbnQlMjB5KSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHkpJTIwcmV0dXJuJTIwbnQuaGlnaCUzRG50LmhpZ2gqMiUyNW1vZCUyQ250LnRhZyUyQiUyQiUyQ3ZvaWQoKSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMG1pZCUzRChsJTJCciklM0UlM0UxJTNCJTBBJTIwJTIwJTIwJTIwcHVzaGRvd24oayklM0IlMEElMjAlMjAlMjAlMjBpZih4JTNDJTNEbWlkKSUyMG1vZGlmeV9oaWdoYml0KGxzKGspJTJDbCUyQ21pZCUyQ3glMkN5KSUzQiUwQSUyMCUyMCUyMCUyMGlmKHklM0VtaWQpJTIwbW9kaWZ5X2hpZ2hiaXQocnMoayklMkNtaWQlMkIxJTJDciUyQ3glMkN5KSUzQiUwQSUyMCUyMCUyMCUyMHB1c2h1cChrKSUzQiUwQSU3RCUwQWlubGluZSUyMHZvaWQlMjBzdWJ0YXNrKCklN0IlMEElMjAlMjAlMjAlMjBpbnQlMjBuJTNCY2luJTNFJTNFbiUzQiUwQSUyMCUyMCUyMCUyMGZvcihpbnQlMjBpJTNEMSUzQmklM0MlM0RuJTNCaSUyQiUyQiklMjBjaW4lM0UlM0VpbiU1QmklNUQlM0IlMEElMjAlMjAlMjAlMjBidWlsZCgxJTJDMSUyQ24pJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbSUzQmNpbiUzRSUzRW0lM0IlMEElMjAlMjAlMjAlMjB3aGlsZShtLS0pJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW50JTIwb3AlMkNsJTJDciUzQmNpbiUzRSUzRW9wJTNFJTNFbCUzRSUzRXIlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCUzRCUzRDEpJTIwY291dCUzQyUzQ3F1ZXJ5KDElMkMxJTJDbiUyQ2wlMkNyKSUzQyUzQ2VuZGwlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCUzRCUzRDIpJTIwbW9kaWZ5X2xvd2JpdCgxJTJDMSUyQ24lMkNsJTJDciklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCUzRCUzRDMpJTIwbW9kaWZ5X2hpZ2hiaXQoMSUyQzElMkNuJTJDbCUyQ3IpJTNCJTBBJTIwJTIwJTIwJTIwJTdEJTBBJTdEJTBBc2lnbmVkJTIwbWFpbigpJTdCJTBBJTIwJTIwJTIwJTIwcHclNUIwJTVEJTNEMSUzQiUwQSUyMCUyMCUyMCUyMGZvcihpbnQlMjBpJTNEMSUzQmklM0MlM0QxMDAwMDAlM0JpJTJCJTJCKSUyMHB3JTVCaSU1RCUzRHB3JTVCaS0xJTVEKjIlMjVtb2QlM0IlMEElMjAlMjAlMjAlMjBpb3MlM0ElM0FzeW5jX3dpdGhfc3RkaW8oZmFsc2UpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwdCUzQmNpbiUzRSUzRXQlM0IlMEElMjAlMjAlMjAlMjB3aGlsZSh0LS0pJTIwc3VidGFzaygpJTNCJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwMCUzQiUwQSU3RCUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div><div>63</div><div>64</div><div>65</div><div>66</div><div>67</div><div>68</div><div>69</div><div>70</div><div>71</div><div>72</div><div>73</div><div>74</div><div>75</div><div>76</div><div>77</div><div>78</div><div>79</div><div>80</div><div>81</div><div>82</div><div>83</div><div>84</div><div>85</div><div>86</div><div>87</div><div>88</div><div>89</div><div>90</div><div>91</div><div>92</div><div>93</div></div><div class="code"><span class="hljs-comment">//#pragma GCC optimize(3,&quot;Ofast&quot;,&quot;inline&quot;)</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ls(k) (k)&lt;&lt;1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rs(k) (k)&lt;&lt;1|1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> nt tree[k]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> lt tree[ls(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rt tree[rs(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> debug(x) cout&lt;&lt;#x&lt;&lt;<span class="hljs-string">&quot;=&quot;</span>&lt;&lt;x&lt;&lt;endl</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> inf=<span class="hljs-number">0x3f3f3f3f3f3f3f3f</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mod=<span class="hljs-number">998244353</span>;
<span class="hljs-keyword">typedef</span> pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; pii;
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ 100005</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>{<span class="hljs-type">int</span> high,low,tag;} tree[_&lt;&lt;<span class="hljs-number">2</span>];
<span class="hljs-type">int</span> in[_],pw[_];
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">lowbit</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>{<span class="hljs-keyword">return</span> x&amp;-x;}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{nt.high=(lt.high+rt.high)%mod;nt.low=(lt.low+rt.low)%mod;}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
    <span class="hljs-keyword">if</span>(!nt.tag) <span class="hljs-keyword">return</span>;
    lt.high=lt.high*pw[nt.tag]%mod;
    rt.high=rt.high*pw[nt.tag]%mod;
    lt.tag+=nt.tag;
    rt.tag+=nt.tag;
    nt.tag=<span class="hljs-number">0</span>;
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>{
    nt.tag=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(l==r){
        <span class="hljs-type">int</span> now=<span class="hljs-number">0</span>,x=in[l];
        <span class="hljs-keyword">while</span>(x){
            <span class="hljs-keyword">if</span>(x&amp;<span class="hljs-number">1</span>) nt.high=now;
            x&gt;&gt;=<span class="hljs-number">1</span>;now++;
        }
        nt.high=pw[nt.high];nt.low=in[l]-nt.high;
        nt.tag=<span class="hljs-number">0</span>;
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">ls</span>(k),l,mid);
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> (nt.low+nt.high)%mod;
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=<span class="hljs-number">0</span>;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-keyword">if</span>(x&lt;=mid) res+=<span class="hljs-built_in">query</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y),res%=mod;
    <span class="hljs-keyword">if</span>(y&gt;mid) res+=<span class="hljs-built_in">query</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y),res%=mod;
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify_lowbit</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(!nt.high&amp;&amp;!nt.low) <span class="hljs-keyword">return</span> <span class="hljs-built_in">void</span>();
    <span class="hljs-keyword">if</span>(l==r){
        <span class="hljs-keyword">if</span>(nt.low) nt.low-=<span class="hljs-built_in">lowbit</span>(nt.low);
        <span class="hljs-keyword">else</span> nt.high=<span class="hljs-number">0</span>;
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify_lowbit</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify_lowbit</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify_highbit</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.high=nt.high*<span class="hljs-number">2</span>%mod,nt.tag++,<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify_highbit</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify_highbit</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">subtask</span><span class="hljs-params">()</span></span>{
    <span class="hljs-type">int</span> n;cin&gt;&gt;n;
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) cin&gt;&gt;in[i];
    <span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);
    <span class="hljs-type">int</span> m;cin&gt;&gt;m;
    <span class="hljs-keyword">while</span>(m--){
        <span class="hljs-type">int</span> op,l,r;cin&gt;&gt;op&gt;&gt;l&gt;&gt;r;
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>) cout&lt;&lt;<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r)&lt;&lt;endl;
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">2</span>) <span class="hljs-built_in">modify_lowbit</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">3</span>) <span class="hljs-built_in">modify_highbit</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r);
    }
}
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    pw[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">100000</span>;i++) pw[i]=pw[i<span class="hljs-number">-1</span>]*<span class="hljs-number">2</span>%mod;
    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-type">int</span> t;cin&gt;&gt;t;
    <span class="hljs-keyword">while</span>(t--) <span class="hljs-built_in">subtask</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<div class="alert alert-warn"><div class="icon"><svg focusable="false" aria-hidden="true" viewBox="0 0 24 24"><path d="M12 5.99L19.53 19H4.47L12 5.99M12 2L1 21h22L12 2zm1 14h-2v2h2v-2zm0-6h-2v4h2v-4z"></path></svg></div><div class="message"><div class="title"> 踩坑</div><p>一开始 build 函数那里忘记把 tag 清空了，wa了好几次</p>
</div></div>
<h3 id="lowbit" tabindex="-1">Lowbit</h3>
<p><a href="https://vjudge.net/problem/HDU-7116">https://vjudge.net/problem/HDU-7116</a></p>
<p><strong>题目描述</strong></p>
<p>给定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 个数，两种操作：</p>
<ol>
<li>区间内每个数都加上自身的 lowbit</li>
<li>询问区间和</li>
</ol>
<p><strong>数据范围</strong></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo>≤</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding="application/x-tex">1\le n,m \le 10^5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>笔记</strong></p>
<p>我们发现，一个数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 加上 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi><mi>o</mi><mi>w</mi><mi>b</mi><mi>i</mi><mi>t</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">lowbit(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">bi</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> ，那么这个数的二进制 1 数量要么减少要么不变。如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 的二进制 1 数量为 1 了，那么 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>+</mo><mi>l</mi><mi>o</mi><mi>w</mi><mi>b</mi><mi>i</mi><mi>t</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">x+lowbit(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="mord mathnormal">bi</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> 就相当于对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 乘二了。</p>
<p>那么就有了做法，区间内所有的数的二进制 1 数量都为 1 了，那么就相当于区间乘 2 ，使用懒标记。反之，暴力修改</p>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTIzaW5jbHVkZSUzQ2JpdHMlMkZzdGRjJTJCJTJCLmglM0UlMEElMjNkZWZpbmUlMjBpbnQlMjBsb25nJTIwbG9uZyUwQSUyM2RlZmluZSUyMHVsbCUyMHVuc2lnbmVkJTIwbG9uZyUyMGxvbmclMEElMjNkZWZpbmUlMjBscyhrKSUyMChrKSUzQyUzQzElMEElMjNkZWZpbmUlMjBycyhrKSUyMChrKSUzQyUzQzElN0MxJTBBJTIzZGVmaW5lJTIwbnQlMjB0cmVlJTVCayU1RCUwQSUyM2RlZmluZSUyMGx0JTIwdHJlZSU1QmxzKGspJTVEJTBBJTIzZGVmaW5lJTIwcnQlMjB0cmVlJTVCcnMoayklNUQlMEElMjNkZWZpbmUlMjBkZWJ1Zyh4KSUyMGNvdXQlM0MlM0MlMjN4JTNDJTNDJTIyJTNEJTIyJTNDJTNDeCUzQyUzQ2VuZGwlMEF1c2luZyUyMG5hbWVzcGFjZSUyMHN0ZCUzQiUwQWNvbnN0JTIwaW50JTIwaW5mJTNEMHgzZjNmM2YzZjNmM2YzZjNmJTNCJTBBY29uc3QlMjBpbnQlMjBtb2QlM0Q5OTgyNDQzNTMlM0IlMEF0eXBlZGVmJTIwcGFpciUzQ2ludCUyQ2ludCUzRSUyMHBpaSUzQiUwQSUyM2RlZmluZSUyMF8lMjAxMDAwMDUlMEFzdHJ1Y3QlMjBOb2RlJTdCaW50JTIwc3VtJTJDb2slMkN0YWclM0IlN0QlMjB0cmVlJTVCXyUzQyUzQzIlNUQlM0IlMEFpbnQlMjBpbiU1Ql8lNUQlMkNwdyU1Ql8lNUQlM0IlMEFpbmxpbmUlMjBpbnQlMjBsb3diaXQoaW50JTIweCklN0JyZXR1cm4lMjB4JTI2LXglM0IlN0QlMEFpbmxpbmUlMjBpbnQlMjBwb3BjbnQoaW50JTIweCUyQ2ludCUyMHJlcyUzRDApJTdCZm9yKCUzQnglM0J4JTNFJTNFJTNEMSklMjBpZih4JTI2MSklMjByZXMlMkIlMkIlM0JyZXR1cm4lMjByZXMlM0IlN0QlMEFpbmxpbmUlMjB2b2lkJTIwcHVzaHVwKGludCUyMGspJTdCbnQuc3VtJTNEKGx0LnN1bSUyQnJ0LnN1bSklMjVtb2QlM0JudC5vayUzRGx0Lm9rJTI2cnQub2slM0IlN0QlMEFpbmxpbmUlMjB2b2lkJTIwcHVzaGRvd24oaW50JTIwayklN0IlMEElMjAlMjAlMjAlMjBpZighbnQudGFnKSUyMHJldHVybiUzQiUwQSUyMCUyMCUyMCUyMGx0LnN1bSUzRGx0LnN1bSpwdyU1Qm50LnRhZyU1RCUyNW1vZCUzQiUwQSUyMCUyMCUyMCUyMHJ0LnN1bSUzRHJ0LnN1bSpwdyU1Qm50LnRhZyU1RCUyNW1vZCUzQiUwQSUyMCUyMCUyMCUyMGx0LnRhZyUyQiUzRG50LnRhZyUzQiUwQSUyMCUyMCUyMCUyMHJ0LnRhZyUyQiUzRG50LnRhZyUzQiUwQSUyMCUyMCUyMCUyMG50LnRhZyUzRDAlM0IlMEElN0QlMEF2b2lkJTIwYnVpbGQoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByKSU3QiUwQSUyMCUyMCUyMCUyMG50LnRhZyUzRDAlM0IlMEElMjAlMjAlMjAlMjBpZihsJTNEJTNEciklMjByZXR1cm4lMjBudC5zdW0lM0RpbiU1QmwlNUQlMkNudC5vayUzRHBvcGNudChpbiU1QmwlNUQpJTNEJTNEMSUzRjElM0EwJTJDdm9pZCgpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElM0IlMEElMjAlMjAlMjAlMjBidWlsZChscyhrKSUyQ2wlMkNtaWQpJTNCJTBBJTIwJTIwJTIwJTIwYnVpbGQocnMoayklMkNtaWQlMkIxJTJDciklM0IlMEElMjAlMjAlMjAlMjBwdXNodXAoayklM0IlMEElN0QlMEFpbnQlMjBxdWVyeShpbnQlMjBrJTJDaW50JTIwbCUyQ2ludCUyMHIlMkNpbnQlMjB4JTJDaW50JTIweSklN0IlMEElMjAlMjAlMjAlMjBpZihsJTNFJTNEeCUyNiUyNnIlM0MlM0R5KSUyMHJldHVybiUyMG50LnN1bSUzQiUwQSUyMCUyMCUyMCUyMHB1c2hkb3duKGspJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElMkNyZXMlM0QwJTNCJTBBJTIwJTIwJTIwJTIwaWYoeCUzQyUzRG1pZCklMjByZXMlMkIlM0RxdWVyeShscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSklMkNyZXMlMjUlM0Rtb2QlM0IlMEElMjAlMjAlMjAlMjBpZih5JTNFbWlkKSUyMHJlcyUyQiUzRHF1ZXJ5KHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSklMkNyZXMlMjUlM0Rtb2QlM0IlMEElMjAlMjAlMjAlMjByZXR1cm4lMjByZXMlM0IlMEElN0QlMEF2b2lkJTIwbW9kaWZ5KGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciUyQ2ludCUyMHglMkNpbnQlMjB5KSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHklMjYlMjZudC5vayklMjByZXR1cm4lMjBudC5zdW0lM0RudC5zdW0qMiUyNW1vZCUyQ250LnRhZyUyQiUyQiUyQ3ZvaWQoKSUzQiUwQSUyMCUyMCUyMCUyMGlmKGwlM0QlM0RyKSUyMHJldHVybiUyMG50LnN1bSUyQiUzRGxvd2JpdChudC5zdW0pJTJDbnQub2slM0Rwb3BjbnQobnQuc3VtKSUzRCUzRDElM0YxJTNBMCUyQ3ZvaWQoKSUzQiUwQSUyMCUyMCUyMCUyMHB1c2hkb3duKGspJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElM0IlMEElMjAlMjAlMjAlMjBpZih4JTNDJTNEbWlkKSUyMG1vZGlmeShscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSklM0IlMEElMjAlMjAlMjAlMjBpZih5JTNFbWlkKSUyMG1vZGlmeShycyhrKSUyQ21pZCUyQjElMkNyJTJDeCUyQ3kpJTNCJTBBJTIwJTIwJTIwJTIwcHVzaHVwKGspJTNCJTBBJTdEJTBBaW5saW5lJTIwdm9pZCUyMHN1YnRhc2soKSU3QiUwQSUyMCUyMCUyMCUyMGludCUyMG4lM0JjaW4lM0UlM0VuJTNCJTBBJTIwJTIwJTIwJTIwZm9yKGludCUyMGklM0QxJTNCaSUzQyUzRG4lM0JpJTJCJTJCKSUyMGNpbiUzRSUzRWluJTVCaSU1RCUzQiUwQSUyMCUyMCUyMCUyMGJ1aWxkKDElMkMxJTJDbiklM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtJTNCY2luJTNFJTNFbSUzQiUwQSUyMCUyMCUyMCUyMHdoaWxlKG0tLSklN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbnQlMjBvcCUyQ2wlMkNyJTNCY2luJTNFJTNFb3AlM0UlM0VsJTNFJTNFciUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKG9wJTNEJTNEMSklMjBtb2RpZnkoMSUyQzElMkNuJTJDbCUyQ3IpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlM0QlM0QyKSUyMGNvdXQlM0MlM0NxdWVyeSgxJTJDMSUyQ24lMkNsJTJDciklM0MlM0NlbmRsJTNCJTBBJTIwJTIwJTIwJTIwJTdEJTBBJTdEJTBBc2lnbmVkJTIwbWFpbigpJTdCJTBBJTIwJTIwJTIwJTIwcHclNUIwJTVEJTNEMSUzQiUwQSUyMCUyMCUyMCUyMGZvcihpbnQlMjBpJTNEMSUzQmklM0MlM0QxMDAwMDAlM0JpJTJCJTJCKSUyMHB3JTVCaSU1RCUzRHB3JTVCaS0xJTVEKjIlMjVtb2QlM0IlMEElMjAlMjAlMjAlMjBpb3MlM0ElM0FzeW5jX3dpdGhfc3RkaW8oZmFsc2UpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwdCUzQmNpbiUzRSUzRXQlM0IlMEElMjAlMjAlMjAlMjB3aGlsZSh0LS0pJTIwc3VidGFzaygpJTNCJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwMCUzQiUwQSU3RCUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div><div>63</div><div>64</div><div>65</div><div>66</div><div>67</div><div>68</div><div>69</div><div>70</div><div>71</div></div><div class="code"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ls(k) (k)&lt;&lt;1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rs(k) (k)&lt;&lt;1|1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> nt tree[k]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> lt tree[ls(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rt tree[rs(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> debug(x) cout&lt;&lt;#x&lt;&lt;<span class="hljs-string">&quot;=&quot;</span>&lt;&lt;x&lt;&lt;endl</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> inf=<span class="hljs-number">0x3f3f3f3f3f3f3f3f</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mod=<span class="hljs-number">998244353</span>;
<span class="hljs-keyword">typedef</span> pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; pii;
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ 100005</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>{<span class="hljs-type">int</span> sum,ok,tag;} tree[_&lt;&lt;<span class="hljs-number">2</span>];
<span class="hljs-type">int</span> in[_],pw[_];
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">lowbit</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>{<span class="hljs-keyword">return</span> x&amp;-x;}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">popcnt</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> res=<span class="hljs-number">0</span>)</span></span>{<span class="hljs-keyword">for</span>(;x;x&gt;&gt;=<span class="hljs-number">1</span>) <span class="hljs-keyword">if</span>(x&amp;<span class="hljs-number">1</span>) res++;<span class="hljs-keyword">return</span> res;}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{nt.sum=(lt.sum+rt.sum)%mod;nt.ok=lt.ok&amp;rt.ok;}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
    <span class="hljs-keyword">if</span>(!nt.tag) <span class="hljs-keyword">return</span>;
    lt.sum=lt.sum*pw[nt.tag]%mod;
    rt.sum=rt.sum*pw[nt.tag]%mod;
    lt.tag+=nt.tag;
    rt.tag+=nt.tag;
    nt.tag=<span class="hljs-number">0</span>;
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>{
    nt.tag=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.sum=in[l],nt.ok=<span class="hljs-built_in">popcnt</span>(in[l])==<span class="hljs-number">1</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>,<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">ls</span>(k),l,mid);
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.sum;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(x&lt;=mid) res+=<span class="hljs-built_in">query</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y),res%=mod;
    <span class="hljs-keyword">if</span>(y&gt;mid) res+=<span class="hljs-built_in">query</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y),res%=mod;
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y&amp;&amp;nt.ok) <span class="hljs-keyword">return</span> nt.sum=nt.sum*<span class="hljs-number">2</span>%mod,nt.tag++,<span class="hljs-built_in">void</span>();
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.sum+=<span class="hljs-built_in">lowbit</span>(nt.sum),nt.ok=<span class="hljs-built_in">popcnt</span>(nt.sum)==<span class="hljs-number">1</span>?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>,<span class="hljs-built_in">void</span>();
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">subtask</span><span class="hljs-params">()</span></span>{
    <span class="hljs-type">int</span> n;cin&gt;&gt;n;
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) cin&gt;&gt;in[i];
    <span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);
    <span class="hljs-type">int</span> m;cin&gt;&gt;m;
    <span class="hljs-keyword">while</span>(m--){
        <span class="hljs-type">int</span> op,l,r;cin&gt;&gt;op&gt;&gt;l&gt;&gt;r;
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>) <span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">2</span>) cout&lt;&lt;<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r)&lt;&lt;endl;
    }
}
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    pw[<span class="hljs-number">0</span>]=<span class="hljs-number">1</span>;
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=<span class="hljs-number">100000</span>;i++) pw[i]=pw[i<span class="hljs-number">-1</span>]*<span class="hljs-number">2</span>%mod;
    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-type">int</span> t;cin&gt;&gt;t;
    <span class="hljs-keyword">while</span>(t--) <span class="hljs-built_in">subtask</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<h2 id="ji-si-ji-xian-duan-shu" tabindex="-1">吉司机线段树</h2>
<p>我们把一类需要划分数域来解决的区间最值、区间历史最值问题，用到的势能线段树称为吉司机线段树</p>
<h3 id="qu-jian-zui-zhi-cao-zuo" tabindex="-1">区间最值操作</h3>
<p>以一道题举例</p>
<p><strong>Gorgeous Sequence</strong></p>
<p><a href="https://vjudge.net/problem/HDU-5306">https://vjudge.net/problem/HDU-5306</a></p>
<p><strong>题目描述</strong></p>
<p>给出一个长度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><mo>≤</mo><msup><mn>10</mn><mn>6</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">n(n\le 10^6)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 的序列 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo stretchy="false">(</mo><mi>m</mi><mo>≤</mo><msup><mn>10</mn><mn>6</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">m(m\le 10^6)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 次操作，每次操作为以下三种类型之一：</p>
<ol>
<li>区间对数字 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 取 min</li>
<li>求区间最大值</li>
<li>求区间和</li>
</ol>
<p><strong>笔记</strong></p>
<p>如果没有区间求和的话就很好做了。有区间求和的话我们就不能使用传统的懒标记的方法来做了。</p>
<p>这种题一般是这样考虑的：</p>
<p>维护区间最大值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">mx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">x</span></span></span></span> 和次大值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">se</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">se</span></span></span></span>，以及最大值个数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>n</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">cnt</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span></span></span></span>，区间和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">sum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span></span></span></span>，然后进行区间对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">min</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">min</span></span></span></span> 的时候，有如下的情况：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>≥</mo><mi>m</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">k\ge mx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.136em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≥</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">x</span></span></span></span>，此时该操作不会对当前节点产生影响</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>e</mi><mo>&lt;</mo><mi>k</mi><mo>&lt;</mo><mi>m</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">se &lt; k &lt; mx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5782em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">se</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">x</span></span></span></span> ，此时区间上的最大值都会被修改为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>，我们借助 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>n</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">cnt</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">mx</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">x</span></span></span></span> 快速更新 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">sum</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">u</span><span class="mord mathnormal">m</span></span></span></span></li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>≤</mo><mi>s</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">k\le se</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.136em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">se</span></span></span></span> 时，我们无法快速更新区间信息，选择直接暴力递归左右子树</li>
</ul>
<p>时间复杂度是正确的，我们这么考虑，当我们递归左右子树的时候，说明该区间内不同的数字个数一定会减少，而线段树每层节点表示的区间内的不同数字个数一共是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span> 的，一共有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>log</mi><mo>⁡</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">\log n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span></span></span></span> 层，因此递归的总时间复杂度是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span>。再加上每次操作的复杂度，总时间复杂度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mo stretchy="false">(</mo><mi>n</mi><mo>+</mo><mi>m</mi><mo stretchy="false">)</mo><mi>log</mi><mo>⁡</mo><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O((n+m)\log n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">((</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></p>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTIzaW5jbHVkZSUzQ2JpdHMlMkZzdGRjJTJCJTJCLmglM0UlMEElMjNkZWZpbmUlMjBpbnQlMjBsb25nJTIwbG9uZyUwQSUyM2RlZmluZSUyMHVsbCUyMHVuc2lnbmVkJTIwbG9uZyUyMGxvbmclMEElMjNkZWZpbmUlMjBscyhrKSUyMChrKSUzQyUzQzElMEElMjNkZWZpbmUlMjBycyhrKSUyMChrKSUzQyUzQzElN0MxJTBBJTIzZGVmaW5lJTIwbnQlMjB0cmVlJTVCayU1RCUwQSUyM2RlZmluZSUyMGx0JTIwdHJlZSU1QmxzKGspJTVEJTBBJTIzZGVmaW5lJTIwcnQlMjB0cmVlJTVCcnMoayklNUQlMEElMjNkZWZpbmUlMjBkZWJ1Zyh4KSUyMGNvdXQlM0MlM0MlMjN4JTNDJTNDJTIyJTNEJTIyJTNDJTNDeCUzQyUzQ2VuZGwlMEF1c2luZyUyMG5hbWVzcGFjZSUyMHN0ZCUzQiUwQWNvbnN0JTIwaW50JTIwaW5mJTNEMHgzZjNmM2YzZjNmM2YzZjNmJTNCJTBBY29uc3QlMjBpbnQlMjBtb2QlM0QwJTNCJTBBdHlwZWRlZiUyMHBhaXIlM0NpbnQlMkNpbnQlM0UlMjBwaWklM0IlMEElMjNkZWZpbmUlMjBfJTIwMTAwMDAwNiUwQSUyM2RlZmluZSUyMExPQ0FMJTBBbmFtZXNwYWNlJTIwbHklMEElN0IlMEElMjAlMjAlMjAlMjBuYW1lc3BhY2UlMjBJTyUwQSUyMCUyMCUyMCUyMCU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyM2lmbmRlZiUyMExPQ0FMJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwY29uc3RleHByJTIwYXV0byUyMG1heG4lM0QxJTNDJTNDMjAlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBjaGFyJTIwaW4lNUJtYXhuJTVEJTJDb3V0JTVCbWF4biU1RCUyQypwMSUzRGluJTJDKnAyJTNEaW4lMkMqcDMlM0RvdXQlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjNkZWZpbmUlMjBnZXRjaGFyKCklMjAocDElM0QlM0RwMiUyNiUyNihwMiUzRChwMSUzRGluKSUyQmZyZWFkKGluJTJDMSUyQ21heG4lMkNzdGRpbiklMkNwMSUzRCUzRHAyKSUzRkVPRiUzQSpwMSUyQiUyQiklMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjNkZWZpbmUlMjBmbHVzaCgpJTIwKGZ3cml0ZShvdXQlMkMxJTJDcDMtb3V0JTJDc3Rkb3V0KSklMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjNkZWZpbmUlMjBwdXRjaGFyKHgpJTIwKHAzJTNEJTNEb3V0JTJCbWF4biUyNiUyNihmbHVzaCgpJTJDcDMlM0RvdXQpJTJDKnAzJTJCJTJCJTNEKHgpKSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGNsYXNzJTIwRmx1c2glN0JwdWJsaWMlM0F+Rmx1c2goKSU3QmZsdXNoKCklM0IlN0QlN0RfJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzZW5kaWYlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBuYW1lc3BhY2UlMjB1c3IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB0ZW1wbGF0ZSUzQ3R5cGVuYW1lJTIwdHlwZSUzRSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlubGluZSUyMHR5cGUlMjByZWFkKHR5cGUlMjAlMjZ4KSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHglM0QwJTNCYm9vbCUyMGZsYWcoMCklM0JjaGFyJTIwY2glM0RnZXRjaGFyKCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB3aGlsZSghaXNkaWdpdChjaCkpJTIwZmxhZyU1RSUzRGNoJTNEJTNEJy0nJTJDY2glM0RnZXRjaGFyKCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB3aGlsZShpc2RpZ2l0KGNoKSklMjB4JTNEKHglM0MlM0MxKSUyQih4JTNDJTNDMyklMkIoY2glNUU0OCklMkNjaCUzRGdldGNoYXIoKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHJldHVybiUyMGZsYWclM0Z4JTNELXglM0F4JTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdGVtcGxhdGUlM0N0eXBlbmFtZSUyMHR5cGUlM0UlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbmxpbmUlMjB2b2lkJTIwd3JpdGUodHlwZSUyMHgpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIweCUzQzAlM0Z4JTNELXglMkNwdXRjaGFyKCctJyklM0EwJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwc3RhdGljJTIwc2hvcnQlMjBTdGFjayU1QjUwJTVEJTJDdG9wKDApJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwZG8lMjBTdGFjayU1QiUyQiUyQnRvcCU1RCUzRHglMjUxMCUyQ3glMkYlM0QxMCUzQndoaWxlKHgpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwd2hpbGUodG9wKSUyMHB1dGNoYXIoU3RhY2slNUJ0b3AtLSU1RCU3QzQ4KSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlubGluZSUyMGNoYXIlMjByZWFkKGNoYXIlMjAlMjZ4KSU3QmRvJTIweCUzRGdldGNoYXIoKSUzQndoaWxlKGlzc3BhY2UoeCkpJTNCcmV0dXJuJTIweCUzQiU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlubGluZSUyMGNoYXIlMjB3cml0ZShjb25zdCUyMGNoYXIlMjAlMjZ4KSU3QnJldHVybiUyMHB1dGNoYXIoeCklM0IlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbmxpbmUlMjB2b2lkJTIwcmVhZChjaGFyJTIwKngpJTdCc3RhdGljJTIwY2hhciUyMGNoJTNCcmVhZChjaCklM0JkbyUyMCooeCUyQiUyQiklM0RjaCUzQndoaWxlKCFpc3NwYWNlKGNoJTNEZ2V0Y2hhcigpKSUyNiUyNn5jaCklM0IlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB0ZW1wbGF0ZSUzQ3R5cGVuYW1lJTIwdHlwZSUzRWlubGluZSUyMHZvaWQlMjB3cml0ZSh0eXBlJTIwKngpJTdCd2hpbGUoKngpcHV0Y2hhcigqKHglMkIlMkIpKSUzQiU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlubGluZSUyMHZvaWQlMjByZWFkKHN0cmluZyUyMCUyNngpJTdCc3RhdGljJTIwY2hhciUyMGNoJTNCcmVhZChjaCklMkN4LmNsZWFyKCklM0JkbyUyMHglMkIlM0RjaCUzQndoaWxlKCFpc3NwYWNlKGNoJTNEZ2V0Y2hhcigpKSUyNiUyNn5jaCklM0IlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbmxpbmUlMjB2b2lkJTIwd3JpdGUoY29uc3QlMjBzdHJpbmclMjAlMjZ4KSU3QmZvcihpbnQlMjBpJTNEMCUyQ2xlbiUzRHgubGVuZ3RoKCklM0JpJTNDbGVuJTNCJTJCJTJCaSlwdXRjaGFyKHglNUJpJTVEKSUzQiU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRlbXBsYXRlJTNDdHlwZW5hbWUlMjB0eXBlJTJDdHlwZW5hbWUuLi5UJTNFaW5saW5lJTIwdm9pZCUyMHJlYWQodHlwZSUyMCUyNnglMkNUJTI2Li4ueSklN0JyZWFkKHgpJTJDcmVhZCh5Li4uKSUzQiU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRlbXBsYXRlJTNDdHlwZW5hbWUlMjB0eXBlJTJDdHlwZW5hbWUuLi5UJTNFJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW5saW5lJTIwdm9pZCUyMHdyaXRlKGNvbnN0JTIwdHlwZSUyMCUyNnglMkNjb25zdCUyMFQlMjYuLi55KSU3QndyaXRlKHgpJTJDcHV0Y2hhcignJTIwJyklMkN3cml0ZSh5Li4uKSUyQ3NpemVvZi4uLih5KSU1RTElM0YwJTNBcHV0Y2hhcignJTVDbicpJTNCJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdGVtcGxhdGUlM0N0eXBlbmFtZSUyMHR5cGUlM0UlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbmxpbmUlMjB2b2lkJTIwcHV0KGNvbnN0JTIwdHlwZSUyMCUyNnglMkNib29sJTIwZmxhZyUzRDEpJTdCd3JpdGUoeCklMkNmbGFnJTNGcHV0Y2hhcignJTVDbicpJTNBcHV0Y2hhcignJTIwJyklM0IlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjNpZm5kZWYlMjBMT0NBTCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyM3VuZGVmJTIwZ2V0Y2hhciUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyM3VuZGVmJTIwZmx1c2glMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjN1bmRlZiUyMHB1dGNoYXIlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjNlbmRpZiUwQSUyMCUyMCUyMCUyMCU3RHVzaW5nJTIwbmFtZXNwYWNlJTIwSU8lM0ElM0F1c3IlM0IlMEElN0R1c2luZyUyMG5hbWVzcGFjZSUyMGx5JTNBJTNBSU8lM0ElM0F1c3IlM0IlMEElMEFzdHJ1Y3QlMjBOb2RlJTdCaW50JTIwc3VtJTJDbXglMkNzZSUyQ3RhZyUyQ2NudCUzQiU3RCUyMHRyZWUlNUJfJTNDJTNDMiU1RCUzQiUwQWludCUyMGluJTVCXyU1RCUzQiUwQWlubGluZSUyMHZvaWQlMjBwdXNodXAoaW50JTIwayklN0IlMEElMjAlMjAlMjAlMjBudC5zdW0lM0RsdC5zdW0lMkJydC5zdW0lM0IlMEElMjAlMjAlMjAlMjBudC5teCUzRG1heChsdC5teCUyQ3J0Lm14KSUzQiUwQSUyMCUyMCUyMCUyMGlmKGx0Lm14JTNEJTNEcnQubXgpJTIwbnQuc2UlM0RtYXgobHQuc2UlMkNydC5zZSklMkNudC5jbnQlM0RsdC5jbnQlMkJydC5jbnQlM0IlMEElMjAlMjAlMjAlMjBlbHNlJTIwbnQuc2UlM0RtYXgobWluKGx0Lm14JTJDcnQubXgpJTJDbWF4KGx0LnNlJTJDcnQuc2UpKSUyQ250LmNudCUzRGx0Lm14JTNFcnQubXglM0ZsdC5jbnQlM0FydC5jbnQlM0IlMEElN0QlMEFpbmxpbmUlMjB2b2lkJTIwdXBkYXRlKGludCUyMGslMkNpbnQlMjB4KSU3QmlmKHglM0NudC5teCklMjBudC5zdW0tJTNEKG50Lm14LXgpKm50LmNudCUyQ250Lm14JTNEbnQudGFnJTNEeCUzQiU3RCUwQWlubGluZSUyMHZvaWQlMjBwdXNoZG93bihpbnQlMjBrKSU3QmlmKG50LnRhZyElM0QtMSklMjB1cGRhdGUobHMoayklMkNudC50YWcpJTJDdXBkYXRlKHJzKGspJTJDbnQudGFnKSUyQ250LnRhZyUzRC0xJTNCJTdEJTBBdm9pZCUyMGJ1aWxkKGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciklN0IlMEElMjAlMjAlMjAlMjBudC50YWclM0QtMSUzQiUwQSUyMCUyMCUyMCUyMGlmKGwlM0QlM0RyKSUyMHJldHVybiUyMG50LnN1bSUzRG50Lm14JTNEaW4lNUJsJTVEJTJDbnQuc2UlM0QtMSUyQ250LmNudCUzRDElMkN2b2lkKCklM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUzQiUwQSUyMCUyMCUyMCUyMGJ1aWxkKGxzKGspJTJDbCUyQ21pZCklM0IlMEElMjAlMjAlMjAlMjBidWlsZChycyhrKSUyQ21pZCUyQjElMkNyKSUzQiUwQSUyMCUyMCUyMCUyMHB1c2h1cChrKSUzQiUwQSU3RCUwQXZvaWQlMjBtb2RpZnkoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHklMkNpbnQlMjB2KSU3QiUwQSUyMCUyMCUyMCUyMGlmKHYlM0UlM0RudC5teCklMjByZXR1cm4lM0IlMEElMjAlMjAlMjAlMjBpZihsJTNFJTNEeCUyNiUyNnIlM0MlM0R5JTI2JTI2diUzRW50LnNlKSUyMHJldHVybiUyMHVwZGF0ZShrJTJDdiklMkN2b2lkKCklM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUzQiUwQSUyMCUyMCUyMCUyMHB1c2hkb3duKGspJTNCJTBBJTIwJTIwJTIwJTIwaWYoeCUzQyUzRG1pZCklMjBtb2RpZnkobHMoayklMkNsJTJDbWlkJTJDeCUyQ3klMkN2KSUzQiUwQSUyMCUyMCUyMCUyMGlmKHklM0VtaWQpJTIwbW9kaWZ5KHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwcHVzaHVwKGspJTNCJTBBJTdEJTBBaW50JTIwcXVlcnlfbWF4KGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciUyQ2ludCUyMHglMkNpbnQlMjB5KSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHkpJTIwcmV0dXJuJTIwbnQubXglM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUyQ3JlcyUzRC1pbmYlM0IlMEElMjAlMjAlMjAlMjBwdXNoZG93bihrKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwcmVzJTNEbWF4KHJlcyUyQ3F1ZXJ5X21heChscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSkpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeSUzRW1pZCklMjByZXMlM0RtYXgocmVzJTJDcXVlcnlfbWF4KHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSkpJTNCJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwcmVzJTNCJTBBJTdEJTBBaW50JTIwcXVlcnlfc3VtKGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciUyQ2ludCUyMHglMkNpbnQlMjB5KSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHkpJTIwcmV0dXJuJTIwbnQuc3VtJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElMkNyZXMlM0QwJTNCJTBBJTIwJTIwJTIwJTIwcHVzaGRvd24oayklM0IlMEElMjAlMjAlMjAlMjBpZih4JTNDJTNEbWlkKSUyMHJlcyUyQiUzRHF1ZXJ5X3N1bShscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSklM0IlMEElMjAlMjAlMjAlMjBpZih5JTNFbWlkKSUyMHJlcyUyQiUzRHF1ZXJ5X3N1bShycyhrKSUyQ21pZCUyQjElMkNyJTJDeCUyQ3kpJTNCJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwcmVzJTNCJTBBJTdEJTBBaW5saW5lJTIwdm9pZCUyMHN1YnRhc2soKSU3QiUwQSUyMCUyMCUyMCUyMGludCUyMG4lMkNtJTNCcmVhZChuKSUzQnJlYWQobSklM0IlMEElMjAlMjAlMjAlMjBmb3IoaW50JTIwaSUzRDElM0JpJTNDJTNEbiUzQmklMkIlMkIpJTIwcmVhZChpbiU1QmklNUQpJTNCJTBBJTIwJTIwJTIwJTIwYnVpbGQoMSUyQzElMkNuKSUzQiUwQSUyMCUyMCUyMCUyMHdoaWxlKG0tLSklN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbnQlMjBvcCUyQ2wlMkNyJTJDeCUzQnJlYWQob3ApJTJDcmVhZChsKSUyQ3JlYWQociklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCUzRCUzRDApJTIwcmVhZCh4KSUyQ21vZGlmeSgxJTJDMSUyQ24lMkNsJTJDciUyQ3gpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlM0QlM0QxKSUyMHB1dChxdWVyeV9tYXgoMSUyQzElMkNuJTJDbCUyQ3IpKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKG9wJTNEJTNEMiklMjBwdXQocXVlcnlfc3VtKDElMkMxJTJDbiUyQ2wlMkNyKSklM0IlMEElMjAlMjAlMjAlMjAlN0QlMEElN0QlMEFzaWduZWQlMjBtYWluKCklN0IlMEElMjAlMjAlMjAlMjAlMkYlMkZpb3MlM0ElM0FzeW5jX3dpdGhfc3RkaW8oZmFsc2UpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwdCUzQnJlYWQodCklM0IlMEElMjAlMjAlMjAlMjB3aGlsZSh0LS0pJTIwc3VidGFzaygpJTNCJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwMCUzQiUwQSU3RCUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div><div>63</div><div>64</div><div>65</div><div>66</div><div>67</div><div>68</div><div>69</div><div>70</div><div>71</div><div>72</div><div>73</div><div>74</div><div>75</div><div>76</div><div>77</div><div>78</div><div>79</div><div>80</div><div>81</div><div>82</div><div>83</div><div>84</div><div>85</div><div>86</div><div>87</div><div>88</div><div>89</div><div>90</div><div>91</div><div>92</div><div>93</div><div>94</div><div>95</div><div>96</div><div>97</div><div>98</div><div>99</div><div>100</div><div>101</div><div>102</div><div>103</div><div>104</div><div>105</div><div>106</div><div>107</div><div>108</div><div>109</div><div>110</div><div>111</div><div>112</div><div>113</div><div>114</div><div>115</div><div>116</div><div>117</div><div>118</div><div>119</div><div>120</div><div>121</div><div>122</div><div>123</div><div>124</div><div>125</div></div><div class="code"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ls(k) (k)&lt;&lt;1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rs(k) (k)&lt;&lt;1|1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> nt tree[k]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> lt tree[ls(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rt tree[rs(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> debug(x) cout&lt;&lt;#x&lt;&lt;<span class="hljs-string">&quot;=&quot;</span>&lt;&lt;x&lt;&lt;endl</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> inf=<span class="hljs-number">0x3f3f3f3f3f3f3f3f</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mod=<span class="hljs-number">0</span>;
<span class="hljs-keyword">typedef</span> pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; pii;
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ 1000006</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> LOCAL</span>
<span class="hljs-keyword">namespace</span> ly
{
    <span class="hljs-keyword">namespace</span> IO
    {
        <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> LOCAL</span>
            <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> maxn=<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">20</span>;
            <span class="hljs-type">char</span> in[maxn],out[maxn],*p1=in,*p2=in,*p3=out;
            <span class="hljs-meta">#<span class="hljs-keyword">define</span> getchar() (p1==p2&amp;&amp;(p2=(p1=in)+fread(in,1,maxn,stdin),p1==p2)?EOF:*p1++)</span>
            <span class="hljs-meta">#<span class="hljs-keyword">define</span> flush() (fwrite(out,1,p3-out,stdout))</span>
            <span class="hljs-meta">#<span class="hljs-keyword">define</span> putchar(x) (p3==out+maxn&amp;&amp;(flush(),p3=out),*p3++=(x))</span>
            <span class="hljs-keyword">class</span> <span class="hljs-title class_">Flush</span>{<span class="hljs-keyword">public</span>:~<span class="hljs-built_in">Flush</span>(){<span class="hljs-built_in">flush</span>();}}_;
        <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
        <span class="hljs-keyword">namespace</span> usr
        {
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;
            <span class="hljs-keyword">inline</span> type <span class="hljs-title">read</span><span class="hljs-params">(type &amp;x)</span>
            </span>{
                x=<span class="hljs-number">0</span>;<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">flag</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;<span class="hljs-type">char</span> ch=<span class="hljs-built_in">getchar</span>();
                <span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isdigit</span>(ch)) flag^=ch==<span class="hljs-string">&#x27;-&#x27;</span>,ch=<span class="hljs-built_in">getchar</span>();
                <span class="hljs-keyword">while</span>(<span class="hljs-built_in">isdigit</span>(ch)) x=(x&lt;&lt;<span class="hljs-number">1</span>)+(x&lt;&lt;<span class="hljs-number">3</span>)+(ch^<span class="hljs-number">48</span>),ch=<span class="hljs-built_in">getchar</span>();
                <span class="hljs-keyword">return</span> flag?x=-x:x;
            }
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;
            <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(type x)</span>
            </span>{
                x&lt;<span class="hljs-number">0</span>?x=-x,<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;-&#x27;</span>):<span class="hljs-number">0</span>;
                <span class="hljs-type">static</span> <span class="hljs-type">short</span> Stack[<span class="hljs-number">50</span>],<span class="hljs-built_in">top</span>(<span class="hljs-number">0</span>);
                <span class="hljs-keyword">do</span> Stack[++top]=x%<span class="hljs-number">10</span>,x/=<span class="hljs-number">10</span>;<span class="hljs-keyword">while</span>(x);
                <span class="hljs-keyword">while</span>(top) <span class="hljs-built_in">putchar</span>(Stack[top--]|<span class="hljs-number">48</span>);
            }
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">char</span> <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-type">char</span> &amp;x)</span></span>{<span class="hljs-keyword">do</span> x=<span class="hljs-built_in">getchar</span>();<span class="hljs-keyword">while</span>(<span class="hljs-built_in">isspace</span>(x));<span class="hljs-keyword">return</span> x;}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">char</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> &amp;x)</span></span>{<span class="hljs-keyword">return</span> <span class="hljs-built_in">putchar</span>(x);}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-type">char</span> *x)</span></span>{<span class="hljs-type">static</span> <span class="hljs-type">char</span> ch;<span class="hljs-built_in">read</span>(ch);<span class="hljs-keyword">do</span> *(x++)=ch;<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isspace</span>(ch=<span class="hljs-built_in">getchar</span>())&amp;&amp;~ch);}
            <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(type *x)</span></span>{<span class="hljs-keyword">while</span>(*x)<span class="hljs-built_in">putchar</span>(*(x++));}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">read</span><span class="hljs-params">(string &amp;x)</span></span>{<span class="hljs-type">static</span> <span class="hljs-type">char</span> ch;<span class="hljs-built_in">read</span>(ch),x.<span class="hljs-built_in">clear</span>();<span class="hljs-keyword">do</span> x+=ch;<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isspace</span>(ch=<span class="hljs-built_in">getchar</span>())&amp;&amp;~ch);}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">const</span> string &amp;x)</span></span>{<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>,len=x.<span class="hljs-built_in">length</span>();i&lt;len;++i)<span class="hljs-built_in">putchar</span>(x[i]);}
            <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type,<span class="hljs-keyword">typename</span>...T&gt;<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">read</span><span class="hljs-params">(type &amp;x,T&amp;...y)</span></span>{<span class="hljs-built_in">read</span>(x),<span class="hljs-built_in">read</span>(y...);}
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type,<span class="hljs-keyword">typename</span>...T&gt;
            <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">const</span> type &amp;x,<span class="hljs-type">const</span> T&amp;...y)</span></span>{<span class="hljs-built_in">write</span>(x),<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27; &#x27;</span>),<span class="hljs-built_in">write</span>(y...),<span class="hljs-keyword">sizeof</span>...(y)^<span class="hljs-number">1</span>?<span class="hljs-number">0</span>:<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);}
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;
            <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">put</span><span class="hljs-params">(<span class="hljs-type">const</span> type &amp;x,<span class="hljs-type">bool</span> flag=<span class="hljs-number">1</span>)</span></span>{<span class="hljs-built_in">write</span>(x),flag?<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>):<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27; &#x27;</span>);}
        }
        <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> LOCAL</span>
            <span class="hljs-meta">#<span class="hljs-keyword">undef</span> getchar</span>
            <span class="hljs-meta">#<span class="hljs-keyword">undef</span> flush</span>
            <span class="hljs-meta">#<span class="hljs-keyword">undef</span> putchar</span>
        <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
    }<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> IO::usr;
}<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> ly::IO::usr;

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>{<span class="hljs-type">int</span> sum,mx,se,tag,cnt;} tree[_&lt;&lt;<span class="hljs-number">2</span>];
<span class="hljs-type">int</span> in[_];
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
    nt.sum=lt.sum+rt.sum;
    nt.mx=<span class="hljs-built_in">max</span>(lt.mx,rt.mx);
    <span class="hljs-keyword">if</span>(lt.mx==rt.mx) nt.se=<span class="hljs-built_in">max</span>(lt.se,rt.se),nt.cnt=lt.cnt+rt.cnt;
    <span class="hljs-keyword">else</span> nt.se=<span class="hljs-built_in">max</span>(<span class="hljs-built_in">min</span>(lt.mx,rt.mx),<span class="hljs-built_in">max</span>(lt.se,rt.se)),nt.cnt=lt.mx&gt;rt.mx?lt.cnt:rt.cnt;
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> x)</span></span>{<span class="hljs-keyword">if</span>(x&lt;nt.mx) nt.sum-=(nt.mx-x)*nt.cnt,nt.mx=nt.tag=x;}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{<span class="hljs-keyword">if</span>(nt.tag!=<span class="hljs-number">-1</span>) <span class="hljs-built_in">update</span>(<span class="hljs-built_in">ls</span>(k),nt.tag),<span class="hljs-built_in">update</span>(<span class="hljs-built_in">rs</span>(k),nt.tag),nt.tag=<span class="hljs-number">-1</span>;}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>{
    nt.tag=<span class="hljs-number">-1</span>;
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.sum=nt.mx=in[l],nt.se=<span class="hljs-number">-1</span>,nt.cnt=<span class="hljs-number">1</span>,<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">ls</span>(k),l,mid);
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(v&gt;=nt.mx) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y&amp;&amp;v&gt;nt.se) <span class="hljs-keyword">return</span> <span class="hljs-built_in">update</span>(k,v),<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y,v);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query_max</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.mx;
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=-inf;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-keyword">if</span>(x&lt;=mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query_max</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y));
    <span class="hljs-keyword">if</span>(y&gt;mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query_max</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y));
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query_sum</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.sum;
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=<span class="hljs-number">0</span>;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-keyword">if</span>(x&lt;=mid) res+=<span class="hljs-built_in">query_sum</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y);
    <span class="hljs-keyword">if</span>(y&gt;mid) res+=<span class="hljs-built_in">query_sum</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y);
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">subtask</span><span class="hljs-params">()</span></span>{
    <span class="hljs-type">int</span> n,m;<span class="hljs-built_in">read</span>(n);<span class="hljs-built_in">read</span>(m);
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) <span class="hljs-built_in">read</span>(in[i]);
    <span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);
    <span class="hljs-keyword">while</span>(m--){
        <span class="hljs-type">int</span> op,l,r,x;<span class="hljs-built_in">read</span>(op),<span class="hljs-built_in">read</span>(l),<span class="hljs-built_in">read</span>(r);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">0</span>) <span class="hljs-built_in">read</span>(x),<span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,x);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>) <span class="hljs-built_in">put</span>(<span class="hljs-built_in">query_max</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r));
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">2</span>) <span class="hljs-built_in">put</span>(<span class="hljs-built_in">query_sum</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r));
    }
}
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">//ios::sync_with_stdio(false);</span>
    <span class="hljs-type">int</span> t;<span class="hljs-built_in">read</span>(t);
    <span class="hljs-keyword">while</span>(t--) <span class="hljs-built_in">subtask</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<h3 id="zhi-chi-qu-jian-jia-jian" tabindex="-1">支持区间加减</h3>
<p>现在既有加减的懒标记，又有取 min 的懒标记，难点在于如何 pushdown 这两个标记</p>
<p>由于取 min 需要依赖原有的值，所以加减的懒标记应该先于 min 懒标记下放</p>
<p>对于加减 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>，下放的时候直接让子节点的加减懒标记和取 min 懒标记也加减 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 就可以了</p>
<p>对于对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 取 min，下放的时候直接将子节点的取 min 懒标记置为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>。注意这么做的前提是，区间内所有数的最大值是大于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 的，这样的话可以保证如果多次下放取 min 懒标记，懒标记的值是单调的，直接置为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 是没问题的</p>
<p>但是有了这个操作之后，上述的时间复杂度分析的方法不适用了。论文<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>中给出了另一种分析思路，分析出来的时间复杂度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>m</mi><msup><mrow><mi>log</mi><mo>⁡</mo></mrow><mn>2</mn></msup><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(m\log^2n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1484em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8984em;"><span style="top:-3.1473em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></p>
<h3 id="qu-min-he-qu-max-tong-shi-cun-zai" tabindex="-1">取 min 和取 max 同时存在</h3>
<p><strong>P10639 BZOJ4695 最佳女选手</strong></p>
<p><a href="https://www.luogu.com.cn/problem/P10639">https://www.luogu.com.cn/problem/P10639</a></p>
<p><strong>题目描述</strong></p>
<p>给定一个长度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 的序列，要求支持以下 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>6</mn></mrow><annotation encoding="application/x-tex">6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">6</span></span></span></span> 种操作：</p>
<ul>
<li>给一个区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span> 加上一个整数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>；</li>
<li>把一个区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span> 内小于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 的数都变成 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>；</li>
<li>把一个区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span> 内大于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 的数都变成 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>；</li>
<li>求区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span> 的和；</li>
<li>求区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span> 的最大值；</li>
<li>求区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span> 的最小值；</li>
</ul>
<p><strong>数据范围</strong></p>
<p>数据保证，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo>≤</mo><mn>5</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding="application/x-tex">1\leq n,m\leq 5\times 10^5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><msub><mi>a</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mo>≤</mo><msup><mn>10</mn><mn>8</mn></msup></mrow><annotation encoding="application/x-tex">|a_i|\leq 10^8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span></span></span></span>。</p>
<p>当进行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 操作时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><mi>x</mi><mi mathvariant="normal">∣</mi><mo>≤</mo><mn>1000</mn></mrow><annotation encoding="application/x-tex">|x| \leq 1000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1000</span></span></span></span>；</p>
<p>当进行 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> 操作时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><mi>x</mi><mi mathvariant="normal">∣</mi><mo>≤</mo><msup><mn>10</mn><mn>8</mn></msup></mrow><annotation encoding="application/x-tex">|x| \leq 10^8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mord mathnormal">x</span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span></span></span></span>。</p>
<p><strong>笔记</strong></p>
<p>现在在支持区间加减的基础上，既支持取 min 又支持取 max。我们可以维护区间最大值，区间次大值，区间最大值个数，区间最小值，区间次小值，区间最小值个数，区间和，以及取 min 懒标记，取 max 懒标记，加减懒标记</p>
<p>有三个懒标记，如何下放就成了问题，显然我们还是先下放加减懒标记</p>
<ul>
<li>对于加减 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>，下放时子节点的加减懒标记，取 min 懒标记，取 max 懒标记都加减 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></li>
</ul>
<p>后面先下放取 min 懒标记还是先下放取 max 懒标记就无所谓了，我们先下放取 min 懒标记</p>
<ul>
<li>对于对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 取 min，子节点的取 min 懒标记置为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>，然后子节点的取 max 懒标记对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 取 min，防止先前的取 max 操作影响到本次的取 min 操作</li>
<li>对于对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 取 max，同理</li>
</ul>
<p>同时，当一个区间内数字较少的时候，可能会出现最大值、最小值、次小值、次大值中间有几个是相同的</p>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTIzaW5jbHVkZSUzQ2JpdHMlMkZzdGRjJTJCJTJCLmglM0UlMEElMjNkZWZpbmUlMjBpbnQlMjBsb25nJTIwbG9uZyUwQSUyM2RlZmluZSUyMHVsbCUyMHVuc2lnbmVkJTIwbG9uZyUyMGxvbmclMEElMjNkZWZpbmUlMjBscyhrKSUyMChrKSUzQyUzQzElMEElMjNkZWZpbmUlMjBycyhrKSUyMChrKSUzQyUzQzElN0MxJTBBJTIzZGVmaW5lJTIwZGVidWcoeCklMjBjb3V0JTNDJTNDJTIzeCUzQyUzQyUyMiUzRCUyMiUzQyUzQ3glM0MlM0NlbmRsJTBBdXNpbmclMjBuYW1lc3BhY2UlMjBzdGQlM0IlMEFjb25zdCUyMGludCUyMGluZiUzRDB4M2YzZjNmM2YzZjNmM2YzZiUzQiUwQWNvbnN0JTIwaW50JTIwbW9kJTNEMCUzQiUwQXR5cGVkZWYlMjBwYWlyJTNDaW50JTJDaW50JTNFJTIwcGlpJTNCJTBBJTIzZGVmaW5lJTIwXyUyMDUwMDAwNSUwQSUyM2RlZmluZSUyMG50JTIwdHJlZSU1QmslNUQlMEElMjNkZWZpbmUlMjBsdCUyMHRyZWUlNUJscyhrKSU1RCUwQSUyM2RlZmluZSUyMHJ0JTIwdHJlZSU1QnJzKGspJTVEJTBBJTIzZGVmaW5lJTIwTE9DQUwlMEFuYW1lc3BhY2UlMjBseSUwQSU3QiUwQSUyMCUyMCUyMCUyMG5hbWVzcGFjZSUyMElPJTBBJTIwJTIwJTIwJTIwJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzaWZuZGVmJTIwTE9DQUwlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBjb25zdGV4cHIlMjBhdXRvJTIwbWF4biUzRDElM0MlM0MyMCUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGNoYXIlMjBpbiU1Qm1heG4lNUQlMkNvdXQlNUJtYXhuJTVEJTJDKnAxJTNEaW4lMkMqcDIlM0RpbiUyQypwMyUzRG91dCUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyM2RlZmluZSUyMGdldGNoYXIoKSUyMChwMSUzRCUzRHAyJTI2JTI2KHAyJTNEKHAxJTNEaW4pJTJCZnJlYWQoaW4lMkMxJTJDbWF4biUyQ3N0ZGluKSUyQ3AxJTNEJTNEcDIpJTNGRU9GJTNBKnAxJTJCJTJCKSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyM2RlZmluZSUyMGZsdXNoKCklMjAoZndyaXRlKG91dCUyQzElMkNwMy1vdXQlMkNzdGRvdXQpKSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyM2RlZmluZSUyMHB1dGNoYXIoeCklMjAocDMlM0QlM0RvdXQlMkJtYXhuJTI2JTI2KGZsdXNoKCklMkNwMyUzRG91dCklMkMqcDMlMkIlMkIlM0QoeCkpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwY2xhc3MlMjBGbHVzaCU3QnB1YmxpYyUzQX5GbHVzaCgpJTdCZmx1c2goKSUzQiU3RCU3RF8lM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjNlbmRpZiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMG5hbWVzcGFjZSUyMHVzciUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRlbXBsYXRlJTNDdHlwZW5hbWUlMjB0eXBlJTNFJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW5saW5lJTIwdHlwZSUyMHJlYWQodHlwZSUyMCUyNngpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIweCUzRDAlM0Jib29sJTIwZmxhZygwKSUzQmNoYXIlMjBjaCUzRGdldGNoYXIoKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHdoaWxlKCFpc2RpZ2l0KGNoKSklMjBmbGFnJTVFJTNEY2glM0QlM0QnLSclMkNjaCUzRGdldGNoYXIoKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHdoaWxlKGlzZGlnaXQoY2gpKSUyMHglM0QoeCUzQyUzQzEpJTJCKHglM0MlM0MzKSUyQihjaCU1RTQ4KSUyQ2NoJTNEZ2V0Y2hhcigpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwcmV0dXJuJTIwZmxhZyUzRnglM0QteCUzQXglM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB0ZW1wbGF0ZSUzQ3R5cGVuYW1lJTIwdHlwZSUzRSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlubGluZSUyMHZvaWQlMjB3cml0ZSh0eXBlJTIweCklMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB4JTNDMCUzRnglM0QteCUyQ3B1dGNoYXIoJy0nKSUzQTAlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBzdGF0aWMlMjBzaG9ydCUyMFN0YWNrJTVCNTAlNUQlMkN0b3AoMCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBkbyUyMFN0YWNrJTVCJTJCJTJCdG9wJTVEJTNEeCUyNTEwJTJDeCUyRiUzRDEwJTNCd2hpbGUoeCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB3aGlsZSh0b3ApJTIwcHV0Y2hhcihTdGFjayU1QnRvcC0tJTVEJTdDNDgpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW5saW5lJTIwY2hhciUyMHJlYWQoY2hhciUyMCUyNngpJTdCZG8lMjB4JTNEZ2V0Y2hhcigpJTNCd2hpbGUoaXNzcGFjZSh4KSklM0JyZXR1cm4lMjB4JTNCJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW5saW5lJTIwY2hhciUyMHdyaXRlKGNvbnN0JTIwY2hhciUyMCUyNngpJTdCcmV0dXJuJTIwcHV0Y2hhcih4KSUzQiU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlubGluZSUyMHZvaWQlMjByZWFkKGNoYXIlMjAqeCklN0JzdGF0aWMlMjBjaGFyJTIwY2glM0JyZWFkKGNoKSUzQmRvJTIwKih4JTJCJTJCKSUzRGNoJTNCd2hpbGUoIWlzc3BhY2UoY2glM0RnZXRjaGFyKCkpJTI2JTI2fmNoKSUzQiU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRlbXBsYXRlJTNDdHlwZW5hbWUlMjB0eXBlJTNFaW5saW5lJTIwdm9pZCUyMHdyaXRlKHR5cGUlMjAqeCklN0J3aGlsZSgqeClwdXRjaGFyKCooeCUyQiUyQikpJTNCJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW5saW5lJTIwdm9pZCUyMHJlYWQoc3RyaW5nJTIwJTI2eCklN0JzdGF0aWMlMjBjaGFyJTIwY2glM0JyZWFkKGNoKSUyQ3guY2xlYXIoKSUzQmRvJTIweCUyQiUzRGNoJTNCd2hpbGUoIWlzc3BhY2UoY2glM0RnZXRjaGFyKCkpJTI2JTI2fmNoKSUzQiU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlubGluZSUyMHZvaWQlMjB3cml0ZShjb25zdCUyMHN0cmluZyUyMCUyNngpJTdCZm9yKGludCUyMGklM0QwJTJDbGVuJTNEeC5sZW5ndGgoKSUzQmklM0NsZW4lM0IlMkIlMkJpKXB1dGNoYXIoeCU1QmklNUQpJTNCJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdGVtcGxhdGUlM0N0eXBlbmFtZSUyMHR5cGUlMkN0eXBlbmFtZS4uLlQlM0VpbmxpbmUlMjB2b2lkJTIwcmVhZCh0eXBlJTIwJTI2eCUyQ1QlMjYuLi55KSU3QnJlYWQoeCklMkNyZWFkKHkuLi4pJTNCJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdGVtcGxhdGUlM0N0eXBlbmFtZSUyMHR5cGUlMkN0eXBlbmFtZS4uLlQlM0UlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbmxpbmUlMjB2b2lkJTIwd3JpdGUoY29uc3QlMjB0eXBlJTIwJTI2eCUyQ2NvbnN0JTIwVCUyNi4uLnkpJTdCd3JpdGUoeCklMkNwdXRjaGFyKCclMjAnKSUyQ3dyaXRlKHkuLi4pJTJDc2l6ZW9mLi4uKHkpJTVFMSUzRjAlM0FwdXRjaGFyKCclNUNuJyklM0IlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB0ZW1wbGF0ZSUzQ3R5cGVuYW1lJTIwdHlwZSUzRSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlubGluZSUyMHZvaWQlMjBwdXQoY29uc3QlMjB0eXBlJTIwJTI2eCUyQ2Jvb2wlMjBmbGFnJTNEMSklN0J3cml0ZSh4KSUyQ2ZsYWclM0ZwdXRjaGFyKCclNUNuJyklM0FwdXRjaGFyKCclMjAnKSUzQiU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyM2lmbmRlZiUyMExPQ0FMJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzdW5kZWYlMjBnZXRjaGFyJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzdW5kZWYlMjBmbHVzaCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyM3VuZGVmJTIwcHV0Y2hhciUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyM2VuZGlmJTBBJTIwJTIwJTIwJTIwJTdEdXNpbmclMjBuYW1lc3BhY2UlMjBJTyUzQSUzQXVzciUzQiUwQSU3RHVzaW5nJTIwbmFtZXNwYWNlJTIwbHklM0ElM0FJTyUzQSUzQXVzciUzQiUwQWludCUyMGluJTVCXyU1RCUzQiUwQXN0cnVjdCUyME5vZGUlN0JpbnQlMjBtYXgxJTJDbWF4MiUyQ21pbjElMkNtaW4yJTJDY21pbiUyQ2NtYXglMkNzdW0lMkN0bWluJTJDdG1heCUyQ3RzdW0lM0IlN0QlMjB0cmVlJTVCXyUzQyUzQzIlNUQlM0IlMEFpbmxpbmUlMjB2b2lkJTIwcHVzaHVwKGludCUyMGspJTdCJTBBJTIwJTIwJTIwJTIwbnQuc3VtJTNEbHQuc3VtJTJCcnQuc3VtJTNCJTBBJTIwJTIwJTIwJTIwbnQubWF4MSUzRG1heChsdC5tYXgxJTJDcnQubWF4MSklM0IlMEElMjAlMjAlMjAlMjBpZihsdC5tYXgxJTNEJTNEcnQubWF4MSklMjBudC5tYXgyJTNEbWF4KGx0Lm1heDIlMkNydC5tYXgyKSUyQ250LmNtYXglM0RsdC5jbWF4JTJCcnQuY21heCUzQiUwQSUyMCUyMCUyMCUyMGVsc2UlMjBudC5tYXgyJTNEbWF4KG1pbihsdC5tYXgxJTJDcnQubWF4MSklMkNtYXgobHQubWF4MiUyQ3J0Lm1heDIpKSUyQ250LmNtYXglM0RsdC5tYXgxJTNFcnQubWF4MSUzRmx0LmNtYXglM0FydC5jbWF4JTNCJTBBJTIwJTIwJTIwJTIwbnQubWluMSUzRG1pbihsdC5taW4xJTJDcnQubWluMSklM0IlMEElMjAlMjAlMjAlMjBpZihsdC5taW4xJTNEJTNEcnQubWluMSklMjBudC5taW4yJTNEbWluKGx0Lm1pbjIlMkNydC5taW4yKSUyQ250LmNtaW4lM0RsdC5jbWluJTJCcnQuY21pbiUzQiUwQSUyMCUyMCUyMCUyMGVsc2UlMjBudC5taW4yJTNEbWluKG1heChsdC5taW4xJTJDcnQubWluMSklMkNtaW4obHQubWluMiUyQ3J0Lm1pbjIpKSUyQ250LmNtaW4lM0RsdC5taW4xJTNDcnQubWluMSUzRmx0LmNtaW4lM0FydC5jbWluJTNCJTBBJTdEJTBBdm9pZCUyMGJ1aWxkKGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciklN0IlMEElMjAlMjAlMjAlMjBudC50bWluJTNEaW5mJTJDbnQudG1heCUzRC1pbmYlMkNudC50c3VtJTNEMCUzQiUwQSUyMCUyMCUyMCUyMGlmKGwlM0QlM0RyKSUyMHJldHVybiUyMG50Lm1heDElM0RudC5taW4xJTNEbnQuc3VtJTNEaW4lNUJsJTVEJTJDbnQubWF4MiUzRC1pbmYlMkNudC5taW4yJTNEaW5mJTJDbnQuY21heCUzRG50LmNtaW4lM0QxJTJDdm9pZCgpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElM0IlMEElMjAlMjAlMjAlMjBidWlsZChscyhrKSUyQ2wlMkNtaWQpJTNCJTBBJTIwJTIwJTIwJTIwYnVpbGQocnMoayklMkNtaWQlMkIxJTJDciklM0IlMEElMjAlMjAlMjAlMjBwdXNodXAoayklM0IlMEElN0QlMEFpbmxpbmUlMjB2b2lkJTIwcHVzaHN1bShpbnQlMjBrJTJDaW50JTIwbCUyQ2ludCUyMHIlMkNpbnQlMjB2KSU3QiUwQSUyMCUyMCUyMCUyMG50LnN1bSUyQiUzRChyLWwlMkIxbGwpKnYlM0IlMEElMjAlMjAlMjAlMjBudC5tYXgxJTJCJTNEdiUyQ250Lm1pbjElMkIlM0R2JTNCJTBBJTIwJTIwJTIwJTIwaWYobnQubWF4MiElM0QtaW5mKSUyMG50Lm1heDIlMkIlM0R2JTNCJTBBJTIwJTIwJTIwJTIwaWYobnQubWluMiElM0RpbmYpJTIwbnQubWluMiUyQiUzRHYlM0IlMEElMjAlMjAlMjAlMjBpZihudC50bWluISUzRGluZiklMjBudC50bWluJTJCJTNEdiUzQiUwQSUyMCUyMCUyMCUyMGlmKG50LnRtYXghJTNELWluZiklMjBudC50bWF4JTJCJTNEdiUzQiUwQSUyMCUyMCUyMCUyMG50LnRzdW0lMkIlM0R2JTNCJTBBJTdEJTBBaW5saW5lJTIwdm9pZCUyMHB1c2htaW4oaW50JTIwayUyQ2ludCUyMHYpJTdCJTBBJTIwJTIwJTIwJTIwaWYobnQubWF4MSUzQyUzRHYpJTIwcmV0dXJuJTNCJTBBJTIwJTIwJTIwJTIwbnQuc3VtLSUzRChudC5tYXgxLXYpKm50LmNtYXglM0IlMEElMjAlMjAlMjAlMjBpZihudC5tYXgxJTNEJTNEbnQubWluMiklMjBudC5taW4yJTNEdiUzQiUwQSUyMCUyMCUyMCUyMGlmKG50Lm1heDElM0QlM0RudC5taW4xKSUyMG50Lm1pbjElM0R2JTNCJTBBJTIwJTIwJTIwJTIwbnQudG1heCUzRG1pbihudC50bWF4JTJDdiklMkNudC5tYXgxJTNEdiUyQ250LnRtaW4lM0R2JTNCJTBBJTdEJTBBaW5saW5lJTIwdm9pZCUyMHB1c2htYXgoaW50JTIwayUyQ2ludCUyMHYpJTdCJTBBJTIwJTIwJTIwJTIwaWYobnQubWluMSUzRSUzRHYpJTIwcmV0dXJuJTNCJTBBJTIwJTIwJTIwJTIwbnQuc3VtJTJCJTNEKHYtbnQubWluMSkqbnQuY21pbiUzQiUwQSUyMCUyMCUyMCUyMGlmKG50Lm1pbjElM0QlM0RudC5tYXgyKSUyMG50Lm1heDIlM0R2JTNCJTBBJTIwJTIwJTIwJTIwaWYobnQubWluMSUzRCUzRG50Lm1heDEpJTIwbnQubWF4MSUzRHYlM0IlMEElMjAlMjAlMjAlMjBudC50bWluJTNEbWF4KG50LnRtaW4lMkN2KSUyQ250Lm1pbjElM0R2JTJDbnQudG1heCUzRHYlM0IlMEElN0QlMEFpbmxpbmUlMjB2b2lkJTIwcHVzaGRvd24oaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIwbWlkKSU3QiUwQSUyMCUyMCUyMCUyMGlmKG50LnRzdW0pJTIwcHVzaHN1bShscyhrKSUyQ2wlMkNtaWQlMkNudC50c3VtKSUyQ3B1c2hzdW0ocnMoayklMkNtaWQlMkIxJTJDciUyQ250LnRzdW0pJTNCJTBBJTIwJTIwJTIwJTIwaWYobnQudG1pbiElM0RpbmYpJTIwcHVzaG1pbihscyhrKSUyQ250LnRtaW4pJTJDcHVzaG1pbihycyhrKSUyQ250LnRtaW4pJTNCJTBBJTIwJTIwJTIwJTIwaWYobnQudG1heCElM0QtaW5mKSUyMHB1c2htYXgobHMoayklMkNudC50bWF4KSUyQ3B1c2htYXgocnMoayklMkNudC50bWF4KSUzQiUwQSUyMCUyMCUyMCUyMG50LnRzdW0lM0QwJTJDbnQudG1heCUzRC1pbmYlMkNudC50bWluJTNEaW5mJTNCJTBBJTdEJTBBdm9pZCUyMG1vZGlmeV9zdW0oaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHklMkNpbnQlMjB2KSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHkpJTIwcmV0dXJuJTIwcHVzaHN1bShrJTJDbCUyQ3IlMkN2KSUyQ3ZvaWQoKSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMG1pZCUzRChsJTJCciklM0UlM0UxJTNCJTBBJTIwJTIwJTIwJTIwcHVzaGRvd24oayUyQ2wlMkNyJTJDbWlkKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwbW9kaWZ5X3N1bShscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeSUzRW1pZCklMjBtb2RpZnlfc3VtKHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwcHVzaHVwKGspJTNCJTBBJTdEJTBBdm9pZCUyMG1vZGlmeV9taW4oaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHklMkNpbnQlMjB2KSU3QiUwQSUyMCUyMCUyMCUyMGlmKG50Lm1heDElM0MlM0R2KSUyMHJldHVybiUzQiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHklMjYlMjZ2JTNFbnQubWF4MiklMjByZXR1cm4lMjBwdXNobWluKGslMkN2KSUyQ3ZvaWQoKSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMG1pZCUzRChsJTJCciklM0UlM0UxJTNCJTBBJTIwJTIwJTIwJTIwcHVzaGRvd24oayUyQ2wlMkNyJTJDbWlkKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwbW9kaWZ5X21pbihscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeSUzRW1pZCklMjBtb2RpZnlfbWluKHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwcHVzaHVwKGspJTNCJTBBJTdEJTBBdm9pZCUyMG1vZGlmeV9tYXgoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHklMkNpbnQlMjB2KSU3QiUwQSUyMCUyMCUyMCUyMGlmKG50Lm1pbjElM0UlM0R2KSUyMHJldHVybiUzQiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHklMjYlMjZ2JTNDbnQubWluMiklMjByZXR1cm4lMjBwdXNobWF4KGslMkN2KSUyQ3ZvaWQoKSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMG1pZCUzRChsJTJCciklM0UlM0UxJTNCJTBBJTIwJTIwJTIwJTIwcHVzaGRvd24oayUyQ2wlMkNyJTJDbWlkKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwbW9kaWZ5X21heChscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeSUzRW1pZCklMjBtb2RpZnlfbWF4KHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwcHVzaHVwKGspJTNCJTBBJTdEJTBBaW50JTIwcXVlcnlfc3VtKGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciUyQ2ludCUyMHglMkNpbnQlMjB5KSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHkpJTIwcmV0dXJuJTIwbnQuc3VtJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElMkNyZXMlM0QwJTNCJTBBJTIwJTIwJTIwJTIwcHVzaGRvd24oayUyQ2wlMkNyJTJDbWlkKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwcmVzJTJCJTNEcXVlcnlfc3VtKGxzKGspJTJDbCUyQ21pZCUyQ3glMkN5KSUzQiUwQSUyMCUyMCUyMCUyMGlmKHklM0VtaWQpJTIwcmVzJTJCJTNEcXVlcnlfc3VtKHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSklM0IlMEElMjAlMjAlMjAlMjByZXR1cm4lMjByZXMlM0IlMEElN0QlMEFpbnQlMjBxdWVyeV9taW4oaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHkpJTdCJTBBJTIwJTIwJTIwJTIwaWYobCUzRSUzRHglMjYlMjZyJTNDJTNEeSklMjByZXR1cm4lMjBudC5taW4xJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElMkNyZXMlM0RpbmYlM0IlMEElMjAlMjAlMjAlMjBwdXNoZG93bihrJTJDbCUyQ3IlMkNtaWQpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeCUzQyUzRG1pZCklMjByZXMlM0RtaW4ocmVzJTJDcXVlcnlfbWluKGxzKGspJTJDbCUyQ21pZCUyQ3glMkN5KSklM0IlMEElMjAlMjAlMjAlMjBpZih5JTNFbWlkKSUyMHJlcyUzRG1pbihyZXMlMkNxdWVyeV9taW4ocnMoayklMkNtaWQlMkIxJTJDciUyQ3glMkN5KSklM0IlMEElMjAlMjAlMjAlMjByZXR1cm4lMjByZXMlM0IlMEElN0QlMEFpbnQlMjBxdWVyeV9tYXgoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHkpJTdCJTBBJTIwJTIwJTIwJTIwaWYobCUzRSUzRHglMjYlMjZyJTNDJTNEeSklMjByZXR1cm4lMjBudC5tYXgxJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElMkNyZXMlM0QtaW5mJTNCJTBBJTIwJTIwJTIwJTIwcHVzaGRvd24oayUyQ2wlMkNyJTJDbWlkKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwcmVzJTNEbWF4KHJlcyUyQ3F1ZXJ5X21heChscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSkpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeSUzRW1pZCklMjByZXMlM0RtYXgocmVzJTJDcXVlcnlfbWF4KHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSkpJTNCJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwcmVzJTNCJTBBJTdEJTBBaW5saW5lJTIwdm9pZCUyMHN1YnRhc2soKSU3QiUwQSUyMCUyMCUyMCUyMGludCUyMG4lMkNtJTNCcmVhZChuKSUzQiUwQSUyMCUyMCUyMCUyMGZvcihpbnQlMjBpJTNEMSUzQmklM0MlM0RuJTNCaSUyQiUyQiklMjByZWFkKGluJTVCaSU1RCklM0IlMEElMjAlMjAlMjAlMjBidWlsZCgxJTJDMSUyQ24pJTNCcmVhZChtKSUzQiUwQSUyMCUyMCUyMCUyMHdoaWxlKG0tLSklN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbnQlMjBvcCUyQ2wlMkNyJTJDeCUzQnJlYWQob3ApJTJDcmVhZChsKSUyQ3JlYWQociklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCUzQyUzRDMpJTIwcmVhZCh4KSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKG9wJTNEJTNEMSklMjBtb2RpZnlfc3VtKDElMkMxJTJDbiUyQ2wlMkNyJTJDeCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCUzRCUzRDIpJTIwbW9kaWZ5X21heCgxJTJDMSUyQ24lMkNsJTJDciUyQ3gpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlM0QlM0QzKSUyMG1vZGlmeV9taW4oMSUyQzElMkNuJTJDbCUyQ3IlMkN4KSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKG9wJTNEJTNENCklMjBwdXQocXVlcnlfc3VtKDElMkMxJTJDbiUyQ2wlMkNyKSklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCUzRCUzRDUpJTIwcHV0KHF1ZXJ5X21heCgxJTJDMSUyQ24lMkNsJTJDcikpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlM0QlM0Q2KSUyMHB1dChxdWVyeV9taW4oMSUyQzElMkNuJTJDbCUyQ3IpKSUzQiUwQSUyMCUyMCUyMCUyMCU3RCUwQSU3RCUwQXNpZ25lZCUyMG1haW4oKSU3QiUwQSUyMCUyMCUyMCUyMCUyRiUyRmlvcyUzQSUzQXN5bmNfd2l0aF9zdGRpbyhmYWxzZSklM0IlMEElMjAlMjAlMjAlMjBpbnQlMjB0JTNEMSUzQiUyRiUyRmNpbiUzRSUzRXQlM0IlMEElMjAlMjAlMjAlMjB3aGlsZSh0LS0pJTIwc3VidGFzaygpJTNCJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwMCUzQiUwQSU3RCUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div><div>63</div><div>64</div><div>65</div><div>66</div><div>67</div><div>68</div><div>69</div><div>70</div><div>71</div><div>72</div><div>73</div><div>74</div><div>75</div><div>76</div><div>77</div><div>78</div><div>79</div><div>80</div><div>81</div><div>82</div><div>83</div><div>84</div><div>85</div><div>86</div><div>87</div><div>88</div><div>89</div><div>90</div><div>91</div><div>92</div><div>93</div><div>94</div><div>95</div><div>96</div><div>97</div><div>98</div><div>99</div><div>100</div><div>101</div><div>102</div><div>103</div><div>104</div><div>105</div><div>106</div><div>107</div><div>108</div><div>109</div><div>110</div><div>111</div><div>112</div><div>113</div><div>114</div><div>115</div><div>116</div><div>117</div><div>118</div><div>119</div><div>120</div><div>121</div><div>122</div><div>123</div><div>124</div><div>125</div><div>126</div><div>127</div><div>128</div><div>129</div><div>130</div><div>131</div><div>132</div><div>133</div><div>134</div><div>135</div><div>136</div><div>137</div><div>138</div><div>139</div><div>140</div><div>141</div><div>142</div><div>143</div><div>144</div><div>145</div><div>146</div><div>147</div><div>148</div><div>149</div><div>150</div><div>151</div><div>152</div><div>153</div><div>154</div><div>155</div><div>156</div><div>157</div><div>158</div><div>159</div><div>160</div><div>161</div><div>162</div><div>163</div><div>164</div><div>165</div><div>166</div><div>167</div><div>168</div><div>169</div><div>170</div><div>171</div><div>172</div><div>173</div><div>174</div><div>175</div><div>176</div><div>177</div><div>178</div><div>179</div><div>180</div><div>181</div><div>182</div><div>183</div></div><div class="code"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ls(k) (k)&lt;&lt;1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rs(k) (k)&lt;&lt;1|1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> debug(x) cout&lt;&lt;#x&lt;&lt;<span class="hljs-string">&quot;=&quot;</span>&lt;&lt;x&lt;&lt;endl</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> inf=<span class="hljs-number">0x3f3f3f3f3f3f3f3f</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mod=<span class="hljs-number">0</span>;
<span class="hljs-keyword">typedef</span> pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; pii;
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ 500005</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> nt tree[k]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> lt tree[ls(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rt tree[rs(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> LOCAL</span>
<span class="hljs-keyword">namespace</span> ly
{
    <span class="hljs-keyword">namespace</span> IO
    {
        <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> LOCAL</span>
            <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> maxn=<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">20</span>;
            <span class="hljs-type">char</span> in[maxn],out[maxn],*p1=in,*p2=in,*p3=out;
            <span class="hljs-meta">#<span class="hljs-keyword">define</span> getchar() (p1==p2&amp;&amp;(p2=(p1=in)+fread(in,1,maxn,stdin),p1==p2)?EOF:*p1++)</span>
            <span class="hljs-meta">#<span class="hljs-keyword">define</span> flush() (fwrite(out,1,p3-out,stdout))</span>
            <span class="hljs-meta">#<span class="hljs-keyword">define</span> putchar(x) (p3==out+maxn&amp;&amp;(flush(),p3=out),*p3++=(x))</span>
            <span class="hljs-keyword">class</span> <span class="hljs-title class_">Flush</span>{<span class="hljs-keyword">public</span>:~<span class="hljs-built_in">Flush</span>(){<span class="hljs-built_in">flush</span>();}}_;
        <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
        <span class="hljs-keyword">namespace</span> usr
        {
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;
            <span class="hljs-keyword">inline</span> type <span class="hljs-title">read</span><span class="hljs-params">(type &amp;x)</span>
            </span>{
                x=<span class="hljs-number">0</span>;<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">flag</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;<span class="hljs-type">char</span> ch=<span class="hljs-built_in">getchar</span>();
                <span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isdigit</span>(ch)) flag^=ch==<span class="hljs-string">&#x27;-&#x27;</span>,ch=<span class="hljs-built_in">getchar</span>();
                <span class="hljs-keyword">while</span>(<span class="hljs-built_in">isdigit</span>(ch)) x=(x&lt;&lt;<span class="hljs-number">1</span>)+(x&lt;&lt;<span class="hljs-number">3</span>)+(ch^<span class="hljs-number">48</span>),ch=<span class="hljs-built_in">getchar</span>();
                <span class="hljs-keyword">return</span> flag?x=-x:x;
            }
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;
            <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(type x)</span>
            </span>{
                x&lt;<span class="hljs-number">0</span>?x=-x,<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;-&#x27;</span>):<span class="hljs-number">0</span>;
                <span class="hljs-type">static</span> <span class="hljs-type">short</span> Stack[<span class="hljs-number">50</span>],<span class="hljs-built_in">top</span>(<span class="hljs-number">0</span>);
                <span class="hljs-keyword">do</span> Stack[++top]=x%<span class="hljs-number">10</span>,x/=<span class="hljs-number">10</span>;<span class="hljs-keyword">while</span>(x);
                <span class="hljs-keyword">while</span>(top) <span class="hljs-built_in">putchar</span>(Stack[top--]|<span class="hljs-number">48</span>);
            }
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">char</span> <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-type">char</span> &amp;x)</span></span>{<span class="hljs-keyword">do</span> x=<span class="hljs-built_in">getchar</span>();<span class="hljs-keyword">while</span>(<span class="hljs-built_in">isspace</span>(x));<span class="hljs-keyword">return</span> x;}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">char</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> &amp;x)</span></span>{<span class="hljs-keyword">return</span> <span class="hljs-built_in">putchar</span>(x);}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-type">char</span> *x)</span></span>{<span class="hljs-type">static</span> <span class="hljs-type">char</span> ch;<span class="hljs-built_in">read</span>(ch);<span class="hljs-keyword">do</span> *(x++)=ch;<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isspace</span>(ch=<span class="hljs-built_in">getchar</span>())&amp;&amp;~ch);}
            <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(type *x)</span></span>{<span class="hljs-keyword">while</span>(*x)<span class="hljs-built_in">putchar</span>(*(x++));}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">read</span><span class="hljs-params">(string &amp;x)</span></span>{<span class="hljs-type">static</span> <span class="hljs-type">char</span> ch;<span class="hljs-built_in">read</span>(ch),x.<span class="hljs-built_in">clear</span>();<span class="hljs-keyword">do</span> x+=ch;<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isspace</span>(ch=<span class="hljs-built_in">getchar</span>())&amp;&amp;~ch);}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">const</span> string &amp;x)</span></span>{<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>,len=x.<span class="hljs-built_in">length</span>();i&lt;len;++i)<span class="hljs-built_in">putchar</span>(x[i]);}
            <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type,<span class="hljs-keyword">typename</span>...T&gt;<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">read</span><span class="hljs-params">(type &amp;x,T&amp;...y)</span></span>{<span class="hljs-built_in">read</span>(x),<span class="hljs-built_in">read</span>(y...);}
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type,<span class="hljs-keyword">typename</span>...T&gt;
            <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">const</span> type &amp;x,<span class="hljs-type">const</span> T&amp;...y)</span></span>{<span class="hljs-built_in">write</span>(x),<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27; &#x27;</span>),<span class="hljs-built_in">write</span>(y...),<span class="hljs-keyword">sizeof</span>...(y)^<span class="hljs-number">1</span>?<span class="hljs-number">0</span>:<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);}
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;
            <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">put</span><span class="hljs-params">(<span class="hljs-type">const</span> type &amp;x,<span class="hljs-type">bool</span> flag=<span class="hljs-number">1</span>)</span></span>{<span class="hljs-built_in">write</span>(x),flag?<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>):<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27; &#x27;</span>);}
        }
        <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> LOCAL</span>
            <span class="hljs-meta">#<span class="hljs-keyword">undef</span> getchar</span>
            <span class="hljs-meta">#<span class="hljs-keyword">undef</span> flush</span>
            <span class="hljs-meta">#<span class="hljs-keyword">undef</span> putchar</span>
        <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
    }<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> IO::usr;
}<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> ly::IO::usr;
<span class="hljs-type">int</span> in[_];
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>{<span class="hljs-type">int</span> max1,max2,min1,min2,cmin,cmax,sum,tmin,tmax,tsum;} tree[_&lt;&lt;<span class="hljs-number">2</span>];
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
    nt.sum=lt.sum+rt.sum;
    nt.max1=<span class="hljs-built_in">max</span>(lt.max1,rt.max1);
    <span class="hljs-keyword">if</span>(lt.max1==rt.max1) nt.max2=<span class="hljs-built_in">max</span>(lt.max2,rt.max2),nt.cmax=lt.cmax+rt.cmax;
    <span class="hljs-keyword">else</span> nt.max2=<span class="hljs-built_in">max</span>(<span class="hljs-built_in">min</span>(lt.max1,rt.max1),<span class="hljs-built_in">max</span>(lt.max2,rt.max2)),nt.cmax=lt.max1&gt;rt.max1?lt.cmax:rt.cmax;
    nt.min1=<span class="hljs-built_in">min</span>(lt.min1,rt.min1);
    <span class="hljs-keyword">if</span>(lt.min1==rt.min1) nt.min2=<span class="hljs-built_in">min</span>(lt.min2,rt.min2),nt.cmin=lt.cmin+rt.cmin;
    <span class="hljs-keyword">else</span> nt.min2=<span class="hljs-built_in">min</span>(<span class="hljs-built_in">max</span>(lt.min1,rt.min1),<span class="hljs-built_in">min</span>(lt.min2,rt.min2)),nt.cmin=lt.min1&lt;rt.min1?lt.cmin:rt.cmin;
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>{
    nt.tmin=inf,nt.tmax=-inf,nt.tsum=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.max1=nt.min1=nt.sum=in[l],nt.max2=-inf,nt.min2=inf,nt.cmax=nt.cmin=<span class="hljs-number">1</span>,<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">ls</span>(k),l,mid);
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushsum</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> v)</span></span>{
    nt.sum+=(r-l<span class="hljs-number">+1ll</span>)*v;
    nt.max1+=v,nt.min1+=v;
    <span class="hljs-keyword">if</span>(nt.max2!=-inf) nt.max2+=v;
    <span class="hljs-keyword">if</span>(nt.min2!=inf) nt.min2+=v;
    <span class="hljs-keyword">if</span>(nt.tmin!=inf) nt.tmin+=v;
    <span class="hljs-keyword">if</span>(nt.tmax!=-inf) nt.tmax+=v;
    nt.tsum+=v;
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushmin</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(nt.max1&lt;=v) <span class="hljs-keyword">return</span>;
    nt.sum-=(nt.max1-v)*nt.cmax;
    <span class="hljs-keyword">if</span>(nt.max1==nt.min2) nt.min2=v;
    <span class="hljs-keyword">if</span>(nt.max1==nt.min1) nt.min1=v;
    nt.tmax=<span class="hljs-built_in">min</span>(nt.tmax,v),nt.max1=v,nt.tmin=v;
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushmax</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(nt.min1&gt;=v) <span class="hljs-keyword">return</span>;
    nt.sum+=(v-nt.min1)*nt.cmin;
    <span class="hljs-keyword">if</span>(nt.min1==nt.max2) nt.max2=v;
    <span class="hljs-keyword">if</span>(nt.min1==nt.max1) nt.max1=v;
    nt.tmin=<span class="hljs-built_in">max</span>(nt.tmin,v),nt.min1=v,nt.tmax=v;
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> mid)</span></span>{
    <span class="hljs-keyword">if</span>(nt.tsum) <span class="hljs-built_in">pushsum</span>(<span class="hljs-built_in">ls</span>(k),l,mid,nt.tsum),<span class="hljs-built_in">pushsum</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,nt.tsum);
    <span class="hljs-keyword">if</span>(nt.tmin!=inf) <span class="hljs-built_in">pushmin</span>(<span class="hljs-built_in">ls</span>(k),nt.tmin),<span class="hljs-built_in">pushmin</span>(<span class="hljs-built_in">rs</span>(k),nt.tmin);
    <span class="hljs-keyword">if</span>(nt.tmax!=-inf) <span class="hljs-built_in">pushmax</span>(<span class="hljs-built_in">ls</span>(k),nt.tmax),<span class="hljs-built_in">pushmax</span>(<span class="hljs-built_in">rs</span>(k),nt.tmax);
    nt.tsum=<span class="hljs-number">0</span>,nt.tmax=-inf,nt.tmin=inf;
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify_sum</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> <span class="hljs-built_in">pushsum</span>(k,l,r,v),<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">pushdown</span>(k,l,r,mid);
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify_sum</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y,v);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify_sum</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify_min</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(nt.max1&lt;=v) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y&amp;&amp;v&gt;nt.max2) <span class="hljs-keyword">return</span> <span class="hljs-built_in">pushmin</span>(k,v),<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">pushdown</span>(k,l,r,mid);
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify_min</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y,v);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify_min</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify_max</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(nt.min1&gt;=v) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y&amp;&amp;v&lt;nt.min2) <span class="hljs-keyword">return</span> <span class="hljs-built_in">pushmax</span>(k,v),<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">pushdown</span>(k,l,r,mid);
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify_max</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y,v);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify_max</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query_sum</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.sum;
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=<span class="hljs-number">0</span>;
    <span class="hljs-built_in">pushdown</span>(k,l,r,mid);
    <span class="hljs-keyword">if</span>(x&lt;=mid) res+=<span class="hljs-built_in">query_sum</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y);
    <span class="hljs-keyword">if</span>(y&gt;mid) res+=<span class="hljs-built_in">query_sum</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y);
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query_min</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.min1;
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=inf;
    <span class="hljs-built_in">pushdown</span>(k,l,r,mid);
    <span class="hljs-keyword">if</span>(x&lt;=mid) res=<span class="hljs-built_in">min</span>(res,<span class="hljs-built_in">query_min</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y));
    <span class="hljs-keyword">if</span>(y&gt;mid) res=<span class="hljs-built_in">min</span>(res,<span class="hljs-built_in">query_min</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y));
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query_max</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.max1;
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=-inf;
    <span class="hljs-built_in">pushdown</span>(k,l,r,mid);
    <span class="hljs-keyword">if</span>(x&lt;=mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query_max</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y));
    <span class="hljs-keyword">if</span>(y&gt;mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query_max</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y));
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">subtask</span><span class="hljs-params">()</span></span>{
    <span class="hljs-type">int</span> n,m;<span class="hljs-built_in">read</span>(n);
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) <span class="hljs-built_in">read</span>(in[i]);
    <span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);<span class="hljs-built_in">read</span>(m);
    <span class="hljs-keyword">while</span>(m--){
        <span class="hljs-type">int</span> op,l,r,x;<span class="hljs-built_in">read</span>(op),<span class="hljs-built_in">read</span>(l),<span class="hljs-built_in">read</span>(r);
        <span class="hljs-keyword">if</span>(op&lt;=<span class="hljs-number">3</span>) <span class="hljs-built_in">read</span>(x);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>) <span class="hljs-built_in">modify_sum</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,x);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">2</span>) <span class="hljs-built_in">modify_max</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,x);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">3</span>) <span class="hljs-built_in">modify_min</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,x);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">4</span>) <span class="hljs-built_in">put</span>(<span class="hljs-built_in">query_sum</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r));
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">5</span>) <span class="hljs-built_in">put</span>(<span class="hljs-built_in">query_max</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r));
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">6</span>) <span class="hljs-built_in">put</span>(<span class="hljs-built_in">query_min</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r));
    }
}
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">//ios::sync_with_stdio(false);</span>
    <span class="hljs-type">int</span> t=<span class="hljs-number">1</span>;<span class="hljs-comment">//cin&gt;&gt;t;</span>
    <span class="hljs-keyword">while</span>(t--) <span class="hljs-built_in">subtask</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<h3 id="qu-jian-li-shi-zui-zhi" tabindex="-1">区间历史最值</h3>
<h4 id="chuan-tong-lan-biao-ji" tabindex="-1">传统懒标记</h4>
<p>对于一些不太复杂的问题，我们可以沿用传统懒标记的做法</p>
<p><strong>P4314 CPU 监控</strong></p>
<p><a href="https://www.luogu.com.cn/problem/P4314">https://www.luogu.com.cn/problem/P4314</a></p>
<p><strong>题目描述</strong></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 个数，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> 个操作：</p>
<ol>
<li>询问区间最大值</li>
<li>询问历史区间历史最大值</li>
<li>区间加</li>
<li>区间推平</li>
</ol>
<p><strong>数据范围</strong></p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo>≤</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding="application/x-tex">1\le n,m\le 10^5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span> ，数字值域为 int 取值范围</p>
<p><strong>笔记</strong></p>
<p>本题和势能线段树没有什么关系，只是考虑以下如何用传统的懒标记解决区间历史最值问题</p>
<p>第一个难点是，既有区间加和区间推平，懒标记怎么下放。我们不难发现，作用完区间推平之后，后面无论是区间加还是区间推平，都可以归为区间推平（毕竟推平后所有数就都相等了）。所以我们可以考虑先下放区间加标记，再下放区间推平标记。下放区间加标记时，判断是否已经有了区间推平标记，如果有，就直接加到区间推平标记上，如果没有，就加到区间加标记上。下放区间推平标记就正常下放即可</p>
<p>第二个难点是如何处理区间历史最值，首先一个朴素的想法就是多维护一个区间历史最大值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>h</mi><mi>m</mi><mi>a</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">hmax</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">hma</span><span class="mord mathnormal">x</span></span></span></span> 即可，但这样就会出现问题：比如父节点一开始都为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>，然后对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span> 推平，然后对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> 推平，然后后面操作访问到子节点时，子节点只会接收到对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> 推平的懒标记，之前对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span> 推平的懒标记就被忽略了，但是子节点的历史最值是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span></p>
<p>因此我们还需要记录推平标记的历史最值，加减标记的历史最值</p>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTIzaW5jbHVkZSUzQ2JpdHMlMkZzdGRjJTJCJTJCLmglM0UlMEElMjNkZWZpbmUlMjBpbnQlMjBsb25nJTIwbG9uZyUwQSUyM2RlZmluZSUyMHVsbCUyMHVuc2lnbmVkJTIwbG9uZyUyMGxvbmclMEElMjNkZWZpbmUlMjBscyhrKSUyMChrKSUzQyUzQzElMEElMjNkZWZpbmUlMjBycyhrKSUyMChrKSUzQyUzQzElN0MxJTBBJTIzZGVmaW5lJTIwbnQlMjB0cmVlJTVCayU1RCUwQSUyM2RlZmluZSUyMGx0JTIwdHJlZSU1QmxzKGspJTVEJTBBJTIzZGVmaW5lJTIwcnQlMjB0cmVlJTVCcnMoayklNUQlMEElMjNkZWZpbmUlMjBkZWJ1Zyh4KSUyMGNvdXQlM0MlM0MlMjN4JTNDJTNDJTIyJTNEJTIyJTNDJTNDeCUzQyUzQ2VuZGwlMEF1c2luZyUyMG5hbWVzcGFjZSUyMHN0ZCUzQiUwQWNvbnN0JTIwaW50JTIwaW5mJTNEMHgzZjNmM2YzZjNmM2YzZjNmJTNCJTBBY29uc3QlMjBpbnQlMjBtb2QlM0QwJTNCJTBBJTIzZGVmaW5lJTIwXyUyMDEwMDAwNSUwQXR5cGVkZWYlMjBwYWlyJTNDaW50JTJDaW50JTNFJTIwcGlpJTNCJTBBc3RydWN0JTIwTm9kZSU3QmludCUyMG14JTJDaG14JTJDY292JTJDaGNvdiUyQ2lzY292JTJDYWRkJTJDaGFkZCUzQiU3RCUyMHRyZWUlNUJfJTNDJTNDMiU1RCUzQiUwQWludCUyMGluJTVCXyU1RCUzQiUwQWlubGluZSUyMHZvaWQlMjBwdXNodXAoaW50JTIwayklN0JudC5teCUzRG1heChsdC5teCUyQ3J0Lm14KSUyQ250LmhteCUzRG1heChsdC5obXglMkNydC5obXgpJTNCJTdEJTBBdm9pZCUyMGJ1aWxkKGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciklN0IlMEElMjAlMjAlMjAlMjBudC5pc2NvdiUzRGZhbHNlJTJDbnQuYWRkJTNEMCUzQiUwQSUyMCUyMCUyMCUyMGlmKGwlM0QlM0RyKSUyMHJldHVybiUyMG50Lm14JTNEbnQuaG14JTNEaW4lNUJsJTVEJTJDdm9pZCgpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElM0IlMEElMjAlMjAlMjAlMjBidWlsZChscyhrKSUyQ2wlMkNtaWQpJTNCYnVpbGQocnMoayklMkNtaWQlMkIxJTJDciklM0IlMEElMjAlMjAlMjAlMjBwdXNodXAoayklM0IlMEElN0QlMEF2b2lkJTIwcHVzaGNvdihpbnQlMjBrJTJDaW50JTIwdiUyQ2ludCUyMGh2KSU3QiUwQSUyMCUyMCUyMCUyMGlmKG50LmlzY292KSUyMG50Lmhjb3YlM0RtYXgobnQuaGNvdiUyQ2h2KSUzQiUwQSUyMCUyMCUyMCUyMGVsc2UlMjBudC5pc2NvdiUzRHRydWUlMkNudC5oY292JTNEaHYlM0IlMEElMjAlMjAlMjAlMjBudC5obXglM0RtYXgobnQuaG14JTJDaHYpJTNCJTBBJTIwJTIwJTIwJTIwbnQuY292JTNEbnQubXglM0R2JTNCJTBBJTIwJTIwJTIwJTIwbnQuYWRkJTNEMCUzQiUwQSU3RCUwQXZvaWQlMjBwdXNoc3VtKGludCUyMGslMkNpbnQlMjB2JTJDaW50JTIwaHYpJTdCJTBBJTIwJTIwJTIwJTIwaWYobnQuaXNjb3YpJTIwcHVzaGNvdihrJTJDbnQuY292JTJCdiUyQ250LmNvdiUyQmh2KSUzQiUwQSUyMCUyMCUyMCUyMGVsc2UlN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBudC5oYWRkJTNEbWF4KG50LmhhZGQlMkNudC5hZGQlMkJodiklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBudC5obXglM0RtYXgobnQuaG14JTJDbnQubXglMkJodiklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBudC5hZGQlMkIlM0R2JTJDbnQubXglMkIlM0R2JTNCJTBBJTIwJTIwJTIwJTIwJTdEJTBBJTdEJTBBdm9pZCUyMHB1c2hkb3duKGludCUyMGspJTdCJTBBJTIwJTIwJTIwJTIwcHVzaHN1bShscyhrKSUyQ250LmFkZCUyQ250LmhhZGQpJTNCJTBBJTIwJTIwJTIwJTIwcHVzaHN1bShycyhrKSUyQ250LmFkZCUyQ250LmhhZGQpJTNCJTJGJTJGbnQuYWRkJUU1JThGJUFGJUU4JTgzJUJEJUU0JUI4JUJBMCVFRiVCQyU4QyVFNCVCRCU4NiVFNiU5OCVBRiVFNCVCQiU4RCVFNCVCOCU4QiVFNiU5NCVCRSVFRiVCQyU4QyVFNSU5QiVBMCVFNCVCOCVCQW50LmhhZGQlRTQlQkMlOUElRTYlOUMlODklRTglQjQlQTElRTclOEMlQUUlMEElMjAlMjAlMjAlMjBudC5hZGQlM0RudC5oYWRkJTNEMCUzQiUwQSUyMCUyMCUyMCUyMGlmKG50LmlzY292KSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHB1c2hjb3YobHMoayklMkNudC5jb3YlMkNudC5oY292KSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHB1c2hjb3YocnMoayklMkNudC5jb3YlMkNudC5oY292KSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMG50LmlzY292JTNEZmFsc2UlM0IlMEElMjAlMjAlMjAlMjAlN0QlMEElN0QlMEF2b2lkJTIwbW9kaWZ5X3N1bShpbnQlMjBrJTJDaW50JTIwbCUyQ2ludCUyMHIlMkNpbnQlMjB4JTJDaW50JTIweSUyQ2ludCUyMHYpJTdCJTBBJTIwJTIwJTIwJTIwaWYobCUzRSUzRHglMjYlMjZyJTNDJTNEeSklMjByZXR1cm4lMjBwdXNoc3VtKGslMkN2JTJDdiklMkN2b2lkKCklM0IlMEElMjAlMjAlMjAlMjBwdXNoZG93bihrKSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMG1pZCUzRChsJTJCciklM0UlM0UxJTNCJTBBJTIwJTIwJTIwJTIwaWYoeCUzQyUzRG1pZCklMjBtb2RpZnlfc3VtKGxzKGspJTJDbCUyQ21pZCUyQ3glMkN5JTJDdiklM0IlMEElMjAlMjAlMjAlMjBpZih5JTNFbWlkKSUyMG1vZGlmeV9zdW0ocnMoayklMkNtaWQlMkIxJTJDciUyQ3glMkN5JTJDdiklM0IlMEElMjAlMjAlMjAlMjBwdXNodXAoayklM0IlMEElN0QlMEF2b2lkJTIwbW9kaWZ5X2NvdmVyKGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciUyQ2ludCUyMHglMkNpbnQlMjB5JTJDaW50JTIwdiklN0IlMEElMjAlMjAlMjAlMjBpZihsJTNFJTNEeCUyNiUyNnIlM0MlM0R5KSUyMHJldHVybiUyMHB1c2hjb3YoayUyQ3YlMkN2KSUyQ3ZvaWQoKSUzQiUwQSUyMCUyMCUyMCUyMHB1c2hkb3duKGspJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElM0IlMEElMjAlMjAlMjAlMjBpZih4JTNDJTNEbWlkKSUyMG1vZGlmeV9jb3ZlcihscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeSUzRW1pZCklMjBtb2RpZnlfY292ZXIocnMoayklMkNtaWQlMkIxJTJDciUyQ3glMkN5JTJDdiklM0IlMEElMjAlMjAlMjAlMjBwdXNodXAoayklM0IlMEElN0QlMEFpbnQlMjBxdWVyeV9tYXgoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHkpJTdCJTBBJTIwJTIwJTIwJTIwaWYobCUzRSUzRHglMjYlMjZyJTNDJTNEeSklMjByZXR1cm4lMjBudC5teCUzQiUwQSUyMCUyMCUyMCUyMHB1c2hkb3duKGspJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElMkNyZXMlM0QtaW5mJTNCJTBBJTIwJTIwJTIwJTIwaWYoeCUzQyUzRG1pZCklMjByZXMlM0RtYXgocmVzJTJDcXVlcnlfbWF4KGxzKGspJTJDbCUyQ21pZCUyQ3glMkN5KSklM0IlMEElMjAlMjAlMjAlMjBpZih5JTNFbWlkKSUyMHJlcyUzRG1heChyZXMlMkNxdWVyeV9tYXgocnMoayklMkNtaWQlMkIxJTJDciUyQ3glMkN5KSklM0IlMEElMjAlMjAlMjAlMjByZXR1cm4lMjByZXMlM0IlMEElN0QlMEFpbnQlMjBxdWVyeV9obWF4KGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciUyQ2ludCUyMHglMkNpbnQlMjB5KSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHkpJTIwcmV0dXJuJTIwbnQuaG14JTNCJTBBJTIwJTIwJTIwJTIwcHVzaGRvd24oayklM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUyQ3JlcyUzRC1pbmYlM0IlMEElMjAlMjAlMjAlMjBpZih4JTNDJTNEbWlkKSUyMHJlcyUzRG1heChyZXMlMkNxdWVyeV9obWF4KGxzKGspJTJDbCUyQ21pZCUyQ3glMkN5KSklM0IlMEElMjAlMjAlMjAlMjBpZih5JTNFbWlkKSUyMHJlcyUzRG1heChyZXMlMkNxdWVyeV9obWF4KHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSkpJTNCJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwcmVzJTNCJTBBJTdEJTBBaW5saW5lJTIwdm9pZCUyMHN1YnRhc2soKSU3QiUwQSUyMCUyMCUyMCUyMGludCUyMG4lM0JjaW4lM0UlM0VuJTNCJTBBJTIwJTIwJTIwJTIwZm9yKGludCUyMGklM0QxJTNCaSUzQyUzRG4lM0JpJTJCJTJCKSUyMGNpbiUzRSUzRWluJTVCaSU1RCUzQiUwQSUyMCUyMCUyMCUyMGJ1aWxkKDElMkMxJTJDbiklM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtJTNCY2luJTNFJTNFbSUzQiUwQSUyMCUyMCUyMCUyMHdoaWxlKG0tLSklN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBjaGFyJTIwb3AlM0JpbnQlMjBsJTJDciUyQ3glM0JjaW4lM0UlM0VvcCUzRSUzRWwlM0UlM0VyJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlM0QlM0QnUScpJTIwY291dCUzQyUzQ3F1ZXJ5X21heCgxJTJDMSUyQ24lMkNsJTJDciklM0MlM0NlbmRsJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlM0QlM0QnQScpJTIwY291dCUzQyUzQ3F1ZXJ5X2htYXgoMSUyQzElMkNuJTJDbCUyQ3IpJTNDJTNDZW5kbCUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKG9wJTNEJTNEJ1AnKSUyMGNpbiUzRSUzRXglMkNtb2RpZnlfc3VtKDElMkMxJTJDbiUyQ2wlMkNyJTJDeCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCUzRCUzRCdDJyklMjBjaW4lM0UlM0V4JTJDbW9kaWZ5X2NvdmVyKDElMkMxJTJDbiUyQ2wlMkNyJTJDeCklM0IlMEElMjAlMjAlMjAlMjAlN0QlMEElN0QlMEFzaWduZWQlMjBtYWluKCklN0IlMEElMjAlMjAlMjAlMjBpb3MlM0ElM0FzeW5jX3dpdGhfc3RkaW8oZmFsc2UpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwdCUzRDElM0IlMkYlMkZjaW4lM0UlM0V0JTNCJTBBJTIwJTIwJTIwJTIwd2hpbGUodC0tKSUyMHN1YnRhc2soKSUzQiUwQSUyMCUyMCUyMCUyMHJldHVybiUyMDAlM0IlMEElN0QlMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div><div>63</div><div>64</div><div>65</div><div>66</div><div>67</div><div>68</div><div>69</div><div>70</div><div>71</div><div>72</div><div>73</div><div>74</div><div>75</div><div>76</div><div>77</div><div>78</div><div>79</div><div>80</div><div>81</div><div>82</div><div>83</div><div>84</div><div>85</div><div>86</div><div>87</div><div>88</div><div>89</div><div>90</div><div>91</div><div>92</div><div>93</div><div>94</div><div>95</div><div>96</div><div>97</div><div>98</div><div>99</div><div>100</div></div><div class="code"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ls(k) (k)&lt;&lt;1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rs(k) (k)&lt;&lt;1|1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> nt tree[k]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> lt tree[ls(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rt tree[rs(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> debug(x) cout&lt;&lt;#x&lt;&lt;<span class="hljs-string">&quot;=&quot;</span>&lt;&lt;x&lt;&lt;endl</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> inf=<span class="hljs-number">0x3f3f3f3f3f3f3f3f</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mod=<span class="hljs-number">0</span>;
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ 100005</span>
<span class="hljs-keyword">typedef</span> pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; pii;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>{<span class="hljs-type">int</span> mx,hmx,cov,hcov,iscov,add,hadd;} tree[_&lt;&lt;<span class="hljs-number">2</span>];
<span class="hljs-type">int</span> in[_];
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{nt.mx=<span class="hljs-built_in">max</span>(lt.mx,rt.mx),nt.hmx=<span class="hljs-built_in">max</span>(lt.hmx,rt.hmx);}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>{
    nt.iscov=<span class="hljs-literal">false</span>,nt.add=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.mx=nt.hmx=in[l],<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">ls</span>(k),l,mid);<span class="hljs-built_in">build</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushcov</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> v,<span class="hljs-type">int</span> hv)</span></span>{
    <span class="hljs-keyword">if</span>(nt.iscov) nt.hcov=<span class="hljs-built_in">max</span>(nt.hcov,hv);
    <span class="hljs-keyword">else</span> nt.iscov=<span class="hljs-literal">true</span>,nt.hcov=hv;
    nt.hmx=<span class="hljs-built_in">max</span>(nt.hmx,hv);
    nt.cov=nt.mx=v;
    nt.add=<span class="hljs-number">0</span>;
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushsum</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> v,<span class="hljs-type">int</span> hv)</span></span>{
    <span class="hljs-keyword">if</span>(nt.iscov) <span class="hljs-built_in">pushcov</span>(k,nt.cov+v,nt.cov+hv);
    <span class="hljs-keyword">else</span>{
        nt.hadd=<span class="hljs-built_in">max</span>(nt.hadd,nt.add+hv);
        nt.hmx=<span class="hljs-built_in">max</span>(nt.hmx,nt.mx+hv);
        nt.add+=v,nt.mx+=v;
    }
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
    <span class="hljs-built_in">pushsum</span>(<span class="hljs-built_in">ls</span>(k),nt.add,nt.hadd);
    <span class="hljs-built_in">pushsum</span>(<span class="hljs-built_in">rs</span>(k),nt.add,nt.hadd);<span class="hljs-comment">//nt.add可能为0，但是仍下放，因为nt.hadd会有贡献</span>
    nt.add=nt.hadd=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(nt.iscov){
        <span class="hljs-built_in">pushcov</span>(<span class="hljs-built_in">ls</span>(k),nt.cov,nt.hcov);
        <span class="hljs-built_in">pushcov</span>(<span class="hljs-built_in">rs</span>(k),nt.cov,nt.hcov);
        nt.iscov=<span class="hljs-literal">false</span>;
    }
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify_sum</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> <span class="hljs-built_in">pushsum</span>(k,v,v),<span class="hljs-built_in">void</span>();
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify_sum</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y,v);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify_sum</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify_cover</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> <span class="hljs-built_in">pushcov</span>(k,v,v),<span class="hljs-built_in">void</span>();
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify_cover</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y,v);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify_cover</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query_max</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.mx;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=-inf;
    <span class="hljs-keyword">if</span>(x&lt;=mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query_max</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y));
    <span class="hljs-keyword">if</span>(y&gt;mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query_max</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y));
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query_hmax</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.hmx;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=-inf;
    <span class="hljs-keyword">if</span>(x&lt;=mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query_hmax</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y));
    <span class="hljs-keyword">if</span>(y&gt;mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query_hmax</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y));
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">subtask</span><span class="hljs-params">()</span></span>{
    <span class="hljs-type">int</span> n;cin&gt;&gt;n;
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) cin&gt;&gt;in[i];
    <span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);
    <span class="hljs-type">int</span> m;cin&gt;&gt;m;
    <span class="hljs-keyword">while</span>(m--){
        <span class="hljs-type">char</span> op;<span class="hljs-type">int</span> l,r,x;cin&gt;&gt;op&gt;&gt;l&gt;&gt;r;
        <span class="hljs-keyword">if</span>(op==<span class="hljs-string">&#x27;Q&#x27;</span>) cout&lt;&lt;<span class="hljs-built_in">query_max</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r)&lt;&lt;endl;
        <span class="hljs-keyword">if</span>(op==<span class="hljs-string">&#x27;A&#x27;</span>) cout&lt;&lt;<span class="hljs-built_in">query_hmax</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r)&lt;&lt;endl;
        <span class="hljs-keyword">if</span>(op==<span class="hljs-string">&#x27;P&#x27;</span>) cin&gt;&gt;x,<span class="hljs-built_in">modify_sum</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,x);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-string">&#x27;C&#x27;</span>) cin&gt;&gt;x,<span class="hljs-built_in">modify_cover</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,x);
    }
}
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-type">int</span> t=<span class="hljs-number">1</span>;<span class="hljs-comment">//cin&gt;&gt;t;</span>
    <span class="hljs-keyword">while</span>(t--) <span class="hljs-built_in">subtask</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<h4 id="zui-zhi-cao-zuo-he-wei-hu-de-zui-zhi-tong-xiang" tabindex="-1">最值操作和维护的最值同向</h4>
<p>同向指的是，比如，我维护区间最小值，操作也是区间取 min，这种情况下可以继续沿用上述传统的懒标记方法</p>
<p><strong>#164. 【清华集训2015】V</strong></p>
<p><a href="https://vjudge.net/problem/UniversalOJ-164">https://vjudge.net/problem/UniversalOJ-164</a></p>
<p><strong>题目描述</strong></p>
<p>给出一个长度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><mo>≤</mo><mn>5</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">n(n\le 5\times 10^5)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 的序列，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo stretchy="false">(</mo><mi>m</mi><mo>≤</mo><mn>5</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">m(m\le 5\times 10^5)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 次操作：</p>
<ol>
<li>区间加（非负数）</li>
<li>区间减 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> （非负数）后再对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> 取 max</li>
<li>区间推平（非负数）</li>
<li>单点询问</li>
<li>单点询问历史最大值</li>
</ol>
<p>数字值域最大为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mn>9</mn></msup></mrow><annotation encoding="application/x-tex">10^9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>笔记</strong></p>
<p>为了简单起见，我们把区间推平操作给转化为先减去正无穷，然后对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 取 max。不然再搞一个区间推平的懒标记就有点复杂了</p>
<p>于是本题和上题的区别就是多了个区间取 max，我们多维护两个懒标记：取 max 懒标记，历史最大取 max 懒标记</p>
<p>取 max 标记和加减标记下放时如何处理在前文已经说了</p>
<p>值得注意的是本题涉及到减去正无穷，所以有两个注意点：首先这个无穷值不能太小，不然我加了一堆 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>10</mn><mn>9</mn></msup></mrow><annotation encoding="application/x-tex">10^9</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">9</span></span></span></span></span></span></span></span></span></span></span>，然后再减去无穷值之后得到的结果还是正数；这个无穷值不能太大，不然我减两次无穷就炸了，代码中的解决方案是判断当前值是否小于了 <code>-inf</code>，小于的话就不再继续减了</p>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTIzaW5jbHVkZSUzQ2JpdHMlMkZzdGRjJTJCJTJCLmglM0UlMEElMjNkZWZpbmUlMjBpbnQlMjBsb25nJTIwbG9uZyUwQSUyM2RlZmluZSUyMHVsbCUyMHVuc2lnbmVkJTIwbG9uZyUyMGxvbmclMEElMjNkZWZpbmUlMjBscyhrKSUyMChrKSUzQyUzQzElMEElMjNkZWZpbmUlMjBycyhrKSUyMChrKSUzQyUzQzElN0MxJTBBJTIzZGVmaW5lJTIwbnQlMjB0cmVlJTVCayU1RCUwQSUyM2RlZmluZSUyMGx0JTIwdHJlZSU1QmxzKGspJTVEJTBBJTIzZGVmaW5lJTIwcnQlMjB0cmVlJTVCcnMoayklNUQlMEElMjNkZWZpbmUlMjBkZWJ1Zyh4KSUyMGNvdXQlM0MlM0MlMjN4JTNDJTNDJTIyJTNEJTIyJTNDJTNDeCUzQyUzQ2VuZGwlMEF1c2luZyUyMG5hbWVzcGFjZSUyMHN0ZCUzQiUwQWNvbnN0JTIwaW50JTIwaW5mJTNENWUxNCUzQiUwQWNvbnN0JTIwaW50JTIwbW9kJTNEMCUzQiUwQXR5cGVkZWYlMjBwYWlyJTNDaW50JTJDaW50JTNFJTIwcGlpJTNCJTBBJTIzZGVmaW5lJTIwXyUyMDUwMDAwNSUwQWludCUyMGluJTVCXyU1RCUyQ24lMkNtJTNCJTBBc3RydWN0JTIwTm9kZSU3QmludCUyMG14JTJDaG14JTJDYWRkJTJDaGFkZCUyQ3RteCUyQ2h0bXglM0IlN0QlMjB0cmVlJTVCXyUzQyUzQzIlNUQlM0IlMEFpbmxpbmUlMjB2b2lkJTIwcHVzaHVwKGludCUyMGspJTdCbnQubXglM0RtYXgobHQubXglMkNydC5teCklMkNudC5obXglM0RtYXgobHQuaG14JTJDcnQuaG14KSUzQiU3RCUwQXZvaWQlMjBidWlsZChpbnQlMjBrJTJDaW50JTIwbCUyQ2ludCUyMHIpJTdCJTBBJTIwJTIwJTIwJTIwbnQudG14JTNEbnQuaHRteCUzRC1pbmYlM0IlMEElMjAlMjAlMjAlMjBpZihsJTNEJTNEciklMjByZXR1cm4lMjBudC5teCUzRG50LmhteCUzRGluJTVCbCU1RCUyQ3ZvaWQoKSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMG1pZCUzRChsJTJCciklM0UlM0UxJTNCJTBBJTIwJTIwJTIwJTIwYnVpbGQobHMoayklMkNsJTJDbWlkKSUzQmJ1aWxkKHJzKGspJTJDbWlkJTJCMSUyQ3IpJTNCJTBBJTIwJTIwJTIwJTIwcHVzaHVwKGspJTNCJTBBJTdEJTBBaW5saW5lJTIwdm9pZCUyMHB1c2hhZGQoaW50JTIwayUyQ2ludCUyMHYlMkNpbnQlMjBodiklN0IlMEElMjAlMjAlMjAlMjBudC5oYWRkJTNEbWF4KG50LmhhZGQlMkNudC5hZGQlMkJodiklM0IlMEElMjAlMjAlMjAlMjBudC5obXglM0RtYXgobnQuaG14JTJDbnQubXglMkJodiklM0IlMEElMjAlMjAlMjAlMjBpZihudC50bXghJTNELWluZiklMjBudC5odG14JTNEbWF4KG50Lmh0bXglMkNudC50bXglMkJodiklMkNudC50bXglMkIlM0RudC50bXglM0MtaW5mJTNGMCUzQXYlM0IlMEElMjAlMjAlMjAlMjBudC5hZGQlMkIlM0RudC5hZGQlM0MtaW5mJTNGMCUzQXYlMkNudC5teCUyQiUzRG50Lm14JTNDLWluZiUzRjAlM0F2JTNCJTBBJTdEJTBBaW5saW5lJTIwdm9pZCUyMHB1c2htYXgoaW50JTIwayUyQ2ludCUyMHYlMkNpbnQlMjBodiklN0IlMEElMjAlMjAlMjAlMjBudC5odG14JTNEbWF4KG50Lmh0bXglMkNodiklM0IlMEElMjAlMjAlMjAlMjBudC5obXglM0RtYXgobnQuaG14JTJDbWF4KG50Lm14JTJDaHYpKSUzQiUwQSUyMCUyMCUyMCUyMG50LnRteCUzRG1heChudC50bXglMkN2KSUyQ250Lm14JTNEbWF4KG50Lm14JTJDdiklM0IlMEElN0QlMEFpbmxpbmUlMjB2b2lkJTIwcHVzaGRvd24oaW50JTIwayklN0IlMEElMjAlMjAlMjAlMjBwdXNoYWRkKGxzKGspJTJDbnQuYWRkJTJDbnQuaGFkZCklM0IlMEElMjAlMjAlMjAlMjBwdXNoYWRkKHJzKGspJTJDbnQuYWRkJTJDbnQuaGFkZCklM0IlMEElMjAlMjAlMjAlMjBudC5hZGQlM0RudC5oYWRkJTNEMCUzQiUwQSUyMCUyMCUyMCUyMGlmKG50LnRteCElM0QtaW5mKSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHB1c2htYXgobHMoayklMkNudC50bXglMkNudC5odG14KSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHB1c2htYXgocnMoayklMkNudC50bXglMkNudC5odG14KSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMG50LnRteCUzRG50Lmh0bXglM0QtaW5mJTNCJTBBJTIwJTIwJTIwJTIwJTdEJTBBJTdEJTBBdm9pZCUyMG1vZGlmeV9hZGQoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHklMkNpbnQlMjB2KSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHkpJTIwcmV0dXJuJTIwcHVzaGFkZChrJTJDdiUyQ3YpJTJDdm9pZCgpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElM0IlMEElMjAlMjAlMjAlMjBwdXNoZG93bihrKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwbW9kaWZ5X2FkZChscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeSUzRW1pZCklMjBtb2RpZnlfYWRkKHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwcHVzaHVwKGspJTNCJTBBJTdEJTBBdm9pZCUyMG1vZGlmeV9tYXgoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHklMkNpbnQlMjB2KSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHkpJTIwcmV0dXJuJTIwcHVzaG1heChrJTJDdiUyQ3YpJTJDdm9pZCgpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElM0IlMEElMjAlMjAlMjAlMjBwdXNoZG93bihrKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwbW9kaWZ5X21heChscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeSUzRW1pZCklMjBtb2RpZnlfbWF4KHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwcHVzaHVwKGspJTNCJTBBJTdEJTBBaW50JTIwcXVlcnlfcChpbnQlMjBrJTJDaW50JTIwbCUyQ2ludCUyMHIlMkNpbnQlMjB4KSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0QlM0RyKSUyMHJldHVybiUyMG50Lm14JTNCJTBBJTIwJTIwJTIwJTIwcHVzaGRvd24oayklM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwcmV0dXJuJTIwcXVlcnlfcChscyhrKSUyQ2wlMkNtaWQlMkN4KSUzQiUwQSUyMCUyMCUyMCUyMGVsc2UlMjByZXR1cm4lMjBxdWVyeV9wKHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4KSUzQiUwQSU3RCUwQWludCUyMHF1ZXJ5X2goaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCklN0IlMEElMjAlMjAlMjAlMjBpZihsJTNEJTNEciklMjByZXR1cm4lMjBudC5obXglM0IlMEElMjAlMjAlMjAlMjBwdXNoZG93bihrKSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMG1pZCUzRChsJTJCciklM0UlM0UxJTNCJTBBJTIwJTIwJTIwJTIwaWYoeCUzQyUzRG1pZCklMjByZXR1cm4lMjBxdWVyeV9oKGxzKGspJTJDbCUyQ21pZCUyQ3gpJTNCJTBBJTIwJTIwJTIwJTIwZWxzZSUyMHJldHVybiUyMHF1ZXJ5X2gocnMoayklMkNtaWQlMkIxJTJDciUyQ3gpJTNCJTBBJTdEJTBBaW5saW5lJTIwdm9pZCUyMHN1YnRhc2soKSU3QiUwQSUyMCUyMCUyMCUyMGNpbiUzRSUzRW4lM0UlM0VtJTNCJTBBJTIwJTIwJTIwJTIwZm9yKGludCUyMGklM0QxJTNCaSUzQyUzRG4lM0JpJTJCJTJCKSUyMGNpbiUzRSUzRWluJTVCaSU1RCUzQiUwQSUyMCUyMCUyMCUyMGJ1aWxkKDElMkMxJTJDbiklM0IlMEElMjAlMjAlMjAlMjB3aGlsZShtLS0pJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW50JTIwb3AlMkNsJTJDciUyQ3glM0JjaW4lM0UlM0VvcCUzRSUzRWwlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCUzRCUzRDEpJTIwY2luJTNFJTNFciUzRSUzRXglMkNtb2RpZnlfYWRkKDElMkMxJTJDbiUyQ2wlMkNyJTJDeCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCUzRCUzRDIpJTIwY2luJTNFJTNFciUzRSUzRXglMkNtb2RpZnlfYWRkKDElMkMxJTJDbiUyQ2wlMkNyJTJDLXgpJTJDbW9kaWZ5X21heCgxJTJDMSUyQ24lMkNsJTJDciUyQzApJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlM0QlM0QzKSUyMGNpbiUzRSUzRXIlM0UlM0V4JTJDbW9kaWZ5X2FkZCgxJTJDMSUyQ24lMkNsJTJDciUyQy1pbmYpJTJDbW9kaWZ5X21heCgxJTJDMSUyQ24lMkNsJTJDciUyQ3gpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlM0QlM0Q0KSUyMGNvdXQlM0MlM0NxdWVyeV9wKDElMkMxJTJDbiUyQ2wpJTNDJTNDZW5kbCUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKG9wJTNEJTNENSklMjBjb3V0JTNDJTNDcXVlcnlfaCgxJTJDMSUyQ24lMkNsKSUzQyUzQ2VuZGwlM0IlMEElMjAlMjAlMjAlMjAlN0QlMEElN0QlMEFzaWduZWQlMjBtYWluKCklN0IlMEElMjAlMjAlMjAlMjBpb3MlM0ElM0FzeW5jX3dpdGhfc3RkaW8oZmFsc2UpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwdCUzRDElM0IlMkYlMkZjaW4lM0UlM0V0JTNCJTBBJTIwJTIwJTIwJTIwd2hpbGUodC0tKSUyMHN1YnRhc2soKSUzQiUwQSUyMCUyMCUyMCUyMHJldHVybiUyMDAlM0IlMEElN0QlMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div><div>63</div><div>64</div><div>65</div><div>66</div><div>67</div><div>68</div><div>69</div><div>70</div><div>71</div><div>72</div><div>73</div><div>74</div><div>75</div><div>76</div><div>77</div><div>78</div><div>79</div><div>80</div><div>81</div><div>82</div><div>83</div><div>84</div><div>85</div><div>86</div><div>87</div><div>88</div><div>89</div><div>90</div><div>91</div><div>92</div><div>93</div><div>94</div></div><div class="code"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ls(k) (k)&lt;&lt;1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rs(k) (k)&lt;&lt;1|1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> nt tree[k]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> lt tree[ls(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rt tree[rs(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> debug(x) cout&lt;&lt;#x&lt;&lt;<span class="hljs-string">&quot;=&quot;</span>&lt;&lt;x&lt;&lt;endl</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> inf=<span class="hljs-number">5e14</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mod=<span class="hljs-number">0</span>;
<span class="hljs-keyword">typedef</span> pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; pii;
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ 500005</span>
<span class="hljs-type">int</span> in[_],n,m;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>{<span class="hljs-type">int</span> mx,hmx,add,hadd,tmx,htmx;} tree[_&lt;&lt;<span class="hljs-number">2</span>];
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{nt.mx=<span class="hljs-built_in">max</span>(lt.mx,rt.mx),nt.hmx=<span class="hljs-built_in">max</span>(lt.hmx,rt.hmx);}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>{
    nt.tmx=nt.htmx=-inf;
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.mx=nt.hmx=in[l],<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">ls</span>(k),l,mid);<span class="hljs-built_in">build</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushadd</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> v,<span class="hljs-type">int</span> hv)</span></span>{
    nt.hadd=<span class="hljs-built_in">max</span>(nt.hadd,nt.add+hv);
    nt.hmx=<span class="hljs-built_in">max</span>(nt.hmx,nt.mx+hv);
    <span class="hljs-keyword">if</span>(nt.tmx!=-inf) nt.htmx=<span class="hljs-built_in">max</span>(nt.htmx,nt.tmx+hv),nt.tmx+=nt.tmx&lt;-inf?<span class="hljs-number">0</span>:v;
    nt.add+=nt.add&lt;-inf?<span class="hljs-number">0</span>:v,nt.mx+=nt.mx&lt;-inf?<span class="hljs-number">0</span>:v;
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushmax</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> v,<span class="hljs-type">int</span> hv)</span></span>{
    nt.htmx=<span class="hljs-built_in">max</span>(nt.htmx,hv);
    nt.hmx=<span class="hljs-built_in">max</span>(nt.hmx,<span class="hljs-built_in">max</span>(nt.mx,hv));
    nt.tmx=<span class="hljs-built_in">max</span>(nt.tmx,v),nt.mx=<span class="hljs-built_in">max</span>(nt.mx,v);
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
    <span class="hljs-built_in">pushadd</span>(<span class="hljs-built_in">ls</span>(k),nt.add,nt.hadd);
    <span class="hljs-built_in">pushadd</span>(<span class="hljs-built_in">rs</span>(k),nt.add,nt.hadd);
    nt.add=nt.hadd=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span>(nt.tmx!=-inf){
        <span class="hljs-built_in">pushmax</span>(<span class="hljs-built_in">ls</span>(k),nt.tmx,nt.htmx);
        <span class="hljs-built_in">pushmax</span>(<span class="hljs-built_in">rs</span>(k),nt.tmx,nt.htmx);
        nt.tmx=nt.htmx=-inf;
    }
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify_add</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> <span class="hljs-built_in">pushadd</span>(k,v,v),<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify_add</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y,v);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify_add</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify_max</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> <span class="hljs-built_in">pushmax</span>(k,v,v),<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify_max</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y,v);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify_max</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query_p</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x)</span></span>{
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.mx;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-keyword">return</span> <span class="hljs-built_in">query_p</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">query_p</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x);
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query_h</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x)</span></span>{
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.hmx;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-keyword">return</span> <span class="hljs-built_in">query_h</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">query_h</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x);
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">subtask</span><span class="hljs-params">()</span></span>{
    cin&gt;&gt;n&gt;&gt;m;
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) cin&gt;&gt;in[i];
    <span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);
    <span class="hljs-keyword">while</span>(m--){
        <span class="hljs-type">int</span> op,l,r,x;cin&gt;&gt;op&gt;&gt;l;
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>) cin&gt;&gt;r&gt;&gt;x,<span class="hljs-built_in">modify_add</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,x);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">2</span>) cin&gt;&gt;r&gt;&gt;x,<span class="hljs-built_in">modify_add</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,-x),<span class="hljs-built_in">modify_max</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,<span class="hljs-number">0</span>);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">3</span>) cin&gt;&gt;r&gt;&gt;x,<span class="hljs-built_in">modify_add</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,-inf),<span class="hljs-built_in">modify_max</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,x);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">4</span>) cout&lt;&lt;<span class="hljs-built_in">query_p</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l)&lt;&lt;endl;
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">5</span>) cout&lt;&lt;<span class="hljs-built_in">query_h</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l)&lt;&lt;endl;
    }
}
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-type">int</span> t=<span class="hljs-number">1</span>;<span class="hljs-comment">//cin&gt;&gt;t;</span>
    <span class="hljs-keyword">while</span>(t--) <span class="hljs-built_in">subtask</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<h4 id="zui-zhi-cao-zuo-he-wei-hu-de-zui-zhi-fan-xiang" tabindex="-1">最值操作和维护的最值反向</h4>
<p>比如，我维护区间最小值，但操作是区间取 max，这时候就需要使用势能线段树了</p>
<p><strong>P6242 【模板】线段树 3（区间最值操作、区间历史最值）</strong></p>
<p><a href="https://www.luogu.com.cn/problem/P6242">https://www.luogu.com.cn/problem/P6242</a></p>
<p><strong>题目描述</strong></p>
<p>给出一个长度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 的数列 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span>，同时定义一个辅助数组 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span></span></span></span> 开始与 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> 完全相同。接下来进行了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi></mrow><annotation encoding="application/x-tex">m</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">m</span></span></span></span> 次操作，操作有五种类型，按以下格式给出：</p>
<ul>
<li><code>1 l r k</code>：对于所有的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>∈</mo><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">i\in[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span>，将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">A_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 加上 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span>（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> 可以为负数）。</li>
<li><code>2 l r v</code>：对于所有的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>∈</mo><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">i\in[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span>，将 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">A_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 变成 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>min</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>A</mi><mi>i</mi></msub><mo separator="true">,</mo><mi>v</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\min(A_i,v)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">min</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mclose">)</span></span></span></span>。</li>
<li><code>3 l r</code>：求 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mi>l</mi></mrow><mi>r</mi></msubsup><msub><mi>A</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\sum_{i=l}^{r}A_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.104em;vertical-align:-0.2997em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8043em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mathnormal mtight" style="margin-right:0.01968em;">l</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>。</li>
<li><code>4 l r</code>：对于所有的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>∈</mo><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">i\in[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span>，求 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">A_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的最大值。</li>
<li><code>5 l r</code>：对于所有的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>∈</mo><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">i\in[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6986em;vertical-align:-0.0391em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span>，求 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">B_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的最大值。</li>
</ul>
<p>在每一次操作后，我们都进行一次更新，让 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>i</mi></msub><mo>←</mo><mi>max</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>B</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>A</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">B_i\gets\max(B_i,A_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">←</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop">max</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>。</p>
<p><strong>数据范围</strong></p>
<p>对于全部测试数据，保证 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo separator="true">,</mo><mi>m</mi><mo>≤</mo><mn>5</mn><mo>×</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding="application/x-tex">1\leq n,m\leq 5\times 10^5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>5</mn><mo>×</mo><msup><mn>10</mn><mn>8</mn></msup><mo>≤</mo><msub><mi>A</mi><mi>i</mi></msub><mo>≤</mo><mn>5</mn><mo>×</mo><msup><mn>10</mn><mn>8</mn></msup></mrow><annotation encoding="application/x-tex">-5\times10^8\leq A_i\leq 5\times10^8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9501em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>p</mi><mo>∈</mo><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mn>5</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">op\in[1,5]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∈</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">5</span><span class="mclose">]</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>l</mi><mo>≤</mo><mi>r</mi><mo>≤</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">1 \leq l\leq r \leq n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.136em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>2000</mn><mo>≤</mo><mi>k</mi><mo>≤</mo><mn>2000</mn></mrow><annotation encoding="application/x-tex">-2000\leq k\leq 2000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">−</span><span class="mord">2000</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.136em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2000</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>5</mn><mo>×</mo><msup><mn>10</mn><mn>8</mn></msup><mo>≤</mo><mi>v</mi><mo>≤</mo><mn>5</mn><mo>×</mo><msup><mn>10</mn><mn>8</mn></msup></mrow><annotation encoding="application/x-tex">-5\times10^8\leq v\leq 5\times10^8</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.9501em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7719em;vertical-align:-0.136em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">5</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">8</span></span></span></span></span></span></span></span></span></span></span>。</p>
<p><strong>笔记</strong></p>
<p>如果本题没有区间历史最值的话，做法在之前已经说过了。我们回顾一下之前的做法，之前的做法中维护区间次值，实际上是把维护的数分为了两个部分：最值和非最值。如果操作仅对最值产生影响，那么可以快速处理。如果操作影响到了非最值，那么就暴力处理，同时这个划分方法确保了暴力处理是可以让势能下降的，从而确保了时间复杂度。</p>
<p>并且我们还会发现，划分数域后，所有的操作都可以视为对最值进行直接的修改，即使在某个节点上是对非最值修改，那么递归下去，也是对某个子节点的最值进行修改。这样一来，我们可以把所有的取最值操作转化为对最值的加减操作。比如当前最大值为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>，我想对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo stretchy="false">(</mo><mi>k</mi><mo>&lt;</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">k(k&lt;x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span> 取 min，那么我们可以直接让最大值减去 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi><mo>−</mo><mi>k</mi></mrow><annotation encoding="application/x-tex">x-k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">x</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span></span></span></span> ，在下传标记的时候，我们判断一下左右子节点的最大值是否是父节点的最大值，是的话就把这个仅对最大值操作的标记传过去。这个转化可以让我们抛弃掉不太好处理的区间最值标记，转向更加处理的加减标记</p>
<p>现在这道题，如果我们仍然沿用传统的懒标记方法就不太好处理了。但这种反向的特性，给了我们划分数域处理的机会。我们把区间内的数字划分为最大值和非最大值两部分，每部分维护加减懒标记和历史最大加减懒标记。</p>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTIzaW5jbHVkZSUzQ2JpdHMlMkZzdGRjJTJCJTJCLmglM0UlMEElMjNkZWZpbmUlMjBpbnQlMjBsb25nJTIwbG9uZyUwQSUyM2RlZmluZSUyMHVsbCUyMHVuc2lnbmVkJTIwbG9uZyUyMGxvbmclMEElMjNkZWZpbmUlMjBscyhrKSUyMChrKSUzQyUzQzElMEElMjNkZWZpbmUlMjBycyhrKSUyMChrKSUzQyUzQzElN0MxJTBBJTIzZGVmaW5lJTIwbnQlMjB0cmVlJTVCayU1RCUwQSUyM2RlZmluZSUyMGx0JTIwdHJlZSU1QmxzKGspJTVEJTBBJTIzZGVmaW5lJTIwcnQlMjB0cmVlJTVCcnMoayklNUQlMEElMjNkZWZpbmUlMjBkZWJ1Zyh4KSUyMGNvdXQlM0MlM0MlMjN4JTNDJTNDJTIyJTNEJTIyJTNDJTNDeCUzQyUzQ2VuZGwlMEF1c2luZyUyMG5hbWVzcGFjZSUyMHN0ZCUzQiUwQWNvbnN0JTIwaW50JTIwaW5mJTNEMHgzZjNmM2YzZjNmM2YzZjNmJTNCJTBBY29uc3QlMjBpbnQlMjBtb2QlM0QwJTNCJTBBdHlwZWRlZiUyMHBhaXIlM0NpbnQlMkNpbnQlM0UlMjBwaWklM0IlMEElMjNkZWZpbmUlMjBfJTIwNTAwMDA1JTBBc3RydWN0JTIwVGFnJTdCaW50JTIwYWRkMSUyQ2hhZGQxJTJDYWRkMiUyQ2hhZGQyJTNCJTdEJTNCJTJGJTJGMSVFNyVCQiU5MyVFNSVCMCVCRSVFNCVCOCVCQSVFNCVCRCU5QyVFNyU5NCVBOCVFNCVCQSU4RSVFNiU5QyU4MCVFNSVBNCVBNyVFRiVCQyU4QzIlRTclQkIlOTMlRTUlQjAlQkUlRTQlQjglQkElRTQlQkQlOUMlRTclOTQlQTglRTQlQkElOEUlRTYlQUMlQTElRTUlQTQlQTclMEFzdHJ1Y3QlMjBOb2RlJTdCaW50JTIwbXglMkNobXglMkNzZSUyQ3N1bSUyQ2NudDElM0JUYWclMjB0YWclM0IlN0QlMjB0cmVlJTVCXyUzQyUzQzIlNUQlM0IlMEFpbnQlMjBpbiU1Ql8lNUQlMkNuJTJDbSUzQiUwQWlubGluZSUyMHZvaWQlMjBwdXNodXAoaW50JTIwayklN0IlMEElMjAlMjAlMjAlMjBudC5zdW0lM0RsdC5zdW0lMkJydC5zdW0lM0IlMEElMjAlMjAlMjAlMjBudC5teCUzRG1heChsdC5teCUyQ3J0Lm14KSUzQiUwQSUyMCUyMCUyMCUyMG50LmhteCUzRG1heChsdC5obXglMkNydC5obXgpJTNCJTBBJTIwJTIwJTIwJTIwaWYobHQubXglM0QlM0RydC5teCklMjBudC5jbnQxJTNEbHQuY250MSUyQnJ0LmNudDElMkNudC5zZSUzRG1heChsdC5zZSUyQ3J0LnNlKSUzQiUwQSUyMCUyMCUyMCUyMGVsc2UlMjBudC5zZSUzRG1heChtaW4obHQubXglMkNydC5teCklMkNtYXgobHQuc2UlMkNydC5zZSkpJTJDbnQuY250MSUzRGx0Lm14JTNFcnQubXglM0ZsdC5jbnQxJTNBcnQuY250MSUzQiUwQSU3RCUwQXZvaWQlMjBidWlsZChpbnQlMjBrJTJDaW50JTIwbCUyQ2ludCUyMHIpJTdCJTBBJTIwJTIwJTIwJTIwaWYobCUzRCUzRHIpJTIwcmV0dXJuJTIwbnQubXglM0RudC5obXglM0RudC5zdW0lM0RpbiU1QmwlNUQlMkNudC5jbnQxJTNEMSUyQ250LnNlJTNELWluZiUyQ3ZvaWQoKSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMG1pZCUzRChsJTJCciklM0UlM0UxJTNCJTBBJTIwJTIwJTIwJTIwYnVpbGQobHMoayklMkNsJTJDbWlkKSUzQmJ1aWxkKHJzKGspJTJDbWlkJTJCMSUyQ3IpJTNCJTBBJTIwJTIwJTIwJTIwcHVzaHVwKGspJTNCJTBBJTdEJTBBaW5saW5lJTIwdm9pZCUyMHVwZGF0ZShpbnQlMjBrJTJDaW50JTIwbCUyQ2ludCUyMHIlMkNUYWclMjB0YWcpJTdCJTBBJTIwJTIwJTIwJTIwbnQuc3VtJTJCJTNEdGFnLmFkZDEqbnQuY250MSUyQnRhZy5hZGQyKihyLWwlMkIxLW50LmNudDEpJTNCJTBBJTIwJTIwJTIwJTIwbnQudGFnLmhhZGQxJTNEbWF4KG50LnRhZy5oYWRkMSUyQ250LnRhZy5hZGQxJTJCdGFnLmhhZGQxKSUzQiUwQSUyMCUyMCUyMCUyMG50LnRhZy5oYWRkMiUzRG1heChudC50YWcuaGFkZDIlMkNudC50YWcuYWRkMiUyQnRhZy5oYWRkMiklM0IlMEElMjAlMjAlMjAlMjBudC50YWcuYWRkMSUyQiUzRHRhZy5hZGQxJTNCJTBBJTIwJTIwJTIwJTIwbnQudGFnLmFkZDIlMkIlM0R0YWcuYWRkMiUzQiUwQSUyMCUyMCUyMCUyMG50LmhteCUzRG1heChudC5obXglMkNudC5teCUyQnRhZy5oYWRkMSklM0IlMEElMjAlMjAlMjAlMjBudC5teCUyQiUzRHRhZy5hZGQxJTNCJTBBJTIwJTIwJTIwJTIwaWYobnQuc2UhJTNELWluZiklMjBudC5zZSUyQiUzRHRhZy5hZGQyJTNCJTBBJTdEJTBBaW5saW5lJTIwdm9pZCUyMHB1c2hkb3duKGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciklN0IlMEElMjAlMjAlMjAlMjBpbnQlMjBteCUzRG1heChsdC5teCUyQ3J0Lm14KSUyQ21pZCUzRChsJTJCciklM0UlM0UxJTNCJTBBJTIwJTIwJTIwJTIwVGFnJTIwdGFnMSUzRG50LnRhZyUyQ3RhZzIlM0RudC50YWclM0IlMEElMjAlMjAlMjAlMjB0YWcyLmFkZDElM0RudC50YWcuYWRkMiUyQ3RhZzIuaGFkZDElM0RudC50YWcuaGFkZDIlM0IlMkYlMkYlRTYlOUUlODQlRTklODAlQTAlRTUlOEMlQkElRTklOTclQjQlRTUlODYlODUlRTYlQjIlQTElRTYlOUMlODklRTclODglQjYlRTglOEElODIlRTclODIlQjklRTYlOUMlODAlRTUlQTQlQTclRTUlODAlQkMlRTYlOTclQjYlRUYlQkMlOEMlRTklOUMlODAlRTglQTYlODElRTQlQkQlOUMlRTclOTQlQTglRTclOUElODQlRTYlQTAlODclRTglQUUlQjAlRTMlODAlODIlRTYlQUQlQTQlRTYlOTclQjYlRTUlQUQlOTAlRTglOEElODIlRTclODIlQjklRTclOUElODQlRTYlOUMlODAlRTUlQTQlQTclRTUlODAlQkMlRTclOUIlQjglRTUlQkQlOTMlRTQlQkElOEUlRTclODglQjYlRTglOEElODIlRTclODIlQjklRTclOUElODQlRTklOUQlOUUlRTYlOUMlODAlRTUlQTQlQTclRTUlODAlQkMlMEElMjAlMjAlMjAlMjBpZihteCUzRCUzRGx0Lm14KSUyMHVwZGF0ZShscyhrKSUyQ2wlMkNtaWQlMkN0YWcxKSUzQiUwQSUyMCUyMCUyMCUyMGVsc2UlMjB1cGRhdGUobHMoayklMkNsJTJDbWlkJTJDdGFnMiklM0IlMEElMjAlMjAlMjAlMjBpZihteCUzRCUzRHJ0Lm14KSUyMHVwZGF0ZShycyhrKSUyQ21pZCUyQjElMkNyJTJDdGFnMSklM0IlMEElMjAlMjAlMjAlMjBlbHNlJTIwdXBkYXRlKHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN0YWcyKSUzQiUwQSUyMCUyMCUyMCUyMG50LnRhZy5hZGQxJTNEbnQudGFnLmFkZDIlM0RudC50YWcuaGFkZDElM0RudC50YWcuaGFkZDIlM0QwJTNCJTBBJTdEJTBBdm9pZCUyMG1vZGlmeV9hZGQoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHklMkNpbnQlMjB2KSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHkpJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwVGFnJTIwdGFnJTNCdGFnLmFkZDIlM0R0YWcuaGFkZDIlM0R0YWcuYWRkMSUzRHRhZy5oYWRkMSUzRHYlM0IlMkYlMkYlRTYlOTclQTAlRTglQUUlQkElRTYlOTglQUYlRTYlOUMlODAlRTUlQTQlQTclRTUlODAlQkMlRTglQkYlOTglRTYlOTglQUYlRTklOUQlOUUlRTYlOUMlODAlRTUlQTQlQTclRTUlODAlQkMlRUYlQkMlOEMlRTklODMlQkQlRTklOUMlODAlRTglQTYlODElMkJ2JTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdXBkYXRlKGslMkNsJTJDciUyQ3RhZyklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjByZXR1cm4lM0IlMEElMjAlMjAlMjAlMjAlN0QlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUzQiUwQSUyMCUyMCUyMCUyMHB1c2hkb3duKGslMkNsJTJDciklM0IlMEElMjAlMjAlMjAlMjBpZih4JTNDJTNEbWlkKSUyMG1vZGlmeV9hZGQobHMoayklMkNsJTJDbWlkJTJDeCUyQ3klMkN2KSUzQiUwQSUyMCUyMCUyMCUyMGlmKHklM0VtaWQpJTIwbW9kaWZ5X2FkZChycyhrKSUyQ21pZCUyQjElMkNyJTJDeCUyQ3klMkN2KSUzQiUwQSUyMCUyMCUyMCUyMHB1c2h1cChrKSUzQiUwQSU3RCUwQXZvaWQlMjBtb2RpZnlfbWluKGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciUyQ2ludCUyMHglMkNpbnQlMjB5JTJDaW50JTIwdiklN0IlMEElMjAlMjAlMjAlMjBpZih2JTNFJTNEbnQubXgpJTIwcmV0dXJuJTNCJTBBJTIwJTIwJTIwJTIwaWYobCUzRSUzRHglMjYlMjZyJTNDJTNEeSUyNiUyNnYlM0VudC5zZSklN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBUYWclMjB0YWclM0J0YWcuYWRkMSUzRHRhZy5oYWRkMSUzRHYtbnQubXglMkN0YWcuYWRkMiUzRHRhZy5oYWRkMiUzRDAlM0IlMkYlMkYlRTQlQkIlODUlRTYlOUMlODAlRTUlQTQlQTclRTUlODAlQkMlRTQlQkQlOUMlRTclOTQlQTglMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB1cGRhdGUoayUyQ2wlMkNyJTJDdGFnKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHJldHVybiUzQiUwQSUyMCUyMCUyMCUyMCU3RCUwQSUyMCUyMCUyMCUyMGludCUyMG1pZCUzRChsJTJCciklM0UlM0UxJTNCJTBBJTIwJTIwJTIwJTIwcHVzaGRvd24oayUyQ2wlMkNyKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwbW9kaWZ5X21pbihscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeSUzRW1pZCklMjBtb2RpZnlfbWluKHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwcHVzaHVwKGspJTNCJTBBJTdEJTBBaW50JTIwcXVlcnlfc3VtKGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciUyQ2ludCUyMHglMkNpbnQlMjB5KSU3QiUwQSUyMCUyMCUyMCUyMGlmKGwlM0UlM0R4JTI2JTI2ciUzQyUzRHkpJTIwcmV0dXJuJTIwbnQuc3VtJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElMkNyZXMlM0QwJTNCJTBBJTIwJTIwJTIwJTIwcHVzaGRvd24oayUyQ2wlMkNyKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwcmVzJTJCJTNEcXVlcnlfc3VtKGxzKGspJTJDbCUyQ21pZCUyQ3glMkN5KSUzQiUwQSUyMCUyMCUyMCUyMGlmKHklM0VtaWQpJTIwcmVzJTJCJTNEcXVlcnlfc3VtKHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSklM0IlMEElMjAlMjAlMjAlMjByZXR1cm4lMjByZXMlM0IlMEElN0QlMEFpbnQlMjBxdWVyeV9tYXgoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHkpJTdCJTBBJTIwJTIwJTIwJTIwaWYobCUzRSUzRHglMjYlMjZyJTNDJTNEeSklMjByZXR1cm4lMjBudC5teCUzQiUwQSUyMCUyMCUyMCUyMGludCUyMG1pZCUzRChsJTJCciklM0UlM0UxJTJDcmVzJTNELWluZiUzQiUwQSUyMCUyMCUyMCUyMHB1c2hkb3duKGslMkNsJTJDciklM0IlMEElMjAlMjAlMjAlMjBpZih4JTNDJTNEbWlkKSUyMHJlcyUzRG1heChyZXMlMkNxdWVyeV9tYXgobHMoayklMkNsJTJDbWlkJTJDeCUyQ3kpKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHklM0VtaWQpJTIwcmVzJTNEbWF4KHJlcyUyQ3F1ZXJ5X21heChycyhrKSUyQ21pZCUyQjElMkNyJTJDeCUyQ3kpKSUzQiUwQSUyMCUyMCUyMCUyMHJldHVybiUyMHJlcyUzQiUwQSU3RCUwQWludCUyMHF1ZXJ5X2htYXgoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHkpJTdCJTBBJTIwJTIwJTIwJTIwaWYobCUzRSUzRHglMjYlMjZyJTNDJTNEeSklMjByZXR1cm4lMjBudC5obXglM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUyQ3JlcyUzRC1pbmYlM0IlMEElMjAlMjAlMjAlMjBwdXNoZG93bihrJTJDbCUyQ3IpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeCUzQyUzRG1pZCklMjByZXMlM0RtYXgocmVzJTJDcXVlcnlfaG1heChscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSkpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeSUzRW1pZCklMjByZXMlM0RtYXgocmVzJTJDcXVlcnlfaG1heChycyhrKSUyQ21pZCUyQjElMkNyJTJDeCUyQ3kpKSUzQiUwQSUyMCUyMCUyMCUyMHJldHVybiUyMHJlcyUzQiUwQSU3RCUwQWlubGluZSUyMHZvaWQlMjBzdWJ0YXNrKCklN0IlMEElMjAlMjAlMjAlMjBjaW4lM0UlM0VuJTNFJTNFbSUzQmZvcihpbnQlMjBpJTNEMSUzQmklM0MlM0RuJTNCaSUyQiUyQiklMjBjaW4lM0UlM0VpbiU1QmklNUQlM0IlMEElMjAlMjAlMjAlMjBidWlsZCgxJTJDMSUyQ24pJTNCJTBBJTIwJTIwJTIwJTIwd2hpbGUobS0tKSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGludCUyMG9wJTJDbCUyQ3IlMkN4JTNCY2luJTNFJTNFb3AlM0UlM0VsJTNFJTNFciUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKG9wJTNEJTNEMSklMjBjaW4lM0UlM0V4JTJDbW9kaWZ5X2FkZCgxJTJDMSUyQ24lMkNsJTJDciUyQ3gpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlM0QlM0QyKSUyMGNpbiUzRSUzRXglMkNtb2RpZnlfbWluKDElMkMxJTJDbiUyQ2wlMkNyJTJDeCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCUzRCUzRDMpJTIwY291dCUzQyUzQ3F1ZXJ5X3N1bSgxJTJDMSUyQ24lMkNsJTJDciklM0MlM0NlbmRsJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlM0QlM0Q0KSUyMGNvdXQlM0MlM0NxdWVyeV9tYXgoMSUyQzElMkNuJTJDbCUyQ3IpJTNDJTNDZW5kbCUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKG9wJTNEJTNENSklMjBjb3V0JTNDJTNDcXVlcnlfaG1heCgxJTJDMSUyQ24lMkNsJTJDciklM0MlM0NlbmRsJTNCJTBBJTIwJTIwJTIwJTIwJTdEJTBBJTdEJTBBc2lnbmVkJTIwbWFpbigpJTdCJTBBJTIwJTIwJTIwJTIwaW9zJTNBJTNBc3luY193aXRoX3N0ZGlvKGZhbHNlKSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMHQlM0QxJTNCJTJGJTJGY2luJTNFJTNFdCUzQiUwQSUyMCUyMCUyMCUyMHdoaWxlKHQtLSklMjBzdWJ0YXNrKCklM0IlMEElMjAlMjAlMjAlMjByZXR1cm4lMjAwJTNCJTBBJTdEJTBB"><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div><div>63</div><div>64</div><div>65</div><div>66</div><div>67</div><div>68</div><div>69</div><div>70</div><div>71</div><div>72</div><div>73</div><div>74</div><div>75</div><div>76</div><div>77</div><div>78</div><div>79</div><div>80</div><div>81</div><div>82</div><div>83</div><div>84</div><div>85</div><div>86</div><div>87</div><div>88</div><div>89</div><div>90</div><div>91</div><div>92</div><div>93</div><div>94</div><div>95</div><div>96</div><div>97</div><div>98</div><div>99</div><div>100</div><div>101</div><div>102</div><div>103</div><div>104</div><div>105</div><div>106</div><div>107</div><div>108</div><div>109</div><div>110</div><div>111</div><div>112</div><div>113</div><div>114</div><div>115</div><div>116</div><div>117</div></div><div class="code"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ls(k) (k)&lt;&lt;1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rs(k) (k)&lt;&lt;1|1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> nt tree[k]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> lt tree[ls(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rt tree[rs(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> debug(x) cout&lt;&lt;#x&lt;&lt;<span class="hljs-string">&quot;=&quot;</span>&lt;&lt;x&lt;&lt;endl</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> inf=<span class="hljs-number">0x3f3f3f3f3f3f3f3f</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mod=<span class="hljs-number">0</span>;
<span class="hljs-keyword">typedef</span> pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; pii;
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ 500005</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Tag</span>{<span class="hljs-type">int</span> add1,hadd1,add2,hadd2;};<span class="hljs-comment">//1结尾为作用于最大，2结尾为作用于次大</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>{<span class="hljs-type">int</span> mx,hmx,se,sum,cnt1;Tag tag;} tree[_&lt;&lt;<span class="hljs-number">2</span>];
<span class="hljs-type">int</span> in[_],n,m;
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
    nt.sum=lt.sum+rt.sum;
    nt.mx=<span class="hljs-built_in">max</span>(lt.mx,rt.mx);
    nt.hmx=<span class="hljs-built_in">max</span>(lt.hmx,rt.hmx);
    <span class="hljs-keyword">if</span>(lt.mx==rt.mx) nt.cnt1=lt.cnt1+rt.cnt1,nt.se=<span class="hljs-built_in">max</span>(lt.se,rt.se);
    <span class="hljs-keyword">else</span> nt.se=<span class="hljs-built_in">max</span>(<span class="hljs-built_in">min</span>(lt.mx,rt.mx),<span class="hljs-built_in">max</span>(lt.se,rt.se)),nt.cnt1=lt.mx&gt;rt.mx?lt.cnt1:rt.cnt1;
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>{
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.mx=nt.hmx=nt.sum=in[l],nt.cnt1=<span class="hljs-number">1</span>,nt.se=-inf,<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">ls</span>(k),l,mid);<span class="hljs-built_in">build</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,Tag tag)</span></span>{
    nt.sum+=tag.add1*nt.cnt1+tag.add2*(r-l<span class="hljs-number">+1</span>-nt.cnt1);
    nt.tag.hadd1=<span class="hljs-built_in">max</span>(nt.tag.hadd1,nt.tag.add1+tag.hadd1);
    nt.tag.hadd2=<span class="hljs-built_in">max</span>(nt.tag.hadd2,nt.tag.add2+tag.hadd2);
    nt.tag.add1+=tag.add1;
    nt.tag.add2+=tag.add2;
    nt.hmx=<span class="hljs-built_in">max</span>(nt.hmx,nt.mx+tag.hadd1);
    nt.mx+=tag.add1;
    <span class="hljs-keyword">if</span>(nt.se!=-inf) nt.se+=tag.add2;
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>{
    <span class="hljs-type">int</span> mx=<span class="hljs-built_in">max</span>(lt.mx,rt.mx),mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    Tag tag1=nt.tag,tag2=nt.tag;
    tag<span class="hljs-number">2.</span>add1=nt.tag.add2,tag<span class="hljs-number">2.</span>hadd1=nt.tag.hadd2;<span class="hljs-comment">//构造区间内没有父节点最大值时，需要作用的标记。此时子节点的最大值相当于父节点的非最大值</span>
    <span class="hljs-keyword">if</span>(mx==lt.mx) <span class="hljs-built_in">update</span>(<span class="hljs-built_in">ls</span>(k),l,mid,tag1);
    <span class="hljs-keyword">else</span> <span class="hljs-built_in">update</span>(<span class="hljs-built_in">ls</span>(k),l,mid,tag2);
    <span class="hljs-keyword">if</span>(mx==rt.mx) <span class="hljs-built_in">update</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,tag1);
    <span class="hljs-keyword">else</span> <span class="hljs-built_in">update</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,tag2);
    nt.tag.add1=nt.tag.add2=nt.tag.hadd1=nt.tag.hadd2=<span class="hljs-number">0</span>;
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify_add</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y){
        Tag tag;tag.add2=tag.hadd2=tag.add1=tag.hadd1=v;<span class="hljs-comment">//无论是最大值还是非最大值，都需要+v</span>
        <span class="hljs-built_in">update</span>(k,l,r,tag);
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">pushdown</span>(k,l,r);
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify_add</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y,v);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify_add</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify_min</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(v&gt;=nt.mx) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y&amp;&amp;v&gt;nt.se){
        Tag tag;tag.add1=tag.hadd1=v-nt.mx,tag.add2=tag.hadd2=<span class="hljs-number">0</span>;<span class="hljs-comment">//仅最大值作用</span>
        <span class="hljs-built_in">update</span>(k,l,r,tag);
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">pushdown</span>(k,l,r);
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify_min</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y,v);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify_min</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query_sum</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.sum;
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=<span class="hljs-number">0</span>;
    <span class="hljs-built_in">pushdown</span>(k,l,r);
    <span class="hljs-keyword">if</span>(x&lt;=mid) res+=<span class="hljs-built_in">query_sum</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y);
    <span class="hljs-keyword">if</span>(y&gt;mid) res+=<span class="hljs-built_in">query_sum</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y);
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query_max</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.mx;
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=-inf;
    <span class="hljs-built_in">pushdown</span>(k,l,r);
    <span class="hljs-keyword">if</span>(x&lt;=mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query_max</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y));
    <span class="hljs-keyword">if</span>(y&gt;mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query_max</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y));
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query_hmax</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.hmx;
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=-inf;
    <span class="hljs-built_in">pushdown</span>(k,l,r);
    <span class="hljs-keyword">if</span>(x&lt;=mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query_hmax</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y));
    <span class="hljs-keyword">if</span>(y&gt;mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query_hmax</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y));
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">subtask</span><span class="hljs-params">()</span></span>{
    cin&gt;&gt;n&gt;&gt;m;<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) cin&gt;&gt;in[i];
    <span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n);
    <span class="hljs-keyword">while</span>(m--){
        <span class="hljs-type">int</span> op,l,r,x;cin&gt;&gt;op&gt;&gt;l&gt;&gt;r;
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>) cin&gt;&gt;x,<span class="hljs-built_in">modify_add</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,x);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">2</span>) cin&gt;&gt;x,<span class="hljs-built_in">modify_min</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r,x);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">3</span>) cout&lt;&lt;<span class="hljs-built_in">query_sum</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r)&lt;&lt;endl;
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">4</span>) cout&lt;&lt;<span class="hljs-built_in">query_max</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r)&lt;&lt;endl;
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">5</span>) cout&lt;&lt;<span class="hljs-built_in">query_hmax</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,l,r)&lt;&lt;endl;
    }
}
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-type">int</span> t=<span class="hljs-number">1</span>;<span class="hljs-comment">//cin&gt;&gt;t;</span>
    <span class="hljs-keyword">while</span>(t--) <span class="hljs-built_in">subtask</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<h4 id="qu-jian-li-shi-zui-zhi-qiu-he" tabindex="-1">区间历史最值求和</h4>
<p><strong>题目描述</strong></p>
<p>给出一个长度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><mo>≤</mo><msup><mn>10</mn><mn>5</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">n(n\le 10^5)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 的序列，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo stretchy="false">(</mo><mi>m</mi><mo>≤</mo><msup><mn>10</mn><mn>5</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">m(m\le 10^5)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 次操作：</p>
<ol>
<li>区间加</li>
<li>询问给定区间的区间历史最大值之和</li>
</ol>
<p><strong>笔记</strong></p>
<p>我们要维护的序列为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">A_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，历史最大值为序列 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">B_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p>
<p>然后我们令 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub><mo>=</mo><msub><mi>A</mi><mi>i</mi></msub><mo>−</mo><msub><mi>B</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C_i=A_i-B_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，容易发现 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub><mo>≤</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">C_i\le 0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> 恒成立</p>
<p>当我们对 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">A_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 加 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 的时候，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 也加了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>。此时，如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 仍小于等于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>，说明 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub><mo>+</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">A_i+x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 并没有更新掉历史最大值。 如果 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 大于 0 了，说明 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub><mo>+</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">A_i+x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span> 比历史最大值还大，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>B</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">B_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 更新为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>i</mi></msub><mo>+</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">A_i+x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>，于是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 又变为了 0</p>
<p>于是我们可以再维护 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">C_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，实现 区间加、区间取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">min</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">min</span></span></span></span>、询问区间和 即可</p>
<p>询问区间历史最大值之和时，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>∑</mo><msub><mi>B</mi><mi>i</mi></msub><mo>=</mo><mo>∑</mo><msub><mi>A</mi><mi>i</mi></msub><mo>−</mo><mo>∑</mo><msub><mi>C</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\sum B_i=\sum A_i-\sum C_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0502em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span></p>
<h3 id="ti-mu" tabindex="-1">题目</h3>
<h4 id="ur-19-qian-jin-si" tabindex="-1">【UR #19】前进四</h4>
<p><strong>题目描述</strong></p>
<p>给出一个长度为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi><mo stretchy="false">(</mo><mi>n</mi><mo>≤</mo><msup><mn>10</mn><mn>6</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">n(n\le 10^6)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 的序列 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal">A</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mo stretchy="false">(</mo><mi>m</mi><mo>≤</mo><msup><mn>10</mn><mn>6</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">m(m\le 10^6)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">m</span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">6</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 个操作：</p>
<ol>
<li>将序列中指定位置修改为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span></li>
<li>给出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>x</mi></mrow><annotation encoding="application/x-tex">x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">x</span></span></span></span>，求 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>A</mi><mi>x</mi></msub><mo separator="true">,</mo><msub><mi>A</mi><mrow><mi>x</mi><mo>+</mo><mn>1</mn></mrow></msub><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mo separator="true">,</mo><msub><mi>A</mi><mi>n</mi></msub></mrow><annotation encoding="application/x-tex">A_x,A_{x+1},...,A_n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">x</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">...</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 的不同后缀最小值个数</li>
</ol>
<p><strong>笔记</strong></p>
<p>我们给每个询问和操作分配一个时间，第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> 个询问或操作的时间是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">i+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7429em;vertical-align:-0.0833em;"></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>。将序列的初始状态视为有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 个操作一，时间都是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></p>
<p>然后我们对于每个位置，求出这个位置上哪些时间段内是哪些数，比如一个位置初始时是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>，在操作 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn></mrow><annotation encoding="application/x-tex">3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span> 被修改成了 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span>，那么我们就说这个位置的数在时间段 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>∼</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">1\sim 3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">3</span></span></span></span> 是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>，在时间段 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>4</mn><mo>∼</mo><mi>q</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">4\sim q+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">4</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">∼</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn></mrow><annotation encoding="application/x-tex">5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">5</span></span></span></span></p>
<p>然后我们建立一个线段树，这个线段树的下标表示的是时间，维护在某个时间的后缀最小值为多少</p>
<p>然后我们从序列的最后一个位置开始向前枚举，当我们枚举到一个位置时，这个位置可能在不同时间有不同的数字，因此不同的时间，这个位置开始的后缀最小值也是不一样的。我们可以根据之前求出的哪些时间段内是哪些数，进行区间取 min。同时，可能还会存在关于这个位置的询问，但我们目前做的只能知道这个位置在不同时间的后缀最小值是多少</p>
<p>我们考虑，当我们从序列的最后一个位置开始向前枚举，不断在某个时间点上对一些数字取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>i</mi><mi>n</mi></mrow><annotation encoding="application/x-tex">min</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">min</span></span></span></span> 的时候，成功取 min （即取 min 后数字变得更小了）的次数即为，在当前时间点上，从当前枚举到的位置作为起点开始的后缀最小值个数。成功取 min 的次数可以在区间取 min 的时候顺手记录</p>
<p>因此，关于这个位置的询问，我们只需要根据这个询问的时间点，在线段树上进行单点询问即可</p>
<p>回顾我们这个离线的过程，从序列的最后一个位置开始向前枚举，可以使得当前的状态仅由后面的位置贡献产生；线段树维护在某个时间的后缀最小值为多少，可以做到快速处理修改操作产生的后续影响</p>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTIzaW5jbHVkZSUzQ2JpdHMlMkZzdGRjJTJCJTJCLmglM0UlMEElMjNkZWZpbmUlMjB1bGwlMjB1bnNpZ25lZCUyMGxvbmclMjBsb25nJTBBJTIzZGVmaW5lJTIwbHMoayklMjAoayklM0MlM0MxJTBBJTIzZGVmaW5lJTIwcnMoayklMjAoayklM0MlM0MxJTdDMSUwQSUyM2RlZmluZSUyMG50JTIwdHJlZSU1QmslNUQlMEElMjNkZWZpbmUlMjBsdCUyMHRyZWUlNUJscyhrKSU1RCUwQSUyM2RlZmluZSUyMHJ0JTIwdHJlZSU1QnJzKGspJTVEJTBBJTIzZGVmaW5lJTIwZGVidWcoeCklMjBjb3V0JTNDJTNDJTIzeCUzQyUzQyUyMiUzRCUyMiUzQyUzQ3glM0MlM0NlbmRsJTBBdXNpbmclMjBuYW1lc3BhY2UlMjBzdGQlM0IlMEFjb25zdCUyMGludCUyMGluZiUzRDB4M2YzZjNmM2YzZjNmM2YzZiUzQiUwQWNvbnN0JTIwaW50JTIwbW9kJTNEMCUzQiUwQXR5cGVkZWYlMjBwYWlyJTNDaW50JTJDaW50JTNFJTIwcGlpJTNCJTBBJTIzZGVmaW5lJTIwXyUyMDEwMDAwMDYlMEElMjNkZWZpbmUlMjBMT0NBTCUwQW5hbWVzcGFjZSUyMGx5JTBBJTdCJTBBJTIwJTIwJTIwJTIwbmFtZXNwYWNlJTIwSU8lMEElMjAlMjAlMjAlMjAlN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjNpZm5kZWYlMjBMT0NBTCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGNvbnN0ZXhwciUyMGF1dG8lMjBtYXhuJTNEMSUzQyUzQzIwJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwY2hhciUyMGluJTVCbWF4biU1RCUyQ291dCU1Qm1heG4lNUQlMkMqcDElM0RpbiUyQypwMiUzRGluJTJDKnAzJTNEb3V0JTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzZGVmaW5lJTIwZ2V0Y2hhcigpJTIwKHAxJTNEJTNEcDIlMjYlMjYocDIlM0QocDElM0RpbiklMkJmcmVhZChpbiUyQzElMkNtYXhuJTJDc3RkaW4pJTJDcDElM0QlM0RwMiklM0ZFT0YlM0EqcDElMkIlMkIpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzZGVmaW5lJTIwZmx1c2goKSUyMChmd3JpdGUob3V0JTJDMSUyQ3AzLW91dCUyQ3N0ZG91dCkpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzZGVmaW5lJTIwcHV0Y2hhcih4KSUyMChwMyUzRCUzRG91dCUyQm1heG4lMjYlMjYoZmx1c2goKSUyQ3AzJTNEb3V0KSUyQypwMyUyQiUyQiUzRCh4KSklMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBjbGFzcyUyMEZsdXNoJTdCcHVibGljJTNBfkZsdXNoKCklN0JmbHVzaCgpJTNCJTdEJTdEXyUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyM2VuZGlmJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwbmFtZXNwYWNlJTIwdXNyJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdGVtcGxhdGUlM0N0eXBlbmFtZSUyMHR5cGUlM0UlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbmxpbmUlMjB0eXBlJTIwcmVhZCh0eXBlJTIwJTI2eCklMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB4JTNEMCUzQmJvb2wlMjBmbGFnKDApJTNCY2hhciUyMGNoJTNEZ2V0Y2hhcigpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwd2hpbGUoIWlzZGlnaXQoY2gpKSUyMGZsYWclNUUlM0RjaCUzRCUzRCctJyUyQ2NoJTNEZ2V0Y2hhcigpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwd2hpbGUoaXNkaWdpdChjaCkpJTIweCUzRCh4JTNDJTNDMSklMkIoeCUzQyUzQzMpJTJCKGNoJTVFNDgpJTJDY2glM0RnZXRjaGFyKCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjByZXR1cm4lMjBmbGFnJTNGeCUzRC14JTNBeCUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRlbXBsYXRlJTNDdHlwZW5hbWUlMjB0eXBlJTNFJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW5saW5lJTIwdm9pZCUyMHdyaXRlKHR5cGUlMjB4KSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHglM0MwJTNGeCUzRC14JTJDcHV0Y2hhcignLScpJTNBMCUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHN0YXRpYyUyMHNob3J0JTIwU3RhY2slNUI1MCU1RCUyQ3RvcCgwKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGRvJTIwU3RhY2slNUIlMkIlMkJ0b3AlNUQlM0R4JTI1MTAlMkN4JTJGJTNEMTAlM0J3aGlsZSh4KSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHdoaWxlKHRvcCklMjBwdXRjaGFyKFN0YWNrJTVCdG9wLS0lNUQlN0M0OCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbmxpbmUlMjBjaGFyJTIwcmVhZChjaGFyJTIwJTI2eCklN0JkbyUyMHglM0RnZXRjaGFyKCklM0J3aGlsZShpc3NwYWNlKHgpKSUzQnJldHVybiUyMHglM0IlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbmxpbmUlMjBjaGFyJTIwd3JpdGUoY29uc3QlMjBjaGFyJTIwJTI2eCklN0JyZXR1cm4lMjBwdXRjaGFyKHgpJTNCJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW5saW5lJTIwdm9pZCUyMHJlYWQoY2hhciUyMCp4KSU3QnN0YXRpYyUyMGNoYXIlMjBjaCUzQnJlYWQoY2gpJTNCZG8lMjAqKHglMkIlMkIpJTNEY2glM0J3aGlsZSghaXNzcGFjZShjaCUzRGdldGNoYXIoKSklMjYlMjZ+Y2gpJTNCJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdGVtcGxhdGUlM0N0eXBlbmFtZSUyMHR5cGUlM0VpbmxpbmUlMjB2b2lkJTIwd3JpdGUodHlwZSUyMCp4KSU3QndoaWxlKCp4KXB1dGNoYXIoKih4JTJCJTJCKSklM0IlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbmxpbmUlMjB2b2lkJTIwcmVhZChzdHJpbmclMjAlMjZ4KSU3QnN0YXRpYyUyMGNoYXIlMjBjaCUzQnJlYWQoY2gpJTJDeC5jbGVhcigpJTNCZG8lMjB4JTJCJTNEY2glM0J3aGlsZSghaXNzcGFjZShjaCUzRGdldGNoYXIoKSklMjYlMjZ+Y2gpJTNCJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW5saW5lJTIwdm9pZCUyMHdyaXRlKGNvbnN0JTIwc3RyaW5nJTIwJTI2eCklN0Jmb3IoaW50JTIwaSUzRDAlMkNsZW4lM0R4Lmxlbmd0aCgpJTNCaSUzQ2xlbiUzQiUyQiUyQmkpcHV0Y2hhcih4JTVCaSU1RCklM0IlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB0ZW1wbGF0ZSUzQ3R5cGVuYW1lJTIwdHlwZSUyQ3R5cGVuYW1lLi4uVCUzRWlubGluZSUyMHZvaWQlMjByZWFkKHR5cGUlMjAlMjZ4JTJDVCUyNi4uLnkpJTdCcmVhZCh4KSUyQ3JlYWQoeS4uLiklM0IlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB0ZW1wbGF0ZSUzQ3R5cGVuYW1lJTIwdHlwZSUyQ3R5cGVuYW1lLi4uVCUzRSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlubGluZSUyMHZvaWQlMjB3cml0ZShjb25zdCUyMHR5cGUlMjAlMjZ4JTJDY29uc3QlMjBUJTI2Li4ueSklN0J3cml0ZSh4KSUyQ3B1dGNoYXIoJyUyMCcpJTJDd3JpdGUoeS4uLiklMkNzaXplb2YuLi4oeSklNUUxJTNGMCUzQXB1dGNoYXIoJyU1Q24nKSUzQiU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRlbXBsYXRlJTNDdHlwZW5hbWUlMjB0eXBlJTNFJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW5saW5lJTIwdm9pZCUyMHB1dChjb25zdCUyMHR5cGUlMjAlMjZ4JTJDYm9vbCUyMGZsYWclM0QxKSU3QndyaXRlKHgpJTJDZmxhZyUzRnB1dGNoYXIoJyU1Q24nKSUzQXB1dGNoYXIoJyUyMCcpJTNCJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzaWZuZGVmJTIwTE9DQUwlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjN1bmRlZiUyMGdldGNoYXIlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjN1bmRlZiUyMGZsdXNoJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzdW5kZWYlMjBwdXRjaGFyJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzZW5kaWYlMEElMjAlMjAlMjAlMjAlN0R1c2luZyUyMG5hbWVzcGFjZSUyMElPJTNBJTNBdXNyJTNCJTBBJTdEdXNpbmclMjBuYW1lc3BhY2UlMjBseSUzQSUzQUlPJTNBJTNBdXNyJTNCJTBBc3RydWN0JTIwTm9kZSU3QmludCUyMG14JTJDc2UlMkN2YWwlMkN0YWclM0IlN0QlMjB0cmVlJTVCXyUzQyUzQzIlNUQlM0IlMEFpbmxpbmUlMjB2b2lkJTIwcHVzaHVwKGludCUyMGspJTdCJTBBJTIwJTIwJTIwJTIwbnQubXglM0RtYXgobHQubXglMkNydC5teCklM0IlMEElMjAlMjAlMjAlMjBpZihsdC5teCUzRCUzRHJ0Lm14KSUyMG50LnNlJTNEbWF4KGx0LnNlJTJDcnQuc2UpJTNCJTBBJTIwJTIwJTIwJTIwZWxzZSUyMG50LnNlJTNEbWF4KG1pbihsdC5teCUyQ3J0Lm14KSUyQ21heChsdC5zZSUyQ3J0LnNlKSklM0IlMEElN0QlMEFpbmxpbmUlMjB2b2lkJTIwdXBkYXRlKGludCUyMGslMkNpbnQlMjB2JTJDaW50JTIwZCklN0JpZih2JTNDbnQubXgpJTIwbnQubXglM0RudC50YWclM0R2JTJDbnQudmFsJTJCJTNEZCUzQiU3RCUwQWlubGluZSUyMHZvaWQlMjBwdXNoZG93bihpbnQlMjBrKSU3QmlmKG50LnRhZyklMjB1cGRhdGUobHMoayklMkNudC50YWclMkNudC52YWwpJTJDdXBkYXRlKHJzKGspJTJDbnQudGFnJTJDbnQudmFsKSUyQ250LnRhZyUzRDAlMkNudC52YWwlM0QwJTNCJTdEJTBBdm9pZCUyMGJ1aWxkKGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciklN0IlMEElMjAlMjAlMjAlMjBpZihsJTNEJTNEciklMjByZXR1cm4lMjBudC5teCUzRGluZiUyQ250LnNlJTNELTElMkN2b2lkKCklM0IlMEElMjAlMjAlMjAlMjBpbnQlMjBtaWQlM0QobCUyQnIpJTNFJTNFMSUzQiUwQSUyMCUyMCUyMCUyMGJ1aWxkKGxzKGspJTJDbCUyQ21pZCklM0IlMEElMjAlMjAlMjAlMjBidWlsZChycyhrKSUyQ21pZCUyQjElMkNyKSUzQiUwQSUyMCUyMCUyMCUyMHB1c2h1cChrKSUzQiUwQSU3RCUwQXZvaWQlMjBtb2RpZnkoaW50JTIwayUyQ2ludCUyMGwlMkNpbnQlMjByJTJDaW50JTIweCUyQ2ludCUyMHklMkNpbnQlMjB2KSU3QiUwQSUyMCUyMCUyMCUyMGlmKG50Lm14JTNDJTNEdiklMjByZXR1cm4lM0IlMEElMjAlMjAlMjAlMjBpZihsJTNFJTNEeCUyNiUyNnIlM0MlM0R5JTI2JTI2bnQuc2UlM0N2KSUyMHJldHVybiUyMHVwZGF0ZShrJTJDdiUyQzEpJTJDdm9pZCgpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElM0IlMEElMjAlMjAlMjAlMjBwdXNoZG93bihrKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwbW9kaWZ5KGxzKGspJTJDbCUyQ21pZCUyQ3glMkN5JTJDdiklM0IlMEElMjAlMjAlMjAlMjBpZih5JTNFbWlkKSUyMG1vZGlmeShycyhrKSUyQ21pZCUyQjElMkNyJTJDeCUyQ3klMkN2KSUzQiUwQSUyMCUyMCUyMCUyMHB1c2h1cChrKSUzQiUwQSU3RCUwQWludCUyMHF1ZXJ5KGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciUyQ2ludCUyMHgpJTdCJTBBJTIwJTIwJTIwJTIwaWYobCUzRCUzRHIpJTIwcmV0dXJuJTIwbnQudmFsJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElM0IlMEElMjAlMjAlMjAlMjBwdXNoZG93bihrKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHglM0MlM0RtaWQpJTIwcmV0dXJuJTIwcXVlcnkobHMoayklMkNsJTJDbWlkJTJDeCklM0IlMEElMjAlMjAlMjAlMjBlbHNlJTIwcmV0dXJuJTIwcXVlcnkocnMoayklMkNtaWQlMkIxJTJDciUyQ3gpJTNCJTBBJTdEJTBBc3RydWN0JTIwTyU3QmludCUyMHglMkNsJTJDciUzQiU3RCUzQiUwQXN0cnVjdCUyMFElN0JpbnQlMjBpZCUyQ3RpbWUlM0IlN0QlM0IlMEF2ZWN0b3IlM0NPJTNFJTIwZyU1Ql8lNUQlM0IlMEF2ZWN0b3IlM0NRJTNFJTIwcSU1Ql8lNUQlM0IlMEFpbnQlMjBjbnRxJTJDYW5zJTVCXyU1RCUzQiUwQWlubGluZSUyMHZvaWQlMjBzdWJ0YXNrKCklN0IlMEElMjAlMjAlMjAlMjBpbnQlMjBuJTJDbSUzQnJlYWQobiklMkNyZWFkKG0pJTNCJTBBJTIwJTIwJTIwJTIwZm9yKGludCUyMGklM0QxJTJDeCUzQmklM0MlM0RuJTNCaSUyQiUyQiklMjByZWFkKHgpJTJDZyU1QmklNUQucHVzaF9iYWNrKE8lN0J4JTJDMSUyQ20lMkIxJTdEKSUzQiUwQSUyMCUyMCUyMCUyMGZvcihpbnQlMjBpJTNEMSUzQmklM0MlM0RtJTNCaSUyQiUyQiklN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbnQlMjBvcCUyQ3glMkN2JTNCcmVhZChvcCklMkNyZWFkKHgpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlM0QlM0QxKSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHJlYWQodiklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAoKigtLWclNUJ4JTVELmVuZCgpKSkuciUzRGktMSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGclNUJ4JTVELnB1c2hfYmFjayhPJTdCdiUyQ2klMkNtJTJCMSU3RCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0RlbHNlJTIwcSU1QnglNUQucHVzaF9iYWNrKFElN0IlMkIlMkJjbnRxJTJDaSU3RCklM0IlMEElMjAlMjAlMjAlMjAlN0QlMEElMjAlMjAlMjAlMjBidWlsZCgxJTJDMSUyQ20lMkIxKSUzQiUwQSUyMCUyMCUyMCUyMGZvcihpbnQlMjBpJTNEbiUzQmklM0UlM0QxJTNCaS0tKSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGZvcihhdXRvJTIwdG8lM0FnJTVCaSU1RCklMjBtb2RpZnkoMSUyQzElMkNtJTJCMSUyQ3RvLmwlMkN0by5yJTJDdG8ueCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBmb3IoYXV0byUyMHRvJTNBcSU1QmklNUQpJTIwYW5zJTVCdG8uaWQlNUQlM0RxdWVyeSgxJTJDMSUyQ20lMkIxJTJDdG8udGltZSklM0IlMEElMjAlMjAlMjAlMjAlN0QlMEElMjAlMjAlMjAlMjBmb3IoaW50JTIwaSUzRDElM0JpJTNDJTNEY250cSUzQmklMkIlMkIpJTIwcHV0KGFucyU1QmklNUQpJTNCJTBBJTdEJTBBc2lnbmVkJTIwbWFpbigpJTdCJTBBJTIwJTIwJTIwJTIwJTJGJTJGaW9zJTNBJTNBc3luY193aXRoX3N0ZGlvKGZhbHNlKSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMHQlM0QxJTNCJTJGJTJGY2luJTNFJTNFdCUzQiUwQSUyMCUyMCUyMCUyMHdoaWxlKHQtLSklMjBzdWJ0YXNrKCklM0IlMEElMjAlMjAlMjAlMjByZXR1cm4lMjAwJTNCJTBBJTdEJTBB"><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div><div>63</div><div>64</div><div>65</div><div>66</div><div>67</div><div>68</div><div>69</div><div>70</div><div>71</div><div>72</div><div>73</div><div>74</div><div>75</div><div>76</div><div>77</div><div>78</div><div>79</div><div>80</div><div>81</div><div>82</div><div>83</div><div>84</div><div>85</div><div>86</div><div>87</div><div>88</div><div>89</div><div>90</div><div>91</div><div>92</div><div>93</div><div>94</div><div>95</div><div>96</div><div>97</div><div>98</div><div>99</div><div>100</div><div>101</div><div>102</div><div>103</div><div>104</div><div>105</div><div>106</div><div>107</div><div>108</div><div>109</div><div>110</div><div>111</div><div>112</div><div>113</div><div>114</div><div>115</div><div>116</div><div>117</div><div>118</div><div>119</div><div>120</div><div>121</div><div>122</div><div>123</div></div><div class="code"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ls(k) (k)&lt;&lt;1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rs(k) (k)&lt;&lt;1|1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> nt tree[k]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> lt tree[ls(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rt tree[rs(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> debug(x) cout&lt;&lt;#x&lt;&lt;<span class="hljs-string">&quot;=&quot;</span>&lt;&lt;x&lt;&lt;endl</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> inf=<span class="hljs-number">0x3f3f3f3f3f3f3f3f</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mod=<span class="hljs-number">0</span>;
<span class="hljs-keyword">typedef</span> pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; pii;
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ 1000006</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> LOCAL</span>
<span class="hljs-keyword">namespace</span> ly
{
    <span class="hljs-keyword">namespace</span> IO
    {
        <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> LOCAL</span>
            <span class="hljs-keyword">constexpr</span> <span class="hljs-keyword">auto</span> maxn=<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">20</span>;
            <span class="hljs-type">char</span> in[maxn],out[maxn],*p1=in,*p2=in,*p3=out;
            <span class="hljs-meta">#<span class="hljs-keyword">define</span> getchar() (p1==p2&amp;&amp;(p2=(p1=in)+fread(in,1,maxn,stdin),p1==p2)?EOF:*p1++)</span>
            <span class="hljs-meta">#<span class="hljs-keyword">define</span> flush() (fwrite(out,1,p3-out,stdout))</span>
            <span class="hljs-meta">#<span class="hljs-keyword">define</span> putchar(x) (p3==out+maxn&amp;&amp;(flush(),p3=out),*p3++=(x))</span>
            <span class="hljs-keyword">class</span> <span class="hljs-title class_">Flush</span>{<span class="hljs-keyword">public</span>:~<span class="hljs-built_in">Flush</span>(){<span class="hljs-built_in">flush</span>();}}_;
        <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
        <span class="hljs-keyword">namespace</span> usr
        {
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;
            <span class="hljs-keyword">inline</span> type <span class="hljs-title">read</span><span class="hljs-params">(type &amp;x)</span>
            </span>{
                x=<span class="hljs-number">0</span>;<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">flag</span><span class="hljs-params">(<span class="hljs-number">0</span>)</span></span>;<span class="hljs-type">char</span> ch=<span class="hljs-built_in">getchar</span>();
                <span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isdigit</span>(ch)) flag^=ch==<span class="hljs-string">&#x27;-&#x27;</span>,ch=<span class="hljs-built_in">getchar</span>();
                <span class="hljs-keyword">while</span>(<span class="hljs-built_in">isdigit</span>(ch)) x=(x&lt;&lt;<span class="hljs-number">1</span>)+(x&lt;&lt;<span class="hljs-number">3</span>)+(ch^<span class="hljs-number">48</span>),ch=<span class="hljs-built_in">getchar</span>();
                <span class="hljs-keyword">return</span> flag?x=-x:x;
            }
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;
            <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(type x)</span>
            </span>{
                x&lt;<span class="hljs-number">0</span>?x=-x,<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;-&#x27;</span>):<span class="hljs-number">0</span>;
                <span class="hljs-type">static</span> <span class="hljs-type">short</span> Stack[<span class="hljs-number">50</span>],<span class="hljs-built_in">top</span>(<span class="hljs-number">0</span>);
                <span class="hljs-keyword">do</span> Stack[++top]=x%<span class="hljs-number">10</span>,x/=<span class="hljs-number">10</span>;<span class="hljs-keyword">while</span>(x);
                <span class="hljs-keyword">while</span>(top) <span class="hljs-built_in">putchar</span>(Stack[top--]|<span class="hljs-number">48</span>);
            }
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">char</span> <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-type">char</span> &amp;x)</span></span>{<span class="hljs-keyword">do</span> x=<span class="hljs-built_in">getchar</span>();<span class="hljs-keyword">while</span>(<span class="hljs-built_in">isspace</span>(x));<span class="hljs-keyword">return</span> x;}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">char</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> &amp;x)</span></span>{<span class="hljs-keyword">return</span> <span class="hljs-built_in">putchar</span>(x);}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">read</span><span class="hljs-params">(<span class="hljs-type">char</span> *x)</span></span>{<span class="hljs-type">static</span> <span class="hljs-type">char</span> ch;<span class="hljs-built_in">read</span>(ch);<span class="hljs-keyword">do</span> *(x++)=ch;<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isspace</span>(ch=<span class="hljs-built_in">getchar</span>())&amp;&amp;~ch);}
            <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(type *x)</span></span>{<span class="hljs-keyword">while</span>(*x)<span class="hljs-built_in">putchar</span>(*(x++));}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">read</span><span class="hljs-params">(string &amp;x)</span></span>{<span class="hljs-type">static</span> <span class="hljs-type">char</span> ch;<span class="hljs-built_in">read</span>(ch),x.<span class="hljs-built_in">clear</span>();<span class="hljs-keyword">do</span> x+=ch;<span class="hljs-keyword">while</span>(!<span class="hljs-built_in">isspace</span>(ch=<span class="hljs-built_in">getchar</span>())&amp;&amp;~ch);}
            <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">const</span> string &amp;x)</span></span>{<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">0</span>,len=x.<span class="hljs-built_in">length</span>();i&lt;len;++i)<span class="hljs-built_in">putchar</span>(x[i]);}
            <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type,<span class="hljs-keyword">typename</span>...T&gt;<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">read</span><span class="hljs-params">(type &amp;x,T&amp;...y)</span></span>{<span class="hljs-built_in">read</span>(x),<span class="hljs-built_in">read</span>(y...);}
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type,<span class="hljs-keyword">typename</span>...T&gt;
            <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">write</span><span class="hljs-params">(<span class="hljs-type">const</span> type &amp;x,<span class="hljs-type">const</span> T&amp;...y)</span></span>{<span class="hljs-built_in">write</span>(x),<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27; &#x27;</span>),<span class="hljs-built_in">write</span>(y...),<span class="hljs-keyword">sizeof</span>...(y)^<span class="hljs-number">1</span>?<span class="hljs-number">0</span>:<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>);}
            <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> type&gt;
            <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">put</span><span class="hljs-params">(<span class="hljs-type">const</span> type &amp;x,<span class="hljs-type">bool</span> flag=<span class="hljs-number">1</span>)</span></span>{<span class="hljs-built_in">write</span>(x),flag?<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;\n&#x27;</span>):<span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27; &#x27;</span>);}
        }
        <span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> LOCAL</span>
            <span class="hljs-meta">#<span class="hljs-keyword">undef</span> getchar</span>
            <span class="hljs-meta">#<span class="hljs-keyword">undef</span> flush</span>
            <span class="hljs-meta">#<span class="hljs-keyword">undef</span> putchar</span>
        <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
    }<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> IO::usr;
}<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> ly::IO::usr;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>{<span class="hljs-type">int</span> mx,se,val,tag;} tree[_&lt;&lt;<span class="hljs-number">2</span>];
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
    nt.mx=<span class="hljs-built_in">max</span>(lt.mx,rt.mx);
    <span class="hljs-keyword">if</span>(lt.mx==rt.mx) nt.se=<span class="hljs-built_in">max</span>(lt.se,rt.se);
    <span class="hljs-keyword">else</span> nt.se=<span class="hljs-built_in">max</span>(<span class="hljs-built_in">min</span>(lt.mx,rt.mx),<span class="hljs-built_in">max</span>(lt.se,rt.se));
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> v,<span class="hljs-type">int</span> d)</span></span>{<span class="hljs-keyword">if</span>(v&lt;nt.mx) nt.mx=nt.tag=v,nt.val+=d;}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{<span class="hljs-keyword">if</span>(nt.tag) <span class="hljs-built_in">update</span>(<span class="hljs-built_in">ls</span>(k),nt.tag,nt.val),<span class="hljs-built_in">update</span>(<span class="hljs-built_in">rs</span>(k),nt.tag,nt.val),nt.tag=<span class="hljs-number">0</span>,nt.val=<span class="hljs-number">0</span>;}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">build</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>{
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.mx=inf,nt.se=<span class="hljs-number">-1</span>,<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">ls</span>(k),l,mid);
    <span class="hljs-built_in">build</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(nt.mx&lt;=v) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y&amp;&amp;nt.se&lt;v) <span class="hljs-keyword">return</span> <span class="hljs-built_in">update</span>(k,v,<span class="hljs-number">1</span>),<span class="hljs-built_in">void</span>();
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y,v);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x)</span></span>{
    <span class="hljs-keyword">if</span>(l==r) <span class="hljs-keyword">return</span> nt.val;
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">query</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x);
}
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">O</span>{<span class="hljs-type">int</span> x,l,r;};
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Q</span>{<span class="hljs-type">int</span> id,time;};
vector&lt;O&gt; g[_];
vector&lt;Q&gt; q[_];
<span class="hljs-type">int</span> cntq,ans[_];
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">subtask</span><span class="hljs-params">()</span></span>{
    <span class="hljs-type">int</span> n,m;<span class="hljs-built_in">read</span>(n),<span class="hljs-built_in">read</span>(m);
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>,x;i&lt;=n;i++) <span class="hljs-built_in">read</span>(x),g[i].<span class="hljs-built_in">push_back</span>(O{x,<span class="hljs-number">1</span>,m<span class="hljs-number">+1</span>});
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++){
        <span class="hljs-type">int</span> op,x,v;<span class="hljs-built_in">read</span>(op),<span class="hljs-built_in">read</span>(x);
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>){
            <span class="hljs-built_in">read</span>(v);
            (*(--g[x].<span class="hljs-built_in">end</span>())).r=i<span class="hljs-number">-1</span>;
            g[x].<span class="hljs-built_in">push_back</span>(O{v,i,m<span class="hljs-number">+1</span>});
        }<span class="hljs-keyword">else</span> q[x].<span class="hljs-built_in">push_back</span>(Q{++cntq,i});
    }
    <span class="hljs-built_in">build</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,m<span class="hljs-number">+1</span>);
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=n;i&gt;=<span class="hljs-number">1</span>;i--){
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> to:g[i]) <span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,m<span class="hljs-number">+1</span>,to.l,to.r,to.x);
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">auto</span> to:q[i]) ans[to.id]=<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,m<span class="hljs-number">+1</span>,to.time);
    }
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=cntq;i++) <span class="hljs-built_in">put</span>(ans[i]);
}
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-comment">//ios::sync_with_stdio(false);</span>
    <span class="hljs-type">int</span> t=<span class="hljs-number">1</span>;<span class="hljs-comment">//cin&gt;&gt;t;</span>
    <span class="hljs-keyword">while</span>(t--) <span class="hljs-built_in">subtask</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<h4 id="gss-2-can-you-answer-these-queries-ii" tabindex="-1">GSS2 - Can you answer these queries II</h4>
<p><a href="https://www.luogu.com.cn/problem/SP1557">https://www.luogu.com.cn/problem/SP1557</a></p>
<p><strong>题目描述</strong></p>
<p>给出 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 个数，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi></mrow><annotation encoding="application/x-tex">q</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span></span></span></span> 次询问，求最大字段和，相同的数字只算一次，选出的子段可以为空，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>≤</mo><mi>n</mi><mo separator="true">,</mo><mi>q</mi><mo>≤</mo><msup><mn>10</mn><mn>5</mn></msup></mrow><annotation encoding="application/x-tex">1\le n,q\le 10^5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7804em;vertical-align:-0.136em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8304em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">n</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord">1</span><span class="mord"><span class="mord">0</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">5</span></span></span></span></span></span></span></span></span></span></span></p>
<p><strong>笔记</strong></p>
<p>先不考虑相同的数字只算一次如何处理</p>
<p>先把询问离线下来，按询问区间右端点从小到大排序。然后枚举询问，不断从左到右添加数字到线段树中，直到添加的位置到达了询问的右端点。对于第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> 个数字 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">a_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，我们让线段树上区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>1</mn><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[1,i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span> 全加上 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">a_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，这样线段树上维护的就是从当前询问的右端点开始，往前的前缀和</p>
<p>但是我们选出的子段不一定要包含当前询问的右端点。比如最大子段是区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span>，当前询问的右端点为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span>，那么<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> 到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> 之间的数字是不应该产生贡献的，也就是之前线段树 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> 位置的值很大，但随着 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> 到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span> 之间的数字加入，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> 位置的值变小了。我们发现为了得到 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>l</mi></mrow><annotation encoding="application/x-tex">l</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span></span></span></span> 位置的最大值，可以考虑维护区间的历史最大值</p>
<p>现在考虑相同的数字只算一次，我们只需要记录当前数字 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">a_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 上一次的出现位置 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span>，然后让区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>p</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>i</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[p+1,i]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">i</span><span class="mclose">]</span></span></span></span> 加上 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>a</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">a_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 就可以了</p>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTIzaW5jbHVkZSUzQ2JpdHMlMkZzdGRjJTJCJTJCLmglM0UlMEElMjNkZWZpbmUlMjBpbnQlMjBsb25nJTIwbG9uZyUwQSUyM2RlZmluZSUyMHVsbCUyMHVuc2lnbmVkJTIwbG9uZyUyMGxvbmclMEElMjNkZWZpbmUlMjBscyhrKSUyMChrKSUzQyUzQzElMEElMjNkZWZpbmUlMjBycyhrKSUyMChrKSUzQyUzQzElN0MxJTBBJTIzZGVmaW5lJTIwbnQlMjB0cmVlJTVCayU1RCUwQSUyM2RlZmluZSUyMGx0JTIwdHJlZSU1QmxzKGspJTVEJTBBJTIzZGVmaW5lJTIwcnQlMjB0cmVlJTVCcnMoayklNUQlMEElMjNkZWZpbmUlMjBkZWJ1Zyh4KSUyMGNvdXQlM0MlM0MlMjN4JTNDJTNDJTIyJTNEJTIyJTNDJTNDeCUzQyUzQ2VuZGwlMEF1c2luZyUyMG5hbWVzcGFjZSUyMHN0ZCUzQiUwQWNvbnN0JTIwaW50JTIwaW5mJTNEMHgzZjNmM2YzZjNmM2YzZjNmJTNCJTBBY29uc3QlMjBpbnQlMjBtb2QlM0QwJTNCJTBBdHlwZWRlZiUyMHBhaXIlM0NpbnQlMkNpbnQlM0UlMjBwaWklM0IlMEElMjNkZWZpbmUlMjBfJTIwMTAwMDA1JTBBY29uc3QlMjBpbnQlMjBvZmYlM0QxMDAwMDAlM0IlMEFzdHJ1Y3QlMjBOb2RlJTdCaW50JTIwYWRkJTJDaGFkZCUyQ214JTJDaG14JTNCJTdEJTIwdHJlZSU1Ql8lM0MlM0MyJTVEJTNCJTBBaW50JTIwbiUyQ20lMkNpbiU1Ql8lNUQlMkNsYXMlNUJfJTNDJTNDMyU1RCUzQiUwQWlubGluZSUyMHZvaWQlMjBwdXNodXAoaW50JTIwayklN0JudC5teCUzRG1heChsdC5teCUyQ3J0Lm14KSUyQ250LmhteCUzRG1heChsdC5obXglMkNydC5obXgpJTNCJTdEJTBBaW5saW5lJTIwdm9pZCUyMHB1c2hhZGQoaW50JTIwayUyQ2ludCUyMHYlMkNpbnQlMjBodiklN0IlMEElMjAlMjAlMjAlMjBudC5oYWRkJTNEbWF4KG50LmhhZGQlMkNudC5hZGQlMkJodiklM0IlMEElMjAlMjAlMjAlMjBudC5obXglM0RtYXgobnQuaG14JTJDbnQubXglMkJodiklM0IlMEElMjAlMjAlMjAlMjBudC5hZGQlMkIlM0R2JTJDbnQubXglMkIlM0R2JTNCJTBBJTdEJTBBaW5saW5lJTIwdm9pZCUyMHB1c2hkb3duKGludCUyMGspJTdCcHVzaGFkZChscyhrKSUyQ250LmFkZCUyQ250LmhhZGQpJTNCcHVzaGFkZChycyhrKSUyQ250LmFkZCUyQ250LmhhZGQpJTNCbnQuYWRkJTNEbnQuaGFkZCUzRDAlM0IlN0QlMEF2b2lkJTIwbW9kaWZ5KGludCUyMGslMkNpbnQlMjBsJTJDaW50JTIwciUyQ2ludCUyMHglMkNpbnQlMjB5JTJDaW50JTIwdiklN0IlMEElMjAlMjAlMjAlMjBpZihsJTNFJTNEeCUyNiUyNnIlM0MlM0R5KSUyMHJldHVybiUyMHB1c2hhZGQoayUyQ3YlMkN2KSUyQ3ZvaWQoKSUzQiUwQSUyMCUyMCUyMCUyMHB1c2hkb3duKGspJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElM0IlMEElMjAlMjAlMjAlMjBpZih4JTNDJTNEbWlkKSUyMG1vZGlmeShscyhrKSUyQ2wlMkNtaWQlMkN4JTJDeSUyQ3YpJTNCJTBBJTIwJTIwJTIwJTIwaWYoeSUzRW1pZCklMjBtb2RpZnkocnMoayklMkNtaWQlMkIxJTJDciUyQ3glMkN5JTJDdiklM0IlMEElMjAlMjAlMjAlMjBwdXNodXAoayklM0IlMEElN0QlMEFpbnQlMjBxdWVyeShpbnQlMjBrJTJDaW50JTIwbCUyQ2ludCUyMHIlMkNpbnQlMjB4JTJDaW50JTIweSklN0IlMEElMjAlMjAlMjAlMjBpZihsJTNFJTNEeCUyNiUyNnIlM0MlM0R5KSUyMHJldHVybiUyMG50LmhteCUzQiUwQSUyMCUyMCUyMCUyMHB1c2hkb3duKGspJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwbWlkJTNEKGwlMkJyKSUzRSUzRTElMkNyZXMlM0QtaW5mJTNCJTBBJTIwJTIwJTIwJTIwaWYoeCUzQyUzRG1pZCklMjByZXMlM0RtYXgocmVzJTJDcXVlcnkobHMoayklMkNsJTJDbWlkJTJDeCUyQ3kpKSUzQiUwQSUyMCUyMCUyMCUyMGlmKHklM0VtaWQpJTIwcmVzJTNEbWF4KHJlcyUyQ3F1ZXJ5KHJzKGspJTJDbWlkJTJCMSUyQ3IlMkN4JTJDeSkpJTNCJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwcmVzJTNCJTBBJTdEJTBBc3RydWN0JTIwUSU3QmludCUyMGluZGV4JTJDbCUyQ3IlMkNhbnMlM0IlN0QlMjBxJTVCXyU1RCUzQiUwQWlubGluZSUyMHZvaWQlMjBzdWJ0YXNrKCklN0IlMEElMjAlMjAlMjAlMjBjaW4lM0UlM0VuJTNCZm9yKGludCUyMGklM0QxJTNCaSUzQyUzRG4lM0JpJTJCJTJCKSUyMGNpbiUzRSUzRWluJTVCaSU1RCUzQmNpbiUzRSUzRW0lM0IlMEElMjAlMjAlMjAlMjBmb3IoaW50JTIwaSUzRDElM0JpJTNDJTNEbSUzQmklMkIlMkIpJTIwY2luJTNFJTNFcSU1QmklNUQubCUzRSUzRXElNUJpJTVELnIlMkNxJTVCaSU1RC5pbmRleCUzRGklM0IlMEElMjAlMjAlMjAlMjBzb3J0KHElMkIxJTJDcSUyQm0lMkIxJTJDJTVCJTVEKFElMjB4JTJDUSUyMHkpJTdCcmV0dXJuJTIweC5yJTNDeS5yJTNCJTdEKSUzQiUwQSUyMCUyMCUyMCUyMGZvcihpbnQlMjBpJTNEMSUyQ3AlM0QwJTNCaSUzQyUzRG0lM0JpJTJCJTJCKSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHdoaWxlKHAlM0NxJTVCaSU1RC5yKSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHAlMkIlMkIlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBtb2RpZnkoMSUyQzElMkNuJTJDbGFzJTVCb2ZmJTJCaW4lNUJwJTVEJTVEJTJCMSUyQ3AlMkNpbiU1QnAlNUQpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwbGFzJTVCb2ZmJTJCaW4lNUJwJTVEJTVEJTNEcCUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHElNUJpJTVELmFucyUzRHF1ZXJ5KDElMkMxJTJDbiUyQ3ElNUJpJTVELmwlMkNxJTVCaSU1RC5yKSUzQiUwQSUyMCUyMCUyMCUyMCU3RCUwQSUyMCUyMCUyMCUyMHNvcnQocSUyQjElMkNxJTJCbSUyQjElMkMlNUIlNUQoUSUyMHglMkNRJTIweSklN0JyZXR1cm4lMjB4LmluZGV4JTNDeS5pbmRleCUzQiU3RCklM0IlMEElMjAlMjAlMjAlMjBmb3IoaW50JTIwaSUzRDElM0JpJTNDJTNEbSUzQmklMkIlMkIpJTIwY291dCUzQyUzQ3ElNUJpJTVELmFucyUzQyUzQ2VuZGwlM0IlMEElN0QlMEFzaWduZWQlMjBtYWluKCklN0IlMEElMjAlMjAlMjAlMjBpb3MlM0ElM0FzeW5jX3dpdGhfc3RkaW8oZmFsc2UpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwdCUzRDElM0IlMkYlMkZjaW4lM0UlM0V0JTNCJTBBJTIwJTIwJTIwJTIwd2hpbGUodC0tKSUyMHN1YnRhc2soKSUzQiUwQSUyMCUyMCUyMCUyMHJldHVybiUyMDAlM0IlMEElN0QlMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div></div><div class="code"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ls(k) (k)&lt;&lt;1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rs(k) (k)&lt;&lt;1|1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> nt tree[k]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> lt tree[ls(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rt tree[rs(k)]</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> debug(x) cout&lt;&lt;#x&lt;&lt;<span class="hljs-string">&quot;=&quot;</span>&lt;&lt;x&lt;&lt;endl</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> inf=<span class="hljs-number">0x3f3f3f3f3f3f3f3f</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mod=<span class="hljs-number">0</span>;
<span class="hljs-keyword">typedef</span> pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; pii;
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ 100005</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> off=<span class="hljs-number">100000</span>;
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>{<span class="hljs-type">int</span> add,hadd,mx,hmx;} tree[_&lt;&lt;<span class="hljs-number">2</span>];
<span class="hljs-type">int</span> n,m,in[_],las[_&lt;&lt;<span class="hljs-number">3</span>];
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{nt.mx=<span class="hljs-built_in">max</span>(lt.mx,rt.mx),nt.hmx=<span class="hljs-built_in">max</span>(lt.hmx,rt.hmx);}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushadd</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> v,<span class="hljs-type">int</span> hv)</span></span>{
    nt.hadd=<span class="hljs-built_in">max</span>(nt.hadd,nt.add+hv);
    nt.hmx=<span class="hljs-built_in">max</span>(nt.hmx,nt.mx+hv);
    nt.add+=v,nt.mx+=v;
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{<span class="hljs-built_in">pushadd</span>(<span class="hljs-built_in">ls</span>(k),nt.add,nt.hadd);<span class="hljs-built_in">pushadd</span>(<span class="hljs-built_in">rs</span>(k),nt.add,nt.hadd);nt.add=nt.hadd=<span class="hljs-number">0</span>;}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">modify</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y,<span class="hljs-type">int</span> v)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> <span class="hljs-built_in">pushadd</span>(k,v,v),<span class="hljs-built_in">void</span>();
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>;
    <span class="hljs-keyword">if</span>(x&lt;=mid) <span class="hljs-built_in">modify</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y,v);
    <span class="hljs-keyword">if</span>(y&gt;mid) <span class="hljs-built_in">modify</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y,v);
    <span class="hljs-built_in">pushup</span>(k);
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
    <span class="hljs-keyword">if</span>(l&gt;=x&amp;&amp;r&lt;=y) <span class="hljs-keyword">return</span> nt.hmx;
    <span class="hljs-built_in">pushdown</span>(k);
    <span class="hljs-type">int</span> mid=(l+r)&gt;&gt;<span class="hljs-number">1</span>,res=-inf;
    <span class="hljs-keyword">if</span>(x&lt;=mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query</span>(<span class="hljs-built_in">ls</span>(k),l,mid,x,y));
    <span class="hljs-keyword">if</span>(y&gt;mid) res=<span class="hljs-built_in">max</span>(res,<span class="hljs-built_in">query</span>(<span class="hljs-built_in">rs</span>(k),mid<span class="hljs-number">+1</span>,r,x,y));
    <span class="hljs-keyword">return</span> res;
}
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Q</span>{<span class="hljs-type">int</span> index,l,r,ans;} q[_];
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">subtask</span><span class="hljs-params">()</span></span>{
    cin&gt;&gt;n;<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++) cin&gt;&gt;in[i];cin&gt;&gt;m;
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++) cin&gt;&gt;q[i].l&gt;&gt;q[i].r,q[i].index=i;
    <span class="hljs-built_in">sort</span>(q<span class="hljs-number">+1</span>,q+m<span class="hljs-number">+1</span>,[](Q x,Q y){<span class="hljs-keyword">return</span> x.r&lt;y.r;});
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>,p=<span class="hljs-number">0</span>;i&lt;=m;i++){
        <span class="hljs-keyword">while</span>(p&lt;q[i].r){
            p++;
            <span class="hljs-built_in">modify</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,las[off+in[p]]<span class="hljs-number">+1</span>,p,in[p]);
            las[off+in[p]]=p;
        }
        q[i].ans=<span class="hljs-built_in">query</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>,n,q[i].l,q[i].r);
    }
    <span class="hljs-built_in">sort</span>(q<span class="hljs-number">+1</span>,q+m<span class="hljs-number">+1</span>,[](Q x,Q y){<span class="hljs-keyword">return</span> x.index&lt;y.index;});
    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=m;i++) cout&lt;&lt;q[i].ans&lt;&lt;endl;
}
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-type">int</span> t=<span class="hljs-number">1</span>;<span class="hljs-comment">//cin&gt;&gt;t;</span>
    <span class="hljs-keyword">while</span>(t--) <span class="hljs-built_in">subtask</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>洛谷-灵梦 <a href="https://www.luogu.com.cn/article/rfalvjih">《区间最值操作与区间历史最值详解》</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>etilletaS_ <a href="https://www.cnblogs.com/ywhO3Olsq/p/16120157.html">《势能线段树专题》</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p>吉如一《区间最值操作与历史最值问题》 见 <a href="https://github.com/enkerewpo/OI-Public-Library/blob/master/IOI%E4%B8%AD%E5%9B%BD%E5%9B%BD%E5%AE%B6%E5%80%99%E9%80%89%E9%98%9F%E8%AE%BA%E6%96%87/%E5%9B%BD%E5%AE%B6%E9%9B%86%E8%AE%AD%E9%98%9F2016%E8%AE%BA%E6%96%87%E9%9B%86.pdf">2016年国家集训队论文集</a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
