<h2 id="1-xian-xing-hui-gui" tabindex="-1">1 线性回归</h2>
<h3 id="1-1-wen-ti-ding-yi" tabindex="-1">1.1 问题定义</h3>
<p>给定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 维输入 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">x</mi><mo>=</mo><msup><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>x</mi><mi>n</mi></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{x}=\begin{bmatrix} x_1,x_2,\dots,x_n \end{bmatrix}^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"></span><span class="mord mathbf">x</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.4312em;vertical-align:-0.35em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0812em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>
需要确定一个 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">n</span></span></span></span> 维权重 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">w</mi><mo>=</mo><msup><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>w</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>w</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>w</mi><mi>n</mi></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{w}=\begin{bmatrix} w_1,w_2,\dots,w_n \end{bmatrix}^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.4312em;vertical-align:-0.35em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0812em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span> 和一个标量偏差 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span>
输出一个预测值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><msub><mi>w</mi><mn>1</mn></msub><msub><mi>x</mi><mn>1</mn></msub><mo>+</mo><msub><mi>w</mi><mn>2</mn></msub><msub><mi>x</mi><mn>2</mn></msub><mo>+</mo><mo>⋯</mo><mo>+</mo><msub><mi>w</mi><mi>n</mi></msub><msub><mi>x</mi><mi>n</mi></msub><mo>+</mo><mi>b</mi><mo>=</mo><mrow><mo fence="true">⟨</mo><mi mathvariant="bold">w</mi><mo separator="true">,</mo><mi mathvariant="bold">x</mi><mo fence="true">⟩</mo></mrow><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">y=w_1x_1+w_2x_2+\dots+w_nx_n+b=\left \langle \mathbf{w},\mathbf{x} \right \rangle + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em;"></span><span class="minner">⋯</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0269em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">⟨</span><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbf">x</span><span class="mclose delimcenter" style="top:0em;">⟩</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span>
平方损失：<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">ℓ</mi><mo stretchy="false">(</mo><mi>y</mi><mo separator="true">,</mo><mover accent="true"><mi>y</mi><mo>^</mo></mover><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo stretchy="false">(</mo><mi>y</mi><mo>−</mo><mover accent="true"><mi>y</mi><mo>^</mo></mover><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\ell (y,\hat{y})=\frac{1}{2}(y-\hat{y})^2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">ℓ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.1901em;vertical-align:-0.345em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span>，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span> 是真实值，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>y</mi><mo>^</mo></mover></mrow><annotation encoding="application/x-tex">\hat{y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span></span></span></span> 是估计值
然后我们有训练数据：</p>
<ul>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi><mo>=</mo><msup><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi mathvariant="bold">x</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi mathvariant="bold">x</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi mathvariant="bold">x</mi><mi>n</mi></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{X}=\begin{bmatrix} \mathbf{x}_1,\mathbf{x}_2,\dots,\mathbf{x}_n \end{bmatrix}^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6861em;"></span><span class="mord mathbf">X</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.4312em;vertical-align:-0.35em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0812em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>，表示样本数据的输入，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">x</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\mathbf{x}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5944em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 是一个列向量。合成一个矩阵后转置之后，矩阵的每一行就是一个样本数据</li>
<li><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">y</mi><mo>=</mo><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mi>n</mi></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathbf{y}=\begin{bmatrix} y_1,y_2,\dots,y_n \end{bmatrix}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.2em;vertical-align:-0.35em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span></span></span></span> 为样本的输出数据
有损失函数</li>
</ul>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">ℓ</mi><mo stretchy="false">(</mo><mi mathvariant="bold">X</mi><mo separator="true">,</mo><mi mathvariant="bold">y</mi><mo separator="true">,</mo><mi mathvariant="bold">w</mi><mo separator="true">,</mo><mi>b</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>2</mn><mi>n</mi></mrow></mfrac><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>n</mi></munderover><mo stretchy="false">(</mo><msub><mi>y</mi><mi>i</mi></msub><mo>−</mo><mrow><mo fence="true">⟨</mo><msub><mi mathvariant="bold">x</mi><mi>i</mi></msub><mo separator="true">,</mo><mi mathvariant="bold">w</mi><mo fence="true">⟩</mo></mrow><mo>−</mo><mi>b</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><mo>=</mo><mfrac><mn>1</mn><mrow><mn>2</mn><mi>n</mi></mrow></mfrac><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi mathvariant="bold">y</mi><mo>−</mo><mrow><mi mathvariant="bold">X</mi><mi mathvariant="bold">w</mi></mrow><mo>−</mo><mi>b</mi><mi mathvariant="normal">∣</mi><msup><mi mathvariant="normal">∣</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\ell (\mathbf{X},\mathbf{y},\mathbf{w},b)=\frac{1}{2n}\sum_{i=1}^n(y_i-\left \langle \mathbf{x}_i,\mathbf{w} \right \rangle-b)^2=\frac{1}{2n}||\mathbf{y}-\mathbf{Xw}-b||^2
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">ℓ</span><span class="mopen">(</span><span class="mord mathbf">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal">b</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.9291em;vertical-align:-1.2777em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.6514em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span><span style="top:-4.3em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">⟨</span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="mclose delimcenter" style="top:0em;">⟩</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord mathnormal">b</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord">∣∣</span><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7694em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">Xw</span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord mathnormal">b</span><span class="mord">∣</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>可以把 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> 给合并进 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi><mi mathvariant="bold">w</mi></mrow><annotation encoding="application/x-tex">\mathbf{Xw}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6861em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">Xw</span></span></span></span></span> 中，方法是给 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6861em;"></span><span class="mord mathbf">X</span></span></span></span> 附加一列元素全为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> 的列向量，然后给行向量 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">w</mi></mrow><annotation encoding="application/x-tex">\mathbf{w}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">w</span></span></span></span> 的最后加一个元素 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>。然后就可以合并成：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi mathvariant="normal">ℓ</mi><mo stretchy="false">(</mo><mi mathvariant="bold">X</mi><mo separator="true">,</mo><mi mathvariant="bold">y</mi><mo separator="true">,</mo><mi mathvariant="bold">w</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>2</mn><mi>n</mi></mrow></mfrac><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><mi mathvariant="bold">y</mi><mo>−</mo><mrow><mi mathvariant="bold">X</mi><mi mathvariant="bold">w</mi></mrow><mi mathvariant="normal">∣</mi><msup><mi mathvariant="normal">∣</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">\ell (\mathbf{X},\mathbf{y},\mathbf{w})=\frac{1}{2n}||\mathbf{y}-\mathbf{Xw}||^2
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">ℓ</span><span class="mopen">(</span><span class="mord mathbf">X</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span><span class="mord mathnormal">n</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord">∣∣</span><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">Xw</span></span><span class="mord">∣</span><span class="mord"><span class="mord">∣</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>然后选取最合适的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">w</mi></mrow><annotation encoding="application/x-tex">\mathbf{w}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4444em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">w</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> 来使损失函数最小</p>
<h3 id="1-2-ti-du-xia-jiang" tabindex="-1">1.2 梯度下降</h3>
<p>挑选一个初始值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">w</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\mathbf{w}_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5944em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.016em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>，然后重复迭代参数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span>，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi mathvariant="bold">w</mi><mi>t</mi></msub><mo>=</mo><msub><mi mathvariant="bold">w</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub><mo>−</mo><mi>η</mi><mfrac><mrow><mi mathvariant="normal">∂</mi><mi mathvariant="normal">ℓ</mi></mrow><mrow><mi mathvariant="normal">∂</mi><msub><mi mathvariant="bold">w</mi><mrow><mi>t</mi><mo>−</mo><mn>1</mn></mrow></msub></mrow></mfrac></mrow><annotation encoding="application/x-tex">\mathbf{w}_t=\mathbf{w}_{t-1}-\eta\frac{\partial \ell}{\partial \mathbf{w}_{t-1}}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5944em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.016em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7917em;vertical-align:-0.2083em;"></span><span class="mord"><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.016em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2083em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.3669em;vertical-align:-0.4868em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">η</span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8801em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mtight"><span class="mord mathbf mtight" style="margin-right:0.01597em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em;"><span style="top:-2.357em;margin-left:-0.016em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="mbin mtight">−</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2025em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight" style="margin-right:0.05556em;">∂</span><span class="mord mtight">ℓ</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4868em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>。其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>η</mi></mrow><annotation encoding="application/x-tex">\eta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">η</span></span></span></span> 为学习率，是一个需要认为设置的参数，不能太大也不能太小。
<div class="img-box"><img class="lazy" date-src="https://pic.caiwen.work/i/2025/07/06/686a5542dae72.png" style="transform: scale(1)" width=859 height=421></div>
在整个训练集上计算梯度耗时很长，我们可以随机采样 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi></mrow><annotation encoding="application/x-tex">b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal">b</span></span></span></span> 个样本 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>i</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>i</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>i</mi><mi>b</mi></msub></mrow><annotation encoding="application/x-tex">i_1,i_2,\dots,i_b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.854em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 来近似损失：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><mn>1</mn><mi>b</mi></mfrac><munder><mo>∑</mo><mrow><mi>i</mi><mo>∈</mo><msub><mi>I</mi><mi>b</mi></msub></mrow></munder><mi mathvariant="normal">ℓ</mi><mo stretchy="false">(</mo><msub><mi mathvariant="bold">x</mi><mi>i</mi></msub><mo separator="true">,</mo><msub><mi>y</mi><mi>i</mi></msub><mo separator="true">,</mo><mi mathvariant="bold">w</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\frac{1}{b}\sum_{i\in I_b} \ell(\mathbf{x}_i,y_i,\mathbf{w})
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.7216em;vertical-align:-1.4002em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">b</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8557em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mrel mtight">∈</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07847em;">I</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:-0.0785em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span></span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.4002em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">ℓ</span><span class="mopen">(</span><span class="mord"><span class="mord mathbf">x</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">w</span><span class="mclose">)</span></span></span></span></span></p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="aW1wb3J0JTIwcmFuZG9tJTBBaW1wb3J0JTIwdG9yY2glMEFmcm9tJTIwbWF0cGxvdGxpYiUyMGltcG9ydCUyMHB5cGxvdCUyMGFzJTIwcGx0JTBBZnJvbSUyMG1hdHBsb3RsaWJfaW5saW5lJTIwaW1wb3J0JTIwYmFja2VuZF9pbmxpbmUlMEElMjMlMjAlRTclOTQlOUYlRTYlODglOTAlRTUlOTklQUElRTUlQTMlQjAlRTYlOTUlQjAlRTYlOEQlQUUlMEFkZWYlMjBzeW50aGV0aWNfZGF0YSh3JTJDJTIwYiUyQyUyMGNvdW50KSUzQSUwQSUyMCUyMCUyMCUyMFglMjAlM0QlMjB0b3JjaC5ub3JtYWwoMCUyQyUyMDElMkMlMjAoY291bnQlMkMlMjBsZW4odykpKSUwQSUyMCUyMCUyMCUyMHklMjAlM0QlMjB0b3JjaC5tYXRtdWwoWCUyQyUyMHcpJTIwJTJCJTIwYiUwQSUyMCUyMCUyMCUyMHklMjAlMkIlM0QlMjB0b3JjaC5ub3JtYWwoMCUyQyUyMDAuMSUyQyUyMHkuc2hhcGUpJTIwJTIzJTIwJUU1JThBJUEwJUU1JTk5JUFBJUU1JUEzJUIwJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwWCUyQyUyMHkucmVzaGFwZSgoLTElMkMlMjAxKSklMEF0cnVlX3clMjAlM0QlMjB0b3JjaC50ZW5zb3IoJTVCMiUyQyUyMC0zLjQlNUQpJTBBdHJ1ZV9iJTIwJTNEJTIwNC4yJTBBZmVhdHVyZXMlMkMlMjBsYWJlbHMlMjAlM0QlMjBzeW50aGV0aWNfZGF0YSh0cnVlX3clMkMlMjB0cnVlX2IlMkMlMjAxMDAwMCklMEElMjMlMjBwbHQuc2NhdHRlcihmZWF0dXJlcyU1QiUzQSUyQyUyMDElNUQuZGV0YWNoKCkubnVtcHkoKSUyQyUyMGxhYmVscy5kZXRhY2goKS5udW1weSgpJTJDJTIwMSklMEElMjMlMjBwbHQuc2hvdygpJTBBJTIzJTIwJUU5JTlBJThGJUU2JTlDJUJBJUU1JThGJTk2JUU2JUEwJUI3JTBBZGVmJTIwZGF0YV9pdGVyKGJhdGNoX3NpemUlMkMlMjBmZWF0dXJlcyUyQyUyMGxhYmVscyklM0ElMEElMjAlMjAlMjAlMjBjb3VudCUyMCUzRCUyMGxlbihmZWF0dXJlcyklMEElMjAlMjAlMjAlMjBpbmRpY2VzJTIwJTNEJTIwbGlzdChyYW5nZShjb3VudCkpJTBBJTIwJTIwJTIwJTIwcmFuZG9tLnNodWZmbGUoaW5kaWNlcyklMEElMjAlMjAlMjAlMjBmb3IlMjBpJTIwaW4lMjByYW5nZSgwJTJDJTIwY291bnQlMkMlMjBiYXRjaF9zaXplKSUzQSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGJhdGNoX2luZGljZXMlMjAlM0QlMjB0b3JjaC50ZW5zb3IoaW5kaWNlcyU1QmklM0ElMjBtaW4oaSUyMCUyQiUyMGJhdGNoX3NpemUlMkMlMjBjb3VudCklNUQpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIweWllbGQlMjBmZWF0dXJlcyU1QmJhdGNoX2luZGljZXMlNUQlMkMlMjBsYWJlbHMlNUJiYXRjaF9pbmRpY2VzJTVEJTBBYmF0Y2hfc2l6ZSUyMCUzRCUyMDEwJTBBJTIzJTIwJUU4JUFFJUJFJUU3JUJEJUFFJUU1JTg4JTlEJUU1JUE3JThCJUU5JUEyJTg0JUU2JUI1JThCJUU1JTgwJUJDJTBBdyUyMCUzRCUyMHRvcmNoLm5vcm1hbCgwJTJDJTIwMC4wMSUyQyUyMHNpemUlM0QoMiUyQyUyMDEpJTJDJTIwcmVxdWlyZXNfZ3JhZCUzRFRydWUpJTBBYiUyMCUzRCUyMHRvcmNoLnplcm9zKDElMkMlMjByZXF1aXJlc19ncmFkJTNEVHJ1ZSklMEElMjMlMjAlRTglOEUlQjclRTUlOEYlOTYlRTklQTIlODQlRTYlQjUlOEIlRTUlODAlQkMlRTclOUElODQlRTclOUYlQTklRTklOTglQjUlMEFkZWYlMjBsaW5yZWcoWCUyQyUyMHclMkMlMjBiKSUzQSUwQSUyMCUyMCUyMCUyMHJldHVybiUyMHRvcmNoLm1hdG11bChYJTJDJTIwdyklMjAlMkIlMjBiJTBBJTIzJTIwJUU2JThEJTlGJUU1JUE0JUIxJUU1JTg3JUJEJUU2JTk1JUIwJTBBZGVmJTIwc3F1YXJlZF9sb3NzKHlfaGF0JTJDJTIweSklM0ElMEElMjAlMjAlMjAlMjByZXR1cm4lMjAoeV9oYXQlMjAtJTIweS5yZXNoYXBlKHlfaGF0LnNoYXBlKSklMjAqKiUyMDIlMjAlMkYlMjAyJTBBJTIzJTIwJUU2JUEyJUFGJUU1JUJBJUE2JUU0JUI4JThCJUU5JTk5JThEJTBBZGVmJTIwc2dkKHBhcmFtcyUyQyUyMGxyJTJDJTIwYmF0Y2hfc2l6ZSklM0ElMEElMjAlMjAlMjAlMjB3aXRoJTIwdG9yY2gubm9fZ3JhZCgpJTNBJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzJTIwJUU1JTlDJUE4JUU4JUJGJTk5JUU1JThDJUJBJUU1JTlGJTlGJUU0JUI4JUFEJUU4JUJGJTlCJUU4JUExJThDJUU3JTlBJTg0JUU4JUJGJTkwJUU3JUFFJTk3JUU0JUI4JThEJUU0JUJDJTlBJUU4JUEyJUFCJUU3JUFFJTk3JUU1JTg1JUE1JUU2JUEyJUFGJUU1JUJBJUE2JTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwZm9yJTIwcGFyYW0lMjBpbiUyMHBhcmFtcyUzQSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHBhcmFtJTIwLSUzRCUyMGxyJTIwKiUyMHBhcmFtLmdyYWQlMjAlMkYlMjBiYXRjaF9zaXplJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwcGFyYW0uZ3JhZC56ZXJvXygpJTBBJTIzJTIwJUU4JUFFJUFEJUU3JUJCJTgzJTBBbHIlMjAlM0QlMjAwLjAzJTBBbnVtX2Vwb2NocyUyMCUzRCUyMDEwJTIwJTIzJTIwJUU4JUFFJUFEJUU3JUJCJTgzJUU2JUFDJUExJUU2JTk1JUIwJTBBbmV0JTIwJTNEJTIwbGlucmVnJTIwJTIzJTIwJUU5JTgwJTg5JUU3JTk0JUE4JUU3JUE1JTlFJUU3JUJCJThGJUU3JUJEJTkxJUU3JUJCJTlDJTBBbG9zcyUyMCUzRCUyMHNxdWFyZWRfbG9zcyUyMCUyMyUyMCVFOSU4MCU4OSVFNyU5NCVBOCVFNiU4RCU5RiVFNSVBNCVCMSVFNSU4NyVCRCVFNiU5NSVCMCUwQWZvciUyMGVwb2NoJTIwaW4lMjByYW5nZShudW1fZXBvY2hzKSUzQSUwQSUyMCUyMCUyMCUyMGZvciUyMFglMkMlMjB5JTIwaW4lMjBkYXRhX2l0ZXIoYmF0Y2hfc2l6ZSUyQyUyMGZlYXR1cmVzJTJDJTIwbGFiZWxzKSUzQSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMyUyMCVFNCVCRCVCRiVFNyU5NCVBOCUyMGxpbnJlZyUyMCVFOCVCRiU5QiVFOCVBMSU4QyVFOSVBMiU4NCVFNiVCNSU4QiVFRiVCQyU4QyVFNyU4NCVCNiVFNSU5MCU4RSUyMHNxdWFyZWRfbG9zcyUyMCVFNiU5RCVBNSVFOCVBRSVBMSVFNyVBRSU5NyVFNiU4RCU5RiVFNSVBNCVCMSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGwlMjAlM0QlMjBsb3NzKG5ldChYJTJDJTIwdyUyQyUyMGIpJTJDJTIweSklMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjMlMjAlRTclOUIlQUUlRTUlODklOEQlRTUlQkUlOTclRTUlODglQjAlRTclOUElODQlMjBsJTIwJUU2JTk4JUFGJUU0JUI4JTgwJUU0JUI4JUFBJTIwKGJhdGNoX3NpemUlMkMlMjAxKSUyMCVFNSVCRCVBMiVFNyU4QSVCNiVFNyU5QSU4NCVFNSU5MCU5MSVFOSU4NyU4RiVFRiVCQyU4QyVFNCVCRCVCRiVFNyU5NCVBOCUyMHN1bSUyMCVFNSVCMCU4NiVFNSU4NSVCNiVFOCVCRCVBQyVFNCVCOCVCQSVFNiVBMCU4NyVFOSU4NyU4RiVFRiVCQyU4QyVFNyU4NCVCNiVFNSU5MCU4RSVFNSVCMCVCMSVFNSU4RiVBRiVFNCVCQiVBNSVFNiVCMSU4MiVFNiVBMiVBRiVFNSVCQSVBNiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGwuc3VtKCkuYmFja3dhcmQoKSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHNnZCglNUJ3JTJDJTIwYiU1RCUyQyUyMGxyJTJDJTIwYmF0Y2hfc2l6ZSklMjAlMjMlMjAlRTglQkYlOUIlRTglQTElOEMlRTYlQTIlQUYlRTUlQkElQTYlRTQlQjglOEIlRTklOTklOEQlMEElMjAlMjAlMjAlMjAlMjMlMjAlRTglQkUlOTMlRTUlODclQkElRTclQkIlOUYlRTglQUUlQTElRTYlOTUlQjAlRTYlOEQlQUUlMEElMjAlMjAlMjAlMjB3aXRoJTIwdG9yY2gubm9fZ3JhZCgpJTNBJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdHJhaW5fbCUyMCUzRCUyMGxvc3MobmV0KGZlYXR1cmVzJTJDJTIwdyUyQyUyMGIpJTJDJTIwbGFiZWxzKSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHByaW50KGYnZXBvY2glM0ElMjAlN0JlcG9jaCU3RCUyQyUyMGxvc3MlM0ElMjAlN0JmbG9hdCh0cmFpbl9sLm1lYW4oKSklM0FmJTdEJyklMEFwcmludChmJ3dfaGF0JTNBJTIwJTdCdyU3RCcpJTBBcHJpbnQoZidiX2hhdCUzQSUyMCU3QmIlN0QnKSUwQXByaW50KGYnZGVsdGElMjB3JTNBJTIwJTdCdHJ1ZV93JTIwLSUyMHcucmVzaGFwZSh0cnVlX3cuc2hhcGUpJTdEJyklMEFwcmludChmJ2RlbHRhJTIwYiUzQSUyMCU3QnRydWVfYiUyMC0lMjBiJTdEJyklMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div></div><div class="code"><span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> matplotlib <span class="hljs-keyword">import</span> pyplot <span class="hljs-keyword">as</span> plt
<span class="hljs-keyword">from</span> matplotlib_inline <span class="hljs-keyword">import</span> backend_inline
<span class="hljs-comment"># 生成噪声数据</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">synthetic_data</span>(<span class="hljs-params">w, b, count</span>):
    X = torch.normal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, (count, <span class="hljs-built_in">len</span>(w)))
    y = torch.matmul(X, w) + b
    y += torch.normal(<span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>, y.shape) <span class="hljs-comment"># 加噪声</span>
    <span class="hljs-keyword">return</span> X, y.reshape((-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>))
true_w = torch.tensor([<span class="hljs-number">2</span>, -<span class="hljs-number">3.4</span>])
true_b = <span class="hljs-number">4.2</span>
features, labels = synthetic_data(true_w, true_b, <span class="hljs-number">10000</span>)
<span class="hljs-comment"># plt.scatter(features[:, 1].detach().numpy(), labels.detach().numpy(), 1)</span>
<span class="hljs-comment"># plt.show()</span>
<span class="hljs-comment"># 随机取样</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">data_iter</span>(<span class="hljs-params">batch_size, features, labels</span>):
    count = <span class="hljs-built_in">len</span>(features)
    indices = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">range</span>(count))
    random.shuffle(indices)
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0</span>, count, batch_size):
        batch_indices = torch.tensor(indices[i: <span class="hljs-built_in">min</span>(i + batch_size, count)])
        <span class="hljs-keyword">yield</span> features[batch_indices], labels[batch_indices]
batch_size = <span class="hljs-number">10</span>
<span class="hljs-comment"># 设置初始预测值</span>
w = torch.normal(<span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>, size=(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>), requires_grad=<span class="hljs-literal">True</span>)
b = torch.zeros(<span class="hljs-number">1</span>, requires_grad=<span class="hljs-literal">True</span>)
<span class="hljs-comment"># 获取预测值的矩阵</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">linreg</span>(<span class="hljs-params">X, w, b</span>):
    <span class="hljs-keyword">return</span> torch.matmul(X, w) + b
<span class="hljs-comment"># 损失函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">squared_loss</span>(<span class="hljs-params">y_hat, y</span>):
    <span class="hljs-keyword">return</span> (y_hat - y.reshape(y_hat.shape)) ** <span class="hljs-number">2</span> / <span class="hljs-number">2</span>
<span class="hljs-comment"># 梯度下降</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">sgd</span>(<span class="hljs-params">params, lr, batch_size</span>):
    <span class="hljs-keyword">with</span> torch.no_grad():
        <span class="hljs-comment"># 在这区域中进行的运算不会被算入梯度</span>
        <span class="hljs-keyword">for</span> param <span class="hljs-keyword">in</span> params:
            param -= lr * param.grad / batch_size
            param.grad.zero_()
<span class="hljs-comment"># 训练</span>
lr = <span class="hljs-number">0.03</span>
num_epochs = <span class="hljs-number">10</span> <span class="hljs-comment"># 训练次数</span>
net = linreg <span class="hljs-comment"># 选用神经网络</span>
loss = squared_loss <span class="hljs-comment"># 选用损失函数</span>
<span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):
    <span class="hljs-keyword">for</span> X, y <span class="hljs-keyword">in</span> data_iter(batch_size, features, labels):
        <span class="hljs-comment"># 使用 linreg 进行预测，然后 squared_loss 来计算损失</span>
        l = loss(net(X, w, b), y)
        <span class="hljs-comment"># 目前得到的 l 是一个 (batch_size, 1) 形状的向量，使用 sum 将其转为标量，然后就可以求梯度</span>
        l.<span class="hljs-built_in">sum</span>().backward()
        sgd([w, b], lr, batch_size) <span class="hljs-comment"># 进行梯度下降</span>
    <span class="hljs-comment"># 输出统计数据</span>
    <span class="hljs-keyword">with</span> torch.no_grad():
        train_l = loss(net(features, w, b), labels)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;epoch: <span class="hljs-subst">{epoch}</span>, loss: <span class="hljs-subst">{<span class="hljs-built_in">float</span>(train_l.mean()):f}</span>&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;w_hat: <span class="hljs-subst">{w}</span>&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;b_hat: <span class="hljs-subst">{b}</span>&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;delta w: <span class="hljs-subst">{true_w - w.reshape(true_w.shape)}</span>&#x27;</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;delta b: <span class="hljs-subst">{true_b - b}</span>&#x27;</span>)
</div></code></pre>
<h3 id="1-3-jian-bian-xie-fa" tabindex="-1">1.3 简便写法</h3>
<p>使用 pytorch 定义好的工具。先生成数据集：</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="dHJ1ZV93JTIwJTNEJTIwdG9yY2gudGVuc29yKCU1QjIlMkMlMjAtMy40JTVEKSUwQXRydWVfYiUyMCUzRCUyMDQuMiUwQWZlYXR1cmVzJTJDJTIwbGFiZWxzJTIwJTNEJTIwc3ludGhldGljX2RhdGEodHJ1ZV93JTJDJTIwdHJ1ZV9iJTJDJTIwMTAwMDApJTBB"><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div></div><div class="code">true_w = torch.tensor([<span class="hljs-number">2</span>, -<span class="hljs-number">3.4</span>])
true_b = <span class="hljs-number">4.2</span>
features, labels = synthetic_data(true_w, true_b, <span class="hljs-number">10000</span>)
</div></code></pre>
<p>使用框架自带的随机采样读取器：</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="ZGVmJTIwbG9hZF9hcnJheShkYXRhX2FycmF5cyUyQyUyMGJhdGNoX3NpemUlMkMlMjBpc190cmFpbiUzRFRydWUpJTNBJTBBJTIwJTIwJTIwJTIwJTIyJTIyJTIyJUU2JTlFJTg0JUU5JTgwJUEwJUU0JUI4JTgwJUU0JUI4JUFBUHlUb3JjaCVFNiU5NSVCMCVFNiU4RCVBRSVFOCVCRiVBRCVFNCVCQiVBMyVFNSU5OSVBOCUyMiUyMiUyMiUwQSUyMCUyMCUyMCUyMGRhdGFzZXQlMjAlM0QlMjBkYXRhLlRlbnNvckRhdGFzZXQoKmRhdGFfYXJyYXlzKSUwQSUyMCUyMCUyMCUyMHJldHVybiUyMGRhdGEuRGF0YUxvYWRlcihkYXRhc2V0JTJDJTIwYmF0Y2hfc2l6ZSUyQyUyMHNodWZmbGUlM0Rpc190cmFpbiklMEFiYXRjaF9zaXplJTIwJTNEJTIwMTAlMEFkYXRhX2l0ZXIlMjAlM0QlMjBsb2FkX2FycmF5KChmZWF0dXJlcyUyQyUyMGxhYmVscyklMkMlMjBiYXRjaF9zaXplKSUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div></div><div class="code"><span class="hljs-keyword">def</span> <span class="hljs-title function_">load_array</span>(<span class="hljs-params">data_arrays, batch_size, is_train=<span class="hljs-literal">True</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;构造一个PyTorch数据迭代器&quot;&quot;&quot;</span>
    dataset = data.TensorDataset(*data_arrays)
    <span class="hljs-keyword">return</span> data.DataLoader(dataset, batch_size, shuffle=is_train)
batch_size = <span class="hljs-number">10</span>
data_iter = load_array((features, labels), batch_size)
</div></code></pre>
<p>然后定义神经网络，其中 <code>nn.Sequential</code> 把神经网络中的每一层连接，<code>nn.Linear(2, 1)</code> 相当于是一个全连接层，表示有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn></mrow><annotation encoding="application/x-tex">2</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">2</span></span></span></span> 个因素影响 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 个输出结果（相当于是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mo>×</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2\times 1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">2</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span> 的矩阵）</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="ZnJvbSUyMHRvcmNoJTIwaW1wb3J0JTIwbm4lMEFuZXQlMjAlM0QlMjBubi5TZXF1ZW50aWFsKG5uLkxpbmVhcigyJTJDJTIwMSkpJTBBJTIzJTIwJUU4JUFFJUJFJUU3JUJEJUFFJUU1JTg4JTlEJUU1JUE3JThCJUU2JTlEJTgzJUU5JTg3JThEJUU1JTkyJThDJUU1JTgxJThGJUU3JUJEJUFFJTBBbmV0JTVCMCU1RC53ZWlnaHQuZGF0YS5ub3JtYWxfKDAlMkMlMjAwLjAxKSUwQW5ldCU1QjAlNUQuYmlhcy5kYXRhLmZpbGxfKDApJTBB"><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div></div><div class="code"><span class="hljs-keyword">from</span> torch <span class="hljs-keyword">import</span> nn
net = nn.Sequential(nn.Linear(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>))
<span class="hljs-comment"># 设置初始权重和偏置</span>
net[<span class="hljs-number">0</span>].weight.data.normal_(<span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>)
net[<span class="hljs-number">0</span>].bias.data.fill_(<span class="hljs-number">0</span>)
</div></code></pre>
<p>计算均方误差使用的是 <code>MMSELoss</code> 类</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="bG9zcyUyMCUzRCUyMG5uLk1TRUxvc3MoKSUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div></div><div class="code">loss = nn.MSELoss()
</div></code></pre>
<p>然后设置优化算法，即梯度下降</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="dHJhaW5lciUyMCUzRCUyMHRvcmNoLm9wdGltLlNHRChuZXQucGFyYW1ldGVycygpJTJDJTIwbHIlM0QwLjAzKSUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div></div><div class="code">trainer = torch.optim.SGD(net.parameters(), lr=<span class="hljs-number">0.03</span>)
</div></code></pre>
<p>然后是训练过程：</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="bnVtX2Vwb2NocyUyMCUzRCUyMDMlMEFmb3IlMjBlcG9jaCUyMGluJTIwcmFuZ2UobnVtX2Vwb2NocyklM0ElMEElMjAlMjAlMjAlMjBmb3IlMjBYJTJDJTIweSUyMGluJTIwZGF0YV9pdGVyJTNBJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwbCUyMCUzRCUyMGxvc3MobmV0KFgpJTIwJTJDeSklMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB0cmFpbmVyLnplcm9fZ3JhZCgpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwbC5iYWNrd2FyZCgpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdHJhaW5lci5zdGVwKCklMEElMjAlMjAlMjAlMjBsJTIwJTNEJTIwbG9zcyhuZXQoZmVhdHVyZXMpJTJDJTIwbGFiZWxzKSUwQSUyMCUyMCUyMCUyMHByaW50KGYnZXBvY2glMjAlN0JlcG9jaCUyMCUyQiUyMDElN0QlMkMlMjBsb3NzJTIwJTdCbCUzQWYlN0QnKSUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div></div><div class="code">num_epochs = <span class="hljs-number">3</span>
<span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):
    <span class="hljs-keyword">for</span> X, y <span class="hljs-keyword">in</span> data_iter:
        l = loss(net(X) ,y)
        trainer.zero_grad()
        l.backward()
        trainer.step()
    l = loss(net(features), labels)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f&#x27;epoch <span class="hljs-subst">{epoch + <span class="hljs-number">1</span>}</span>, loss <span class="hljs-subst">{l:f}</span>&#x27;</span>)
</div></code></pre>
<h2 id="2-sun-shi-han-shu" tabindex="-1">2 损失函数</h2>
<h3 id="2-1-l2-loss" tabindex="-1">2.1 L2 Loss</h3>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>l</mi><mo stretchy="false">(</mo><mi>y</mi><mo separator="true">,</mo><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mn>2</mn></mfrac><mo stretchy="false">(</mo><mi>y</mi><mo>−</mo><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">l(y,y&#x27;)=\frac{1}{2}(y-y&#x27;)^2
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0074em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3214em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1141em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span></span></p>
<p>优点：离准确值比较远的时候梯度会很大，下降更快
缺点：有时候可能不希望下降特别快</p>
<h3 id="2-2-l1-loss" tabindex="-1">2.2 L1 Loss</h3>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>l</mi><mo stretchy="false">(</mo><mi>y</mi><mo separator="true">,</mo><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo>=</mo><mi mathvariant="normal">∣</mi><mi>y</mi><mo>−</mo><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi mathvariant="normal">∣</mi></mrow><annotation encoding="application/x-tex">l(y,y&#x27;)=|y-y&#x27;|
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">∣</span></span></span></span></span></p>
<p>优点：永远能以一个固定的速率下降
缺点：原点处不可导，且预测值和准确值比较靠近的时候会发生剧烈抖动</p>
<h3 id="2-3-hubers-robust-loss" tabindex="-1">2.3 Huber's Robust Loss</h3>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>l</mi><mo stretchy="false">(</mo><mi>y</mi><mo separator="true">,</mo><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">)</mo><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi mathvariant="normal">∣</mi><mi>y</mi><mo>−</mo><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi mathvariant="normal">∣</mi><mo>−</mo><mfrac><mn>1</mn><mn>2</mn></mfrac></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext> if </mtext><mi mathvariant="normal">∣</mi><mi>y</mi><mo>−</mo><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi mathvariant="normal">∣</mi><mo>&gt;</mo><mn>1</mn></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mfrac><mn>1</mn><mn>2</mn></mfrac><mo stretchy="false">(</mo><mi>y</mi><mo>−</mo><msup><mi>y</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><msup><mo stretchy="false">)</mo><mn>2</mn></msup></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext> otherwise </mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">l(y,y&#x27;)=
\begin{cases}
|y-y&#x27;|-\frac{1}{2} &amp; \text{ if } |y-y&#x27;|&gt;1 \\
\frac{1}{2}(y-y&#x27;)^2 &amp; \text{ otherwise }
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0519em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8019em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.394em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord"> if </span></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">1</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord"> otherwise </span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>结合上面两个损失函数，损失较大的时候以恒定速度下降，损失较小的时候下降速度比较平滑</p>
<h2 id="3-softmax-hui-gui" tabindex="-1">3 Softmax 回归</h2>
<h3 id="3-1-wen-ti-ding-yi" tabindex="-1">3.1 问题定义</h3>
<p>由多个因素和多个权重，线性确定出多个类的比例 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>o</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">o_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span>
我们的预测概率为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi mathvariant="bold">y</mi><mo>^</mo></mover><mo>=</mo><mtext>sofmax</mtext><mo stretchy="false">(</mo><mi mathvariant="bold">o</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathbf{\hat{y}}=\text{sofmax}(\mathbf{o})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9023em;vertical-align:-0.1944em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7079em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span><span style="top:-3.0134em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2875em;"><span class="mord mathbf">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">sofmax</span></span><span class="mopen">(</span><span class="mord mathbf">o</span><span class="mclose">)</span></span></span></span>
其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mover accent="true"><mi>y</mi><mo>^</mo></mover><mi>i</mi></msub><mo>=</mo><mfrac><mrow><mtext>exp</mtext><mo stretchy="false">(</mo><msub><mi>o</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><mrow><msub><mo>∑</mo><mi>k</mi></msub><mtext>exp</mtext><mo stretchy="false">(</mo><msub><mi>o</mi><mi>k</mi></msub><mo stretchy="false">)</mo></mrow></mfrac></mrow><annotation encoding="application/x-tex">\hat{y}_i=\frac{\text{exp}(o_i)}{\sum_k\text{exp}(o_k)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.58em;vertical-align:-0.57em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em;"><span style="top:-2.655em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1746em;"><span style="top:-2.1786em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3214em;"><span></span></span></span></span></span></span><span class="mspace mtight" style="margin-right:0.1952em;"></span><span class="mord text mtight"><span class="mord mtight">exp</span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.3488em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1512em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.485em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord mtight">exp</span></span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em;"><span style="top:-2.357em;margin-left:0em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.57em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span>，也就是把多个类比例用自然指数函数转为一个非负数之后再分百分比
而精确值 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">y</mi><mo>=</mo><msup><mrow><mo fence="true">[</mo><mtable rowspacing="0.16em" columnalign="center" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><msub><mi>y</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>y</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mi>n</mi></msub></mrow></mstyle></mtd></mtr></mtable><mo fence="true">]</mo></mrow><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">\mathbf{y}=\begin{bmatrix} y_1,y_2,\dots,y_n \end{bmatrix}^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.4312em;vertical-align:-0.35em;"></span><span class="minner"><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size1">[</span></span><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.85em;"><span style="top:-3.01em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.35em;"><span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;"><span class="delimsizing size1">]</span></span></span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:1.0812em;"><span style="top:-3.3029em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span>
其中：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub><mo>=</mo><mrow><mo fence="true">{</mo><mtable rowspacing="0.36em" columnalign="left left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>1</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mtext> if </mtext><mi>i</mi><mo>=</mo><mi>y</mi></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mn>0</mn></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="false"><mtext>otherwise</mtext></mstyle></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">y_i=\begin{cases}
1  &amp;\text{ if } i=y\\
0  &amp;\text{otherwise}
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:3em;vertical-align:-1.25em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">1</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:1em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.69em;"><span style="top:-3.69em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord"> if </span></span><span class="mord mathnormal">i</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span><span style="top:-2.25em;"><span class="pstrut" style="height:3.008em;"></span><span class="mord"><span class="mord text"><span class="mord">otherwise</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.19em;"><span></span></span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p>
<p>也就是精确值只有正确分类的权重为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span>，其他都为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span>
我们一般使用交叉熵来衡量两个概率的区别 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>H</mi><mo stretchy="false">(</mo><mi mathvariant="bold">p</mi><mo separator="true">,</mo><mi mathvariant="bold">q</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mo>∑</mo><mi>i</mi></msub><mo>−</mo><msub><mi>p</mi><mi>i</mi></msub><mi>log</mi><mo>⁡</mo><mo stretchy="false">(</mo><msub><mi>q</mi><mi>i</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">H(\mathbf{p},\mathbf{q})=\sum_i-p_i\log(q_i)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mopen">(</span><span class="mord mathbf">p</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbf">q</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1.0497em;vertical-align:-0.2997em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">−</span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>
那么损失函数：</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>l</mi><mo stretchy="false">(</mo><mi mathvariant="bold">y</mi><mo separator="true">,</mo><mover accent="true"><mi mathvariant="bold">y</mi><mo>^</mo></mover><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>y</mi><mi>i</mi></msub><mi>log</mi><mo>⁡</mo><mover accent="true"><msub><mi>y</mi><mi>i</mi></msub><mo>^</mo></mover><mo>=</mo><mo>−</mo><mi>log</mi><mo>⁡</mo><msub><mover accent="true"><mi>y</mi><mo>^</mo></mover><mi>y</mi></msub></mrow><annotation encoding="application/x-tex">l(\mathbf{y},\mathbf{\hat{y}})=-\sum_iy_i\log\hat{y_i}=-\log\hat{y}_y
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mopen">(</span><span class="mord mathbf" style="margin-right:0.01597em;">y</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.7079em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span><span style="top:-3.0134em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.2875em;"><span class="mord mathbf">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.3277em;vertical-align:-1.2777em;"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.05em;"><span style="top:-1.8723em;margin-left:0em;"><span class="pstrut" style="height:3.05em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.05em;"><span class="pstrut" style="height:3.05em;"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.2777em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.25em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord accent"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6944em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1944em;"><span class="mord">^</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1944em;"><span></span></span></span></span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span></p>
<h3 id="3-2-ti-du-xia-jiang" tabindex="-1">3.2 梯度下降</h3>
<p>准备训练数据集：</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="ZGVmJTIwZ2V0X2RhdGFsb2FkZXJfd29ya2VycygpJTNBJTBBJTIwJTIwJTIwJTIwJTIyJTIyJTIyJUU0JUJEJUJGJUU3JTk0JUE4NCVFNCVCOCVBQSVFOCVCRiU5QiVFNyVBOCU4QiVFNiU5RCVBNSVFOCVBRiVCQiVFNSU4RiU5NiVFNiU5NSVCMCVFNiU4RCVBRSUyMiUyMiUyMiUwQSUyMCUyMCUyMCUyMHJldHVybiUyMDQlMEFkZWYlMjBsb2FkX2RhdGFfZmFzaGlvbl9tbmlzdChiYXRjaF9zaXplJTJDJTIwcmVzaXplJTNETm9uZSklM0ElMEElMjAlMjAlMjAlMjAlMjIlMjIlMjIlRTQlQjglOEIlRTglQkQlQkRGYXNoaW9uLU1OSVNUJUU2JTk1JUIwJUU2JThEJUFFJUU5JTlCJTg2JUVGJUJDJThDJUU3JTg0JUI2JUU1JTkwJThFJUU1JUIwJTg2JUU1JTg1JUI2JUU1JThBJUEwJUU4JUJEJUJEJUU1JTg4JUIwJUU1JTg2JTg1JUU1JUFEJTk4JUU0JUI4JUFEJTIyJTIyJTIyJTBBJTIwJTIwJTIwJTIwdHJhbnMlMjAlM0QlMjAlNUJ0cmFuc2Zvcm1zLlRvVGVuc29yKCklNUQlMEElMjAlMjAlMjAlMjBpZiUyMHJlc2l6ZSUzQSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRyYW5zLmluc2VydCgwJTJDJTIwdHJhbnNmb3Jtcy5SZXNpemUocmVzaXplKSklMEElMjAlMjAlMjAlMjB0cmFucyUyMCUzRCUyMHRyYW5zZm9ybXMuQ29tcG9zZSh0cmFucyklMEElMjAlMjAlMjAlMjBtbmlzdF90cmFpbiUyMCUzRCUyMHRvcmNodmlzaW9uLmRhdGFzZXRzLkZhc2hpb25NTklTVCglMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjByb290JTNEJTIyLi4lMkZkYXRhJTIyJTJDJTIwdHJhaW4lM0RUcnVlJTJDJTIwdHJhbnNmb3JtJTNEdHJhbnMlMkMlMjBkb3dubG9hZCUzRFRydWUpJTBBJTIwJTIwJTIwJTIwbW5pc3RfdGVzdCUyMCUzRCUyMHRvcmNodmlzaW9uLmRhdGFzZXRzLkZhc2hpb25NTklTVCglMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjByb290JTNEJTIyLi4lMkZkYXRhJTIyJTJDJTIwdHJhaW4lM0RGYWxzZSUyQyUyMHRyYW5zZm9ybSUzRHRyYW5zJTJDJTIwZG93bmxvYWQlM0RUcnVlKSUwQSUyMCUyMCUyMCUyMHJldHVybiUyMChkYXRhLkRhdGFMb2FkZXIobW5pc3RfdHJhaW4lMkMlMjBiYXRjaF9zaXplJTJDJTIwc2h1ZmZsZSUzRFRydWUlMkMlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBudW1fd29ya2VycyUzRGdldF9kYXRhbG9hZGVyX3dvcmtlcnMoKSklMkMlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBkYXRhLkRhdGFMb2FkZXIobW5pc3RfdGVzdCUyQyUyMGJhdGNoX3NpemUlMkMlMjBzaHVmZmxlJTNERmFsc2UlMkMlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBudW1fd29ya2VycyUzRGdldF9kYXRhbG9hZGVyX3dvcmtlcnMoKSkpJTBB"><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div></div><div class="code"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_dataloader_workers</span>():
    <span class="hljs-string">&quot;&quot;&quot;使用4个进程来读取数据&quot;&quot;&quot;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-number">4</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">load_data_fashion_mnist</span>(<span class="hljs-params">batch_size, resize=<span class="hljs-literal">None</span></span>):
    <span class="hljs-string">&quot;&quot;&quot;下载Fashion-MNIST数据集，然后将其加载到内存中&quot;&quot;&quot;</span>
    trans = [transforms.ToTensor()]
    <span class="hljs-keyword">if</span> resize:
        trans.insert(<span class="hljs-number">0</span>, transforms.Resize(resize))
    trans = transforms.Compose(trans)
    mnist_train = torchvision.datasets.FashionMNIST(
        root=<span class="hljs-string">&quot;../data&quot;</span>, train=<span class="hljs-literal">True</span>, transform=trans, download=<span class="hljs-literal">True</span>)
    mnist_test = torchvision.datasets.FashionMNIST(
        root=<span class="hljs-string">&quot;../data&quot;</span>, train=<span class="hljs-literal">False</span>, transform=trans, download=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">return</span> (data.DataLoader(mnist_train, batch_size, shuffle=<span class="hljs-literal">True</span>,
                            num_workers=get_dataloader_workers()),
            data.DataLoader(mnist_test, batch_size, shuffle=<span class="hljs-literal">False</span>,
                            num_workers=get_dataloader_workers()))
</div></code></pre>
<p>设置迭代器</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="YmF0Y2hfc2l6ZSUyMCUzRCUyMDI1NiUwQXRyYWluX2l0ZXIlMkMlMjB0ZXN0X2l0ZXIlMjAlM0QlMjBsb2FkX2RhdGFfZmFzaGlvbl9tbmlzdCgzMiUyQyUyMHJlc2l6ZSUzRDY0KSUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div></div><div class="code">batch_size = <span class="hljs-number">256</span>
train_iter, test_iter = load_data_fashion_mnist(<span class="hljs-number">32</span>, resize=<span class="hljs-number">64</span>)
</div></code></pre>
<p>定义权重和偏置：</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="VyUyMCUzRCUyMHRvcmNoLm5vcm1hbCgwJTJDJTIwMC4wMSUyQyUyMHNpemUlM0QobnVtX2lucHV0cyUyQyUyMG51bV9vdXRwdXRzKSUyQyUyMHJlcXVpcmVzX2dyYWQlM0RUcnVlKSUwQWIlMjAlM0QlMjB0b3JjaC56ZXJvcyhudW1fb3V0cHV0cyUyQyUyMHJlcXVpcmVzX2dyYWQlM0RUcnVlKSUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div></div><div class="code">W = torch.normal(<span class="hljs-number">0</span>, <span class="hljs-number">0.01</span>, size=(num_inputs, num_outputs), requires_grad=<span class="hljs-literal">True</span>)
b = torch.zeros(num_outputs, requires_grad=<span class="hljs-literal">True</span>)
</div></code></pre>
<p>其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">W</mi></mrow><annotation encoding="application/x-tex">\mathbf{W}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6861em;"></span><span class="mord mathbf" style="margin-right:0.01597em;">W</span></span></span></span> 为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>784</mn><mo>×</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">784\times 10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">784</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10</span></span></span></span> 的矩阵。我们这里图片像素为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>28</mn><mo>×</mo><mn>28</mn></mrow><annotation encoding="application/x-tex">28\times 28</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">28</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">28</span></span></span></span>，由于图片颜色只有一个通道，所以每个像素的亮度就相当于是一个决定图片类型的因子，共有 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>784</mn></mrow><annotation encoding="application/x-tex">784</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">784</span></span></span></span> 个因子，然后每个因子由分别决定 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn></mrow><annotation encoding="application/x-tex">10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10</span></span></span></span> 个类别
然后有 <code>softmax</code> 函数，其传入一个矩阵。函数将对每个项求幂，然后对每一行进行求和，得到每一行的规范化常数，然后每一行除以规范化常数，使得每一行的加和为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn></mrow><annotation encoding="application/x-tex">1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">1</span></span></span></span></p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="ZGVmJTIwc29mdG1heChYKSUzQSUwQSUyMCUyMCUyMCUyMFhfZXhwJTIwJTNEJTIwdG9yY2guZXhwKFgpJTBBJTIwJTIwJTIwJTIwcGFydGl0aW9uJTIwJTNEJTIwWF9leHAuc3VtKDElMkMlMjBrZWVwZGltJTNEVHJ1ZSklMEElMjAlMjAlMjAlMjByZXR1cm4lMjBYX2V4cCUyMCUyRiUyMHBhcnRpdGlvbiUyMCUyMCUyMyUyMCVFOCVCRiU5OSVFOSU4NyU4QyVFNSVCQSU5NCVFNyU5NCVBOCVFNCVCQSU4NiVFNSVCOSVCRiVFNiU5MiVBRCVFNiU5QyVCQSVFNSU4OCVCNiUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div></div><div class="code"><span class="hljs-keyword">def</span> <span class="hljs-title function_">softmax</span>(<span class="hljs-params">X</span>):
    X_exp = torch.exp(X)
    partition = X_exp.<span class="hljs-built_in">sum</span>(<span class="hljs-number">1</span>, keepdim=<span class="hljs-literal">True</span>)
    <span class="hljs-keyword">return</span> X_exp / partition  <span class="hljs-comment"># 这里应用了广播机制</span>
</div></code></pre>
<p>然后定义神经网络，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">X</mi></mrow><annotation encoding="application/x-tex">\mathbf{X}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6861em;"></span><span class="mord mathbf">X</span></span></span></span> 是样本数据，这里 <code>reshape</code> 以确保样本数据中每一行都是一个样本（行数设为 <code>-1</code> 以自动推导 <code>batch_size</code>），每一列都是该样本的像素信息（把二维像素信息拍平成一维）</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="ZGVmJTIwbmV0KFgpJTNBJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwc29mdG1heCh0b3JjaC5tYXRtdWwoWC5yZXNoYXBlKCgtMSUyQyUyMFcuc2hhcGUlNUIwJTVEKSklMkMlMjBXKSUyMCUyQiUyMGIpJTBB"><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div></div><div class="code"><span class="hljs-keyword">def</span> <span class="hljs-title function_">net</span>(<span class="hljs-params">X</span>):
    <span class="hljs-keyword">return</span> softmax(torch.matmul(X.reshape((-<span class="hljs-number">1</span>, W.shape[<span class="hljs-number">0</span>])), W) + b)
</div></code></pre>
<p>然后样本数据与我们当前预测的权重矩阵相乘，就得到了每个样本对于每个分类的比例，然后再通过 <code>softmax</code> 将比例规范化，同时加上偏置
通过神经网络就能得到我们的 <code>y_hat</code> 了
然后我们定义交叉熵损失函数：</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="ZGVmJTIwY3Jvc3NfZW50cm9weSh5X2hhdCUyQyUyMHkpJTNBJTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwLSUyMHRvcmNoLmxvZyh5X2hhdCU1QnJhbmdlKGxlbih5X2hhdCkpJTJDJTIweSU1RCklMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div></div><div class="code"><span class="hljs-keyword">def</span> <span class="hljs-title function_">cross_entropy</span>(<span class="hljs-params">y_hat, y</span>):
    <span class="hljs-keyword">return</span> - torch.log(y_hat[<span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(y_hat)), y])
</div></code></pre>
<p>我们这里的 <code>y</code> 是一个向量，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>y</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">y_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> 表示第 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> 个样本属于哪类。<code>y_hat[range(len(y_hat)), y]</code> 中，<code>range(len(y_hat))</code> 指明了我们要取 <code>y_hat</code> 的所有行（<code>len</code> 取的是行数），<code>y</code> 是一个 list，指明了每行取哪一列，算是 python 的语法糖。然后按照交叉熵损失的定义来求
为了统计精度数据，我们还需要 <code>accuracy</code> 函数来计算我们这个预测结果在这个样本数据上正确了多少个：</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="ZGVmJTIwYWNjdXJhY3koeV9oYXQlMkMlMjB5KSUzQSUwQSUyMCUyMCUyMCUyMCUyMiUyMiUyMiVFOCVBRSVBMSVFNyVBRSU5NyVFOSVBMiU4NCVFNiVCNSU4QiVFNiVBRCVBMyVFNyVBMSVBRSVFNyU5QSU4NCVFNiU5NSVCMCVFOSU4NyU4RiUyMiUyMiUyMiUwQSUyMCUyMCUyMCUyMGlmJTIwbGVuKHlfaGF0LnNoYXBlKSUyMCUzRSUyMDElMjBhbmQlMjB5X2hhdC5zaGFwZSU1QjElNUQlMjAlM0UlMjAxJTNBJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIweV9oYXQlMjAlM0QlMjB5X2hhdC5hcmdtYXgoYXhpcyUzRDEpJTIwJTIzJTIwJUU1JTg4JTk3JUU0JUI4JThBJUU2JTg5JUJFJUU2JTlDJTgwJUU1JUE0JUE3JUU3JTlBJTg0JUU2JUE2JTgyJUU3JThFJTg3JUVGJUJDJThDJUU1JThEJUIzJUU0JUI4JUJBJUU2JTg4JTkxJUU0JUJCJUFDJUU2JTlDJTgwJUU3JUJCJTg4JUU3JUExJUFFJUU1JUFFJTlBJUU3JTlBJTg0JUU3JUJCJTkzJUU2JTlFJTlDJTBBJTIwJTIwJTIwJTIwY21wJTIwJTNEJTIweV9oYXQudHlwZSh5LmR0eXBlKSUyMCUzRCUzRCUyMHklMEElMjAlMjAlMjAlMjByZXR1cm4lMjBmbG9hdChjbXAudHlwZSh5LmR0eXBlKS5zdW0oKSklMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div></div><div class="code"><span class="hljs-keyword">def</span> <span class="hljs-title function_">accuracy</span>(<span class="hljs-params">y_hat, y</span>):
    <span class="hljs-string">&quot;&quot;&quot;计算预测正确的数量&quot;&quot;&quot;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(y_hat.shape) &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> y_hat.shape[<span class="hljs-number">1</span>] &gt; <span class="hljs-number">1</span>:
        y_hat = y_hat.argmax(axis=<span class="hljs-number">1</span>) <span class="hljs-comment"># 列上找最大的概率，即为我们最终确定的结果</span>
    cmp = y_hat.<span class="hljs-built_in">type</span>(y.dtype) == y
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">float</span>(cmp.<span class="hljs-built_in">type</span>(y.dtype).<span class="hljs-built_in">sum</span>())
</div></code></pre>
<p><code>accuracy(y_hat, y) / len(y)</code> 即为正确率
然后定义实用类 <code>Accumulator</code> 作为累加器：</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="Y2xhc3MlMjBBY2N1bXVsYXRvciUzQSUwQSUyMCUyMCUyMCUyMCUyMiUyMiUyMiVFNSU5QyVBOG4lRTQlQjglQUElRTUlOEYlOTglRTklODclOEYlRTQlQjglOEElRTclQjQlQUYlRTUlOEElQTAlMjIlMjIlMjIlMEElMjAlMjAlMjAlMjBkZWYlMjBfX2luaXRfXyhzZWxmJTJDJTIwbiklM0ElMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBzZWxmLmRhdGElMjAlM0QlMjAlNUIwLjAlNUQlMjAqJTIwbiUwQSUyMCUyMCUyMCUyMGRlZiUyMGFkZChzZWxmJTJDJTIwKmFyZ3MpJTNBJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwc2VsZi5kYXRhJTIwJTNEJTIwJTVCYSUyMCUyQiUyMGZsb2F0KGIpJTIwZm9yJTIwYSUyQyUyMGIlMjBpbiUyMHppcChzZWxmLmRhdGElMkMlMjBhcmdzKSU1RCUwQSUyMCUyMCUyMCUyMGRlZiUyMHJlc2V0KHNlbGYpJTNBJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwc2VsZi5kYXRhJTIwJTNEJTIwJTVCMC4wJTVEJTIwKiUyMGxlbihzZWxmLmRhdGEpJTBBJTIwJTIwJTIwJTIwZGVmJTIwX19nZXRpdGVtX18oc2VsZiUyQyUyMGlkeCklM0ElMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjByZXR1cm4lMjBzZWxmLmRhdGElNUJpZHglNUQlMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div></div><div class="code"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Accumulator</span>:
    <span class="hljs-string">&quot;&quot;&quot;在n个变量上累加&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n</span>):
        <span class="hljs-variable language_">self</span>.data = [<span class="hljs-number">0.0</span>] * n
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, *args</span>):
        <span class="hljs-variable language_">self</span>.data = [a + <span class="hljs-built_in">float</span>(b) <span class="hljs-keyword">for</span> a, b <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(<span class="hljs-variable language_">self</span>.data, args)]
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reset</span>(<span class="hljs-params">self</span>):
        <span class="hljs-variable language_">self</span>.data = [<span class="hljs-number">0.0</span>] * <span class="hljs-built_in">len</span>(<span class="hljs-variable language_">self</span>.data)
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">self</span>.data[idx]
</div></code></pre>
<p>定义 <code>evaluate_acccuracy</code> 来计算在整个数据集上的精确度：</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="ZGVmJTIwZXZhbHVhdGVfYWNjdXJhY3kobmV0JTJDJTIwZGF0YV9pdGVyKSUzQSUwQSUyMCUyMCUyMCUyMCUyMiUyMiUyMiVFOCVBRSVBMSVFNyVBRSU5NyVFNSU5QyVBOCVFNiU4QyU4NyVFNSVBRSU5QSVFNiU5NSVCMCVFNiU4RCVBRSVFOSU5QiU4NiVFNCVCOCU4QSVFNiVBOCVBMSVFNSU5RSU4QiVFNyU5QSU4NCVFNyVCMiVCRSVFNSVCQSVBNiUyMiUyMiUyMiUwQSUyMCUyMCUyMCUyMGlmJTIwaXNpbnN0YW5jZShuZXQlMkMlMjB0b3JjaC5ubi5Nb2R1bGUpJTNBJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwbmV0LmV2YWwoKSUyMCUyMCUyMyUyMCVFNSVCMCU4NiVFNiVBOCVBMSVFNSU5RSU4QiVFOCVBRSVCRSVFNyVCRCVBRSVFNCVCOCVCQSVFOCVBRiU4NCVFNCVCQyVCMCVFNiVBOCVBMSVFNSVCQyU4RiUwQSUyMCUyMCUyMCUyMG1ldHJpYyUyMCUzRCUyMEFjY3VtdWxhdG9yKDIpJTIwJTIwJTIzJTIwJUU2JUFEJUEzJUU3JUExJUFFJUU5JUEyJTg0JUU2JUI1JThCJUU2JTk1JUIwJUUzJTgwJTgxJUU5JUEyJTg0JUU2JUI1JThCJUU2JTgwJUJCJUU2JTk1JUIwJTBBJTIwJTIwJTIwJTIwd2l0aCUyMHRvcmNoLm5vX2dyYWQoKSUzQSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGZvciUyMFglMkMlMjB5JTIwaW4lMjBkYXRhX2l0ZXIlM0ElMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBtZXRyaWMuYWRkKGFjY3VyYWN5KG5ldChYKSUyQyUyMHkpJTJDJTIweS5udW1lbCgpKSUwQSUyMCUyMCUyMCUyMHJldHVybiUyMG1ldHJpYyU1QjAlNUQlMjAlMkYlMjBtZXRyaWMlNUIxJTVEJTBB"><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div></div><div class="code"><span class="hljs-keyword">def</span> <span class="hljs-title function_">evaluate_accuracy</span>(<span class="hljs-params">net, data_iter</span>):
    <span class="hljs-string">&quot;&quot;&quot;计算在指定数据集上模型的精度&quot;&quot;&quot;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(net, torch.nn.Module):
        net.<span class="hljs-built_in">eval</span>()  <span class="hljs-comment"># 将模型设置为评估模式</span>
    metric = Accumulator(<span class="hljs-number">2</span>)  <span class="hljs-comment"># 正确预测数、预测总数</span>
    <span class="hljs-keyword">with</span> torch.no_grad():
        <span class="hljs-keyword">for</span> X, y <span class="hljs-keyword">in</span> data_iter:
            metric.add(accuracy(net(X), y), y.numel())
    <span class="hljs-keyword">return</span> metric[<span class="hljs-number">0</span>] / metric[<span class="hljs-number">1</span>]
</div></code></pre>
<p>定义一个 <code>Animator</code>，以便后续动态观察我们的训练情况</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="ZnJvbSUyMG1hdHBsb3RsaWJfaW5saW5lJTIwaW1wb3J0JTIwYmFja2VuZF9pbmxpbmUlMEFkZWYlMjB1c2Vfc3ZnX2Rpc3BsYXkoKSUzQSUwQSUyMCUyMCUyMCUyMCUyMiUyMiUyMlVzZSUyMHRoZSUyMHN2ZyUyMGZvcm1hdCUyMHRvJTIwZGlzcGxheSUyMGElMjBwbG90JTIwaW4lMjBKdXB5dGVyLiUwQSUyMCUyMCUyMCUyMERlZmluZWQlMjBpbiUyMCUzQW51bXJlZiUzQSU2MHNlY19jYWxjdWx1cyU2MCUyMiUyMiUyMiUwQSUyMCUyMCUyMCUyMGJhY2tlbmRfaW5saW5lLnNldF9tYXRwbG90bGliX2Zvcm1hdHMoJ3N2ZycpJTBBY2xhc3MlMjBBbmltYXRvciUzQSUwQSUyMCUyMCUyMCUyMCUyMiUyMiUyMiVFNSU5QyVBOCVFNSU4QSVBOCVFNyU5NCVCQiVFNCVCOCVBRCVFNyVCQiU5OCVFNSU4OCVCNiVFNiU5NSVCMCVFNiU4RCVBRSUyMiUyMiUyMiUwQSUyMCUyMCUyMCUyMGRlZiUyMF9faW5pdF9fKHNlbGYlMkMlMjB4bGFiZWwlM0ROb25lJTJDJTIweWxhYmVsJTNETm9uZSUyQyUyMGxlZ2VuZCUzRE5vbmUlMkMlMjB4bGltJTNETm9uZSUyQyUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHlsaW0lM0ROb25lJTJDJTIweHNjYWxlJTNEJ2xpbmVhciclMkMlMjB5c2NhbGUlM0QnbGluZWFyJyUyQyUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGZtdHMlM0QoJy0nJTJDJTIwJ20tLSclMkMlMjAnZy0uJyUyQyUyMCdyJTNBJyklMkMlMjBucm93cyUzRDElMkMlMjBuY29scyUzRDElMkMlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBmaWdzaXplJTNEKDMuNSUyQyUyMDIuNSkpJTNBJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzJTIwJUU1JUEyJTlFJUU5JTg3JThGJUU1JTlDJUIwJUU3JUJCJTk4JUU1JTg4JUI2JUU1JUE0JTlBJUU2JTlEJUExJUU3JUJBJUJGJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYlMjBsZWdlbmQlMjBpcyUyME5vbmUlM0ElMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBsZWdlbmQlMjAlM0QlMjAlNUIlNUQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB1c2Vfc3ZnX2Rpc3BsYXkoKSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHNlbGYuZmlnJTJDJTIwc2VsZi5heGVzJTIwJTNEJTIwcGx0LnN1YnBsb3RzKG5yb3dzJTJDJTIwbmNvbHMlMkMlMjBmaWdzaXplJTNEZmlnc2l6ZSklMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZiUyMG5yb3dzJTIwKiUyMG5jb2xzJTIwJTNEJTNEJTIwMSUzQSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHNlbGYuYXhlcyUyMCUzRCUyMCU1QnNlbGYuYXhlcyUyQyUyMCU1RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMyUyMCVFNCVCRCVCRiVFNyU5NCVBOGxhbWJkYSVFNSU4NyVCRCVFNiU5NSVCMCVFNiU4RCU5NSVFOCU4RSVCNyVFNSU4RiU4MiVFNiU5NSVCMCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHNlbGYuY29uZmlnX2F4ZXMlMjAlM0QlMjBsYW1iZGElM0ElMjBkMmwuc2V0X2F4ZXMoJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwc2VsZi5heGVzJTVCMCU1RCUyQyUyMHhsYWJlbCUyQyUyMHlsYWJlbCUyQyUyMHhsaW0lMkMlMjB5bGltJTJDJTIweHNjYWxlJTJDJTIweXNjYWxlJTJDJTIwbGVnZW5kKSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHNlbGYuWCUyQyUyMHNlbGYuWSUyQyUyMHNlbGYuZm10cyUyMCUzRCUyME5vbmUlMkMlMjBOb25lJTJDJTIwZm10cyUwQSUyMCUyMCUyMCUyMGRlZiUyMGFkZChzZWxmJTJDJTIweCUyQyUyMHkpJTNBJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIzJTIwJUU1JTkwJTkxJUU1JTlCJUJFJUU4JUExJUE4JUU0JUI4JUFEJUU2JUI3JUJCJUU1JThBJUEwJUU1JUE0JTlBJUU0JUI4JUFBJUU2JTk1JUIwJUU2JThEJUFFJUU3JTgyJUI5JTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYlMjBub3QlMjBoYXNhdHRyKHklMkMlMjAlMjJfX2xlbl9fJTIyKSUzQSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHklMjAlM0QlMjAlNUJ5JTVEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwbiUyMCUzRCUyMGxlbih5KSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmJTIwbm90JTIwaGFzYXR0cih4JTJDJTIwJTIyX19sZW5fXyUyMiklM0ElMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB4JTIwJTNEJTIwJTVCeCU1RCUyMColMjBuJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYlMjBub3QlMjBzZWxmLlglM0ElMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBzZWxmLlglMjAlM0QlMjAlNUIlNUIlNUQlMjBmb3IlMjBfJTIwaW4lMjByYW5nZShuKSU1RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmJTIwbm90JTIwc2VsZi5ZJTNBJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwc2VsZi5ZJTIwJTNEJTIwJTVCJTVCJTVEJTIwZm9yJTIwXyUyMGluJTIwcmFuZ2UobiklNUQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBmb3IlMjBpJTJDJTIwKGElMkMlMjBiKSUyMGluJTIwZW51bWVyYXRlKHppcCh4JTJDJTIweSkpJTNBJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYlMjBhJTIwaXMlMjBub3QlMjBOb25lJTIwYW5kJTIwYiUyMGlzJTIwbm90JTIwTm9uZSUzQSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHNlbGYuWCU1QmklNUQuYXBwZW5kKGEpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwc2VsZi5ZJTVCaSU1RC5hcHBlbmQoYiklMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBzZWxmLmF4ZXMlNUIwJTVELmNsYSgpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwZm9yJTIweCUyQyUyMHklMkMlMjBmbXQlMjBpbiUyMHppcChzZWxmLlglMkMlMjBzZWxmLlklMkMlMjBzZWxmLmZtdHMpJTNBJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwc2VsZi5heGVzJTVCMCU1RC5wbG90KHglMkMlMjB5JTJDJTIwZm10KSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHNlbGYuY29uZmlnX2F4ZXMoKSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGRpc3BsYXkuZGlzcGxheShzZWxmLmZpZyklMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBkaXNwbGF5LmNsZWFyX291dHB1dCh3YWl0JTNEVHJ1ZSklMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div></div><div class="code"><span class="hljs-keyword">from</span> matplotlib_inline <span class="hljs-keyword">import</span> backend_inline
<span class="hljs-keyword">def</span> <span class="hljs-title function_">use_svg_display</span>():
    <span class="hljs-string">&quot;&quot;&quot;Use the svg format to display a plot in Jupyter.
    Defined in :numref:`sec_calculus`&quot;&quot;&quot;</span>
    backend_inline.set_matplotlib_formats(<span class="hljs-string">&#x27;svg&#x27;</span>)
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Animator</span>:
    <span class="hljs-string">&quot;&quot;&quot;在动画中绘制数据&quot;&quot;&quot;</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, xlabel=<span class="hljs-literal">None</span>, ylabel=<span class="hljs-literal">None</span>, legend=<span class="hljs-literal">None</span>, xlim=<span class="hljs-literal">None</span>,
                 ylim=<span class="hljs-literal">None</span>, xscale=<span class="hljs-string">&#x27;linear&#x27;</span>, yscale=<span class="hljs-string">&#x27;linear&#x27;</span>,
                 fmts=(<span class="hljs-params"><span class="hljs-string">&#x27;-&#x27;</span>, <span class="hljs-string">&#x27;m--&#x27;</span>, <span class="hljs-string">&#x27;g-.&#x27;</span>, <span class="hljs-string">&#x27;r:&#x27;</span></span>), nrows=<span class="hljs-number">1</span>, ncols=<span class="hljs-number">1</span>,
                 figsize=(<span class="hljs-params"><span class="hljs-number">3.5</span>, <span class="hljs-number">2.5</span></span>)</span>):
        <span class="hljs-comment"># 增量地绘制多条线</span>
        <span class="hljs-keyword">if</span> legend <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            legend = []
        use_svg_display()
        <span class="hljs-variable language_">self</span>.fig, <span class="hljs-variable language_">self</span>.axes = plt.subplots(nrows, ncols, figsize=figsize)
        <span class="hljs-keyword">if</span> nrows * ncols == <span class="hljs-number">1</span>:
            <span class="hljs-variable language_">self</span>.axes = [<span class="hljs-variable language_">self</span>.axes, ]
        <span class="hljs-comment"># 使用lambda函数捕获参数</span>
        <span class="hljs-variable language_">self</span>.config_axes = <span class="hljs-keyword">lambda</span>: d2l.set_axes(
            <span class="hljs-variable language_">self</span>.axes[<span class="hljs-number">0</span>], xlabel, ylabel, xlim, ylim, xscale, yscale, legend)
        <span class="hljs-variable language_">self</span>.X, <span class="hljs-variable language_">self</span>.Y, <span class="hljs-variable language_">self</span>.fmts = <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, fmts
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">self, x, y</span>):
        <span class="hljs-comment"># 向图表中添加多个数据点</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">hasattr</span>(y, <span class="hljs-string">&quot;__len__&quot;</span>):
            y = [y]
        n = <span class="hljs-built_in">len</span>(y)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">hasattr</span>(x, <span class="hljs-string">&quot;__len__&quot;</span>):
            x = [x] * n
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.X:
            <span class="hljs-variable language_">self</span>.X = [[] <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n)]
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-variable language_">self</span>.Y:
            <span class="hljs-variable language_">self</span>.Y = [[] <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n)]
        <span class="hljs-keyword">for</span> i, (a, b) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(x, y)):
            <span class="hljs-keyword">if</span> a <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">and</span> b <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                <span class="hljs-variable language_">self</span>.X[i].append(a)
                <span class="hljs-variable language_">self</span>.Y[i].append(b)
        <span class="hljs-variable language_">self</span>.axes[<span class="hljs-number">0</span>].cla()
        <span class="hljs-keyword">for</span> x, y, fmt <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(<span class="hljs-variable language_">self</span>.X, <span class="hljs-variable language_">self</span>.Y, <span class="hljs-variable language_">self</span>.fmts):
            <span class="hljs-variable language_">self</span>.axes[<span class="hljs-number">0</span>].plot(x, y, fmt)
        <span class="hljs-variable language_">self</span>.config_axes()
        display.display(<span class="hljs-variable language_">self</span>.fig)
        display.clear_output(wait=<span class="hljs-literal">True</span>)
</div></code></pre>
<p>定义训练函数 <code>train_epoch</code></p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="ZGVmJTIwdHJhaW5fZXBvY2gobmV0JTJDJTIwdHJhaW5faXRlciUyQyUyMGxvc3MlMkMlMjB1cGRhdGVyKSUzQSUwQSUyMCUyMCUyMCUyMCUyMiUyMiUyMiVFOCVBRSVBRCVFNyVCQiU4MyVFNiVBOCVBMSVFNSU5RSU4QiVFNCVCOCU4MCVFNCVCOCVBQSVFOCVCRiVBRCVFNCVCQiVBMyVFNSU5MSVBOCVFNiU5QyU5RiVFRiVCQyU4OCVFNSVBRSU5QSVFNCVCOSU4OSVFOCVBNyU4MSVFNyVBQyVBQzMlRTclQUIlQTAlRUYlQkMlODklMjIlMjIlMjIlMEElMjAlMjAlMjAlMjAlMjMlMjAlRTUlQjAlODYlRTYlQTglQTElRTUlOUUlOEIlRTglQUUlQkUlRTclQkQlQUUlRTQlQjglQkElRTglQUUlQUQlRTclQkIlODMlRTYlQTglQTElRTUlQkMlOEYlMEElMjAlMjAlMjAlMjBpZiUyMGlzaW5zdGFuY2UobmV0JTJDJTIwdG9yY2gubm4uTW9kdWxlKSUzQSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMG5ldC50cmFpbigpJTBBJTIwJTIwJTIwJTIwJTIzJTIwJUU4JUFFJUFEJUU3JUJCJTgzJUU2JThEJTlGJUU1JUE0JUIxJUU2JTgwJUJCJUU1JTkyJThDJUUzJTgwJTgxJUU4JUFFJUFEJUU3JUJCJTgzJUU1JTg3JTg2JUU3JUExJUFFJUU1JUJBJUE2JUU2JTgwJUJCJUU1JTkyJThDJUUzJTgwJTgxJUU2JUEwJUI3JUU2JTlDJUFDJUU2JTk1JUIwJTBBJTIwJTIwJTIwJTIwbWV0cmljJTIwJTNEJTIwQWNjdW11bGF0b3IoMyklMEElMjAlMjAlMjAlMjBmb3IlMjBYJTJDJTIweSUyMGluJTIwdHJhaW5faXRlciUzQSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMyUyMCVFOCVBRSVBMSVFNyVBRSU5NyVFNiVBMiVBRiVFNSVCQSVBNiVFNSVCOSVCNiVFNiU5QiVCNCVFNiU5NiVCMCVFNSU4RiU4MiVFNiU5NSVCMCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHlfaGF0JTIwJTNEJTIwbmV0KFgpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwbCUyMCUzRCUyMGxvc3MoeV9oYXQlMkMlMjB5KSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmJTIwaXNpbnN0YW5jZSh1cGRhdGVyJTJDJTIwdG9yY2gub3B0aW0uT3B0aW1pemVyKSUzQSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMyUyMCVFNCVCRCVCRiVFNyU5NCVBOFB5VG9yY2glRTUlODYlODUlRTclQkQlQUUlRTclOUElODQlRTQlQkMlOTglRTUlOEMlOTYlRTUlOTklQTglRTUlOTIlOEMlRTYlOEQlOUYlRTUlQTQlQjElRTUlODclQkQlRTYlOTUlQjAlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB1cGRhdGVyLnplcm9fZ3JhZCgpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwbC5tZWFuKCkuYmFja3dhcmQoKSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHVwZGF0ZXIuc3RlcCgpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwZWxzZSUzQSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMyUyMCVFNCVCRCVCRiVFNyU5NCVBOCVFNSVBRSU5QSVFNSU4OCVCNiVFNyU5QSU4NCVFNCVCQyU5OCVFNSU4QyU5NiVFNSU5OSVBOCVFNSU5MiU4QyVFNiU4RCU5RiVFNSVBNCVCMSVFNSU4NyVCRCVFNiU5NSVCMCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGwuc3VtKCkuYmFja3dhcmQoKSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHVwZGF0ZXIoWC5zaGFwZSU1QjAlNUQpJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwbWV0cmljLmFkZChmbG9hdChsLnN1bSgpKSUyQyUyMGFjY3VyYWN5KHlfaGF0JTJDJTIweSklMkMlMjB5Lm51bWVsKCkpJTBBJTIwJTIwJTIwJTIwJTIzJTIwJUU4JUJGJTk0JUU1JTlCJTlFJUU4JUFFJUFEJUU3JUJCJTgzJUU2JThEJTlGJUU1JUE0JUIxJUU1JTkyJThDJUU4JUFFJUFEJUU3JUJCJTgzJUU3JUIyJUJFJUU1JUJBJUE2JTBBJTIwJTIwJTIwJTIwcmV0dXJuJTIwbWV0cmljJTVCMCU1RCUyMCUyRiUyMG1ldHJpYyU1QjIlNUQlMkMlMjBtZXRyaWMlNUIxJTVEJTIwJTJGJTIwbWV0cmljJTVCMiU1RCUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div></div><div class="code"><span class="hljs-keyword">def</span> <span class="hljs-title function_">train_epoch</span>(<span class="hljs-params">net, train_iter, loss, updater</span>):
    <span class="hljs-string">&quot;&quot;&quot;训练模型一个迭代周期（定义见第3章）&quot;&quot;&quot;</span>
    <span class="hljs-comment"># 将模型设置为训练模式</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(net, torch.nn.Module):
        net.train()
    <span class="hljs-comment"># 训练损失总和、训练准确度总和、样本数</span>
    metric = Accumulator(<span class="hljs-number">3</span>)
    <span class="hljs-keyword">for</span> X, y <span class="hljs-keyword">in</span> train_iter:
        <span class="hljs-comment"># 计算梯度并更新参数</span>
        y_hat = net(X)
        l = loss(y_hat, y)
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(updater, torch.optim.Optimizer):
            <span class="hljs-comment"># 使用PyTorch内置的优化器和损失函数</span>
            updater.zero_grad()
            l.mean().backward()
            updater.step()
        <span class="hljs-keyword">else</span>:
            <span class="hljs-comment"># 使用定制的优化器和损失函数</span>
            l.<span class="hljs-built_in">sum</span>().backward()
            updater(X.shape[<span class="hljs-number">0</span>])
        metric.add(<span class="hljs-built_in">float</span>(l.<span class="hljs-built_in">sum</span>()), accuracy(y_hat, y), y.numel())
    <span class="hljs-comment"># 返回训练损失和训练精度</span>
    <span class="hljs-keyword">return</span> metric[<span class="hljs-number">0</span>] / metric[<span class="hljs-number">2</span>], metric[<span class="hljs-number">1</span>] / metric[<span class="hljs-number">2</span>]
</div></code></pre>
<p>定义 <code>updater</code></p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="ZGVmJTIwdXBkYXRlcihiYXRjaF9zaXplKSUzQSUwQSUyMCUyMCUyMCUyMHJldHVybiUyMHNnZCglNUJXJTJDJTIwYiU1RCUyQyUyMGxyJTJDJTIwYmF0Y2hfc2l6ZSklMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div></div><div class="code"><span class="hljs-keyword">def</span> <span class="hljs-title function_">updater</span>(<span class="hljs-params">batch_size</span>):
    <span class="hljs-keyword">return</span> sgd([W, b], lr, batch_size)
</div></code></pre>
<p>总训练函数 <code>train</code></p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="ZGVmJTIwdHJhaW4obmV0JTJDJTIwdHJhaW5faXRlciUyQyUyMHRlc3RfaXRlciUyQyUyMGxvc3MlMkMlMjBudW1fZXBvY2hzJTJDJTIwdXBkYXRlciklM0ElMEElMjAlMjAlMjAlMjAlMjIlMjIlMjIlRTglQUUlQUQlRTclQkIlODMlRTYlQTglQTElRTUlOUUlOEIlRUYlQkMlODglRTUlQUUlOUElRTQlQjklODklRTglQTclODElRTclQUMlQUMzJUU3JUFCJUEwJUVGJUJDJTg5JTIyJTIyJTIyJTBBJTIwJTIwJTIwJTIwYW5pbWF0b3IlMjAlM0QlMjBBbmltYXRvcih4bGFiZWwlM0QnZXBvY2gnJTJDJTIweGxpbSUzRCU1QjElMkMlMjBudW1fZXBvY2hzJTVEJTJDJTIweWxpbSUzRCU1QjAuMyUyQyUyMDAuOSU1RCUyQyUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGxlZ2VuZCUzRCU1Qid0cmFpbiUyMGxvc3MnJTJDJTIwJ3RyYWluJTIwYWNjJyUyQyUyMCd0ZXN0JTIwYWNjJyU1RCklMEElMjAlMjAlMjAlMjBmb3IlMjBlcG9jaCUyMGluJTIwcmFuZ2UobnVtX2Vwb2NocyklM0ElMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB0cmFpbl9tZXRyaWNzJTIwJTNEJTIwdHJhaW5fZXBvY2gobmV0JTJDJTIwdHJhaW5faXRlciUyQyUyMGxvc3MlMkMlMjB1cGRhdGVyKSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRlc3RfYWNjJTIwJTNEJTIwZXZhbHVhdGVfYWNjdXJhY3kobmV0JTJDJTIwdGVzdF9pdGVyKSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGFuaW1hdG9yLmFkZChlcG9jaCUyMCUyQiUyMDElMkMlMjB0cmFpbl9tZXRyaWNzJTIwJTJCJTIwKHRlc3RfYWNjJTJDKSklMEElMjAlMjAlMjAlMjB0cmFpbl9sb3NzJTJDJTIwdHJhaW5fYWNjJTIwJTNEJTIwdHJhaW5fbWV0cmljcyUwQSUyMCUyMCUyMCUyMGFzc2VydCUyMHRyYWluX2xvc3MlMjAlM0MlMjAwLjUlMkMlMjB0cmFpbl9sb3NzJTBBJTIwJTIwJTIwJTIwYXNzZXJ0JTIwdHJhaW5fYWNjJTIwJTNDJTNEJTIwMSUyMGFuZCUyMHRyYWluX2FjYyUyMCUzRSUyMDAuNyUyQyUyMHRyYWluX2FjYyUwQSUyMCUyMCUyMCUyMGFzc2VydCUyMHRlc3RfYWNjJTIwJTNDJTNEJTIwMSUyMGFuZCUyMHRlc3RfYWNjJTIwJTNFJTIwMC43JTJDJTIwdGVzdF9hY2MlMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div></div><div class="code"><span class="hljs-keyword">def</span> <span class="hljs-title function_">train</span>(<span class="hljs-params">net, train_iter, test_iter, loss, num_epochs, updater</span>):
    <span class="hljs-string">&quot;&quot;&quot;训练模型（定义见第3章）&quot;&quot;&quot;</span>
    animator = Animator(xlabel=<span class="hljs-string">&#x27;epoch&#x27;</span>, xlim=[<span class="hljs-number">1</span>, num_epochs], ylim=[<span class="hljs-number">0.3</span>, <span class="hljs-number">0.9</span>],
                        legend=[<span class="hljs-string">&#x27;train loss&#x27;</span>, <span class="hljs-string">&#x27;train acc&#x27;</span>, <span class="hljs-string">&#x27;test acc&#x27;</span>])
    <span class="hljs-keyword">for</span> epoch <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_epochs):
        train_metrics = train_epoch(net, train_iter, loss, updater)
        test_acc = evaluate_accuracy(net, test_iter)
        animator.add(epoch + <span class="hljs-number">1</span>, train_metrics + (test_acc,))
    train_loss, train_acc = train_metrics
    <span class="hljs-keyword">assert</span> train_loss &lt; <span class="hljs-number">0.5</span>, train_loss
    <span class="hljs-keyword">assert</span> train_acc &lt;= <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> train_acc &gt; <span class="hljs-number">0.7</span>, train_acc
    <span class="hljs-keyword">assert</span> test_acc &lt;= <span class="hljs-number">1</span> <span class="hljs-keyword">and</span> test_acc &gt; <span class="hljs-number">0.7</span>, test_acc
</div></code></pre>
<p>设置学习率和训练次数后即可训练：</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="bHIlMjAlM0QlMjAwLjElMEFudW1fZXBvY2hzJTIwJTNEJTIwMTAlMEF0cmFpbihuZXQlMkMlMjB0cmFpbl9pdGVyJTJDJTIwdGVzdF9pdGVyJTJDJTIwY3Jvc3NfZW50cm9weSUyQyUyMG51bV9lcG9jaHMlMkMlMjB1cGRhdGVyKSUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div></div><div class="code">lr = <span class="hljs-number">0.1</span>
num_epochs = <span class="hljs-number">10</span>
train(net, train_iter, test_iter, cross_entropy, num_epochs, updater)
</div></code></pre>
<h3 id="3-3-jian-bian-xie-fa" tabindex="-1">3.3 简便写法</h3>
<p>一样的准备数据集</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="YmF0Y2hfc2l6ZSUyMCUzRCUyMDI1NiUwQXRyYWluX2l0ZXIlMkMlMjB0ZXN0X2l0ZXIlMjAlM0QlMjBkMmwubG9hZF9kYXRhX2Zhc2hpb25fbW5pc3QoYmF0Y2hfc2l6ZSklMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div></div><div class="code">batch_size = <span class="hljs-number">256</span>
train_iter, test_iter = d2l.load_data_fashion_mnist(batch_size)
</div></code></pre>
<p>然后定义神经网络：</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="JTIzJTIwUHlUb3JjaCVFNCVCOCU4RCVFNCVCQyU5QSVFOSU5QSU5MCVFNSVCQyU4RiVFNSU5QyVCMCVFOCVCMCU4MyVFNiU5NSVCNCVFOCVCRSU5MyVFNSU4NSVBNSVFNyU5QSU4NCVFNSVCRCVBMiVFNyU4QSVCNiVFMyU4MCU4MiVFNSU5QiVBMCVFNiVBRCVBNCVFRiVCQyU4QyUwQSUyMyUyMCVFNiU4OCU5MSVFNCVCQiVBQyVFNSU5QyVBOCVFNyVCQSVCRiVFNiU4MCVBNyVFNSVCMSU4MiVFNSU4OSU4RCVFNSVBRSU5QSVFNCVCOSU4OSVFNCVCQSU4NiVFNSVCMSU5NSVFNSVCOSVCMyVFNSVCMSU4MiVFRiVCQyU4OGZsYXR0ZW4lRUYlQkMlODklRUYlQkMlOEMlRTYlOUQlQTUlRTglQjAlODMlRTYlOTUlQjQlRTclQkQlOTElRTclQkIlOUMlRTglQkUlOTMlRTUlODUlQTUlRTclOUElODQlRTUlQkQlQTIlRTclOEElQjYlMEElMjMlMjBubi5GbGF0dGVuJTIwJUU1JUIwJTg2JUU0JUJDJTlBJUU0JUJGJTlEJUU3JTk1JTk5JUU3JUFDJUFDJUU0JUI4JTgwJUU3JUJCJUI0JUU1JUJBJUE2JUVGJUJDJThDJUU3JTg0JUI2JUU1JTkwJThFJUU1JTg5JUE5JUU0JUJEJTk5JUU3JTlBJTg0JUU3JUJCJUI0JUU1JUJBJUE2JUU1JTg1JUE4JUU5JTgzJUE4JUU1JUIxJTk1JUU1JUI5JUIzJTBBbmV0JTIwJTNEJTIwbm4uU2VxdWVudGlhbChubi5GbGF0dGVuKCklMkMlMjBubi5MaW5lYXIoNzg0JTJDJTIwMTApKSUwQWRlZiUyMGluaXRfd2VpZ2h0cyhtKSUzQSUwQSUyMCUyMCUyMCUyMGlmJTIwdHlwZShtKSUyMCUzRCUzRCUyMG5uLkxpbmVhciUzQSUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMG5uLmluaXQubm9ybWFsXyhtLndlaWdodCUyQyUyMHN0ZCUzRDAuMDEpJTBBbmV0LmFwcGx5KGluaXRfd2VpZ2h0cyklM0IlMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div></div><div class="code"><span class="hljs-comment"># PyTorch不会隐式地调整输入的形状。因此，</span>
<span class="hljs-comment"># 我们在线性层前定义了展平层（flatten），来调整网络输入的形状</span>
<span class="hljs-comment"># nn.Flatten 将会保留第一维度，然后剩余的维度全部展平</span>
net = nn.Sequential(nn.Flatten(), nn.Linear(<span class="hljs-number">784</span>, <span class="hljs-number">10</span>))
<span class="hljs-keyword">def</span> <span class="hljs-title function_">init_weights</span>(<span class="hljs-params">m</span>):
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">type</span>(m) == nn.Linear:
        nn.init.normal_(m.weight, std=<span class="hljs-number">0.01</span>)
net.apply(init_weights);
</div></code></pre>
<p>然后定义 <code>loss</code></p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="bG9zcyUyMCUzRCUyMG5uLkNyb3NzRW50cm9weUxvc3MocmVkdWN0aW9uJTNEJ25vbmUnKSUwQQ=="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div></div><div class="code">loss = nn.CrossEntropyLoss(reduction=<span class="hljs-string">&#x27;none&#x27;</span>)
</div></code></pre>
<p>设置优化算法</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="dHJhaW5lciUyMCUzRCUyMHRvcmNoLm9wdGltLlNHRChuZXQucGFyYW1ldGVycygpJTJDJTIwbHIlM0QwLjEpJTBB"><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div></div><div class="code">trainer = torch.optim.SGD(net.parameters(), lr=<span class="hljs-number">0.1</span>)
</div></code></pre>
<p>然后训练：</p>
<pre><div class="head"><div class="language">python</div><div class="copy" data="bnVtX2Vwb2NocyUyMCUzRCUyMDEwJTBBdHJhaW4obmV0JTJDJTIwdHJhaW5faXRlciUyQyUyMHRlc3RfaXRlciUyQyUyMGxvc3MlMkMlMjBudW1fZXBvY2hzJTJDJTIwdHJhaW5lciklMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div></div><div class="code">num_epochs = <span class="hljs-number">10</span>
train(net, train_iter, test_iter, loss, num_epochs, trainer)
</div></code></pre>
