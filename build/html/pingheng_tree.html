<h2 id="ti-mu" tabindex="-1">题目</h2>
<h3 id="p4008-noi-2003-wen-ben-bian-ji-qi" tabindex="-1">P4008 [NOI2003] 文本编辑器</h3>
<p><a href="https://www.luogu.com.cn/problem/P4008">https://www.luogu.com.cn/problem/P4008</a>
<strong>题目描述</strong>
实现一个文本编辑器，有如下操作：</p>
<ol>
<li>将光标移动到某个位置</li>
<li>在光标后插入一个字符串</li>
<li>删除光标后若干字符</li>
<li>获取光标后若干字符</li>
<li>光标向前移动</li>
<li>光标向后移动
<strong>笔记</strong></li>
</ol>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTIzaW5jbHVkZSUzQ2JpdHMlMkZzdGRjJTJCJTJCLmglM0UlMEElMjNkZWZpbmUlMjBpbnQlMjBsb25nJTIwbG9uZyUwQSUyM2RlZmluZSUyMHVsbCUyMHVuc2lnbmVkJTIwbG9uZyUyMGxvbmclMEElMjNkZWZpbmUlMjBscyhrKSUyMChrKSUzQyUzQzElMEElMjNkZWZpbmUlMjBycyhrKSUyMChrKSUzQyUzQzElN0MxJTBBJTIzZGVmaW5lJTIwaWwlMjBpbmxpbmUlMEElMjNkZWZpbmUlMjBkZWJ1Zyh4KSUyMGNvdXQlM0MlM0MlMjN4JTNDJTNDJTIyJTNEJTIyJTNDJTNDeCUzQyUzQ2VuZGwlMEF1c2luZyUyMG5hbWVzcGFjZSUyMHN0ZCUzQiUwQWNvbnN0JTIwaW50JTIwaW5mJTNEMHgzZjNmM2YzZjNmM2YzZjNmJTNCJTBBY29uc3QlMjBpbnQlMjBtb2QlM0QwJTNCJTBBdHlwZWRlZiUyMHBhaXIlM0NpbnQlMkNpbnQlM0UlMjBwaWklM0IlMEElMjNkZWZpbmUlMjBfJTIwMTAyNCoxMDI0KjIlMEFzdHJ1Y3QlMjBGSFElN0IlMEElMjAlMjAlMjAlMjBpbnQlMjB0b3QlM0QwJTNCJTBBJTIwJTIwJTIwJTIwc3RydWN0JTIwTm9kZSU3QmludCUyMGxzJTJDcnMlMkNkYXQlMkNzaXolM0JjaGFyJTIwdmFsJTNCJTdEJTIwdHJlZSU1Ql8lNUQlM0IlMEElMjAlMjAlMjAlMjAlMjNkZWZpbmUlMjBudCUyMHRyZWUlNUJrJTVEJTBBJTIwJTIwJTIwJTIwJTIzZGVmaW5lJTIwbHQlMjB0cmVlJTVCdHJlZSU1QmslNUQubHMlNUQlMEElMjAlMjAlMjAlMjAlMjNkZWZpbmUlMjBydCUyMHRyZWUlNUJ0cmVlJTVCayU1RC5ycyU1RCUwQSUyMCUyMCUyMCUyMGlsJTIwdm9pZCUyMHVwZGF0ZShpbnQlMjBrKSU3Qm50LnNpeiUzRDElMkJsdC5zaXolMkJydC5zaXolM0IlN0QlMEElMjAlMjAlMjAlMjBpbCUyMGludCUyMGNyZWF0ZShjaGFyJTIwdiklN0JpbnQlMjBrJTNEJTJCJTJCdG90JTNCbnQuZGF0JTNEcmFuZCgpJTJDbnQudmFsJTNEdiUyQ250LnNpeiUzRDElM0JyZXR1cm4lMjB0b3QlM0IlN0QlMEElMjAlMjAlMjAlMjBpbCUyMGludCUyMG1lcmdlKGludCUyMHglMkNpbnQlMjB5KSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKCF4JTdDJTdDIXkpJTIwcmV0dXJuJTIweCUyQnklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZih0cmVlJTVCeCU1RC5kYXQlM0N0cmVlJTVCeSU1RC5kYXQpJTIwcmV0dXJuJTIwdHJlZSU1QnglNUQucnMlM0RtZXJnZSh0cmVlJTVCeCU1RC5ycyUyQ3kpJTJDdXBkYXRlKHgpJTJDeCUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGVsc2UlMjByZXR1cm4lMjB0cmVlJTVCeSU1RC5scyUzRG1lcmdlKHglMkN0cmVlJTVCeSU1RC5scyklMkN1cGRhdGUoeSklMkN5JTNCJTBBJTIwJTIwJTIwJTIwJTdEJTBBJTIwJTIwJTIwJTIwdm9pZCUyMHNwbGl0KGludCUyMGslMkNpbnQlMjB4JTJDaW50JTIwJTI2bCUyQ2ludCUyMCUyNnIpJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYoIWspJTIwcmV0dXJuJTIwbCUzRHIlM0QwJTJDdm9pZCgpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYobHQuc2l6JTJCMSUzQyUzRHgpJTIwbCUzRGslMkNzcGxpdChudC5ycyUyQ3gtbHQuc2l6LTElMkNudC5ycyUyQ3IpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwZWxzZSUyMHIlM0RrJTJDc3BsaXQobnQubHMlMkN4JTJDbCUyQ250LmxzKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHVwZGF0ZShrKSUzQiUwQSUyMCUyMCUyMCUyMCU3RCUwQSUyMCUyMCUyMCUyMHZvaWQlMjBwcmludChpbnQlMjBrKSU3QiUyRiUyRiUyMCVFNCVCOCVBRCVFNSVCQSU4RiVFOSU4MSU4RCVFNSU4RSU4NiVFNiU4OSU5MyVFNSU4RCVCMCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKGslM0QlM0QwKSUyMHJldHVybiUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHByaW50KG50LmxzKSUzQmNvdXQlM0MlM0NudC52YWwlM0JwcmludChudC5ycyklM0IlMEElMjAlMjAlMjAlMjAlN0QlMEElN0QlMjB0cmVlJTNCJTBBaW5saW5lJTIwdm9pZCUyMHN1YnRhc2soKSU3QiUwQSUyMCUyMCUyMCUyMHNyYW5kKHRpbWUoTlVMTCkpJTNCJTBBJTIwJTIwJTIwJTIwaW50JTIwcG9zJTNEMCUyQ3Jvb3QlM0QwJTJDbiUyQ2wlMkNyJTNCY2luJTNFJTNFbiUzQiUwQSUyMCUyMCUyMCUyMHdoaWxlKG4tLSklN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBjaGFyJTIwb3AlNUI3JTVEJTNCY2luJTNFJTNFb3AlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCU1QjAlNUQlM0QlM0QnTScpJTIwY2luJTNFJTNFcG9zJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlNUIwJTVEJTNEJTNEJ0knKSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGludCUyMGxlbiUzQmNpbiUzRSUzRWxlbiUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRyZWUuc3BsaXQocm9vdCUyQ3BvcyUyQ2wlMkNyKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGZvcihpbnQlMjBpJTNEMSUzQmklM0MlM0RsZW4lM0JpJTJCJTJCKSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGNoYXIlMjBjaCUzRGdldGNoYXIoKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHdoaWxlKGNoJTNDMzIlN0MlN0NjaCUzRTEyNiklMjBjaCUzRGdldGNoYXIoKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGwlM0R0cmVlLm1lcmdlKGwlMkN0cmVlLmNyZWF0ZShjaCkpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwcm9vdCUzRHRyZWUubWVyZ2UobCUyQ3IpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlNUIwJTVEJTNEJTNEJ0QnKSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGludCUyMGxlbiUyQ3RtcCUzQmNpbiUzRSUzRWxlbiUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRyZWUuc3BsaXQocm9vdCUyQ3BvcyUyQmxlbiUyQ2wlMkNyKSUzQnRyZWUuc3BsaXQobCUyQ3BvcyUyQ2wlMkN0bXApJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwcm9vdCUzRHRyZWUubWVyZ2UobCUyQ3IpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlNUIwJTVEJTNEJTNEJ0cnKSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGludCUyMGxlbiUyQ3RtcCUzQmNpbiUzRSUzRWxlbiUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRyZWUuc3BsaXQocm9vdCUyQ3BvcyUyQmxlbiUyQ2wlMkNyKSUzQnRyZWUuc3BsaXQobCUyQ3BvcyUyQ2wlMkN0bXApJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdHJlZS5wcmludCh0bXApJTNCY291dCUzQyUzQ2VuZGwlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjByb290JTNEdHJlZS5tZXJnZSh0cmVlLm1lcmdlKGwlMkN0bXApJTJDciklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCU1QjAlNUQlM0QlM0QnUCcpJTIwcG9zLS0lM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCU1QjAlNUQlM0QlM0QnTicpJTIwcG9zJTJCJTJCJTNCJTBBJTIwJTIwJTIwJTIwJTdEJTBBJTdEJTBBc2lnbmVkJTIwbWFpbigpJTdCJTBBJTIwJTIwJTIwJTIwaW50JTIwdCUzRDElM0IlMkYlMkZjaW4lM0UlM0V0JTNCJTBBJTIwJTIwJTIwJTIwd2hpbGUodC0tKSUyMHN1YnRhc2soKSUzQiUwQSUyMCUyMCUyMCUyMHJldHVybiUyMDAlM0IlMEElN0QlMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div><div>63</div><div>64</div><div>65</div><div>66</div><div>67</div><div>68</div><div>69</div><div>70</div><div>71</div><div>72</div></div><div class="code"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ls(k) (k)&lt;&lt;1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rs(k) (k)&lt;&lt;1|1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> il inline</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> debug(x) cout&lt;&lt;#x&lt;&lt;<span class="hljs-string">&quot;=&quot;</span>&lt;&lt;x&lt;&lt;endl</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> inf=<span class="hljs-number">0x3f3f3f3f3f3f3f3f</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mod=<span class="hljs-number">0</span>;
<span class="hljs-keyword">typedef</span> pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; pii;
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ 1024*1024*2</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">FHQ</span>{
    <span class="hljs-type">int</span> tot=<span class="hljs-number">0</span>;
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>{<span class="hljs-type">int</span> ls,rs,dat,siz;<span class="hljs-type">char</span> val;} tree[_];
    <span class="hljs-meta">#<span class="hljs-keyword">define</span> nt tree[k]</span>
    <span class="hljs-meta">#<span class="hljs-keyword">define</span> lt tree[tree[k].ls]</span>
    <span class="hljs-meta">#<span class="hljs-keyword">define</span> rt tree[tree[k].rs]</span>
    <span class="hljs-function">il <span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{nt.siz=<span class="hljs-number">1</span>+lt.siz+rt.siz;}
    <span class="hljs-function">il <span class="hljs-type">int</span> <span class="hljs-title">create</span><span class="hljs-params">(<span class="hljs-type">char</span> v)</span></span>{<span class="hljs-type">int</span> k=++tot;nt.dat=<span class="hljs-built_in">rand</span>(),nt.val=v,nt.siz=<span class="hljs-number">1</span>;<span class="hljs-keyword">return</span> tot;}
    <span class="hljs-function">il <span class="hljs-type">int</span> <span class="hljs-title">merge</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
        <span class="hljs-keyword">if</span>(!x||!y) <span class="hljs-keyword">return</span> x+y;
        <span class="hljs-keyword">if</span>(tree[x].dat&lt;tree[y].dat) <span class="hljs-keyword">return</span> tree[x].rs=<span class="hljs-built_in">merge</span>(tree[x].rs,y),<span class="hljs-built_in">update</span>(x),x;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> tree[y].ls=<span class="hljs-built_in">merge</span>(x,tree[y].ls),<span class="hljs-built_in">update</span>(y),y;
    }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">split</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> &amp;l,<span class="hljs-type">int</span> &amp;r)</span></span>{
        <span class="hljs-keyword">if</span>(!k) <span class="hljs-keyword">return</span> l=r=<span class="hljs-number">0</span>,<span class="hljs-built_in">void</span>();
        <span class="hljs-keyword">if</span>(lt.siz<span class="hljs-number">+1</span>&lt;=x) l=k,<span class="hljs-built_in">split</span>(nt.rs,x-lt.siz<span class="hljs-number">-1</span>,nt.rs,r);
        <span class="hljs-keyword">else</span> r=k,<span class="hljs-built_in">split</span>(nt.ls,x,l,nt.ls);
        <span class="hljs-built_in">update</span>(k);
    }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{<span class="hljs-comment">// 中序遍历打印</span>
        <span class="hljs-keyword">if</span>(k==<span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
        <span class="hljs-built_in">print</span>(nt.ls);cout&lt;&lt;nt.val;<span class="hljs-built_in">print</span>(nt.rs);
    }
} tree;
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">subtask</span><span class="hljs-params">()</span></span>{
    <span class="hljs-built_in">srand</span>(<span class="hljs-built_in">time</span>(<span class="hljs-literal">NULL</span>));
    <span class="hljs-type">int</span> pos=<span class="hljs-number">0</span>,root=<span class="hljs-number">0</span>,n,l,r;cin&gt;&gt;n;
    <span class="hljs-keyword">while</span>(n--){
        <span class="hljs-type">char</span> op[<span class="hljs-number">7</span>];cin&gt;&gt;op;
        <span class="hljs-keyword">if</span>(op[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;M&#x27;</span>) cin&gt;&gt;pos;
        <span class="hljs-keyword">if</span>(op[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;I&#x27;</span>){
            <span class="hljs-type">int</span> len;cin&gt;&gt;len;
            tree.<span class="hljs-built_in">split</span>(root,pos,l,r);
            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=len;i++){
                <span class="hljs-type">char</span> ch=<span class="hljs-built_in">getchar</span>();
                <span class="hljs-keyword">while</span>(ch&lt;<span class="hljs-number">32</span>||ch&gt;<span class="hljs-number">126</span>) ch=<span class="hljs-built_in">getchar</span>();
                l=tree.<span class="hljs-built_in">merge</span>(l,tree.<span class="hljs-built_in">create</span>(ch));
            }
            root=tree.<span class="hljs-built_in">merge</span>(l,r);
        }
        <span class="hljs-keyword">if</span>(op[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;D&#x27;</span>){
            <span class="hljs-type">int</span> len,tmp;cin&gt;&gt;len;
            tree.<span class="hljs-built_in">split</span>(root,pos+len,l,r);tree.<span class="hljs-built_in">split</span>(l,pos,l,tmp);
            root=tree.<span class="hljs-built_in">merge</span>(l,r);
        }
        <span class="hljs-keyword">if</span>(op[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;G&#x27;</span>){
            <span class="hljs-type">int</span> len,tmp;cin&gt;&gt;len;
            tree.<span class="hljs-built_in">split</span>(root,pos+len,l,r);tree.<span class="hljs-built_in">split</span>(l,pos,l,tmp);
            tree.<span class="hljs-built_in">print</span>(tmp);cout&lt;&lt;endl;
            root=tree.<span class="hljs-built_in">merge</span>(tree.<span class="hljs-built_in">merge</span>(l,tmp),r);
        }
        <span class="hljs-keyword">if</span>(op[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;P&#x27;</span>) pos--;
        <span class="hljs-keyword">if</span>(op[<span class="hljs-number">0</span>]==<span class="hljs-string">&#x27;N&#x27;</span>) pos++;
    }
}
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    <span class="hljs-type">int</span> t=<span class="hljs-number">1</span>;<span class="hljs-comment">//cin&gt;&gt;t;</span>
    <span class="hljs-keyword">while</span>(t--) <span class="hljs-built_in">subtask</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<h3 id="p3391-mo-ban-wen-yi-ping-heng-shu" tabindex="-1">P3391 【模板】文艺平衡树</h3>
<p><a href="https://www.luogu.com.cn/problem/P3391">https://www.luogu.com.cn/problem/P3391</a>
<strong>题目描述</strong>
维护一个序列，有若干区间翻转操作，输出所有操作后，得到的序列
<strong>笔记</strong>
对区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span> 进行翻转，可以视为将区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>k</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l,k]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">]</span></span></span></span> 和区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[k+1,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span> 交换，然后这两个区间再分别递归进行这个操作
也可以视为找到一个轴 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo stretchy="false">(</mo><mi>l</mi><mo>&lt;</mo><mi>k</mi><mo>&lt;</mo><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">k(l&lt;k&lt;r)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7335em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">&lt;</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span></span></span></span> ，将区间 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>l</mi><mo separator="true">,</mo><mi>k</mi><mo>−</mo><mn>1</mn><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[l,k-1]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mclose">]</span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mi>k</mi><mo>+</mo><mn>1</mn><mo separator="true">,</mo><mi>r</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[k+1,r]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">[</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">1</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">]</span></span></span></span> 交换，然后这两个区间再分别递归进行这个操作
然后对于本题我们在 fhq treap 上引入懒标记，每次分裂或者合并时 pushdown 这个懒标记</p>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTIzaW5jbHVkZSUzQ2lvc3RyZWFtJTNFJTBBJTIzZGVmaW5lJTIwbWF4biUyMDEwMDAwNSUwQXVzaW5nJTIwbmFtZXNwYWNlJTIwc3RkJTNCJTBBaW50JTIwaWQlMkN2YWwlNUJtYXhuJTVEJTJDZGF0JTVCbWF4biU1RCUyQ3NpemUlNUJtYXhuJTVEJTJDY2glNUJtYXhuJTVEJTVCMiU1RCUyQ3Jvb3QlMkN0YWclNUJtYXhuJTVEJTNCJTBBaW5saW5lJTIwaW50JTIwY3JlYXRlKGludCUyMHgpJTdCJTBBJTA5aWQlMkIlMkIlM0IlMEElMDl2YWwlNUJpZCU1RCUzRHglM0IlMEElMDlkYXQlNUJpZCU1RCUzRHJhbmQoKSUzQiUwQSUwOXNpemUlNUJpZCU1RCUzRDElM0IlMEElMDlyZXR1cm4lMjBpZCUzQiUwQSU3RCUwQWlubGluZSUyMHZvaWQlMjBwdXNodXAoaW50JTIwayklN0IlMEElMDlzaXplJTVCayU1RCUzRHNpemUlNUJjaCU1QmslNUQlNUIwJTVEJTVEJTJCMSUyQnNpemUlNUJjaCU1QmslNUQlNUIxJTVEJTVEJTNCJTBBJTdEJTBBaW5saW5lJTIwdm9pZCUyMHB1c2hkb3duKGludCUyMGspJTdCJTBBJTA5aWYodGFnJTVCayU1RCklN0IlMEElMDklMDl0YWclNUJjaCU1QmslNUQlNUIwJTVEJTVEJTVFJTNEMSUzQiUwQSUwOSUwOXRhZyU1QmNoJTVCayU1RCU1QjElNUQlNUQlNUUlM0QxJTNCJTBBJTA5JTA5c3dhcChjaCU1QmslNUQlNUIwJTVEJTJDY2glNUJrJTVEJTVCMSU1RCklM0IlMEElMDklMDl0YWclNUJrJTVEJTNEMCUzQiUwQSUwOSU3RCUwQSU3RCUwQXZvaWQlMjBzcGxpdChpbnQlMjBub3clMkNpbnQlMjBrJTJDaW50JTIwJTI2eCUyQ2ludCUyMCUyNnkpJTdCJTBBJTA5aWYoIW5vdyklMjB4JTNEeSUzRDAlM0IlMEElMDllbHNlJTdCJTBBJTA5JTA5cHVzaGRvd24obm93KSUzQiUwQSUwOSUwOWludCUyMHUlM0RzaXplJTVCY2glNUJub3clNUQlNUIwJTVEJTVEJTJCMSUzQiUwQSUwOSUwOWlmKHUlM0MlM0RrKSU3QiUwQSUwOSUwOSUwOXglM0Rub3clM0IlMEElMDklMDklMDlzcGxpdChjaCU1Qm5vdyU1RCU1QjElNUQlMkNrLXUlMkNjaCU1Qm5vdyU1RCU1QjElNUQlMkN5KSUzQiUwQSUwOSUwOSUwOXB1c2h1cCh4KSUzQiUwQSUwOSUwOSU3RGVsc2UlN0IlMEElMDklMDklMDl5JTNEbm93JTNCJTBBJTA5JTA5JTA5c3BsaXQoY2glNUJub3clNUQlNUIwJTVEJTJDayUyQ3glMkNjaCU1Qm5vdyU1RCU1QjAlNUQpJTNCJTBBJTA5JTA5JTA5cHVzaHVwKHkpJTNCJTBBJTA5JTA5JTdEJTBBJTA5JTdEJTBBJTdEJTBBaW50JTIwbWVyZ2UoaW50JTIweCUyQ2ludCUyMHkpJTdCJTBBJTA5aWYoIXglN0MlN0MheSklMjByZXR1cm4lMjB4JTJCeSUzQiUwQSUwOXB1c2hkb3duKHgpJTNCJTBBJTA5cHVzaGRvd24oeSklM0IlMEElMDlpZihkYXQlNUJ4JTVEJTNDJTNEZGF0JTVCeSU1RCklN0IlMEElMDklMDljaCU1QnglNUQlNUIxJTVEJTNEbWVyZ2UoY2glNUJ4JTVEJTVCMSU1RCUyQ3kpJTNCJTBBJTA5JTA5cHVzaHVwKHgpJTNCJTBBJTA5JTA5cmV0dXJuJTIweCUzQiUwQSUwOSU3RGVsc2UlN0IlMEElMDklMDljaCU1QnklNUQlNUIwJTVEJTNEbWVyZ2UoeCUyQ2NoJTVCeSU1RCU1QjAlNUQpJTNCJTBBJTA5JTA5cHVzaHVwKHkpJTNCJTBBJTA5JTA5cmV0dXJuJTIweSUzQiUwQSUwOSU3RCUwQSU3RCUwQXZvaWQlMjByZXZlcnNlKGludCUyMGwlMkNpbnQlMjByKSU3QiUwQSUwOWludCUyMHAxJTNEMCUyQ3AyJTNEMCUyQ3AzJTNEMCUyQ3A0JTNEMCUzQiUwQSUwOXNwbGl0KHJvb3QlMkNsLTElMkNwMSUyQ3AyKSUzQiUwQSUwOXNwbGl0KHAyJTJDKHItbCUyQjEpJTJDcDMlMkNwNCklM0IlMEElMDl0YWclNUJwMyU1RCU1RSUzRDElM0IlMEElMDlwMiUzRG1lcmdlKHAzJTJDcDQpJTNCJTBBJTA5cm9vdCUzRG1lcmdlKHAxJTJDcDIpJTNCJTBBJTdEJTBBdm9pZCUyMHByaW50KGludCUyMGspJTdCJTBBJTA5cHVzaGRvd24oayklM0IlMEElMDlpZihjaCU1QmslNUQlNUIwJTVEKSUyMHByaW50KGNoJTVCayU1RCU1QjAlNUQpJTNCJTBBJTA5Y291dCUzQyUzQ3ZhbCU1QmslNUQlM0MlM0MlMjIlMjAlMjIlM0IlMEElMDlpZihjaCU1QmslNUQlNUIxJTVEKSUyMHByaW50KGNoJTVCayU1RCU1QjElNUQpJTNCJTBBJTdEJTBBaW50JTIwbWFpbigpJTdCJTBBJTA5aW50JTIwbiUyQ20lM0IlMEElMDljaW4lM0UlM0VuJTNFJTNFbSUzQiUwQSUwOWludCUyMGwlMkNyJTNCJTBBJTA5Zm9yKGludCUyMGklM0QxJTNCaSUzQyUzRG4lM0JpJTJCJTJCKSU3QiUwQSUwOSUwOSUyRiUyRmludCUyMGslM0IlMEElMDklMDklMkYlMkZjaW4lM0UlM0VrJTNCJTBBJTA5JTA5c3BsaXQocm9vdCUyQ2ktMSUyQ2wlMkNyKSUzQiUwQSUwOSUwOXJvb3QlM0RtZXJnZShtZXJnZShsJTJDY3JlYXRlKGkpKSUyQ3IpJTNCJTBBJTA5JTdEJTBBJTA5d2hpbGUobS0tKSU3QiUwQSUwOSUwOWNpbiUzRSUzRWwlM0UlM0VyJTNCJTBBJTA5JTA5cmV2ZXJzZShsJTJDciklM0IlMEElMDklN0QlMEElMDlwcmludChyb290KSUzQiUwQSUwOXJldHVybiUyMDAlM0IlMEElN0QlMEE="><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div><div>63</div><div>64</div><div>65</div><div>66</div><div>67</div><div>68</div><div>69</div><div>70</div><div>71</div><div>72</div><div>73</div><div>74</div><div>75</div><div>76</div><div>77</div><div>78</div><div>79</div><div>80</div><div>81</div><div>82</div><div>83</div></div><div class="code"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> maxn 100005</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">int</span> id,val[maxn],dat[maxn],size[maxn],ch[maxn][<span class="hljs-number">2</span>],root,tag[maxn];
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">create</span><span class="hljs-params">(<span class="hljs-type">int</span> x)</span></span>{
	id++;
	val[id]=x;
	dat[id]=<span class="hljs-built_in">rand</span>();
	size[id]=<span class="hljs-number">1</span>;
	<span class="hljs-keyword">return</span> id;
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushup</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
	size[k]=size[ch[k][<span class="hljs-number">0</span>]]<span class="hljs-number">+1</span>+size[ch[k][<span class="hljs-number">1</span>]];
}
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
	<span class="hljs-keyword">if</span>(tag[k]){
		tag[ch[k][<span class="hljs-number">0</span>]]^=<span class="hljs-number">1</span>;
		tag[ch[k][<span class="hljs-number">1</span>]]^=<span class="hljs-number">1</span>;
		<span class="hljs-built_in">swap</span>(ch[k][<span class="hljs-number">0</span>],ch[k][<span class="hljs-number">1</span>]);
		tag[k]=<span class="hljs-number">0</span>;
	}
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">split</span><span class="hljs-params">(<span class="hljs-type">int</span> now,<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> &amp;x,<span class="hljs-type">int</span> &amp;y)</span></span>{
	<span class="hljs-keyword">if</span>(!now) x=y=<span class="hljs-number">0</span>;
	<span class="hljs-keyword">else</span>{
		<span class="hljs-built_in">pushdown</span>(now);
		<span class="hljs-type">int</span> u=size[ch[now][<span class="hljs-number">0</span>]]<span class="hljs-number">+1</span>;
		<span class="hljs-keyword">if</span>(u&lt;=k){
			x=now;
			<span class="hljs-built_in">split</span>(ch[now][<span class="hljs-number">1</span>],k-u,ch[now][<span class="hljs-number">1</span>],y);
			<span class="hljs-built_in">pushup</span>(x);
		}<span class="hljs-keyword">else</span>{
			y=now;
			<span class="hljs-built_in">split</span>(ch[now][<span class="hljs-number">0</span>],k,x,ch[now][<span class="hljs-number">0</span>]);
			<span class="hljs-built_in">pushup</span>(y);
		}
	}
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">merge</span><span class="hljs-params">(<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> y)</span></span>{
	<span class="hljs-keyword">if</span>(!x||!y) <span class="hljs-keyword">return</span> x+y;
	<span class="hljs-built_in">pushdown</span>(x);
	<span class="hljs-built_in">pushdown</span>(y);
	<span class="hljs-keyword">if</span>(dat[x]&lt;=dat[y]){
		ch[x][<span class="hljs-number">1</span>]=<span class="hljs-built_in">merge</span>(ch[x][<span class="hljs-number">1</span>],y);
		<span class="hljs-built_in">pushup</span>(x);
		<span class="hljs-keyword">return</span> x;
	}<span class="hljs-keyword">else</span>{
		ch[y][<span class="hljs-number">0</span>]=<span class="hljs-built_in">merge</span>(x,ch[y][<span class="hljs-number">0</span>]);
		<span class="hljs-built_in">pushup</span>(y);
		<span class="hljs-keyword">return</span> y;
	}
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">reverse</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>{
	<span class="hljs-type">int</span> p1=<span class="hljs-number">0</span>,p2=<span class="hljs-number">0</span>,p3=<span class="hljs-number">0</span>,p4=<span class="hljs-number">0</span>;
	<span class="hljs-built_in">split</span>(root,l<span class="hljs-number">-1</span>,p1,p2);
	<span class="hljs-built_in">split</span>(p2,(r-l<span class="hljs-number">+1</span>),p3,p4);
	tag[p3]^=<span class="hljs-number">1</span>;
	p2=<span class="hljs-built_in">merge</span>(p3,p4);
	root=<span class="hljs-built_in">merge</span>(p1,p2);
}
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">print</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
	<span class="hljs-built_in">pushdown</span>(k);
	<span class="hljs-keyword">if</span>(ch[k][<span class="hljs-number">0</span>]) <span class="hljs-built_in">print</span>(ch[k][<span class="hljs-number">0</span>]);
	cout&lt;&lt;val[k]&lt;&lt;<span class="hljs-string">&quot; &quot;</span>;
	<span class="hljs-keyword">if</span>(ch[k][<span class="hljs-number">1</span>]) <span class="hljs-built_in">print</span>(ch[k][<span class="hljs-number">1</span>]);
}
<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
	<span class="hljs-type">int</span> n,m;
	cin&gt;&gt;n&gt;&gt;m;
	<span class="hljs-type">int</span> l,r;
	<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i=<span class="hljs-number">1</span>;i&lt;=n;i++){
		<span class="hljs-comment">//int k;</span>
		<span class="hljs-comment">//cin&gt;&gt;k;</span>
		<span class="hljs-built_in">split</span>(root,i<span class="hljs-number">-1</span>,l,r);
		root=<span class="hljs-built_in">merge</span>(<span class="hljs-built_in">merge</span>(l,<span class="hljs-built_in">create</span>(i)),r);
	}
	<span class="hljs-keyword">while</span>(m--){
		cin&gt;&gt;l&gt;&gt;r;
		<span class="hljs-built_in">reverse</span>(l,r);
	}
	<span class="hljs-built_in">print</span>(root);
	<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
<h3 id="p5055-mo-ban-ke-chi-jiu-hua-wen-yi-ping-heng-shu" tabindex="-1">P5055 【模板】可持久化文艺平衡树</h3>
<p><a href="https://www.luogu.com.cn/problem/P5055">https://www.luogu.com.cn/problem/P5055</a>
<strong>题目描述</strong>
每次操作创建一个新版本。然后有如下的操作，可以基于之前的版本进行修改：</p>
<ol>
<li>在某个位置插入一个数</li>
<li>删除某个位置上的数字</li>
<li>翻转区间</li>
<li>查询区间和
<strong>笔记</strong>
考虑创建新版本时，很多节点是和上一个版本是重合的，所以我们对于重合的点，直接重用，只产生新的发生改变的点。每次 pushdown 和 split 的时候克隆
至于节点数组开多大，直接估计比较麻烦，我们可以直接根据题目的空间的限制尽可能开大</li>
</ol>
<pre><div class="head"><div class="language">cpp</div><div class="copy" data="JTIzaW5jbHVkZSUzQ2JpdHMlMkZzdGRjJTJCJTJCLmglM0UlMEElMjNkZWZpbmUlMjBpbnQlMjBsb25nJTIwbG9uZyUwQSUyM2RlZmluZSUyMHVsbCUyMHVuc2lnbmVkJTIwbG9uZyUyMGxvbmclMEElMjNkZWZpbmUlMjBscyhrKSUyMChrKSUzQyUzQzElMEElMjNkZWZpbmUlMjBycyhrKSUyMChrKSUzQyUzQzElN0MxJTBBJTIzZGVmaW5lJTIwZGVidWcoeCklMjBjb3V0JTNDJTNDJTIzeCUzQyUzQyUyMiUzRCUyMiUzQyUzQ3glM0MlM0NlbmRsJTBBdXNpbmclMjBuYW1lc3BhY2UlMjBzdGQlM0IlMEFjb25zdCUyMGludCUyMGluZiUzRDB4M2YzZjNmM2YzZjNmM2YzZiUzQiUwQWNvbnN0JTIwaW50JTIwbW9kJTNEMCUzQiUwQXR5cGVkZWYlMjBwYWlyJTNDaW50JTJDaW50JTNFJTIwcGlpJTNCJTBBJTIzZGVmaW5lJTIwXyUyMDIwMDAwNSUwQXN0cnVjdCUyMEZIUSU3QiUwQSUyMCUyMCUyMCUyMHN0cnVjdCUyME5vZGUlN0JpbnQlMjBscyUyQ3JzJTJDdmFsJTJDZGF0JTJDc2l6JTJDbGF6eSUyQ3N1bSUzQiU3RCUyMHRyZWUlNUJfJTNDJTNDNiU1RCUzQiUwQSUyMCUyMCUyMCUyMGludCUyMHRvdCUzRDAlM0IlMEElMjAlMjAlMjAlMjAlMjNkZWZpbmUlMjBudCUyMHRyZWUlNUJrJTVEJTBBJTIwJTIwJTIwJTIwJTIzZGVmaW5lJTIwbHQlMjB0cmVlJTVCdHJlZSU1QmslNUQubHMlNUQlMEElMjAlMjAlMjAlMjAlMjNkZWZpbmUlMjBydCUyMHRyZWUlNUJ0cmVlJTVCayU1RC5ycyU1RCUwQSUyMCUyMCUyMCUyMGlubGluZSUyMGludCUyMGNyZWF0ZShpbnQlMjB2KSU3QmludCUyMGslM0QlMkIlMkJ0b3QlM0JudC5kYXQlM0RyYW5kKCklMkNudC5zaXolM0QxJTJDbnQuc3VtJTNEdiUyQ250LnZhbCUzRHYlM0JyZXR1cm4lMjB0b3QlM0IlN0QlMEElMjAlMjAlMjAlMjBpbmxpbmUlMjBpbnQlMjBjbG9uZShpbnQlMjBrKSU3QnRyZWUlNUIlMkIlMkJ0b3QlNUQlM0RudCUzQnJldHVybiUyMHRvdCUzQiU3RCUwQSUyMCUyMCUyMCUyMGlubGluZSUyMHZvaWQlMjB1cGRhdGUoaW50JTIwayklN0JudC5zaXolM0QxJTJCbHQuc2l6JTJCcnQuc2l6JTJDbnQuc3VtJTNEbHQuc3VtJTJCcnQuc3VtJTJCbnQudmFsJTNCJTdEJTBBJTIwJTIwJTIwJTIwdm9pZCUyMHB1c2hkb3duKGludCUyMGspJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYoIW50LmxhenkpJTIwcmV0dXJuJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYobnQubHMpJTIwbnQubHMlM0RjbG9uZShudC5scyklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihudC5ycyklMjBudC5ycyUzRGNsb25lKG50LnJzKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHN3YXAobnQubHMlMkNudC5ycyklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBsdC5sYXp5JTVFJTNEMSUyQ3J0LmxhenklNUUlM0QxJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwbnQubGF6eSUzRDAlM0IlMEElMjAlMjAlMjAlMjAlN0QlMEElMjAlMjAlMjAlMjB2b2lkJTIwc3BsaXQoaW50JTIwayUyQ2ludCUyMHglMkNpbnQlMjAlMjZsJTJDaW50JTIwJTI2ciklN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZighayklMjByZXR1cm4lMjBsJTNEciUzRDAlMkN2b2lkKCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBwdXNoZG93bihrKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKGx0LnNpeiUyQjElM0MlM0R4KSUyMGwlM0RjbG9uZShrKSUyQ3NwbGl0KHRyZWUlNUJsJTVELnJzJTJDeC1sdC5zaXotMSUyQ3RyZWUlNUJsJTVELnJzJTJDciklMkN1cGRhdGUobCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBlbHNlJTIwciUzRGNsb25lKGspJTJDc3BsaXQodHJlZSU1QnIlNUQubHMlMkN4JTJDbCUyQ3RyZWUlNUJyJTVELmxzKSUyQ3VwZGF0ZShyKSUzQiUwQSUyMCUyMCUyMCUyMCU3RCUwQSUyMCUyMCUyMCUyMGludCUyMG1lcmdlKGludCUyMGwlMkNpbnQlMjByKSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKGwlM0QlM0QwJTdDJTdDciUzRCUzRDApJTIwcmV0dXJuJTIwbCUyQnIlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBwdXNoZG93bihsKSUzQnB1c2hkb3duKHIpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYodHJlZSU1QmwlNUQuZGF0JTNDdHJlZSU1QnIlNUQuZGF0KSUyMHJldHVybiUyMHRyZWUlNUJsJTVELnJzJTNEbWVyZ2UodHJlZSU1QmwlNUQucnMlMkNyKSUyQ3VwZGF0ZShsKSUyQ2wlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBlbHNlJTIwcmV0dXJuJTIwdHJlZSU1QnIlNUQubHMlM0RtZXJnZShsJTJDdHJlZSU1QnIlNUQubHMpJTJDdXBkYXRlKHIpJTJDciUzQiUwQSUyMCUyMCUyMCUyMCU3RCUwQSU3RCUyMHRyZWUlM0IlMEFpbnQlMjByb290JTVCXyU1RCUzQiUwQWlubGluZSUyMHZvaWQlMjBzdWJ0YXNrKCklN0IlMEElMjAlMjAlMjAlMjBzcmFuZCh0aW1lKE5VTEwpKSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMG5vdyUzRDAlMkNsJTJDciUyQ3RtcCUyQ2xhc3RhbnMlM0QwJTJDbiUzQmNpbiUzRSUzRW4lM0IlMEElMjAlMjAlMjAlMjB3aGlsZShuLS0pJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW50JTIwdiUyQ29wJTNCY2luJTNFJTNFdiUzRSUzRW9wJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlM0QlM0QxKSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGludCUyMHAlMkN4JTNCY2luJTNFJTNFcCUzRSUzRXglM0JwJTVFJTNEbGFzdGFucyUyQ3glNUUlM0RsYXN0YW5zJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdHJlZS5zcGxpdChyb290JTVCdiU1RCUyQ3AlMkNsJTJDciklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjByb290JTVCJTJCJTJCbm93JTVEJTNEdHJlZS5tZXJnZSh0cmVlLm1lcmdlKGwlMkN0cmVlLmNyZWF0ZSh4KSklMkNyKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCU3RCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGlmKG9wJTNEJTNEMiklN0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpbnQlMjBwJTNCY2luJTNFJTNFcCUzQnAlNUUlM0RsYXN0YW5zJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdHJlZS5zcGxpdChyb290JTVCdiU1RCUyQ3AlMkN0bXAlMkNyKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRyZWUuc3BsaXQodG1wJTJDcC0xJTJDbCUyQ3RtcCklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjByb290JTVCJTJCJTJCbm93JTVEJTNEdHJlZS5tZXJnZShsJTJDciklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0QlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBpZihvcCUzRCUzRDMpJTdCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaW50JTIweCUyQ3klM0JjaW4lM0UlM0V4JTNFJTNFeSUzQnglNUUlM0RsYXN0YW5zJTJDeSU1RSUzRGxhc3RhbnMlM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB0cmVlLnNwbGl0KHJvb3QlNUJ2JTVEJTJDeSUyQ2wlMkNyKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMHRyZWUuc3BsaXQobCUyQ3gtMSUyQ2wlMkN0bXApJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdHJlZS50cmVlJTVCdG1wJTVELmxhenklNUUlM0QxJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwcm9vdCU1QiUyQiUyQm5vdyU1RCUzRHRyZWUubWVyZ2UodHJlZS5tZXJnZShsJTJDdG1wKSUyQ3IpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwaWYob3AlM0QlM0Q0KSU3QiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGludCUyMHglMkN5JTNCY2luJTNFJTNFeCUzRSUzRXklM0J4JTVFJTNEbGFzdGFucyUyQ3klNUUlM0RsYXN0YW5zJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwdHJlZS5zcGxpdChyb290JTVCdiU1RCUyQ3klMkNsJTJDciklM0IlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjB0cmVlLnNwbGl0KGwlMkN4LTElMkNsJTJDdG1wKSUzQiUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGxhc3RhbnMlM0R0cmVlLnRyZWUlNUJ0bXAlNUQuc3VtJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwY291dCUzQyUzQ2xhc3RhbnMlM0MlM0NlbmRsJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwcm9vdCU1QiUyQiUyQm5vdyU1RCUzRHRyZWUubWVyZ2UodHJlZS5tZXJnZShsJTJDdG1wKSUyQ3IpJTNCJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTdEJTBBJTIwJTIwJTIwJTIwJTdEJTBBJTdEJTBBc2lnbmVkJTIwbWFpbigpJTdCJTBBJTIwJTIwJTIwJTIwaW9zJTNBJTNBc3luY193aXRoX3N0ZGlvKGZhbHNlKSUzQiUwQSUyMCUyMCUyMCUyMGludCUyMHQlM0QxJTNCJTJGJTJGY2luJTNFJTNFdCUzQiUwQSUyMCUyMCUyMCUyMHdoaWxlKHQtLSklMjBzdWJ0YXNrKCklM0IlMEElMjAlMjAlMjAlMjByZXR1cm4lMjAwJTNCJTBBJTdEJTBB"><svg focusable="false" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"></path></svg></div></div><code class="hljs"><div class="lines"><div>1</div><div>2</div><div>3</div><div>4</div><div>5</div><div>6</div><div>7</div><div>8</div><div>9</div><div>10</div><div>11</div><div>12</div><div>13</div><div>14</div><div>15</div><div>16</div><div>17</div><div>18</div><div>19</div><div>20</div><div>21</div><div>22</div><div>23</div><div>24</div><div>25</div><div>26</div><div>27</div><div>28</div><div>29</div><div>30</div><div>31</div><div>32</div><div>33</div><div>34</div><div>35</div><div>36</div><div>37</div><div>38</div><div>39</div><div>40</div><div>41</div><div>42</div><div>43</div><div>44</div><div>45</div><div>46</div><div>47</div><div>48</div><div>49</div><div>50</div><div>51</div><div>52</div><div>53</div><div>54</div><div>55</div><div>56</div><div>57</div><div>58</div><div>59</div><div>60</div><div>61</div><div>62</div><div>63</div><div>64</div><div>65</div><div>66</div><div>67</div><div>68</div><div>69</div><div>70</div><div>71</div><div>72</div><div>73</div><div>74</div><div>75</div><div>76</div><div>77</div><div>78</div><div>79</div><div>80</div><div>81</div></div><div class="code"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;bits/stdc++.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> int long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ull unsigned long long</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> ls(k) (k)&lt;&lt;1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> rs(k) (k)&lt;&lt;1|1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> debug(x) cout&lt;&lt;#x&lt;&lt;<span class="hljs-string">&quot;=&quot;</span>&lt;&lt;x&lt;&lt;endl</span>
<span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> std;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> inf=<span class="hljs-number">0x3f3f3f3f3f3f3f3f</span>;
<span class="hljs-type">const</span> <span class="hljs-type">int</span> mod=<span class="hljs-number">0</span>;
<span class="hljs-keyword">typedef</span> pair&lt;<span class="hljs-type">int</span>,<span class="hljs-type">int</span>&gt; pii;
<span class="hljs-meta">#<span class="hljs-keyword">define</span> _ 200005</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">FHQ</span>{
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">Node</span>{<span class="hljs-type">int</span> ls,rs,val,dat,siz,lazy,sum;} tree[_&lt;&lt;<span class="hljs-number">6</span>];
    <span class="hljs-type">int</span> tot=<span class="hljs-number">0</span>;
    <span class="hljs-meta">#<span class="hljs-keyword">define</span> nt tree[k]</span>
    <span class="hljs-meta">#<span class="hljs-keyword">define</span> lt tree[tree[k].ls]</span>
    <span class="hljs-meta">#<span class="hljs-keyword">define</span> rt tree[tree[k].rs]</span>
    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">create</span><span class="hljs-params">(<span class="hljs-type">int</span> v)</span></span>{<span class="hljs-type">int</span> k=++tot;nt.dat=<span class="hljs-built_in">rand</span>(),nt.siz=<span class="hljs-number">1</span>,nt.sum=v,nt.val=v;<span class="hljs-keyword">return</span> tot;}
    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">int</span> <span class="hljs-title">clone</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{tree[++tot]=nt;<span class="hljs-keyword">return</span> tot;}
    <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">update</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{nt.siz=<span class="hljs-number">1</span>+lt.siz+rt.siz,nt.sum=lt.sum+rt.sum+nt.val;}
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pushdown</span><span class="hljs-params">(<span class="hljs-type">int</span> k)</span></span>{
        <span class="hljs-keyword">if</span>(!nt.lazy) <span class="hljs-keyword">return</span>;
        <span class="hljs-keyword">if</span>(nt.ls) nt.ls=<span class="hljs-built_in">clone</span>(nt.ls);
        <span class="hljs-keyword">if</span>(nt.rs) nt.rs=<span class="hljs-built_in">clone</span>(nt.rs);
        <span class="hljs-built_in">swap</span>(nt.ls,nt.rs);
        lt.lazy^=<span class="hljs-number">1</span>,rt.lazy^=<span class="hljs-number">1</span>;
        nt.lazy=<span class="hljs-number">0</span>;
    }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">split</span><span class="hljs-params">(<span class="hljs-type">int</span> k,<span class="hljs-type">int</span> x,<span class="hljs-type">int</span> &amp;l,<span class="hljs-type">int</span> &amp;r)</span></span>{
        <span class="hljs-keyword">if</span>(!k) <span class="hljs-keyword">return</span> l=r=<span class="hljs-number">0</span>,<span class="hljs-built_in">void</span>();
        <span class="hljs-built_in">pushdown</span>(k);
        <span class="hljs-keyword">if</span>(lt.siz<span class="hljs-number">+1</span>&lt;=x) l=<span class="hljs-built_in">clone</span>(k),<span class="hljs-built_in">split</span>(tree[l].rs,x-lt.siz<span class="hljs-number">-1</span>,tree[l].rs,r),<span class="hljs-built_in">update</span>(l);
        <span class="hljs-keyword">else</span> r=<span class="hljs-built_in">clone</span>(k),<span class="hljs-built_in">split</span>(tree[r].ls,x,l,tree[r].ls),<span class="hljs-built_in">update</span>(r);
    }
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">merge</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> r)</span></span>{
        <span class="hljs-keyword">if</span>(l==<span class="hljs-number">0</span>||r==<span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> l+r;
        <span class="hljs-built_in">pushdown</span>(l);<span class="hljs-built_in">pushdown</span>(r);
        <span class="hljs-keyword">if</span>(tree[l].dat&lt;tree[r].dat) <span class="hljs-keyword">return</span> tree[l].rs=<span class="hljs-built_in">merge</span>(tree[l].rs,r),<span class="hljs-built_in">update</span>(l),l;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">return</span> tree[r].ls=<span class="hljs-built_in">merge</span>(l,tree[r].ls),<span class="hljs-built_in">update</span>(r),r;
    }
} tree;
<span class="hljs-type">int</span> root[_];
<span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">subtask</span><span class="hljs-params">()</span></span>{
    <span class="hljs-built_in">srand</span>(<span class="hljs-built_in">time</span>(<span class="hljs-literal">NULL</span>));
    <span class="hljs-type">int</span> now=<span class="hljs-number">0</span>,l,r,tmp,lastans=<span class="hljs-number">0</span>,n;cin&gt;&gt;n;
    <span class="hljs-keyword">while</span>(n--){
        <span class="hljs-type">int</span> v,op;cin&gt;&gt;v&gt;&gt;op;
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">1</span>){
            <span class="hljs-type">int</span> p,x;cin&gt;&gt;p&gt;&gt;x;p^=lastans,x^=lastans;
            tree.<span class="hljs-built_in">split</span>(root[v],p,l,r);
            root[++now]=tree.<span class="hljs-built_in">merge</span>(tree.<span class="hljs-built_in">merge</span>(l,tree.<span class="hljs-built_in">create</span>(x)),r);
        }
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">2</span>){
            <span class="hljs-type">int</span> p;cin&gt;&gt;p;p^=lastans;
            tree.<span class="hljs-built_in">split</span>(root[v],p,tmp,r);
            tree.<span class="hljs-built_in">split</span>(tmp,p<span class="hljs-number">-1</span>,l,tmp);
            root[++now]=tree.<span class="hljs-built_in">merge</span>(l,r);
        }
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">3</span>){
            <span class="hljs-type">int</span> x,y;cin&gt;&gt;x&gt;&gt;y;x^=lastans,y^=lastans;
            tree.<span class="hljs-built_in">split</span>(root[v],y,l,r);
            tree.<span class="hljs-built_in">split</span>(l,x<span class="hljs-number">-1</span>,l,tmp);
            tree.tree[tmp].lazy^=<span class="hljs-number">1</span>;
            root[++now]=tree.<span class="hljs-built_in">merge</span>(tree.<span class="hljs-built_in">merge</span>(l,tmp),r);
        }
        <span class="hljs-keyword">if</span>(op==<span class="hljs-number">4</span>){
            <span class="hljs-type">int</span> x,y;cin&gt;&gt;x&gt;&gt;y;x^=lastans,y^=lastans;
            tree.<span class="hljs-built_in">split</span>(root[v],y,l,r);
            tree.<span class="hljs-built_in">split</span>(l,x<span class="hljs-number">-1</span>,l,tmp);
            lastans=tree.tree[tmp].sum;
            cout&lt;&lt;lastans&lt;&lt;endl;
            root[++now]=tree.<span class="hljs-built_in">merge</span>(tree.<span class="hljs-built_in">merge</span>(l,tmp),r);
        }
    }
}
<span class="hljs-function"><span class="hljs-type">signed</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span>{
    ios::<span class="hljs-built_in">sync_with_stdio</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-type">int</span> t=<span class="hljs-number">1</span>;<span class="hljs-comment">//cin&gt;&gt;t;</span>
    <span class="hljs-keyword">while</span>(t--) <span class="hljs-built_in">subtask</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</div></code></pre>
